´
QC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ConnectionStr.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
{ 
public 

class 
ConnectionStr 
{		 
public

 
string

 
dbConnection

 "
{

# $
get

% (
;

( )
set

* -
;

- .
}

/ 0
=

1 2
string

3 9
.

9 :
Empty

: ?
;

? @
} 
} ÇP
aC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Controllers\AccountController.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Controllers# .
{ 
public 

class 
AccountController "
:# $

Controller% /
{ 
private 
Logger 
log 
; 
public 
AccountController  
(  !
)! "
{ 	
log 
= 

LogManager 
. !
GetCurrentClassLogger 2
(2 3
)3 4
;4 5
} 	
public 
IActionResult 
Read !
(! "
[" #
FromServices# /
]/ 0
BookDbContext1 >
ctx? B
)B C
{ 	
var 
user 
= 
User 
. 
Identity $
.$ %
Name% )
.) *
Replace* 1
(1 2
$str2 <
,< =
$str> @
)@ A
;A B
var 

paperBooks 
= 
ctx  
.  !
RentHistories! .
. 
Where 
( 
q 
=> 
q 
. 
User "
." #
	LoginName# ,
==- /
user0 4
&&5 7
q8 9
.9 :
ReturnedDate: F
!=G I
nullJ N
)N O
. 
Select 
( 
q 
=> 
q 
. 
	TakenBook (
)( )
. 
Distinct 
( 
) 
. 
ToList 
( 
) 
; 
var 
eBooks 
= 
ctx 
. 
DownloadHistories .
.   
Where   
(   
q   
=>   
q   
.   
User   "
.  " #
	LoginName  # ,
==  - /
user  0 4
)  4 5
.!! 
Select!! 
(!! 
q!! 
=>!! 
q!! 
.!! 
DownloadedBook!! -
)!!- .
."" 
Distinct"" 
("" 
)"" 
.## 
ToList## 
(## 
)## 
;## 
var$$ 
list$$ 
=$$ 
new$$ 
List$$ 
<$$  
Book$$  $
>$$$ %
($$% &
)$$& '
;$$' (
if%% 
(%% 

paperBooks%% 
.%% 
Any%% 
(%% 
)%% 
)%%  
list&& 
.&& 
AddRange&& 
(&& 

paperBooks&& (
)&&( )
;&&) *
if'' 
('' 
eBooks'' 
.'' 
Any'' 
('' 
)'' 
)'' 
list(( 
.(( 
AddRange(( 
((( 

paperBooks(( (
)((( )
;(() *
return)) 
View)) 
()) 
$str)) 
,)) 
list)) #
)))# $
;))$ %
}** 	
public++ 
IActionResult++ 
Reading++ $
(++$ %
[++% &
FromServices++& 2
]++2 3
BookDbContext++4 A
ctx++B E
)++E F
{,, 	
var-- 
userName-- 
=-- 
User-- 
.--  
Identity--  (
.--( )
Name--) -
.--- .
Replace--. 5
(--5 6
$str--6 @
,--@ A
$str--A C
)--C D
;--D E
var.. 
user.. 
=.. 
ctx.. 
... 
AppUsers.. #
...# $
First..$ )
(..) *
q..* +
=>.., .
q../ 0
...0 1
	LoginName..1 :
==..; =
userName..> F
)..F G
;..G H
var// 

paperBooks// 
=// 
ctx//  
.//  !

PaperBooks//! +
.00 
Where00 
(00 
q00 
=>00 
q00 
.00 
TakenByUser00 )
==00) +
user00+ /
)00/ 0
.11 
ToList11 
(11 
)11 
;11 
return33 
View33 
(33 
$str33 !
,33! "

paperBooks33" ,
)33, -
;33- .
}44 	
public55 
IActionResult55 
Requests55 %
(55% &
[55& '
FromServices55' 3
]553 4
BookDbContext555 B
ctx55C F
)55F G
{66 	
var77 
user77 
=77 
User77 
.77 
Identity77 $
.77$ %
Name77% )
.77) *
Replace77* 1
(771 2
$str772 <
,77< =
$str77> @
)77@ A
;77A B
var88 
book88 
=88 
ctx88 
.88 
RequestBooks88 '
.99 
Where99 
(99 
q99 
=>99 
q99 
.99 
AppUser99 %
.99% &
	LoginName99& /
==990 2
user993 7
)997 8
.:: 
Select:: 
(:: 
q:: 
=>:: 
(:: 
	PaperBook:: '
)::' (
q::( )
.::) *
Book::* .
)::. /
.;; 
AsEnumerable;; 
(;; 
);; 
;;;  
return== 
View== 
(== 
$str== "
,==" #
book==$ (
)==( )
;==) *
}>> 	
public@@ 
async@@ 
Task@@ 
<@@ 

JsonResult@@ $
>@@$ %
	AddReview@@& /
(@@/ 0
[@@0 1
FromServices@@1 =
]@@= >
BookDbContext@@? L
ctx@@M P
,@@P Q
[@@Q R
FromBody@@R Z
]@@Z [
AddReviewModel@@\ j
model@@k p
)@@p q
{AA 	
varBB 
resultBB 
=BB 
newBB 
OperationResultBB ,
(BB, -
)BB- .
;BB. /
tryCC 
{DD 
varEE 
bookEE 
=EE 
ctxEE 
.EE 
BooksEE $
.EE$ %
FirstOrDefaultEE% 3
(EE3 4
qEE4 5
=>EE6 8
qEE9 :
.EE: ;
BiaIdEE; @
==EEA C
modelEED I
.EEI J
BookIdEEJ P
)EEP Q
;EEQ R
varFF 
userFF 
=FF 
ctxFF 
.FF 
AppUsersFF '
.FF' (
FirstOrDefaultFF( 6
(FF6 7
qFF7 8
=>FF9 ;
qFF< =
.FF= >
	LoginNameFF> G
==FFH J
UserFFK O
.FFO P
IdentityFFP X
.FFX Y
NameFFY ]
.FF] ^
ReplaceFF^ e
(FFe f
$strFFf p
,FFp q
$strFFr t
)FFt u
)FFu v
;FFv w
ifHH 
(HH 
bookHH 
==HH 
nullHH 
)HH  
{II 
returnJJ 
JsonJJ 
(JJ  
resultJJ  &
.JJ& '
SetFailJJ' .
(JJ. /
$strJJ/ A
)JJA B
)JJB C
;JJC D
}KK 
ifMM 
(MM 
userMM 
==MM 
nullMM  
)MM  !
{NN 
returnOO 
JsonOO 
(OO  
resultOO  &
.OO& '
SetFailOO' .
(OO. /
$strOO/ G
)OOG H
)OOH I
;OOI J
}PP 
ifRR 
(RR 
ctxRR 
.RR 
ReviewsRR 
.RR  
AnyRR  #
(RR# $
qRR$ %
=>RR& (
qRR) *
.RR* +
BookIdRR+ 1
==RR2 4
bookRR5 9
.RR9 :
BiaIdRR: ?
&&RR@ B
qRRC D
.RRD E

RatedByUidRRE O
==RRP R
userRRS W
.RRW X
UidRRX [
)RR[ \
)RR\ ]
{SS 
returnTT 
JsonTT 
(TT  
resultTT  &
.TT& '
SetFailTT' .
(TT. /
$strTT/ G
)TTG H
)TTH I
;TTI J
}UU 
varWW 
reviewWW 
=WW 
newWW  
ReviewWW! '
(WW' (
)WW( )
{XX 
TextYY 
=YY 
modelYY  
.YY  !
TextYY! %
,YY% &
RatingZZ 
=ZZ 
modelZZ "
.ZZ" #
RatingZZ# )
,ZZ) *

RatedByUid[[ 
=[[  
user[[! %
.[[% &
Uid[[& )
,[[) *
BookId\\ 
=\\ 
book\\ !
.\\! "
BiaId\\" '
}]] 
;]] 
ctx__ 
.__ 
Reviews__ 
.__ 
Add__ 
(__  
review__  &
)__& '
;__' (
ctx`` 
.`` 
SaveChanges`` 
(``  
)``  !
;``! "
bookaa 
.aa 
AverageRatingaa "
=aa# $
bookaa% )
.aa) *
SumCurrentRatingaa* :
(aa: ;
)aa; <
;aa< =
ctxbb 
.bb 
SaveChangesbb 
(bb  
)bb  !
;bb! "
returndd 
Jsondd 
(dd 
resultdd "
.dd" #

SetSuccessdd# -
(dd- .
$strdd. ?
)dd? @
)dd@ A
;ddA B
}ee 
catchff 
(ff 
	Exceptionff 
eff 
)ff 
{gg 
returnhh 
Jsonhh 
(hh 
resulthh "
.hh" #
SetFailhh# *
(hh* +
ehh+ ,
)hh, -
)hh- .
;hh. /
}ii 
}jj 	
}kk 
}ll ²ã
_C:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Controllers\AdminController.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Controllers# .
{ 
[ 
	Authorize 
( 
Policy 
= 
Data 
. 
S 
. 

GroupAdmin )
)) *
]* +
public 

class 
AdminController  
:! "

Controller# -
{   
private!! 
readonly!! 
IHostingEnvironment!! ,
_hostingEnvironment!!- @
;!!@ A
private"" 
readonly"" 
IConfiguration"" '
_config""( /
;""/ 0
private## 
readonly## 
IBrowser## !
_browser##" *
;##* +
private$$ 
Logger$$ 
log$$ 
;$$ 
public%% 
AdminController%% 
(%% 
IConfiguration%% -
configuration%%. ;
,%%; <
IHostingEnvironment%%= P
hostingEnvironment%%Q c
,%%c d
IBrowserResolver%%e u
browserResolver	%%v 
)
%% 
{&& 	
log'' 
='' 
NLog'' 
.'' 

LogManager'' !
.''! "!
GetCurrentClassLogger''" 7
(''7 8
)''8 9
;''9 :
_config(( 
=(( 
configuration(( #
;((# $
_hostingEnvironment)) 
=))  !
hostingEnvironment))" 4
;))4 5
_browser** 
=** 
browserResolver** &
.**& '
Browser**' .
;**. /
}++ 	
public-- 
IActionResult-- 
Manage-- #
(--# $
[--$ %
FromServices--% 1
]--1 2
BookDbContext--3 @
ctx--A D
)--D E
{.. 	
var// 
books// 
=// 
ctx// 
.// 
Books// !
.//! "
AsEnumerable//" .
(//. /
)/// 0
;//0 1
return00 
View00 
(00 
$str00  
,00  !
books00" '
)00' (
;00( )
}11 	
public33 
IActionResult33 

TakenBooks33 '
(33' (
[33( )
FromServices33) 5
]335 6
BookDbContext337 D
ctx33E H
)33H I
{44 	
var55 
books55 
=55 
ctx55 
.55 
RentHistories55 )
.55) *
Where55* /
(55/ 0
q550 1
=>552 4
q555 6
.556 7
ReturnedDate557 C
==55D F
null55G K
)55K L
.55L M
OrderByDescending55M ^
(55^ _
q55_ `
=>55a c
q55d e
.55e f
ExtendedDueDate55f u
)55u v
.55v w
ToList55w }
(55} ~
)55~ 
;	55 
return66 
View66 
(66 
$str66 #
,66# $
books66% *
)66* +
;66+ ,
}77 	
public99 
IActionResult99 
Reviews99 $
(99$ %
[99% &
FromServices99& 2
]992 3
BookDbContext994 A
ctx99B E
)99E F
{:: 	
var;; 
reviews;; 
=;; 
ctx;; 
.;; 
Reviews;; %
.;;% &
OrderBy;;& -
(;;- .
q;;. /
=>;;0 2
q;;3 4
.;;4 5
Book;;5 9
);;9 :
.;;: ;
AsEnumerable;;; G
(;;G H
);;H I
;;;I J
return<< 
View<< 
(<< 
$str<< !
,<<! "
reviews<<# *
)<<* +
;<<+ ,
}== 	
publicEE 
IActionResultEE 
CreateEE #
(EE# $
[EE$ %
FromServicesEE% 1
]EE1 2
BookDbContextEE3 @
ctxEEA D
)EED E
{FF 	
varGG 
bookGG 
=GG 
newGG 
BookGG 
(GG  
)GG  !
;GG! "
ctxHH 
.HH 
BooksHH 
.HH 
AddHH 
(HH 
bookHH 
)HH 
;HH  
ctxII 
.II 
SaveChangesII 
(II 
)II 
;II 
returnKK 
RedirectKK 
(KK 
$"KK 
$strKK .
{KK. /
bookKK/ 3
.KK3 4
BiaIdKK4 9
}KK9 :
"KK: ;
)KK; <
;KK< =
}LL 	
publicTT 
IActionResultTT 
BookTT !
(TT! "
[TT" #
FromServicesTT# /
]TT/ 0
BookDbContextTT1 >
ctxTT? B
,TTB C
intTTD G
idTTH J
)TTJ K
{UU 	
varVV 
bookVV 
=VV 
ctxVV 
.VV 
BooksVV  
.VV  !
FirstVV! &
(VV& '
qVV' (
=>VV) +
qVV, -
.VV- .
BiaIdVV. 3
==VV4 6
idVV7 9
)VV9 :
;VV: ;
returnWW 
ViewWW 
(WW 
$strWW 
,WW 
bookWW  $
)WW$ %
;WW% &
}XX 	
publicZZ 
IActionResultZZ 
RequestsZZ %
(ZZ% &
[ZZ& '
FromServicesZZ' 3
]ZZ3 4
BookDbContextZZ5 B
ctxZZC F
)ZZF G
{[[ 	
var\\ 
requests\\ 
=\\ 
ctx\\ 
.\\ 
RequestBooks\\ +
.\\+ ,
OrderBy\\, 3
(\\3 4
q\\4 5
=>\\6 8
q\\9 :
.\\: ;
Date\\; ?
)\\? @
;\\@ A
return]] 
View]] 
(]] 
$str]] "
,]]" #
requests]]$ ,
)]], -
;]]- .
}^^ 	
public`` 
IActionResult`` 
Settings`` %
(``% &
[``& '
FromServices``' 3
]``3 4
BookDbContext``5 B
ctx``C F
)``F G
{aa 	
varbb 
usersbb 
=bb 
ctxbb 
.bb 
AppUsersbb $
.bb$ %
ToListbb% +
(bb+ ,
)bb, -
;bb- .
varcc 
authorscc 
=cc 
ctxcc 
.cc 
Authorscc %
.cc% &
ToListcc& ,
(cc, -
)cc- .
;cc. /
vardd 
categorydd 
=dd 
ctxdd 
.dd 

Categoriesdd )
.dd) *
ToListdd* 0
(dd0 1
)dd1 2
;dd2 3
varee 
settingsee 
=ee 
newee 
SettingsViewModelee 0
(ee0 1
)ee1 2
{ff 
Usersgg 
=gg 
usersgg 
,gg 
Authorshh 
=hh 
authorshh !
,hh! "

Categoriesii 
=ii 
categoryii %
}jj 
;jj 
returnkk 
Viewkk 
(kk 
$strkk "
,kk" #
settingskk$ ,
)kk, -
;kk- .
}ll 	
publicnn 
IActionResultnn 
Usersnn "
(nn" #
[nn# $
FromServicesnn$ 0
]nn0 1
BookDbContextnn2 ?
ctxnn@ C
)nnC D
{oo 	
varpp 
userspp 
=pp 
ctxpp 
.pp 
AppUserspp $
.pp$ %
ToListpp% +
(pp+ ,
)pp, -
;pp- .
varqq 
ignoredqq 
=qq 
ctxqq 
.qq 
IgnoredUsersqq *
.qq* +
ToListqq+ 1
(qq1 2
)qq2 3
;qq3 4
returnrr 
Viewrr 
(rr 
$strrr 
,rr  
usersrr! &
)rr& '
;rr' (
}ss 	
publicuu 
IActionResultuu 
selectedUseruu )
(uu) *
[uu* +
FromServicesuu+ 7
]uu7 8
BookDbContextuu9 F
ctxuuG J
,uuJ K
[uuL M
	FromQueryuuM V
]uuV W
GuiduuX \
uiduu] `
)uu` a
{vv 	
varww 
userww 
=ww 
ctxww 
.ww 
AppUsersww #
.ww# $
Firstww$ )
(ww) *
qww* +
=>ww+ -
qww- .
.ww. /
Uidww/ 2
==ww2 4
uidww4 7
)ww7 8
;ww8 9
varxx 
dowloadsxx 
=xx 
ctxxx 
.xx 
DownloadHistoriesxx 0
.xx0 1
ToListxx1 7
(xx7 8
)xx8 9
;xx9 :
varyy 
uploadsyy 
=yy 
ctxyy 
.yy 
UploadHistoriesyy -
.yy- .
ToListyy. 4
(yy4 5
)yy5 6
;yy6 7
returnzz 
Viewzz 
(zz 
$strzz 
,zz 
userzz  $
)zz$ %
;zz% &
}{{ 	
public~~ 
async~~ 
Task~~ 
<~~ 

JsonResult~~ $
>~~$ %
	AddAuthor~~& /
(~~/ 0
[~~0 1
FromServices~~1 =
]~~= >
BookDbContext~~? L
ctx~~M P
,~~P Q
[~~R S
FromBody~~S [
]~~[ \
dynamic~~] d
model~~e j
)~~j k
{ 	
var
 
result
 
=
 
new
 
OperationResult
 ,
(
, -
)
- .
;
. /
try
 
{
 
var
 
first
 
=
 
(
 
string
 #
)
# $
model
$ )
.
) *
	FirstName
* 3
;
3 4
var
 
last
 
=
 
(
 
string
 "
)
" #
model
# (
.
( )
LastName
) 1
;
1 2
var
 
midle
 
=
 
(
 
string
 #
)
# $
model
$ )
.
) *

MiddleName
* 4
;
4 5
var
 
author
 
=
 
ctx
  
.
  !
Authors
! (
.
( )
FirstOrDefault
) 7
(
7 8
a
8 9
=>
: <
a
= >
.
> ?
	FirstName
? H
.
H I
ToLower
I P
(
P Q
)
Q R
==
S U
first
V [
.
[ \
ToLower
\ c
(
c d
)
d e
&&
; =
a
> ?
.
? @
LastName
@ H
.
H I
ToLower
I P
(
P Q
)
Q R
==
S U
last
V Z
.
Z [
ToLower
[ b
(
b c
)
c d
&&
; =
a
> ?
.
? @

MiddleName
@ J
.
J K
ToLower
K R
(
R S
)
S T
==
U W
midle
X ]
.
] ^
ToLower
^ e
(
e f
)
f g
)
g h
;
h i
if
 
(
 
author
 
!=
 
null
 "
)
" #
{
 
return
 
Json
 
(
  
new
  #
OperationResult
$ 3
(
3 4
)
4 5
.
5 6
SetFail
6 =
(
= >
$str
> b
)
b c
)
c d
;
d e
}
 
else
 
{
 
author
 
=
 
new
  
Author
! '
(
' (
)
( )
{
 
	AuthorUid
 !
=
" #
Guid
$ (
.
( )
NewGuid
) 0
(
0 1
)
1 2
,
2 3
	FirstName
 !
=
" #
first
$ )
,
) *

MiddleName
 "
=
# $
midle
% *
,
* +
LastName
  
=
! "
last
# '
}
 
;
 
ctx
 
.
 
Authors
 
.
  
Add
  #
(
# $
author
$ *
)
* +
;
+ ,
ctx
 
.
 
SaveChanges
 #
(
# $
)
$ %
;
% &
var
 
res
 
=
 
new
 !
OperationResult
" 1
(
1 2
)
2 3
.
3 4

SetSuccess
4 >
(
> ?
)
? @
;
@ A
res
 
.
 
Details
 
=
  !
JsonConvert
" -
.
- .
SerializeObject
. =
(
= >
new
> A
{
B C
name
D H
=
I J
author
K Q
.
Q R
FullName
R Z
(
Z [
)
[ \
,
\ ]
value
^ c
=
d e
author
f l
.
l m
	AuthorUid
m v
,
v w
details
x 
= 
$str 
} 
) 
; 
log
 
.
 
Info
 
(
 
$"
 
{
  
User
  $
.
$ %
Identity
% -
.
- .
Name
. 2
}
2 3
$str
3 5
{
5 6
res
6 9
.
9 :
Details
: A
}
A B
"
B C
)
C D
;
D E
return
 
Json
 
(
  
res
  #
)
# $
;
$ %
}
 
}
 
catch
   
(
   
	Exception
   
ex
   
)
    
{
¡¡ 
log
¢¢ 
.
¢¢ 
Error
¢¢ 
(
¢¢ 
ex
¢¢ 
)
¢¢ 
;
¢¢ 
return
££ 
Json
££ 
(
££ 
new
££ 
OperationResult
££  /
(
££/ 0
)
££0 1
.
££1 2
SetFail
££2 9
(
££9 :
ex
££: <
)
££< =
)
££= >
;
££> ?
}
¤¤ 
}
¥¥ 	
public
¨¨ 
async
¨¨ 
Task
¨¨ 
<
¨¨ 

JsonResult
¨¨ $
>
¨¨$ %

EditAuthor
¨¨& 0
(
¨¨0 1
[
¨¨1 2
FromServices
¨¨2 >
]
¨¨> ?
BookDbContext
¨¨@ M
ctx
¨¨N Q
,
¨¨Q R
[
¨¨S T
FromBody
¨¨T \
]
¨¨\ ]
dynamic
¨¨^ e
model
¨¨f k
)
¨¨k l
{
©© 	
try
ªª 
{
«« 
var
¬¬ 
id
¬¬ 
=
¬¬ 
(
¬¬ 
Guid
¬¬ 
)
¬¬ 
model
¬¬ $
.
¬¬$ %
Id
¬¬% '
;
¬¬' (
var
­­ 
first
­­ 
=
­­ 
(
­­ 
string
­­ #
)
­­# $
model
­­$ )
.
­­) *
	FirstName
­­* 3
;
­­3 4
var
®® 
last
®® 
=
®® 
(
®® 
string
®® "
)
®®" #
model
®®# (
.
®®( )
LastName
®®) 1
;
®®1 2
var
¯¯ 
midle
¯¯ 
=
¯¯ 
(
¯¯ 
string
¯¯ #
)
¯¯# $
model
¯¯$ )
.
¯¯) *

MiddleName
¯¯* 4
;
¯¯4 5
var
±± 
author
±± 
=
±± 
ctx
±±  
.
±±  !
Authors
±±! (
.
±±( )
First
±±) .
(
±±. /
q
±±/ 0
=>
±±1 3
q
±±4 5
.
±±5 6
	AuthorUid
±±6 ?
==
±±@ B
id
±±C E
)
±±E F
;
±±F G
if
³³ 
(
³³ 
author
³³ 
.
³³ 
	FirstName
³³ $
==
³³% '
first
³³( -
&&
³³. 0
author
³³1 7
.
³³7 8
LastName
³³8 @
==
³³A C
last
³³D H
&&
³³I K
author
³³L R
.
³³R S

MiddleName
³³S ]
==
³³^ `
midle
³³a f
)
³³f g
{
´´ 
return
µµ 
Json
µµ 
(
µµ  
new
µµ  #
OperationResult
µµ$ 3
(
µµ3 4
)
µµ4 5
.
µµ5 6
SetFail
µµ6 =
(
µµ= >
$str
µµ> e
)
µµe f
)
µµf g
;
µµg h
}
¶¶ 
author
¸¸ 
.
¸¸ 
	FirstName
¸¸  
=
¸¸! "
first
¸¸# (
;
¸¸( )
author
¹¹ 
.
¹¹ 

MiddleName
¹¹ !
=
¹¹" #
midle
¹¹$ )
;
¹¹) *
author
ºº 
.
ºº 
LastName
ºº 
=
ºº  !
last
ºº" &
;
ºº& '
ctx
¼¼ 
.
¼¼ 
SaveChanges
¼¼ 
(
¼¼  
)
¼¼  !
;
¼¼! "
var
½½ 
res
½½ 
=
½½ 
new
½½ 
OperationResult
½½ -
(
½½- .
)
½½. /
.
½½/ 0

SetSuccess
½½0 :
(
½½: ;
)
½½; <
;
½½< =
res
¾¾ 
.
¾¾ 
Details
¾¾ 
=
¾¾ 
JsonConvert
¾¾ )
.
¾¾) *
SerializeObject
¾¾* 9
(
¾¾9 :
new
¾¾: =
{
¾¾> ?
uid
¾¾@ C
=
¾¾D E
author
¾¾F L
.
¾¾L M
	AuthorUid
¾¾M V
.
¾¾V W
ToString
¾¾W _
(
¾¾_ `
)
¾¾` a
,
¾¾a b
details
¾¾c j
=
¾¾k l
$str¾¾m 
}¾¾ 
)¾¾ 
;¾¾ 
log
¿¿ 
.
¿¿ 
Info
¿¿ 
(
¿¿ 
$"
¿¿ 
{
¿¿ 
User
¿¿  
.
¿¿  !
Identity
¿¿! )
.
¿¿) *
Name
¿¿* .
}
¿¿. /
$str
¿¿/ 1
{
¿¿1 2
res
¿¿2 5
.
¿¿5 6
Details
¿¿6 =
}
¿¿= >
"
¿¿> ?
)
¿¿? @
;
¿¿@ A
return
ÀÀ 
Json
ÀÀ 
(
ÀÀ 
res
ÀÀ 
)
ÀÀ  
;
ÀÀ  !
}
ÁÁ 
catch
ÂÂ 
(
ÂÂ 
	Exception
ÂÂ 
ex
ÂÂ 
)
ÂÂ  
{
ÃÃ 
return
ÄÄ 
Json
ÄÄ 
(
ÄÄ 
new
ÄÄ 
OperationResult
ÄÄ  /
(
ÄÄ/ 0
)
ÄÄ0 1
.
ÄÄ1 2
SetFail
ÄÄ2 9
(
ÄÄ9 :
ex
ÄÄ: <
)
ÄÄ< =
)
ÄÄ= >
;
ÄÄ> ?
}
ÅÅ 
}
ÆÆ 	
public
ÉÉ 
async
ÉÉ 
Task
ÉÉ 
<
ÉÉ 

JsonResult
ÉÉ $
>
ÉÉ$ %
AddCathegory
ÉÉ& 2
(
ÉÉ2 3
[
ÉÉ3 4
FromServices
ÉÉ4 @
]
ÉÉ@ A
BookDbContext
ÉÉB O
ctx
ÉÉP S
,
ÉÉS T
[
ÉÉU V
FromBody
ÉÉV ^
]
ÉÉ^ _
string
ÉÉa g
str
ÉÉh k
)
ÉÉk l
{
ÊÊ 	
var
ËË 
result
ËË 
=
ËË 
new
ËË 
OperationResult
ËË ,
(
ËË, -
)
ËË- .
;
ËË. /
str
ÌÌ 
=
ÌÌ 
str
ÌÌ 
.
ÌÌ 
Trim
ÌÌ 
(
ÌÌ 
)
ÌÌ 
.
ÌÌ 
ToLower
ÌÌ $
(
ÌÌ$ %
)
ÌÌ% &
;
ÌÌ& '
if
ÍÍ 
(
ÍÍ 
ctx
ÍÍ 
.
ÍÍ 

Categories
ÍÍ 
.
ÍÍ 
Any
ÍÍ "
(
ÍÍ" #
q
ÍÍ# $
=>
ÍÍ% '
q
ÍÍ( )
.
ÍÍ) *
CategoryName
ÍÍ* 6
==
ÍÍ7 9
str
ÍÍ: =
)
ÍÍ= >
)
ÍÍ> ?
{
ÎÎ 
return
ÏÏ 
Json
ÏÏ 
(
ÏÏ 
result
ÏÏ "
.
ÏÏ" #
SetFail
ÏÏ# *
(
ÏÏ* +
$str
ÏÏ+ L
)
ÏÏL M
)
ÏÏM N
;
ÏÏN O
}
ÐÐ 
else
ÑÑ 
{
ÒÒ 
try
ÓÓ 
{
ÔÔ 
var
ÕÕ 
category
ÕÕ  
=
ÕÕ! "
new
ÕÕ# &
Category
ÕÕ' /
(
ÕÕ/ 0
)
ÕÕ0 1
{
ÕÕ2 3
CategoryName
ÕÕ4 @
=
ÕÕA B
str
ÕÕC F
}
ÕÕG H
;
ÕÕH I
ctx
ÖÖ 
.
ÖÖ 

Categories
ÖÖ "
.
ÖÖ" #
Add
ÖÖ# &
(
ÖÖ& '
category
ÖÖ' /
)
ÖÖ/ 0
;
ÖÖ0 1
ctx
×× 
.
×× 
SaveChanges
×× #
(
××# $
)
××$ %
;
××% &
var
ØØ 
res
ØØ 
=
ØØ 
new
ØØ !
OperationResult
ØØ" 1
(
ØØ1 2
)
ØØ2 3
.
ØØ3 4

SetSuccess
ØØ4 >
(
ØØ> ?
)
ØØ? @
;
ØØ@ A
res
ÙÙ 
.
ÙÙ 
Details
ÙÙ 
=
ÙÙ  !
JsonConvert
ÙÙ" -
.
ÙÙ- .
SerializeObject
ÙÙ. =
(
ÙÙ= >
new
ÙÙ> A
{
ÙÙB C
name
ÙÙD H
=
ÙÙI J
category
ÙÙK S
.
ÙÙS T
CategoryName
ÙÙT `
,
ÙÙ` a
value
ÙÙb g
=
ÙÙh i
category
ÙÙj r
.
ÙÙr s

CategoryId
ÙÙs }
,
ÙÙ} ~
detailsÙÙ 
=ÙÙ 
$strÙÙ 
}ÙÙ  
)ÙÙ  ¡
;ÙÙ¡ ¢
log
ÚÚ 
.
ÚÚ 
Info
ÚÚ 
(
ÚÚ 
$"
ÚÚ 
{
ÚÚ  
User
ÚÚ  $
.
ÚÚ$ %
Identity
ÚÚ% -
.
ÚÚ- .
Name
ÚÚ. 2
}
ÚÚ2 3
$str
ÚÚ3 5
{
ÚÚ5 6
res
ÚÚ6 9
.
ÚÚ9 :
Details
ÚÚ: A
}
ÚÚA B
"
ÚÚB C
)
ÚÚC D
;
ÚÚD E
return
ÛÛ 
Json
ÛÛ 
(
ÛÛ  
res
ÛÛ  #
)
ÛÛ# $
;
ÛÛ$ %
}
ÜÜ 
catch
ÝÝ 
(
ÝÝ 
	Exception
ÝÝ  
ex
ÝÝ! #
)
ÝÝ# $
{
ÞÞ 
log
ßß 
.
ßß 
Error
ßß 
(
ßß 
ex
ßß  
)
ßß  !
;
ßß! "
return
àà 
Json
àà 
(
àà  
new
àà  #
OperationResult
àà$ 3
(
àà3 4
)
àà4 5
.
àà5 6
SetFail
àà6 =
(
àà= >
ex
àà> @
)
àà@ A
)
ààA B
;
ààB C
}
áá 
}
ââ 
}
ãã 	
public
åå 
async
åå 
Task
åå 
<
åå 

JsonResult
åå $
>
åå$ %
EditCategory
åå& 2
(
åå2 3
[
åå3 4
FromServices
åå4 @
]
åå@ A
BookDbContext
ååB O
ctx
ååP S
,
ååS T
[
ååU V
FromBody
ååV ^
]
åå^ _
dynamic
åå` g
model
ååh m
)
ååm n
{
ææ 	
try
çç 
{
èè 
var
éé 
id
éé 
=
éé 
(
éé 
int
éé 
)
éé 
model
éé #
.
éé# $
Id
éé$ &
;
éé& '
var
êê 
categoryName
êê  
=
êê! "
(
êê# $
string
êê$ *
)
êê* +
model
êê+ 0
.
êê0 1
CategoryName
êê1 =
;
êê= >
var
ìì 
category
ìì 
=
ìì 
ctx
ìì "
.
ìì" #

Categories
ìì# -
.
ìì- .
First
ìì. 3
(
ìì3 4
q
ìì4 5
=>
ìì6 8
q
ìì9 :
.
ìì: ;

CategoryId
ìì; E
==
ììF H
id
ììI K
)
ììK L
;
ììL M
if
îî 
(
îî 
category
îî 
.
îî 
CategoryName
îî )
==
îî* ,
categoryName
îî- 9
)
îî9 :
{
ïï 
return
ðð 
Json
ðð 
(
ðð  
new
ðð  #
OperationResult
ðð$ 3
(
ðð3 4
)
ðð4 5
.
ðð5 6
SetFail
ðð6 =
(
ðð= >
$str
ðð> e
)
ððe f
)
ððf g
;
ððg h
}
ññ 
category
óó 
.
óó 
CategoryName
óó %
=
óó& '
categoryName
óó( 4
;
óó4 5
ctx
õõ 
.
õõ 
SaveChanges
õõ 
(
õõ  
)
õõ  !
;
õõ! "
var
öö 
res
öö 
=
öö 
new
öö 
OperationResult
öö -
(
öö- .
)
öö. /
.
öö/ 0

SetSuccess
öö0 :
(
öö: ;
)
öö; <
;
öö< =
res
÷÷ 
.
÷÷ 
Details
÷÷ 
=
÷÷ 
JsonConvert
÷÷ )
.
÷÷) *
SerializeObject
÷÷* 9
(
÷÷9 :
new
÷÷: =
{
÷÷> ?
id
÷÷@ B
=
÷÷C D
category
÷÷E M
.
÷÷M N

CategoryId
÷÷N X
.
÷÷X Y
ToString
÷÷Y a
(
÷÷a b
)
÷÷b c
,
÷÷c d
details
÷÷e l
=
÷÷m n
$str÷÷o 
}÷÷ 
)÷÷ 
;÷÷ 
log
øø 
.
øø 
Info
øø 
(
øø 
$"
øø 
{
øø 
User
øø  
.
øø  !
Identity
øø! )
.
øø) *
Name
øø* .
}
øø. /
$str
øø/ 1
{
øø1 2
res
øø2 5
.
øø5 6
Details
øø6 =
}
øø= >
"
øø> ?
)
øø? @
;
øø@ A
return
ùù 
Json
ùù 
(
ùù 
res
ùù 
)
ùù  
;
ùù  !
}
úú 
catch
ûû 
(
ûû 
	Exception
ûû 
ex
ûû 
)
ûû  
{
üü 
return
ýý 
Json
ýý 
(
ýý 
new
ýý 
OperationResult
ýý  /
(
ýý/ 0
)
ýý0 1
.
ýý1 2
SetFail
ýý2 9
(
ýý9 :
ex
ýý: <
)
ýý< =
)
ýý= >
;
ýý> ?
}
þþ 
}
ÿÿ 	
public
 
async
 
Task
 
<
 

JsonResult
 $
>
$ %
AddBook
& -
(
- .
[
. /
FromServices
/ ;
]
; <
BookDbContext
= J
ctx
K N
,
N O
[
P Q
FromBody
Q Y
]
Y Z
AddBookForm
[ f
book
g k
)
k l
{
 	
try
 
{
 
var
 
user
 
=
 
ctx
 
.
 
AppUsers
 '
.
' (
First
( -
(
- .
q
. /
=>
0 2
q
3 4
.
4 5
	LoginName
5 >
==
? A
User
B F
.
F G
Identity
G O
.
O P
Name
P T
.
T U
Replace
U \
(
\ ]
$str
] g
,
g h
$str
i k
)
k l
)
l m
;
m n
if
 
(
 
book
 
==
 
null
  
)
  !
throw
 
new
 #
ArgumentNullException
 3
(
3 4
$str
4 M
)
M N
;
N O
var
 
Title
 
=
 
book
  
.
  !
Title
! &
;
& '
var
 
Subtitle
 
=
 
book
 #
.
# $
Subtitle
$ ,
;
, -
var
 

Annotation
 
=
  
book
! %
.
% &

Annotation
& 0
;
0 1
var
 
Language
 
=
 
book
 #
.
# $
Language
$ ,
;
, -
var
 
Edition
 
=
 
book
 "
.
" #
Edition
# *
;
* +
var
 
Year
 
=
 
book
 
.
  
Year
  $
;
$ %
var
 
Isbn
 
=
 
book
 
.
  
Isbn
  $
;
$ %
var
 
Pages
 
=
 
book
  
.
  !
Pages
! &
;
& '
var
 
Authors
 
=
 
book
 "
.
" #
Authors
# *
;
* +
var
 
Cathegories
 
=
  !
book
" &
.
& '

Categories
' 1
;
1 2
var
 

PapperBook
 
=
  
book
! %
.
% &
	PaperBook
& /
;
/ 0
var
 
Link
 
=
 
book
 
.
  
Link
  $
;
$ %
var
 

CoverImage
 
=
  
(
! "
string
" (
.
( )
IsNullOrEmpty
) 6
(
6 7
book
7 ;
.
; <

CoverImage
< F
)
F G
)
G H
?
I J
null
K O
:
P Q
$@"
R U
$str
U d
{
d e
book
e i
.
i j

CoverImage
j t
}
t u
"
u v
;
v w
var
 
result
 
=
 
new
  
OperationResult
! 0
(
0 1
)
1 2
;
2 3
Book
 
newBook
 
;
 
if
 
(
 

PapperBook
 
==
 !
true
" &
)
& '
{
 
if
 
(
 
Isbn
 
.
 
Length
 #
>
$ %
$num
& (
)
( )
throw
 
new
 !
	Exception
" +
(
+ ,
$str
, S
)
S T
;
T U
var
 
uniqIsbn
  
=
! "
ctx
# &
.
& '
Books
' ,
.
, -
FirstOrDefault
- ;
(
; <
b
< =
=>
> @
b
A B
.
B C
Isbn
C G
==
H J
Isbn
K O
)
O P
;
P Q
if
 
(
 
uniqIsbn
  
!=
! #
null
$ (
)
( )
{
   
throw
¡¡ 
new
¡¡ !
	Exception
¡¡" +
(
¡¡+ ,
$str
¡¡, X
)
¡¡X Y
;
¡¡Y Z
}
¢¢ 
newBook
££ 
=
££ 
new
££ !
	PaperBook
££" +
(
££+ ,
)
££, -
{
¤¤ 
Title
¥¥ 
=
¥¥ 
Title
¥¥  %
,
¥¥% &
Subtitle
¦¦  
=
¦¦! "
Subtitle
¦¦# +
,
¦¦+ ,

Annotation
§§ "
=
§§# $

Annotation
§§% /
,
§§/ 0
Pages
¨¨ 
=
¨¨ 
Pages
¨¨  %
,
¨¨% &
Year
©© 
=
©© 
Year
©© #
,
©©# $
Isbn
ªª 
=
ªª 
Isbn
ªª #
,
ªª# $
Language
««  
=
««! "
Language
««# +
,
««+ ,
Edition
¬¬ 
=
¬¬  !
Edition
¬¬" )
,
¬¬) *

CoverImage
­­ "
=
­­# $

CoverImage
­­% /
}
®® 
;
®® 
ctx
°° 
.
°° 

PaperBooks
°° "
.
°°" #
Add
°°# &
(
°°& '
(
°°' (
	PaperBook
°°( 1
)
°°1 2
newBook
°°2 9
)
°°9 :
;
°°: ;
ctx
±± 
.
±± 
SaveChanges
±± #
(
±±# $
)
±±$ %
;
±±% &
}
²² 
else
³³ 
{
´´ 
if
µµ 
(
µµ 
string
µµ 
.
µµ 
IsNullOrEmpty
µµ ,
(
µµ, -
Link
µµ- 1
)
µµ1 2
)
µµ2 3
{
¶¶ 
return
·· 
Json
·· #
(
··# $
new
··$ '
OperationResult
··( 7
(
··7 8
)
··8 9
.
··9 :
SetFail
··: A
(
··A B
$str
··B k
)
··k l
)
··l m
;
··m n
}
¸¸ 
newBook
ºº 
=
ºº 
new
ºº !
Ebook
ºº" '
(
ºº' (
)
ºº( )
{
»» 
Title
¼¼ 
=
¼¼ 
Title
¼¼  %
,
¼¼% &
Subtitle
½½  
=
½½! "
Subtitle
½½# +
,
½½+ ,

Annotation
¾¾ "
=
¾¾# $

Annotation
¾¾% /
,
¾¾/ 0
Pages
¿¿ 
=
¿¿ 
Pages
¿¿  %
,
¿¿% &
Year
ÀÀ 
=
ÀÀ 
Year
ÀÀ #
,
ÀÀ# $
Isbn
ÁÁ 
=
ÁÁ 
Isbn
ÁÁ #
,
ÁÁ# $
Language
ÂÂ  
=
ÂÂ! "
Language
ÂÂ# +
,
ÂÂ+ ,
Edition
ÃÃ 
=
ÃÃ  !
Edition
ÃÃ" )
,
ÃÃ) *
Link
ÄÄ 
=
ÄÄ 
Link
ÄÄ #
.
ÄÄ# $
GenerateLink
ÄÄ$ 0
(
ÄÄ0 1
)
ÄÄ1 2
,
ÄÄ2 3

CoverImage
ÅÅ "
=
ÅÅ# $

CoverImage
ÅÅ% /
}
ÆÆ 
;
ÆÆ 
ctx
ÈÈ 
.
ÈÈ 
Ebooks
ÈÈ 
.
ÈÈ 
Add
ÈÈ "
(
ÈÈ" #
(
ÈÈ# $
Ebook
ÈÈ$ )
)
ÈÈ) *
newBook
ÈÈ* 1
)
ÈÈ1 2
;
ÈÈ2 3
ctx
ÉÉ 
.
ÉÉ 
SaveChanges
ÉÉ #
(
ÉÉ# $
)
ÉÉ$ %
;
ÉÉ% &
}
ÊÊ 
var
ÌÌ 
	newAutors
ÌÌ 
=
ÌÌ 
ctx
ÌÌ  #
.
ÌÌ# $
Authors
ÌÌ$ +
.
ÌÌ+ ,
Where
ÌÌ, 1
(
ÌÌ1 2
q
ÌÌ2 3
=>
ÌÌ4 6
Authors
ÌÌ7 >
.
ÌÌ> ?
Contains
ÌÌ? G
(
ÌÌG H
q
ÌÌH I
.
ÌÌI J
	AuthorUid
ÌÌJ S
)
ÌÌS T
)
ÌÌT U
;
ÌÌU V
if
ÍÍ 
(
ÍÍ 
	newAutors
ÍÍ 
.
ÍÍ 
Any
ÍÍ !
(
ÍÍ! "
)
ÍÍ" #
)
ÍÍ# $
{
ÎÎ 
var
ÏÏ 
list
ÏÏ 
=
ÏÏ 
	newAutors
ÏÏ (
.
ÐÐ 
Select
ÐÐ 
(
ÐÐ  
q
ÐÐ  !
=>
ÐÐ" $
new
ÐÐ% (

BookAuthor
ÐÐ) 3
(
ÐÐ3 4
)
ÐÐ4 5
{
ÐÐ6 7
BookId
ÐÐ8 >
=
ÐÐ? @
newBook
ÐÐA H
.
ÐÐH I
BiaId
ÐÐI N
,
ÐÐN O
	AuthorUid
ÐÐP Y
=
ÐÐZ [
q
ÐÐ\ ]
.
ÐÐ] ^
	AuthorUid
ÐÐ^ g
}
ÐÐh i
)
ÐÐi j
.
ÑÑ 
AsEnumerable
ÑÑ %
(
ÑÑ% &
)
ÑÑ& '
;
ÑÑ' (
ctx
ÒÒ 
.
ÒÒ 
BookAuthors
ÒÒ #
.
ÒÒ# $
AddRange
ÒÒ$ ,
(
ÒÒ, -
list
ÒÒ- 1
)
ÒÒ1 2
;
ÒÒ2 3
}
ÓÓ 
var
ÕÕ 
newCathegories
ÕÕ "
=
ÕÕ# $
ctx
ÕÕ% (
.
ÕÕ( )

Categories
ÕÕ) 3
.
ÕÕ3 4
Where
ÕÕ4 9
(
ÕÕ9 :
q
ÕÕ: ;
=>
ÕÕ< >
Cathegories
ÕÕ? J
.
ÕÕJ K
Contains
ÕÕK S
(
ÕÕS T
q
ÕÕT U
.
ÕÕU V

CategoryId
ÕÕV `
)
ÕÕ` a
)
ÕÕa b
;
ÕÕb c
if
ÖÖ 
(
ÖÖ 
newCathegories
ÖÖ "
.
ÖÖ" #
Any
ÖÖ# &
(
ÖÖ& '
)
ÖÖ' (
)
ÖÖ( )
{
×× 
var
ØØ 
list
ØØ 
=
ØØ 
newCathegories
ØØ -
.
ØØ- .
Select
ØØ. 4
(
ØØ4 5
q
ØØ5 6
=>
ØØ7 9
new
ØØ: =
BookCategory
ØØ> J
(
ØØJ K
)
ØØK L
{
ØØM N

CategoryId
ØØO Y
=
ØØZ [
q
ØØ\ ]
.
ØØ] ^

CategoryId
ØØ^ h
,
ØØh i
BookId
ØØj p
=
ØØq r
newBook
ØØs z
.
ØØz {
BiaIdØØ{ 
}ØØ 
)ØØ 
.ØØ 
AsEnumerableØØ 
(ØØ 
)ØØ 
;ØØ 
ctx
ÙÙ 
.
ÙÙ 
BookCategories
ÙÙ &
.
ÙÙ& '
AddRange
ÙÙ' /
(
ÙÙ/ 0
list
ÙÙ0 4
)
ÙÙ4 5
;
ÙÙ5 6
}
ÚÚ 
ctx
ÜÜ 
.
ÜÜ 
UploadHistories
ÜÜ #
.
ÜÜ# $
Add
ÜÜ$ '
(
ÜÜ' (
new
ÜÜ( +
UploadHistory
ÜÜ, 9
(
ÜÜ9 :
)
ÜÜ: ;
{
ÜÜ< =
BookId
ÜÜ> D
=
ÜÜE F
newBook
ÜÜG N
.
ÜÜN O
BiaId
ÜÜO T
,
ÜÜT U

AppUserUid
ÜÜV `
=
ÜÜa b
user
ÜÜc g
.
ÜÜg h
Uid
ÜÜh k
,
ÜÜk l

UploadDate
ÜÜm w
=
ÜÜx y
DateTimeÜÜz 
.ÜÜ 
NowÜÜ 
}ÜÜ 
)ÜÜ 
;ÜÜ 
ctx
ÞÞ 
.
ÞÞ 
SaveChanges
ÞÞ 
(
ÞÞ  
)
ÞÞ  !
;
ÞÞ! "
log
ßß 
.
ßß 
Info
ßß 
(
ßß 
$"
ßß 
{
ßß 
User
ßß  
.
ßß  !
Identity
ßß! )
.
ßß) *
Name
ßß* .
}
ßß. /
$str
ßß/ >
{
ßß> ?
book
ßß? C
.
ßßC D
Id
ßßD F
}
ßßF G
"
ßßG H
)
ßßH I
;
ßßI J
return
àà 
Json
àà 
(
àà 
new
àà 
OperationResult
àà  /
(
àà/ 0
)
àà0 1
.
àà1 2

SetSuccess
àà2 <
(
àà< =
)
àà= >
)
àà> ?
;
àà? @
}
áá 
catch
ââ 
(
ââ 
	Exception
ââ 
ex
ââ 
)
ââ  
{
ãã 
log
ää 
.
ää 
Error
ää 
(
ää 
ex
ää 
)
ää 
;
ää 
return
åå 
Json
åå 
(
åå 
new
åå 
OperationResult
åå  /
(
åå/ 0
)
åå0 1
.
åå1 2
SetFail
åå2 9
(
åå9 :
ex
åå: <
)
åå< =
)
åå= >
;
åå> ?
}
ææ 
}
çç 	
[
éé 	
HttpPost
éé	 
]
éé 
public
êê 
async
êê 
Task
êê 
<
êê 

JsonResult
êê $
>
êê$ %
AddCover
êê& .
(
êê. /
[
êê/ 0
FromServices
êê0 <
]
êê< =
BookDbContext
êê> K
ctx
êêL O
)
êêO P
{
ëë 	
var
îî 
result
îî 
=
îî 
new
îî 
OperationResult
îî ,
(
îî, -
)
îî- .
;
îî. /
try
ïï 
{
ðð 
var
ññ 
file
ññ 
=
ññ 
Request
ññ "
.
ññ" #
Form
ññ# '
.
ññ' (
Files
ññ( -
.
ññ- .
FirstOrDefault
ññ. <
(
ññ< =
)
ññ= >
;
ññ> ?
if
òò 
(
òò 
file
òò 
==
òò 
null
òò  
)
òò  !
{
óó 
return
ôô 
Json
ôô 
(
ôô  
result
ôô  &
.
ôô& '
SetFail
ôô' .
(
ôô. /
$str
ôô/ A
)
ôôA B
)
ôôB C
;
ôôC D
}
õõ 
var
÷÷ 
fileExtention
÷÷ !
=
÷÷" #
System
÷÷$ *
.
÷÷* +
IO
÷÷+ -
.
÷÷- .
Path
÷÷. 2
.
÷÷2 3
GetExtension
÷÷3 ?
(
÷÷? @+
ContentDispositionHeaderValue
÷÷@ ]
.
øø 
Parse
øø 
(
øø 
file
øø 
.
øø   
ContentDisposition
øø  2
)
øø2 3
.
ùù 
FileName
ùù 
.
úú 
Trim
úú 
(
úú 
$char
úú 
)
úú 
)
úú 
;
úú  
if
ûû 
(
ûû 
fileExtention
ûû !
==
ûû" $
$str
ûû% '
)
ûû' (
{
üü 
return
ýý 
Json
ýý 
(
ýý  
result
ýý  &
.
ýý& '
SetFail
ýý' .
(
ýý. /
$str
ýý/ =
)
ýý= >
)
ýý> ?
;
ýý? @
}
þþ 
;
þþ 
var
 
	coverName
 
=
 
file
  $
.
$ %
FileName
% -
;
- .
if
 
(
 
_browser
 
.
 
Type
 !
==
" $
BrowserType
% 0
.
0 1
Edge
1 5
||
6 8
_browser
9 A
.
A B
Type
B F
==
G I
BrowserType
J U
.
U V
IE
V X
)
X Y
{
 
	coverName
 
=
 
file
  $
.
$ %
FileName
% -
.
- .
Split
. 3
(
3 4
$char
4 8
)
8 9
.
9 :
Last
: >
(
> ?
)
? @
;
@ A
}
 
var
 
uriPath
 
=
 
$@"
 !
$str
! 0
{
0 1
file
1 5
.
5 6
FileName
6 >
}
> ?
"
? @
;
@ A
var
 
fullPath
 
=
 
$@"
 "
{
" #!
_hostingEnvironment
# 6
.
6 7
WebRootPath
7 B
}
B C
$str
C R
{
R S
file
S W
.
W X
FileName
X `
}
` a
"
a b
;
b c
if
 
(
 
System
 
.
 
IO
 
.
 
File
 "
.
" #
Exists
# )
(
) *
fullPath
* 2
)
2 3
)
3 4
{
 
return
 
Json
 
(
  
result
  &
.
& '
SetFail
' .
(
. /
$str/ 
) 
) 
; 
}
 
new
 
System
 
.
 
IO
 
.
 
FileInfo
 &
(
& '
fullPath
' /
)
/ 0
.
0 1
	Directory
1 :
.
: ;
Create
; A
(
A B
)
B C
;
C D
using
 
(
 
var
 
fs
 
=
 
System
  &
.
& '
IO
' )
.
) *
File
* .
.
. /
Exists
/ 5
(
5 6
fullPath
6 >
)
> ?
?
@ A
System
B H
.
H I
IO
I K
.
K L
File
L P
.
P Q
	OpenWrite
Q Z
(
Z [
fullPath
[ c
)
c d
:
e f
System
g m
.
m n
IO
n p
.
p q
File
q u
.
u v
Create
v |
(
| }
fullPath} 
) 
) 
{
 
file
 
.
 
CopyTo
 
(
  
fs
  "
)
" #
;
# $
fs
 
.
 
Flush
 
(
 
)
 
;
 
}
 
return
 
Json
 
(
 
result
 "
.
" #

SetSuccess
# -
(
- .
$str
. I
)
I J
)
J K
;
K L
}
 
catch
 
(
 
	Exception
 
e
 
)
 
{
 
log
 
.
 
Error
 
(
 
e
 
)
 
;
 
return
 
Json
 
(
 
result
 "
.
" #
SetFail
# *
(
* +
e
+ ,
)
, -
)
- .
;
. /
}
 
}
 	
[
 	
HttpPost
	 
]
 
public
   
async
   
Task
   
<
   

JsonResult
   $
>
  $ %
SetFile
  & -
(
  - .
[
  . /
FromServices
  / ;
]
  ; <
BookDbContext
  = J
ctx
  K N
)
  N O
{
¡¡ 	
try
¢¢ 
{
££ 
var
¤¤ 
result
¤¤ 
=
¤¤ 
new
¤¤  
OperationResult
¤¤! 0
(
¤¤0 1
)
¤¤1 2
;
¤¤2 3
var
¥¥ 
file
¥¥ 
=
¥¥ 
Request
¥¥ "
.
¥¥" #
Form
¥¥# '
.
¥¥' (
Files
¥¥( -
.
¥¥- .
FirstOrDefault
¥¥. <
(
¥¥< =
)
¥¥= >
;
¥¥> ?
if
¦¦ 
(
¦¦ 
file
¦¦ 
==
¦¦ 
null
¦¦  
)
¦¦  !
{
§§ 
return
¨¨ 
Json
¨¨ 
(
¨¨  
result
¨¨  &
.
¨¨& '
SetFail
¨¨' .
(
¨¨. /
$str
¨¨/ ?
)
¨¨? @
)
¨¨@ A
;
¨¨A B
}
©© 
var
ªª 
fileExtention
ªª !
=
ªª" #
System
ªª$ *
.
ªª* +
IO
ªª+ -
.
ªª- .
Path
ªª. 2
.
ªª2 3
GetExtension
ªª3 ?
(
ªª? @+
ContentDispositionHeaderValue
ªª@ ]
.
«« 
Parse
«« 
(
«« 
file
«« 
.
««   
ContentDisposition
««  2
)
««2 3
.
¬¬ 
FileName
¬¬ 
.
­­ 
Trim
­­ 
(
­­ 
$char
­­ 
)
­­ 
)
­­ 
;
­­  
if
®® 
(
®® 
fileExtention
®® !
==
®®" $
$str
®®% '
)
®®' (
{
¯¯ 
return
°° 
Json
°° 
(
°°  
result
°°  &
.
°°& '
SetFail
°°' .
(
°°. /
$str
°°/ 9
)
°°9 :
)
°°: ;
;
°°; <
}
±± 
;
±± 
var
²² 
FileName
²² 
=
²² 
file
²² #
.
²²# $
FileName
²²$ ,
;
²², -
if
³³ 
(
³³ 
_browser
³³ 
.
³³ 
Type
³³ !
==
³³" $
BrowserType
³³% 0
.
³³0 1
Edge
³³1 5
||
³³6 8
_browser
³³9 A
.
³³A B
Type
³³B F
==
³³G I
BrowserType
³³J U
.
³³U V
IE
³³V X
)
³³X Y
{
´´ 
FileName
µµ 
=
µµ 
file
µµ #
.
µµ# $
FileName
µµ$ ,
.
µµ, -
Split
µµ- 2
(
µµ2 3
$char
µµ3 7
)
µµ7 8
.
µµ8 9
Last
µµ9 =
(
µµ= >
)
µµ> ?
;
µµ? @
}
¶¶ 
var
¸¸ 
fullPath
¸¸ 
=
¸¸ 
$@"
¸¸ "
{
¸¸" #!
_hostingEnvironment
¸¸# 6
.
¸¸6 7
WebRootPath
¸¸7 B
}
¸¸B C
$str
¸¸C K
{
¸¸K L
file
¸¸L P
.
¸¸P Q
FileName
¸¸Q Y
}
¸¸Y Z
"
¸¸Z [
;
¸¸[ \
if
¹¹ 
(
¹¹ 
System
¹¹ 
.
¹¹ 
IO
¹¹ 
.
¹¹ 
File
¹¹ "
.
¹¹" #
Exists
¹¹# )
(
¹¹) *
fullPath
¹¹* 2
)
¹¹2 3
)
¹¹3 4
{
ºº 
return
»» 
Json
»» 
(
»»  
result
»»  &
.
»»& '
SetFail
»»' .
(
»». /
$str
»»/ 
)»» 
)»» 
;»» 
}
¼¼ 
new
½½ 
System
½½ 
.
½½ 
IO
½½ 
.
½½ 
FileInfo
½½ &
(
½½& '
fullPath
½½' /
)
½½/ 0
.
½½0 1
	Directory
½½1 :
.
½½: ;
Create
½½; A
(
½½A B
)
½½B C
;
½½C D
using
¾¾ 
(
¾¾ 
var
¾¾ 
fs
¾¾ 
=
¾¾ 
System
¾¾  &
.
¾¾& '
IO
¾¾' )
.
¾¾) *
File
¾¾* .
.
¾¾. /
Exists
¾¾/ 5
(
¾¾5 6
fullPath
¾¾6 >
)
¾¾> ?
?
¾¾@ A
System
¾¾B H
.
¾¾H I
IO
¾¾I K
.
¾¾K L
File
¾¾L P
.
¾¾P Q
	OpenWrite
¾¾Q Z
(
¾¾Z [
fullPath
¾¾[ c
)
¾¾c d
:
¾¾e f
System
¾¾g m
.
¾¾m n
IO
¾¾n p
.
¾¾p q
File
¾¾q u
.
¾¾u v
Create
¾¾v |
(
¾¾| }
fullPath¾¾} 
)¾¾ 
)¾¾ 
{
¿¿ 
file
ÀÀ 
.
ÀÀ 
CopyTo
ÀÀ 
(
ÀÀ  
fs
ÀÀ  "
)
ÀÀ" #
;
ÀÀ# $
fs
ÁÁ 
.
ÁÁ 
Flush
ÁÁ 
(
ÁÁ 
)
ÁÁ 
;
ÁÁ 
}
ÂÂ 
return
ÃÃ 
Json
ÃÃ 
(
ÃÃ 
result
ÃÃ "
.
ÃÃ" #

SetSuccess
ÃÃ# -
(
ÃÃ- .
$str
ÃÃ. D
)
ÃÃD E
)
ÃÃE F
;
ÃÃF G
}
ÄÄ 
catch
ÅÅ 
(
ÅÅ 
	Exception
ÅÅ 
e
ÅÅ 
)
ÅÅ 
{
ÆÆ 
NLog
ÇÇ 
.
ÇÇ 

LogManager
ÇÇ 
.
ÇÇ  #
GetCurrentClassLogger
ÇÇ  5
(
ÇÇ5 6
)
ÇÇ6 7
.
ÇÇ7 8
Error
ÇÇ8 =
(
ÇÇ= >
e
ÇÇ> ?
)
ÇÇ? @
;
ÇÇ@ A
return
ÈÈ 
Json
ÈÈ 
(
ÈÈ 
$str
ÈÈ -
)
ÈÈ- .
;
ÈÈ. /
}
ÉÉ 
}
ÊÊ 	
public
ÌÌ 
async
ÌÌ 
Task
ÌÌ 
<
ÌÌ 

JsonResult
ÌÌ $
>
ÌÌ$ %
EditBook
ÌÌ& .
(
ÌÌ. /
[
ÌÌ/ 0
FromServices
ÌÌ0 <
]
ÌÌ< =
BookDbContext
ÌÌ> K
ctx
ÌÌL O
,
ÌÌO P
[
ÌÌQ R
FromBody
ÌÌR Z
]
ÌÌZ [
AddBookForm
ÌÌ\ g
model
ÌÌh m
)
ÌÌm n
{
ÍÍ 	
var
ÎÎ 
result
ÎÎ 
=
ÎÎ 
new
ÎÎ 
OperationResult
ÎÎ ,
(
ÎÎ, -
)
ÎÎ- .
;
ÎÎ. /
try
ÐÐ 
{
ÑÑ 
if
ÒÒ 
(
ÒÒ 
model
ÒÒ 
.
ÒÒ 
Authors
ÒÒ !
!=
ÒÒ" $
null
ÒÒ% )
)
ÒÒ) *
{
ÓÓ 
var
ÔÔ 
authors
ÔÔ 
=
ÔÔ  !
ctx
ÔÔ" %
.
ÔÔ% &
Authors
ÔÔ& -
.
ÔÔ- .
Where
ÔÔ. 3
(
ÔÔ3 4
q
ÔÔ4 5
=>
ÔÔ6 8
model
ÔÔ9 >
.
ÔÔ> ?
Authors
ÔÔ? F
.
ÔÔF G
Contains
ÔÔG O
(
ÔÔO P
q
ÔÔP Q
.
ÔÔQ R
	AuthorUid
ÔÔR [
)
ÔÔ[ \
)
ÔÔ\ ]
;
ÔÔ] ^
if
ÕÕ 
(
ÕÕ 
authors
ÕÕ 
.
ÕÕ  
Count
ÕÕ  %
(
ÕÕ% &
)
ÕÕ& '
!=
ÕÕ( *
model
ÕÕ+ 0
.
ÕÕ0 1
Authors
ÕÕ1 8
.
ÕÕ8 9
Count
ÕÕ9 >
(
ÕÕ> ?
)
ÕÕ? @
)
ÕÕ@ A
{
ÖÖ 
return
×× 
Json
×× #
(
××# $
result
××$ *
.
××* +
SetFail
××+ 2
(
××2 3
$str
××3 j
)
××j k
)
××k l
;
××l m
}
ØØ 
}
ÙÙ 
if
ÛÛ 
(
ÛÛ 
model
ÛÛ 
.
ÛÛ 

Categories
ÛÛ $
!=
ÛÛ% '
null
ÛÛ( ,
)
ÛÛ, -
{
ÜÜ 
var
ÝÝ 

categories
ÝÝ "
=
ÝÝ# $
ctx
ÝÝ% (
.
ÝÝ( )

Categories
ÝÝ) 3
.
ÝÝ3 4
Where
ÝÝ4 9
(
ÝÝ9 :
q
ÝÝ: ;
=>
ÝÝ< >
model
ÝÝ? D
.
ÝÝD E

Categories
ÝÝE O
.
ÝÝO P
Contains
ÝÝP X
(
ÝÝX Y
q
ÝÝY Z
.
ÝÝZ [

CategoryId
ÝÝ[ e
)
ÝÝe f
)
ÝÝf g
;
ÝÝg h
if
ÞÞ 
(
ÞÞ 

categories
ÞÞ "
.
ÞÞ" #
Count
ÞÞ# (
(
ÞÞ( )
)
ÞÞ) *
!=
ÞÞ+ -
model
ÞÞ. 3
.
ÞÞ3 4

Categories
ÞÞ4 >
.
ÞÞ> ?
Count
ÞÞ? D
(
ÞÞD E
)
ÞÞE F
)
ÞÞF G
{
ßß 
return
àà 
Json
àà #
(
àà# $
result
àà$ *
.
àà* +
SetFail
àà+ 2
(
àà2 3
$str
àà3 l
)
ààl m
)
ààm n
;
ààn o
}
áá 
}
ââ 
var
ää 
book
ää 
=
ää 
ctx
ää 
.
ää 
Books
ää $
.
ää$ %
FirstOrDefault
ää% 3
(
ää3 4
q
ää4 5
=>
ää6 8
q
ää9 :
.
ää: ;
BiaId
ää; @
==
ääA C
model
ääD I
.
ääI J
Id
ääJ L
)
ääL M
;
ääM N
if
åå 
(
åå 
book
åå 
==
åå 
null
åå  
)
åå  !
{
ææ 
return
çç 
Json
çç 
(
çç  
result
çç  &
.
çç& '
SetFail
çç' .
(
çç. /
$str
çç/ U
)
ççU V
)
ççV W
;
ççW X
}
èè 
if
êê 
(
êê 
model
êê 
.
êê 
Title
êê 
!=
êê  "
null
êê# '
)
êê' (
if
ëë 
(
ëë 
model
ëë 
.
ëë 
Title
ëë #
!=
ëë$ &
book
ëë' +
.
ëë+ ,
Title
ëë, 1
)
ëë1 2
{
ìì 
book
íí 
.
íí 
Title
íí "
=
íí# $
model
íí% *
.
íí* +
Title
íí+ 0
;
íí0 1
}
îî 
if
ïï 
(
ïï 
model
ïï 
.
ïï 
Subtitle
ïï "
!=
ïï# %
null
ïï& *
)
ïï* +
if
ðð 
(
ðð 
model
ðð 
.
ðð 
Subtitle
ðð &
!=
ðð' )
book
ðð* .
.
ðð. /
Subtitle
ðð/ 7
)
ðð7 8
{
ññ 
book
òò 
.
òò 
Subtitle
òò %
=
òò& '
model
òò( -
.
òò- .
Subtitle
òò. 6
;
òò6 7
}
óó 
if
ôô 
(
ôô 
model
ôô 
.
ôô 

Annotation
ôô $
!=
ôô% '
null
ôô( ,
)
ôô, -
if
õõ 
(
õõ 
model
õõ 
.
õõ 

Annotation
õõ (
!=
õõ) +
book
õõ, 0
.
õõ0 1

Annotation
õõ1 ;
)
õõ; <
{
öö 
book
÷÷ 
.
÷÷ 

Annotation
÷÷ '
=
÷÷( )
model
÷÷* /
.
÷÷/ 0

Annotation
÷÷0 :
;
÷÷: ;
}
øø 
if
ùù 
(
ùù 
model
ùù 
.
ùù 

CoverImage
ùù $
!=
ùù% '
null
ùù( ,
)
ùù, -
if
úú 
(
úú 
model
úú 
.
úú 

CoverImage
úú (
!=
úú) +
book
úú, 0
.
úú0 1

CoverImage
úú1 ;
)
úú; <
{
ûû 
book
üü 
.
üü 

CoverImage
üü '
=
üü( )
$@"
üü* -
$str
üü- <
{
üü< =
model
üü= B
.
üüB C

CoverImage
üüC M
}
üüM N
"
üüN O
;
üüO P
}
ýý 
if
þþ 
(
þþ 
model
þþ 
.
þþ 
Year
þþ 
!=
þþ !
null
þþ" &
)
þþ& '
if
ÿÿ 
(
ÿÿ 
model
ÿÿ 
.
ÿÿ 
Year
ÿÿ "
!=
ÿÿ# %
book
ÿÿ& *
.
ÿÿ* +
Year
ÿÿ+ /
)
ÿÿ/ 0
{
 
book
 
.
 
Year
 !
=
" #
model
$ )
.
) *
Year
* .
;
. /
}
 
if
 
(
 
model
 
.
 
Isbn
 
!=
 !
null
" &
)
& '
{
 
if
 
(
 
model
 
.
 
Isbn
 "
.
" #
Length
# )
>
* +
$num
, .
)
. /
throw
 
new
 !
	Exception
" +
(
+ ,
$str
, S
)
S T
;
T U
if
 
(
 
model
 
.
 
Isbn
 "
==
# %
book
& *
.
* +
Isbn
+ /
)
/ 0
{
 
book
 
.
 
Isbn
 !
=
" #
model
$ )
.
) *
Isbn
* .
;
. /
}
 
else
 
{
 
var
 
uiqIsbnColl
 '
=
( )
ctx
* -
.
- .
Books
. 3
.
3 4
Where
4 9
(
9 :
b
: ;
=>
< >
b
? @
.
@ A
Isbn
A E
==
F H
model
I N
.
N O
Isbn
O S
)
S T
;
T U
if
 
(
 
uiqIsbnColl
 '
.
' (
Count
( -
(
- .
)
. /
>
0 1
$num
2 3
)
3 4
{
 
throw
 !
new
" %
	Exception
& /
(
/ 0
$str
0 \
)
\ ]
;
] ^
}
 
else
 
book
  
.
  !
Isbn
! %
=
& '
model
( -
.
- .
Isbn
. 2
;
2 3
}
 
}
 
if
 
(
 
model
 
.
 
Language
 "
!=
# %
book
& *
.
* +
Language
+ 3
)
3 4
{
 
book
 
.
 
Language
 !
=
" #
model
$ )
.
) *
Language
* 2
;
2 3
}
 
if
 
(
 
model
 
.
 
Edition
 !
!=
" $
null
% )
)
) *
if
 
(
 
model
 
.
 
Edition
 %
!=
& (
book
) -
.
- .
Edition
. 5
)
5 6
{
 
book
 
.
 
Edition
 $
=
% &
model
' ,
.
, -
Edition
- 4
;
4 5
}
   
if
¡¡ 
(
¡¡ 
model
¡¡ 
.
¡¡ 
Pages
¡¡ 
!=
¡¡  "
null
¡¡# '
)
¡¡' (
if
¢¢ 
(
¢¢ 
model
¢¢ 
.
¢¢ 
Pages
¢¢ #
!=
¢¢$ &
book
¢¢' +
.
¢¢+ ,
Pages
¢¢, 1
)
¢¢1 2
{
££ 
book
¤¤ 
.
¤¤ 
Pages
¤¤ "
=
¤¤# $
model
¤¤% *
.
¤¤* +
Pages
¤¤+ 0
;
¤¤0 1
}
¥¥ 
if
§§ 
(
§§ 
string
§§ 
.
§§  
IsNullOrWhiteSpace
§§ -
(
§§- .
model
§§. 3
.
§§3 4
Link
§§4 8
)
§§8 9
==
§§: <
false
§§= B
)
§§B C
{
¨¨ 
var
©© 
ebook
©© 
=
©© 
book
©©  $
as
©©% '
Ebook
©©( -
;
©©- .
ebook
ªª 
.
ªª 
Link
ªª 
=
ªª  
model
ªª! &
.
ªª& '
Link
ªª' +
;
ªª+ ,
}
«« 
if
­­ 
(
­­ 
model
­­ 
.
­­ 
Authors
­­ !
!=
­­" $
null
­­% )
)
­­) *
{
®® 
var
¯¯ 
deleted
¯¯ 
=
¯¯  !
ctx
°° 
.
°° 
BookAuthors
°° '
.
°°' (
Where
°°( -
(
°°- .
q
°°. /
=>
°°0 2
q
°°3 4
.
°°4 5
BookId
°°5 ;
==
°°< >
book
°°? C
.
°°C D
BiaId
°°D I
&&
°°J L
!
°°M N
model
°°N S
.
°°S T
Authors
°°T [
.
°°[ \
Contains
°°\ d
(
°°d e
q
°°e f
.
°°f g
	AuthorUid
°°g p
)
°°p q
)
°°q r
;
°°r s
if
±± 
(
±± 
deleted
±± 
.
±±  
Any
±±  #
(
±±# $
)
±±$ %
)
±±% &
{
²² 
ctx
³³ 
.
³³ 
BookAuthors
³³ '
.
³³' (
RemoveRange
³³( 3
(
³³3 4
deleted
³³4 ;
)
³³; <
;
³³< =
}
´´ 
foreach
¶¶ 
(
¶¶ 
var
¶¶  
author
¶¶! '
in
¶¶( *
model
¶¶+ 0
.
¶¶0 1
Authors
¶¶1 8
)
¶¶8 9
{
·· 
if
¸¸ 
(
¸¸ 
!
¸¸ 
book
¸¸ !
.
¸¸! "
Authors
¸¸" )
.
¸¸) *
Any
¸¸* -
(
¸¸- .
q
¸¸. /
=>
¸¸0 2
q
¸¸3 4
.
¸¸4 5
	AuthorUid
¸¸5 >
==
¸¸? A
author
¸¸B H
)
¸¸H I
)
¸¸I J
{
¹¹ 
var
ºº 

bookAuthor
ºº  *
=
ºº+ ,
new
ºº- 0

BookAuthor
ºº1 ;
(
ºº; <
)
ºº< =
{
»» 
BookId
¼¼  &
=
¼¼' (
book
¼¼) -
.
¼¼- .
BiaId
¼¼. 3
,
¼¼3 4
	AuthorUid
½½  )
=
½½* +
author
½½, 2
}
¾¾ 
;
¾¾ 
ctx
¿¿ 
.
¿¿  
BookAuthors
¿¿  +
.
¿¿+ ,
Add
¿¿, /
(
¿¿/ 0

bookAuthor
¿¿0 :
)
¿¿: ;
;
¿¿; <
}
ÀÀ 
}
ÁÁ 
}
ÂÂ 
else
ÃÃ 
{
ÄÄ 
var
ÅÅ 
deleted
ÅÅ 
=
ÅÅ  !
ctx
ÅÅ" %
.
ÅÅ% &
BookAuthors
ÅÅ& 1
.
ÅÅ1 2
Where
ÅÅ2 7
(
ÅÅ7 8
q
ÅÅ8 9
=>
ÅÅ: <
q
ÅÅ= >
.
ÅÅ> ?
BookId
ÅÅ? E
==
ÅÅF H
book
ÅÅI M
.
ÅÅM N
BiaId
ÅÅN S
)
ÅÅS T
;
ÅÅT U
if
ÆÆ 
(
ÆÆ 
deleted
ÆÆ 
.
ÆÆ  
Any
ÆÆ  #
(
ÆÆ# $
)
ÆÆ$ %
)
ÆÆ% &
ctx
ÇÇ 
.
ÇÇ 
BookAuthors
ÇÇ '
.
ÇÇ' (
RemoveRange
ÇÇ( 3
(
ÇÇ3 4
deleted
ÇÇ4 ;
)
ÇÇ; <
;
ÇÇ< =
}
ÈÈ 
if
ÊÊ 
(
ÊÊ 
model
ÊÊ 
.
ÊÊ 

Categories
ÊÊ $
!=
ÊÊ% '
null
ÊÊ( ,
)
ÊÊ, -
{
ËË 
var
ÌÌ 
deleted
ÌÌ 
=
ÌÌ  !
ctx
ÍÍ 
.
ÍÍ 
BookCategories
ÍÍ *
.
ÎÎ 
Where
ÎÎ "
(
ÎÎ" #
q
ÎÎ# $
=>
ÎÎ% '
q
ÎÎ( )
.
ÎÎ) *
BookId
ÎÎ* 0
==
ÎÎ1 3
book
ÎÎ4 8
.
ÎÎ8 9
BiaId
ÎÎ9 >
&&
ÎÎ? A
!
ÎÎB C
model
ÎÎC H
.
ÎÎH I

Categories
ÎÎI S
.
ÎÎS T
Contains
ÎÎT \
(
ÎÎ\ ]
q
ÎÎ] ^
.
ÎÎ^ _

CategoryId
ÎÎ_ i
)
ÎÎi j
)
ÎÎj k
;
ÎÎk l
if
ÏÏ 
(
ÏÏ 
deleted
ÏÏ 
.
ÏÏ  
Any
ÏÏ  #
(
ÏÏ# $
)
ÏÏ$ %
)
ÏÏ% &
{
ÐÐ 
ctx
ÑÑ 
.
ÑÑ 
BookCategories
ÑÑ *
.
ÑÑ* +
RemoveRange
ÑÑ+ 6
(
ÑÑ6 7
deleted
ÑÑ7 >
)
ÑÑ> ?
;
ÑÑ? @
}
ÒÒ 
foreach
ÔÔ 
(
ÔÔ 
var
ÔÔ  
category
ÔÔ! )
in
ÔÔ* ,
model
ÔÔ- 2
.
ÔÔ2 3

Categories
ÔÔ3 =
)
ÔÔ= >
{
ÕÕ 
if
ÖÖ 
(
ÖÖ 
!
ÖÖ 
book
ÖÖ !
.
ÖÖ! "
Cathegories
ÖÖ" -
.
ÖÖ- .
Any
ÖÖ. 1
(
ÖÖ1 2
q
ÖÖ2 3
=>
ÖÖ4 6
q
ÖÖ7 8
.
ÖÖ8 9

CategoryId
ÖÖ9 C
==
ÖÖD F
category
ÖÖG O
)
ÖÖO P
)
ÖÖP Q
{
×× 
var
ØØ 
bookCategory
ØØ  ,
=
ØØ- .
new
ØØ/ 2
BookCategory
ØØ3 ?
(
ØØ? @
)
ØØ@ A
{
ÙÙ 
BookId
ÚÚ  &
=
ÚÚ' (
book
ÚÚ) -
.
ÚÚ- .
BiaId
ÚÚ. 3
,
ÚÚ3 4

CategoryId
ÛÛ  *
=
ÛÛ+ ,
category
ÛÛ- 5
}
ÜÜ 
;
ÜÜ 
ctx
ÝÝ 
.
ÝÝ  
BookCategories
ÝÝ  .
.
ÝÝ. /
Add
ÝÝ/ 2
(
ÝÝ2 3
bookCategory
ÝÝ3 ?
)
ÝÝ? @
;
ÝÝ@ A
}
ÞÞ 
}
ßß 
}
àà 
else
áá 
{
ââ 
var
ãã 
deleted
ãã 
=
ãã  !
ctx
ãã" %
.
ãã% &
BookCategories
ãã& 4
.
ãã4 5
Where
ãã5 :
(
ãã: ;
q
ãã; <
=>
ãã= ?
q
ãã@ A
.
ããA B
BookId
ããB H
==
ããI K
book
ããL P
.
ããP Q
BiaId
ããQ V
)
ããV W
;
ããW X
if
ää 
(
ää 
deleted
ää 
.
ää  
Any
ää  #
(
ää# $
)
ää$ %
)
ää% &
ctx
åå 
.
åå 
BookCategories
åå *
.
åå* +
RemoveRange
åå+ 6
(
åå6 7
deleted
åå7 >
)
åå> ?
;
åå? @
}
ææ 
ctx
èè 
.
èè 
SaveChanges
èè 
(
èè  
)
èè  !
;
èè! "
log
éé 
.
éé 
Info
éé 
(
éé 
$"
éé 
{
éé 
User
éé  
.
éé  !
Identity
éé! )
.
éé) *
Name
éé* .
}
éé. /
$str
éé/ ;
{
éé; <
book
éé< @
.
éé@ A
BiaId
ééA F
}
ééF G
"
ééG H
)
ééH I
;
ééI J
return
êê 
Json
êê 
(
êê 
result
êê "
.
êê" #

SetSuccess
êê# -
(
êê- .
)
êê. /
)
êê/ 0
;
êê0 1
}
ëë 
catch
ìì 
(
ìì 
	Exception
ìì 
e
ìì 
)
ìì 
{
íí 
log
îî 
.
îî 
Error
îî 
(
îî 
e
îî 
)
îî 
;
îî 
return
ïï 
Json
ïï 
(
ïï 
result
ïï "
.
ïï" #
SetFail
ïï# *
(
ïï* +
e
ïï+ ,
)
ïï, -
)
ïï- .
;
ïï. /
}
ðð 
}
ññ 	
public
óó 
async
óó 
Task
óó 
<
óó 

JsonResult
óó $
>
óó$ %

DeleteBook
óó& 0
(
óó0 1
[
óó1 2
FromServices
óó2 >
]
óó> ?
BookDbContext
óó@ M
ctx
óóN Q
,
óóQ R
[
óóS T
FromBody
óóT \
]
óó\ ]
int
óó^ a
id
óób d
)
óód e
{
ôô 	
var
õõ 
result
õõ 
=
õõ 
new
õõ 
OperationResult
õõ ,
(
õõ, -
)
õõ- .
;
õõ. /
try
÷÷ 
{
øø 
var
ùù 
book
ùù 
=
ùù 
ctx
ùù 
.
ùù 
Books
ùù $
.
ùù$ %
FirstOrDefault
ùù% 3
(
ùù3 4
q
ùù4 5
=>
ùù6 8
q
ùù9 :
.
ùù: ;
BiaId
ùù; @
==
ùùA C
id
ùùD F
)
ùùF G
;
ùùG H
if
ûû 
(
ûû 
book
ûû 
is
ûû 
	PaperBook
ûû %
)
ûû% &
{
üü 
var
ýý 
papper
ýý 
=
ýý  
book
ýý! %
as
ýý& (
	PaperBook
ýý) 2
;
ýý2 3
if
þþ 
(
þþ 
papper
þþ 
.
þþ 
TakenByUser
þþ *
!=
þþ+ -
null
þþ. 2
)
þþ2 3
{
ÿÿ 
return
 
Json
 #
(
# $
new
$ '
OperationResult
( 7
(
7 8
)
8 9
.
9 :
SetFail
: A
(
A B
$"
B D
$str
D j
{
j k
papper
k q
.
q r
TakenByUser
r }
.
} ~
FullName~ 
} 
" 
) 
) 
; 
}
 
var
 
rentbook
  
=
! "
ctx
# &
.
& '
RentHistories
' 4
.
4 5
Where
5 :
(
: ;
q
; <
=>
= ?
q
@ A
.
A B
	TakenBook
B K
==
L N
papper
O U
)
U V
;
V W
if
 
(
 
rentbook
  
.
  !
Any
! $
(
$ %
)
% &
)
& '
ctx
 
.
 
RentHistories
 )
.
) *
RemoveRange
* 5
(
5 6
rentbook
6 >
)
> ?
;
? @
}
 
var
 

authorbook
 
=
  
ctx
! $
.
$ %
BookAuthors
% 0
.
0 1
Where
1 6
(
6 7
q
7 8
=>
9 ;
q
< =
.
= >
BookId
> D
==
E G
book
H L
.
L M
BiaId
M R
)
R S
;
S T
var
 
cathegoryBook
 !
=
" #
ctx
$ '
.
' (
BookCategories
( 6
.
6 7
Where
7 <
(
< =
q
= >
=>
? A
q
B C
.
C D
BookId
D J
==
K M
book
N R
.
R S
BiaId
S X
)
X Y
;
Y Z
var
 
reviews
 
=
 
ctx
 !
.
! "
Reviews
" )
.
) *
Where
* /
(
/ 0
q
0 1
=>
2 4
q
5 6
.
6 7
BookId
7 =
==
> @
book
A E
.
E F
BiaId
F K
)
K L
;
L M
var
 
requests
 
=
 
ctx
 "
.
" #
RequestBooks
# /
.
/ 0
Where
0 5
(
5 6
q
6 7
=>
8 :
q
; <
.
< =
BookId
= C
==
D F
book
G K
.
K L
BiaId
L Q
)
Q R
;
R S
if
 
(
 
book
 
is
 
Ebook
 !
)
! "
{
 
var
 
ebook
 
=
 
book
  $
as
% '
Ebook
( -
;
- .
var
 
	downloads
 !
=
" #
ctx
$ '
.
' (
DownloadHistories
( 9
.
9 :
Where
: ?
(
? @
q
@ A
=>
B D
q
E F
.
F G
DownloadedBook
G U
==
V X
ebook
Y ^
)
^ _
;
_ `
if
 
(
 
	downloads
 !
.
! "
Any
" %
(
% &
)
& '
)
' (
ctx
 
.
 
DownloadHistories
 -
.
- .
RemoveRange
. 9
(
9 :
	downloads
: C
)
C D
;
D E
var
 
fullPath
  
=
! "
$@"
# &
{
& '!
_hostingEnvironment
' :
.
: ;
WebRootPath
; F
}
F G
$str
G O
{
O P
ebook
P U
.
U V
Link
V Z
}
Z [
"
[ \
;
\ ]
if
 
(
 
System
 
.
 
IO
 !
.
! "
File
" &
.
& '
Exists
' -
(
- .
fullPath
. 6
)
6 7
)
7 8
{
 
System
 
.
 
IO
 !
.
! "
File
" &
.
& '
Delete
' -
(
- .
fullPath
. 6
)
6 7
;
7 8
}
 
}
 
if
 
(
 
reviews
 
.
 
Any
 
(
  
)
  !
)
! "
ctx
 
.
 
Reviews
 
.
  
RemoveRange
  +
(
+ ,
reviews
, 3
)
3 4
;
4 5
if
 
(
 
cathegoryBook
 !
.
! "
Any
" %
(
% &
)
& '
)
' (
ctx
 
.
 
BookCategories
 &
.
& '
RemoveRange
' 2
(
2 3
cathegoryBook
3 @
)
@ A
;
A B
if
 
(
 

authorbook
 
.
 
Any
 "
(
" #
)
# $
)
$ %
ctx
 
.
 
BookAuthors
 #
.
# $
RemoveRange
$ /
(
/ 0

authorbook
0 :
)
: ;
;
; <
if
   
(
   
requests
   
.
   
Any
    
(
    !
)
  ! "
)
  " #
ctx
¡¡ 
.
¡¡ 
RequestBooks
¡¡ $
.
¡¡$ %
RemoveRange
¡¡% 0
(
¡¡0 1
requests
¡¡1 9
)
¡¡9 :
;
¡¡: ;
ctx
££ 
.
££ 
SaveChanges
££ 
(
££  
)
££  !
;
££! "
ctx
¤¤ 
.
¤¤ 
Books
¤¤ 
.
¤¤ 
Remove
¤¤  
(
¤¤  !
book
¤¤! %
)
¤¤% &
;
¤¤& '
ctx
¥¥ 
.
¥¥ 
SaveChanges
¥¥ 
(
¥¥  
)
¥¥  !
;
¥¥! "
log
§§ 
.
§§ 
Info
§§ 
(
§§ 
$"
§§ 
{
§§ 
User
§§  
.
§§  !
Identity
§§! )
.
§§) *
Name
§§* .
}
§§. /
$str
§§/ =
{
§§= >
book
§§> B
.
§§B C
BiaId
§§C H
}
§§H I
$str
§§I J
{
§§J K
book
§§K O
.
§§O P
Title
§§P U
}
§§U V
"
§§V W
)
§§W X
;
§§X Y
return
¨¨ 
Json
¨¨ 
(
¨¨ 
result
¨¨ "
.
¨¨" #

SetSuccess
¨¨# -
(
¨¨- .
)
¨¨. /
)
¨¨/ 0
;
¨¨0 1
}
©© 
catch
ªª 
(
ªª 
	Exception
ªª 
e
ªª 
)
ªª 
{
«« 
return
¬¬ 
Json
¬¬ 
(
¬¬ 
new
¬¬ 
OperationResult
¬¬  /
(
¬¬/ 0
)
¬¬0 1
.
¬¬1 2
SetFail
¬¬2 9
(
¬¬9 :
e
¬¬: ;
)
¬¬; <
)
¬¬< =
;
¬¬= >
}
­­ 
}
®® 	
public
°° 
async
°° 
Task
°° 
<
°° 

JsonResult
°° $
>
°°$ %
RentBook
°°& .
(
°°. /
[
°°/ 0
FromServices
°°0 <
]
°°< =
BookDbContext
°°> K
ctx
°°L O
,
°°O P
[
°°Q R
FromServices
°°R ^
]
°°^ _
EmailService
°°_ k
email
°°l q
,
°°q r
[
°°s t
FromBody
°°t |
]
°°| }
dynamic°°~ 
model°° 
)°° 
{
±± 	
try
²² 
{
³³ 
var
´´ 
id
´´ 
=
´´ 
(
´´ 
int
´´ 
)
´´ 
model
´´ #
.
´´# $
Id
´´$ &
;
´´& '
var
µµ 
userName
µµ 
=
µµ 
(
µµ  
Guid
µµ  $
)
µµ$ %
model
µµ% *
.
µµ* +
User
µµ+ /
;
µµ/ 0
var
¶¶ 
rentDate
¶¶ 
=
¶¶ 
(
¶¶  
DateTime
¶¶  (
)
¶¶( )
model
¶¶) .
.
¶¶. /
Date
¶¶/ 3
;
¶¶3 4
if
¸¸ 
(
¸¸ 
rentDate
¸¸ 
<
¸¸ 
DateTime
¸¸ '
.
¸¸' (
Now
¸¸( +
)
¸¸+ ,
{
¹¹ 
return
ºº 
Json
ºº 
(
ºº  
new
ºº  #
OperationResult
ºº$ 3
(
ºº3 4
)
ºº4 5
{
ºº6 7
Details
ºº8 ?
=
ºº@ A
$str
ººB Y
}
ººZ [
)
ºº[ \
;
ºº\ ]
}
»» 
var
¾¾ 
book
¾¾ 
=
¾¾ 
ctx
¾¾ 
.
¾¾ 

PaperBooks
¾¾ )
.
¾¾) *
First
¾¾* /
(
¾¾/ 0
b
¾¾0 1
=>
¾¾2 4
b
¾¾5 6
.
¾¾6 7
BiaId
¾¾7 <
==
¾¾= ?
id
¾¾@ B
)
¾¾B C
;
¾¾C D
if
¿¿ 
(
¿¿ 
book
¿¿ 
!=
¿¿ 
null
¿¿  
)
¿¿  !
{
ÀÀ 
if
ÁÁ 
(
ÁÁ 
book
ÁÁ 
.
ÁÁ 
TakenByUser
ÁÁ (
==
ÁÁ) +
null
ÁÁ, 0
)
ÁÁ0 1
{
ÂÂ 
var
ÃÃ 
user
ÃÃ  
=
ÃÃ! "
ctx
ÃÃ# &
.
ÃÃ& '
AppUsers
ÃÃ' /
.
ÃÃ/ 0
FirstOrDefault
ÃÃ0 >
(
ÃÃ> ?
q
ÃÃ? @
=>
ÃÃA C
q
ÃÃD E
.
ÃÃE F
Uid
ÃÃF I
==
ÃÃJ L
userName
ÃÃM U
)
ÃÃU V
;
ÃÃV W
if
ÅÅ 
(
ÅÅ 
ctx
ÅÅ 
.
ÅÅ  

PaperBooks
ÅÅ  *
.
ÅÅ* +
Count
ÅÅ+ 0
(
ÅÅ0 1
q
ÅÅ1 2
=>
ÅÅ3 5
q
ÅÅ6 7
.
ÅÅ7 8
TakenByUser
ÅÅ8 C
==
ÅÅD F
user
ÅÅG K
)
ÅÅK L
>
ÅÅM N
S
ÅÅO P
.
ÅÅP Q
MaxBook
ÅÅQ X
)
ÅÅX Y
{
ÆÆ 
return
ÇÇ "
Json
ÇÇ# '
(
ÇÇ' (
new
ÇÇ( +
OperationResult
ÇÇ, ;
(
ÇÇ; <
)
ÇÇ< =
.
ÇÇ= >
SetFail
ÇÇ> E
(
ÇÇE F
$"
ÇÇF H
$str
ÇÇH o
{
ÇÇo p
S
ÇÇp q
.
ÇÇq r
MaxBook
ÇÇr y
}
ÇÇy z
$str
ÇÇz 
"ÇÇ 
)ÇÇ 
)ÇÇ 
;ÇÇ 
}
ÈÈ 
var
ÊÊ 
request
ÊÊ #
=
ÊÊ$ %
ctx
ÊÊ& )
.
ÊÊ) *
RequestBooks
ÊÊ* 6
.
ÊÊ6 7
FirstOrDefault
ÊÊ7 E
(
ÊÊE F
q
ÊÊF G
=>
ÊÊH J
q
ÊÊK L
.
ÊÊL M
BookId
ÊÊM S
==
ÊÊT V
book
ÊÊW [
.
ÊÊ[ \
BiaId
ÊÊ\ a
&&
ÊÊb d
q
ÊÊe f
.
ÊÊf g

AppUserUid
ÊÊg q
==
ÊÊr t
user
ÊÊu y
.
ÊÊy z
Uid
ÊÊz }
)
ÊÊ} ~
;
ÊÊ~ 
if
ËË 
(
ËË 
request
ËË #
!=
ËË$ &
null
ËË' +
)
ËË+ ,
{
ÌÌ 
ctx
ÍÍ 
.
ÍÍ  
RequestBooks
ÍÍ  ,
.
ÍÍ, -
Remove
ÍÍ- 3
(
ÍÍ3 4
request
ÍÍ4 ;
)
ÍÍ; <
;
ÍÍ< =
}
ÎÎ 
ctx
ÐÐ 
.
ÐÐ 
RentHistories
ÐÐ )
.
ÐÐ) *
Add
ÐÐ* -
(
ÐÐ- .
new
ÐÐ. 1
RentHistory
ÐÐ2 =
(
ÐÐ= >
)
ÐÐ> ?
{
ÑÑ 
Uid
ÒÒ 
=
ÒÒ  !
Guid
ÒÒ" &
.
ÒÒ& '
NewGuid
ÒÒ' .
(
ÒÒ. /
)
ÒÒ/ 0
,
ÒÒ0 1
ExtendedDueDate
ÓÓ +
=
ÓÓ, -
rentDate
ÓÓ. 6
,
ÓÓ6 7
	TakenDate
ÔÔ %
=
ÔÔ& '
DateTime
ÔÔ( 0
.
ÔÔ0 1
Now
ÔÔ1 4
,
ÔÔ4 5
	TakenBook
ÕÕ %
=
ÕÕ& '
book
ÕÕ( ,
,
ÕÕ, -
User
ÖÖ  
=
ÖÖ! "
user
ÖÖ# '
}
×× 
)
×× 
;
×× 
book
ØØ 
.
ØØ 
TakenByUserUid
ØØ +
=
ØØ, -
user
ØØ. 2
.
ØØ2 3
Uid
ØØ3 6
;
ØØ6 7
book
ÙÙ 
.
ÙÙ 
TakenDue
ÙÙ %
=
ÙÙ& '
rentDate
ÙÙ( 0
;
ÙÙ0 1
ctx
ÚÚ 
.
ÚÚ 
SaveChanges
ÚÚ '
(
ÚÚ' (
)
ÚÚ( )
;
ÚÚ) *
var
ÞÞ 
admins
ÞÞ "
=
ÞÞ# $
ctx
ÞÞ% (
.
ÞÞ( )
AdminNotifies
ÞÞ) 6
.
ÞÞ6 7
Where
ÞÞ7 <
(
ÞÞ< =
q
ÞÞ= >
=>
ÞÞ? A
q
ÞÞB C
.
ÞÞC D
NotifyId
ÞÞD L
==
ÞÞM O
AdminNotifyTypes
ÞÞP `
.
ÞÞ` a
General
ÞÞa h
)
ÞÞh i
.
ÞÞi j
Select
ÞÞj p
(
ÞÞp q
q
ÞÞq r
=>
ÞÞs u
q
ÞÞv w
.
ÞÞw x
Admin
ÞÞx }
)
ÞÞ} ~
;
ÞÞ~ 
if
ßß 
(
ßß 
!
ßß 
string
ßß #
.
ßß# $ 
IsNullOrWhiteSpace
ßß$ 6
(
ßß6 7
user
ßß7 ;
.
ßß; <
Email
ßß< A
)
ßßA B
)
ßßB C
{
àà 
var
ââ 
config
ââ  &
=
ââ' (
new
ââ) ,
	Extension
ââ- 6
.
ââ6 7
MailConfiguration
ââ7 H
(
ââH I
)
ââI J
{
ãã 
UserName
ää  (
=
ää) *
user
ää+ /
.
ää/ 0
	FirstName
ää0 9
,
ää9 :
BookID
åå  &
=
åå' (
book
åå) -
.
åå- .
BiaId
åå. 3
,
åå3 4
Date
ææ  $
=
ææ% &
rentDate
ææ' /
.
ææ/ 0
ToString
ææ0 8
(
ææ8 9
$str
ææ9 E
)
ææE F
,
ææF G
	BookTitle
çç  )
=
çç* +
book
çç, 0
.
çç0 1
Title
çç1 6
}
èè 
;
èè 
var
éé 
message
éé  '
=
éé( )
new
éé* -
MimeMessage
éé. 9
(
éé9 :
)
éé: ;
.
éé; <'
UserRequestConfirmMessage
éé< U
(
ééU V
config
ééV \
)
éé\ ]
;
éé] ^
message
êê #
.
êê# $
From
êê$ (
.
êê( )
Add
êê) ,
(
êê, -
new
êê- 0
MailboxAddress
êê1 ?
(
êê? @
S
êê@ A
.
êêA B
MailBot
êêB I
)
êêI J
)
êêJ K
;
êêK L
message
ëë #
.
ëë# $
To
ëë$ &
.
ëë& '
Add
ëë' *
(
ëë* +
new
ëë+ .
MailboxAddress
ëë/ =
(
ëë= >
user
ëë> B
.
ëëB C
Email
ëëC H
)
ëëH I
)
ëëI J
;
ëëJ K
email
ìì !
.
ìì! "
Send
ìì" &
(
ìì& '
message
ìì' .
)
ìì. /
;
ìì/ 0
}
îî 
else
ïï 
{
ðð 
if
òò 
(
òò  
admins
òò  &
.
òò& '
Any
òò' *
(
òò* +
)
òò+ ,
)
òò, -
{
óó 
var
ôô  #
message
ôô$ +
=
ôô, -
new
ôô. 1
MimeMessage
ôô2 =
(
ôô= >
)
ôô> ?
;
ôô? @
message
õõ  '
.
õõ' (
From
õõ( ,
.
õõ, -
Add
õõ- 0
(
õõ0 1
new
õõ1 4
MailboxAddress
õõ5 C
(
õõC D
S
õõD E
.
õõE F
MailBot
õõF M
)
õõM N
)
õõN O
;
õõO P
foreach
öö  '
(
öö( )
var
öö) ,
admin
öö- 2
in
öö3 5
admins
öö6 <
)
öö< =
{
÷÷  !
message
øø$ +
.
øø+ ,
To
øø, .
.
øø. /
Add
øø/ 2
(
øø2 3
new
øø3 6
MailboxAddress
øø7 E
(
øøE F
admin
øøF K
.
øøK L
Email
øøL Q
)
øøQ R
)
øøR S
;
øøS T
}
ùù  !
message
úú  '
.
úú' (
Subject
úú( /
=
úú0 1
$str
úú2 J
;
úúJ K
message
ûû  '
.
ûû' (
Body
ûû( ,
=
ûû- .
new
ûû/ 2
TextPart
ûû3 ;
(
ûû; <
)
ûû< =
{
üü  !
Text
ýý$ (
=
ýý) *
$"
ýý+ -
{
ýý- .
user
ýý. 2
.
ýý2 3
	LoginName
ýý3 <
}
ýý< =
$str
ýý= v
"
ýýv w
}
þþ  !
;
þþ! "
email
ÿÿ  %
.
ÿÿ% &
Send
ÿÿ& *
(
ÿÿ* +
message
ÿÿ+ 2
)
ÿÿ2 3
;
ÿÿ3 4
}
 
}
 
log
 
.
 
Info
  
(
  !
$"
! #
{
# $
User
$ (
.
( )
Identity
) 1
.
1 2
Name
2 6
}
6 7
$str
7 C
{
C D
book
D H
.
H I
BiaId
I N
}
N O
$str
O S
{
S T
book
T X
.
X Y
TakenByUser
Y d
.
d e
FullName
e m
}
m n
"
n o
)
o p
;
p q
return
 
Json
 #
(
# $
new
$ '
OperationResult
( 7
(
7 8
)
8 9
.
9 :

SetSuccess
: D
(
D E
)
E F
)
F G
;
G H
}
 
else
 
{
 
return
 
Json
 #
(
# $
new
$ '
OperationResult
( 7
(
7 8
)
8 9
.
9 :
SetFail
: A
(
A B
$"
B D
$str
D ]
{
] ^
book
^ b
.
b c
TakenByUser
c n
.
n o
FullName
o w
}
w x
"
x y
)
y z
)
z {
;
{ |
}
 
}
 
else
 
{
 
return
 
Json
 
(
  
new
  #
OperationResult
$ 3
(
3 4
)
4 5
{
6 7
Details
8 ?
=
@ A
$str
B Q
}
R S
)
S T
;
T U
}
 
}
 
catch
 
(
 
	Exception
 
e
 
)
 
{
 
log
 
.
 
Error
 
(
 
e
 
)
 
;
 
return
 
Json
 
(
 
new
 
OperationResult
  /
(
/ 0
)
0 1
.
1 2
SetFail
2 9
(
9 :
e
: ;
)
; <
)
< =
;
= >
}
 
}
 	
public
 
async
 
Task
 
<
 

JsonResult
 $
>
$ %
PassBook
& .
(
. /
[
/ 0
FromServices
0 <
]
< =
BookDbContext
> K
ctx
L O
,
O P
[
Q R
FromServices
R ^
]
^ _
EmailService
` l
email
m r
,
r s
[
t u
FromBody
u }
]
} ~
Guid 
id 
) 
{
 	
var
 
result
 
=
 
new
 
OperationResult
 ,
(
, -
)
- .
;
. /
try
 
{
 
var
 
rent
 
=
 
ctx
 
.
 
RentHistories
 ,
.
, -
First
- 2
(
2 3
q
3 4
=>
5 7
q
8 9
.
9 :
Uid
: =
==
> @
id
A C
)
C D
;
D E
var
 
book
 
=
 
rent
 
.
  
	TakenBook
  )
;
) *
var
 
user
 
=
 
rent
 
.
  
User
  $
;
$ %
book
 
.
 
TakenByUserUid
 #
=
$ %
null
& *
;
* +
book
 
.
 
TakenDue
 
=
 
null
  $
;
$ %
rent
   
.
   
ReturnedDate
   !
=
  " #
DateTime
  $ ,
.
  , -
Now
  - 0
;
  0 1
ctx
¢¢ 
.
¢¢ 
SaveChanges
¢¢ 
(
¢¢  
)
¢¢  !
;
¢¢! "
log
££ 
.
££ 
Info
££ 
(
££ 
$"
££ 
{
££ 
User
££  
.
££  !
Identity
££! )
.
££) *
Name
££* .
}
££. /
$str
££/ ;
{
££; <
book
££< @
.
££@ A
BiaId
££A F
}
££F G
"
££G H
)
££H I
;
££I J
var
¦¦ 
admins
¦¦ 
=
¦¦ 
ctx
¦¦  
.
¦¦  !
AdminNotifies
¦¦! .
.
¦¦. /
Where
¦¦/ 4
(
¦¦4 5
q
¦¦5 6
=>
¦¦7 9
q
¦¦: ;
.
¦¦; <
NotifyId
¦¦< D
==
¦¦E G
AdminNotifyTypes
¦¦H X
.
¦¦X Y
General
¦¦Y `
)
¦¦` a
.
¦¦a b
Select
¦¦b h
(
¦¦h i
q
¦¦i j
=>
¦¦k m
q
¦¦n o
.
¦¦o p
Admin
¦¦p u
)
¦¦u v
;
¦¦v w
if
¨¨ 
(
¨¨ 
!
¨¨ 
string
¨¨ 
.
¨¨  
IsNullOrWhiteSpace
¨¨ .
(
¨¨. /
user
¨¨/ 3
.
¨¨3 4
Email
¨¨4 9
)
¨¨9 :
)
¨¨: ;
{
©© 
var
ªª 
config
ªª 
=
ªª  
new
ªª! $
	Extension
ªª% .
.
ªª. /
MailConfiguration
ªª/ @
(
ªª@ A
)
ªªA B
{
«« 
UserName
¬¬  
=
¬¬! "
user
¬¬# '
.
¬¬' (
	FirstName
¬¬( 1
,
¬¬1 2
BookID
­­ 
=
­­  
book
­­! %
.
­­% &
BiaId
­­& +
,
­­+ ,
	BookTitle
®® !
=
®®" #
book
®®$ (
.
®®( )
Title
®®) .
}
¯¯ 
;
¯¯ 
var
°° 
message
°° 
=
°°  !
new
°°" %
MimeMessage
°°& 1
(
°°1 2
)
°°2 3
.
°°3 4#
UserReturnBookMessage
°°4 I
(
°°I J
config
°°J P
)
°°P Q
;
°°Q R
message
±± 
.
±± 
From
±±  
.
±±  !
Add
±±! $
(
±±$ %
new
±±% (
MailboxAddress
±±) 7
(
±±7 8
S
±±8 9
.
±±9 :
MailBot
±±: A
)
±±A B
)
±±B C
;
±±C D
message
²² 
.
²² 
To
²² 
.
²² 
Add
²² "
(
²²" #
new
²²# &
MailboxAddress
²²' 5
(
²²5 6
user
²²6 :
.
²²: ;
Email
²²; @
)
²²@ A
)
²²A B
;
²²B C
email
³³ 
.
³³ 
Send
³³ 
(
³³ 
message
³³ &
)
³³& '
;
³³' (
}
´´ 
else
µµ 
{
¶¶ 
foreach
·· 
(
·· 
var
··  
admin
··! &
in
··' )
admins
··* 0
)
··0 1
{
¸¸ 
var
¹¹ 
message
¹¹ #
=
¹¹$ %
new
¹¹& )
MimeMessage
¹¹* 5
(
¹¹5 6
)
¹¹6 7
;
¹¹7 8
message
ºº 
.
ºº  
From
ºº  $
.
ºº$ %
Add
ºº% (
(
ºº( )
new
ºº) ,
MailboxAddress
ºº- ;
(
ºº; <
S
ºº< =
.
ºº= >
MailBot
ºº> E
)
ººE F
)
ººF G
;
ººG H
message
»» 
.
»»  
To
»»  "
.
»»" #
Add
»»# &
(
»»& '
new
»»' *
MailboxAddress
»»+ 9
(
»»9 :
admin
»»: ?
.
»»? @
Email
»»@ E
)
»»E F
)
»»F G
;
»»G H
message
¼¼ 
.
¼¼  
Subject
¼¼  '
=
¼¼( )
$str
¼¼* B
;
¼¼B C
message
½½ 
.
½½  
Body
½½  $
=
½½% &
new
½½' *
TextPart
½½+ 3
(
½½3 4
)
½½4 5
{
¾¾ 
Text
¿¿  
=
¿¿! "
$"
¿¿# %
{
¿¿% &
user
¿¿& *
.
¿¿* +
	LoginName
¿¿+ 4
}
¿¿4 5
$str¿¿5 
"¿¿ 
}
ÀÀ 
;
ÀÀ 
email
ÁÁ 
.
ÁÁ 
Send
ÁÁ "
(
ÁÁ" #
message
ÁÁ# *
)
ÁÁ* +
;
ÁÁ+ ,
}
ÂÂ 
}
ÃÃ 
return
ÄÄ 
Json
ÄÄ 
(
ÄÄ 
result
ÄÄ "
.
ÄÄ" #

SetSuccess
ÄÄ# -
(
ÄÄ- .
$str
ÄÄ. ;
)
ÄÄ; <
)
ÄÄ< =
;
ÄÄ= >
}
ÅÅ 
catch
ÆÆ 
(
ÆÆ 
	Exception
ÆÆ 
e
ÆÆ 
)
ÆÆ 
{
ÇÇ 
log
ÈÈ 
.
ÈÈ 
Error
ÈÈ 
(
ÈÈ 
e
ÈÈ 
)
ÈÈ 
;
ÈÈ 
return
ÉÉ 
Json
ÉÉ 
(
ÉÉ 
result
ÉÉ "
.
ÉÉ" #
SetFail
ÉÉ# *
(
ÉÉ* +
e
ÉÉ+ ,
)
ÉÉ, -
)
ÉÉ- .
;
ÉÉ. /
}
ÊÊ 
}
ÌÌ 	
public
ÎÎ 
async
ÎÎ 
Task
ÎÎ 
<
ÎÎ 

JsonResult
ÎÎ $
>
ÎÎ$ %
ProlongBook
ÎÎ& 1
(
ÎÎ1 2
[
ÎÎ2 3
FromServices
ÎÎ3 ?
]
ÎÎ? @
BookDbContext
ÎÎA N
ctx
ÎÎO R
,
ÎÎR S
[
ÎÎT U
FromBody
ÎÎU ]
]
ÎÎ] ^
dynamic
ÎÎ` g
model
ÎÎh m
)
ÎÎm n
{
ÏÏ 	
var
ÐÐ 
result
ÐÐ 
=
ÐÐ 
new
ÐÐ 
OperationResult
ÐÐ ,
(
ÐÐ, -
)
ÐÐ- .
;
ÐÐ. /
try
ÑÑ 
{
ÒÒ 
var
ÓÓ 
id
ÓÓ 
=
ÓÓ 
(
ÓÓ 
Guid
ÓÓ 
)
ÓÓ 
model
ÓÓ $
.
ÓÓ$ %
Id
ÓÓ% '
;
ÓÓ' (
var
ÔÔ 
date
ÔÔ 
=
ÔÔ 
(
ÔÔ 
DateTime
ÔÔ $
)
ÔÔ$ %
model
ÔÔ% *
.
ÔÔ* +
Date
ÔÔ+ /
;
ÔÔ/ 0
if
ÖÖ 
(
ÖÖ 
date
ÖÖ 
<
ÖÖ 
DateTime
ÖÖ #
.
ÖÖ# $
Now
ÖÖ$ '
)
ÖÖ' (
{
×× 
return
ØØ 
Json
ØØ 
(
ØØ  
new
ØØ  #
OperationResult
ØØ$ 3
(
ØØ3 4
)
ØØ4 5
{
ØØ6 7
Details
ØØ8 ?
=
ØØ@ A
$str
ØØB Y
}
ØØZ [
)
ØØ[ \
;
ØØ\ ]
}
ÙÙ 
var
ÛÛ 
rent
ÛÛ 
=
ÛÛ 
ctx
ÛÛ 
.
ÛÛ 
RentHistories
ÛÛ ,
.
ÛÛ, -
FirstOrDefault
ÛÛ- ;
(
ÛÛ; <
q
ÛÛ< =
=>
ÛÛ> @
q
ÛÛA B
.
ÛÛB C
Uid
ÛÛC F
==
ÛÛG I
id
ÛÛJ L
)
ÛÛL M
;
ÛÛM N
var
ÜÜ 
book
ÜÜ 
=
ÜÜ 
rent
ÜÜ 
.
ÜÜ  
	TakenBook
ÜÜ  )
;
ÜÜ) *
book
ÝÝ 
.
ÝÝ 
TakenDue
ÝÝ 
=
ÝÝ 
date
ÝÝ  $
;
ÝÝ$ %
rent
ÞÞ 
.
ÞÞ 
ExtendedDueDate
ÞÞ $
=
ÞÞ% &
date
ÞÞ' +
;
ÞÞ+ ,
rent
ßß 
.
ßß  
ExtendedTimesCount
ßß '
++
ßß' )
;
ßß) *
ctx
àà 
.
àà 
SaveChanges
àà 
(
àà  
)
àà  !
;
àà! "
log
ãã 
.
ãã 
Info
ãã 
(
ãã 
$"
ãã 
{
ãã 
User
ãã  
.
ãã  !
Identity
ãã! )
.
ãã) *
Name
ãã* .
}
ãã. /
$str
ãã/ >
{
ãã> ?
book
ãã? C
.
ããC D
BiaId
ããD I
}
ããI J
"
ããJ K
)
ããK L
;
ããL M
return
ää 
Json
ää 
(
ää 
new
ää 
OperationResult
ää  /
(
ää/ 0
)
ää0 1
.
ää1 2

SetSuccess
ää2 <
(
ää< =
)
ää= >
)
ää> ?
;
ää? @
}
åå 
catch
ææ 
(
ææ 
	Exception
ææ 
e
ææ 
)
ææ 
{
çç 
log
èè 
.
èè 
Error
èè 
(
èè 
e
èè 
)
èè 
;
èè 
return
éé 
Json
éé 
(
éé 
new
éé 
OperationResult
éé  /
(
éé/ 0
)
éé0 1
.
éé1 2
SetFail
éé2 9
(
éé9 :
e
éé: ;
)
éé; <
)
éé< =
;
éé= >
}
êê 
}
ëë 	
public
íí 
async
íí 
Task
íí 
<
íí 

JsonResult
íí $
>
íí$ %
DeleteReview
íí& 2
(
íí2 3
[
íí3 4
FromServices
íí4 @
]
íí@ A
BookDbContext
ííB O
ctx
ííP S
,
ííS T
[
ííU V
FromBody
ííV ^
]
íí^ _
Guid
íí` d
uid
ííe h
)
ííh i
{
îî 	
var
ïï 
result
ïï 
=
ïï 
new
ïï 
OperationResult
ïï ,
(
ïï, -
)
ïï- .
;
ïï. /
try
ðð 
{
ññ 
var
òò 
review
òò 
=
òò 
ctx
òò  
.
òò  !
Reviews
òò! (
.
òò( )
FirstOrDefault
òò) 7
(
òò7 8
q
òò8 9
=>
òò: <
q
òò= >
.
òò> ?
Uid
òò? B
==
òòC E
uid
òòF I
)
òòI J
;
òòJ K
var
óó 
book
óó 
=
óó 
review
óó !
.
óó! "
Book
óó" &
;
óó& '
ctx
ôô 
.
ôô 
Reviews
ôô 
.
ôô 
Remove
ôô "
(
ôô" #
review
ôô# )
)
ôô) *
;
ôô* +
ctx
õõ 
.
õõ 
SaveChanges
õõ 
(
õõ  
)
õõ  !
;
õõ! "
book
öö 
.
öö 
AverageRating
öö "
=
öö# $
book
öö% )
.
öö) *
SumCurrentRating
öö* :
(
öö: ;
)
öö; <
;
öö< =
ctx
÷÷ 
.
÷÷ 
SaveChanges
÷÷ 
(
÷÷  
)
÷÷  !
;
÷÷! "
log
øø 
.
øø 
Info
øø 
(
øø 
$"
øø 
{
øø 
User
øø  
.
øø  !
Identity
øø! )
.
øø) *
Name
øø* .
}
øø. /
$str
øø/ ?
{
øø? @
book
øø@ D
.
øøD E
BiaId
øøE J
}
øøJ K
"
øøK L
)
øøL M
;
øøM N
return
ùù 
Json
ùù 
(
ùù 
result
ùù "
.
ùù" #

SetSuccess
ùù# -
(
ùù- .
$str
ùù. <
)
ùù< =
)
ùù= >
;
ùù> ?
}
úú 
catch
ûû 
(
ûû 
	Exception
ûû 
e
ûû 
)
ûû 
{
üü 
log
ýý 
.
ýý 
Error
ýý 
(
ýý 
e
ýý 
)
ýý 
;
ýý 
return
þþ 
Json
þþ 
(
þþ 
new
þþ 
OperationResult
þþ  /
(
þþ/ 0
)
þþ0 1
.
þþ1 2
SetFail
þþ2 9
(
þþ9 :
e
þþ: ;
)
þþ; <
)
þþ< =
;
þþ= >
}
ÿÿ 
return
 
Json
 
(
 
result
 
.
 
SetFail
 &
(
& '
)
' (
)
( )
;
) *
}
 	
public
 
async
 
Task
 
<
 

JsonResult
 $
>
$ %
DeleteAuthor
& 2
(
2 3
[
3 4
FromServices
4 @
]
@ A
BookDbContext
B O
ctx
P S
,
S T
[
U V
FromBody
V ^
]
^ _
Guid
` d
id
e g
)
g h
{
 	
var
 
result
 
=
 
new
 
OperationResult
 ,
(
, -
)
- .
;
. /
try
 
{
 
var
 
author
 
=
 
ctx
  
.
  !
Authors
! (
.
( )
FirstOrDefault
) 7
(
7 8
q
8 9
=>
: <
q
= >
.
> ?
	AuthorUid
? H
==
I K
id
L N
)
N O
;
O P
if
 
(
 
author
 
==
 
null
 "
)
" #
{
 
return
 
Json
 
(
  
result
  &
.
& '
SetFail
' .
(
. /
$str
/ @
)
@ A
)
A B
;
B C
}
 
var
 
bookAuthors
 
=
  !
ctx
" %
.
% &
BookAuthors
& 1
.
1 2
Where
2 7
(
7 8
q
8 9
=>
: <
q
= >
.
> ?
	AuthorUid
? H
==
I K
author
L R
.
R S
	AuthorUid
S \
)
\ ]
.
] ^
ToList
^ d
(
d e
)
e f
;
f g
if
 
(
 
bookAuthors
 
.
  
Any
  #
(
# $
)
$ %
)
% &
{
 
ctx
 
.
 
BookAuthors
 #
.
# $
RemoveRange
$ /
(
/ 0
bookAuthors
0 ;
)
; <
;
< =
}
 
ctx
 
.
 
SaveChanges
 
(
  
)
  !
;
! "
ctx
 
.
 
Authors
 
.
 
Remove
 "
(
" #
author
# )
)
) *
;
* +
ctx
 
.
 
SaveChanges
 
(
  
)
  !
;
! "
log
 
.
 
Info
 
(
 
$"
 
{
 
User
  
.
  !
Identity
! )
.
) *
Name
* .
}
. /
$str
/ ?
{
? @
author
@ F
.
F G
FullName
G O
(
O P
)
P Q
}
Q R
"
R S
)
S T
;
T U
return
 
Json
 
(
 
result
 "
.
" #

SetSuccess
# -
(
- .
$str
. <
)
< =
)
= >
;
> ?
}
 
catch
 
(
 
	Exception
 
e
 
)
 
{
 
log
 
.
 
Error
 
(
 
e
 
)
 
;
 
return
 
Json
 
(
 
result
 "
.
" #
SetFail
# *
(
* +
)
+ ,
)
, -
;
- .
}
 
}
¡¡ 	
public
££ 
async
££ 
Task
££ 
<
££ 

JsonResult
££ $
>
££$ %
DeleteCategory
££& 4
(
££4 5
[
££5 6
FromServices
££6 B
]
££B C
BookDbContext
££D Q
ctx
££R U
,
££U V
[
££W X
FromBody
££X `
]
££` a
int
££b e
id
££f h
)
££h i
{
¤¤ 	
var
¥¥ 
result
¥¥ 
=
¥¥ 
new
¥¥ 
OperationResult
¥¥ ,
(
¥¥, -
)
¥¥- .
;
¥¥. /
try
¦¦ 
{
§§ 
var
¨¨ 
category
¨¨ 
=
¨¨ 
ctx
¨¨ "
.
¨¨" #

Categories
¨¨# -
.
¨¨- .
FirstOrDefault
¨¨. <
(
¨¨< =
q
¨¨= >
=>
¨¨? A
q
¨¨B C
.
¨¨C D

CategoryId
¨¨D N
==
¨¨O Q
id
¨¨R T
)
¨¨T U
;
¨¨U V
if
©© 
(
©© 
category
©© 
==
©© 
null
©©  $
)
©©$ %
{
ªª 
return
«« 
Json
«« 
(
««  
result
««  &
.
««& '
SetFail
««' .
(
««. /
$str
««/ E
)
««E F
)
««F G
;
««G H
}
¬¬ 
var
®® 
bookCategories
®® "
=
®®# $
ctx
®®% (
.
®®( )
BookCategories
®®) 7
.
®®7 8
Where
®®8 =
(
®®= >
q
®®> ?
=>
®®@ B
q
®®C D
.
®®D E

CategoryId
®®E O
==
®®P R
category
®®S [
.
®®[ \

CategoryId
®®\ f
)
®®f g
.
®®g h
ToList
®®h n
(
®®n o
)
®®o p
;
®®p q
if
¯¯ 
(
¯¯ 
bookCategories
¯¯ "
.
¯¯" #
Any
¯¯# &
(
¯¯& '
)
¯¯' (
)
¯¯( )
{
°° 
ctx
±± 
.
±± 
BookCategories
±± &
.
±±& '
RemoveRange
±±' 2
(
±±2 3
bookCategories
±±3 A
)
±±A B
;
±±B C
}
²² 
ctx
´´ 
.
´´ 
SaveChanges
´´ 
(
´´  
)
´´  !
;
´´! "
ctx
µµ 
.
µµ 

Categories
µµ 
.
µµ 
Remove
µµ %
(
µµ% &
category
µµ& .
)
µµ. /
;
µµ/ 0
ctx
¶¶ 
.
¶¶ 
SaveChanges
¶¶ 
(
¶¶  
)
¶¶  !
;
¶¶! "
log
·· 
.
·· 
Info
·· 
(
·· 
$"
·· 
{
·· 
User
··  
.
··  !
Identity
··! )
.
··) *
Name
··* .
}
··. /
$str
··/ A
{
··A B
category
··B J
}
··J K
"
··K L
)
··L M
;
··M N
return
¸¸ 
Json
¸¸ 
(
¸¸ 
result
¸¸ "
.
¸¸" #

SetSuccess
¸¸# -
(
¸¸- .
$str
¸¸. A
)
¸¸A B
)
¸¸B C
;
¸¸C D
}
¹¹ 
catch
ºº 
(
ºº 
	Exception
ºº 
e
ºº 
)
ºº 
{
»» 
log
¼¼ 
.
¼¼ 
Error
¼¼ 
(
¼¼ 
e
¼¼ 
)
¼¼ 
;
¼¼ 
return
½½ 
Json
½½ 
(
½½ 
result
½½ "
.
½½" #
SetFail
½½# *
(
½½* +
)
½½+ ,
)
½½, -
;
½½- .
}
¾¾ 
}
ÀÀ 	
public
ÂÂ 
ActionResult
ÂÂ 

AuthorList
ÂÂ &
(
ÂÂ& '
[
ÂÂ' (
FromServices
ÂÂ( 4
]
ÂÂ4 5
BookDbContext
ÂÂ6 C
ctx
ÂÂD G
)
ÂÂG H
{
ÃÃ 	
var
ÄÄ 
list
ÄÄ 
=
ÄÄ 
ctx
ÄÄ 
.
ÄÄ 
Authors
ÄÄ "
.
ÅÅ 
Select
ÅÅ 
(
ÅÅ 
st
ÅÅ 
=>
ÅÅ 
new
ÅÅ !
SelectListItem
ÅÅ" 0
(
ÅÅ0 1
)
ÅÅ1 2
{
ÅÅ3 4
Text
ÅÅ5 9
=
ÅÅ: ;
st
ÅÅ< >
.
ÅÅ> ?
FullName
ÅÅ? G
(
ÅÅG H
)
ÅÅH I
,
ÅÅI J
Value
ÅÅK P
=
ÅÅQ R
st
ÅÅS U
.
ÅÅU V
	AuthorUid
ÅÅV _
.
ÅÅ_ `
ToString
ÅÅ` h
(
ÅÅh i
)
ÅÅi j
}
ÅÅk l
)
ÅÅl m
.
ÆÆ 
ToList
ÆÆ 
(
ÆÆ 
)
ÆÆ 
;
ÆÆ 
return
ÈÈ 
PartialView
ÈÈ 
(
ÈÈ 
$str
ÈÈ M
,
ÈÈM N
list
ÈÈO S
)
ÈÈS T
;
ÈÈT U
}
ÉÉ 	
public
ÊÊ 
ActionResult
ÊÊ 
CategoryList
ÊÊ (
(
ÊÊ( )
[
ÊÊ) *
FromServices
ÊÊ* 6
]
ÊÊ6 7
BookDbContext
ÊÊ8 E
ctx
ÊÊF I
)
ÊÊI J
{
ËË 	
var
ÌÌ 
top
ÌÌ 
=
ÌÌ 
ctx
ÌÌ 
.
ÌÌ 

Categories
ÌÌ $
.
ÍÍ 
Select
ÍÍ 
(
ÍÍ 
st
ÍÍ 
=>
ÍÍ 
new
ÍÍ !
SelectListItem
ÍÍ" 0
(
ÍÍ0 1
)
ÍÍ1 2
{
ÍÍ3 4
Text
ÍÍ5 9
=
ÍÍ: ;
st
ÍÍ< >
.
ÍÍ> ?
CategoryName
ÍÍ? K
,
ÍÍK L
Value
ÍÍM R
=
ÍÍS T
st
ÍÍU W
.
ÍÍW X

CategoryId
ÍÍX b
.
ÍÍb c
ToString
ÍÍc k
(
ÍÍk l
)
ÍÍl m
}
ÍÍn o
)
ÍÍo p
.
ÎÎ 
ToList
ÎÎ 
(
ÎÎ 
)
ÎÎ 
;
ÎÎ 
return
ÐÐ 
PartialView
ÐÐ 
(
ÐÐ 
$str
ÐÐ ?
,
ÐÐ? @
top
ÐÐA D
)
ÐÐD E
;
ÐÐE F
}
ÑÑ 	
public
ÓÓ 
async
ÓÓ 
Task
ÓÓ 
<
ÓÓ 

JsonResult
ÓÓ $
>
ÓÓ$ %
DeclineRent
ÓÓ& 1
(
ÓÓ1 2
[
ÓÓ2 3
FromServices
ÓÓ3 ?
]
ÓÓ? @
BookDbContext
ÓÓA N
ctx
ÓÓO R
,
ÓÓR S
[
ÓÓT U
FromBody
ÓÓU ]
]
ÓÓ] ^
dynamic
ÓÓ_ f
model
ÓÓg l
)
ÓÓl m
{
ÔÔ 	
var
ÕÕ 
result
ÕÕ 
=
ÕÕ 
new
ÕÕ 
OperationResult
ÕÕ ,
(
ÕÕ, -
)
ÕÕ- .
;
ÕÕ. /
try
×× 
{
ØØ 
var
ÙÙ 
bookId
ÙÙ 
=
ÙÙ 
(
ÙÙ 
int
ÙÙ !
)
ÙÙ! "
model
ÙÙ" '
.
ÙÙ' (
book
ÙÙ( ,
;
ÙÙ, -
var
ÚÚ 
userUid
ÚÚ 
=
ÚÚ 
(
ÚÚ 
Guid
ÚÚ #
)
ÚÚ# $
model
ÚÚ$ )
.
ÚÚ) *
user
ÚÚ* .
;
ÚÚ. /
var
ÛÛ 
book
ÛÛ 
=
ÛÛ 
ctx
ÛÛ 
.
ÛÛ 
Books
ÛÛ $
.
ÛÛ$ %
FirstOrDefault
ÛÛ% 3
(
ÛÛ3 4
q
ÛÛ4 5
=>
ÛÛ6 8
q
ÛÛ9 :
.
ÛÛ: ;
BiaId
ÛÛ; @
==
ÛÛA C
bookId
ÛÛD J
)
ÛÛJ K
;
ÛÛK L
var
ÜÜ 
user
ÜÜ 
=
ÜÜ 
ctx
ÜÜ 
.
ÜÜ 
AppUsers
ÜÜ '
.
ÜÜ' (
First
ÜÜ( -
(
ÜÜ- .
q
ÜÜ. /
=>
ÜÜ0 2
q
ÜÜ3 4
.
ÜÜ4 5
Uid
ÜÜ5 8
==
ÜÜ9 ;
userUid
ÜÜ< C
)
ÜÜC D
;
ÜÜD E
var
ÝÝ 
req
ÝÝ 
=
ÝÝ 
ctx
ÝÝ 
.
ÝÝ 
RequestBooks
ÝÝ *
.
ÝÝ* +
FirstOrDefault
ÝÝ+ 9
(
ÝÝ9 :
q
ÝÝ: ;
=>
ÝÝ< >
q
ÝÝ? @
.
ÝÝ@ A
AppUser
ÝÝA H
==
ÝÝI K
user
ÝÝL P
&&
ÝÝQ S
q
ÝÝT U
.
ÝÝU V
Book
ÝÝV Z
==
ÝÝ[ ]
book
ÝÝ^ b
)
ÝÝb c
;
ÝÝc d
if
ÞÞ 
(
ÞÞ 
req
ÞÞ 
!=
ÞÞ 
null
ÞÞ 
)
ÞÞ  
{
ßß 
ctx
àà 
.
àà 
RequestBooks
àà $
.
àà$ %
Remove
àà% +
(
àà+ ,
req
àà, /
)
àà/ 0
;
àà0 1
ctx
áá 
.
áá 
SaveChanges
áá #
(
áá# $
)
áá$ %
;
áá% &
log
ââ 
.
ââ 
Info
ââ 
(
ââ 
$"
ââ 
{
ââ  
User
ââ  $
.
ââ$ %
Identity
ââ% -
.
ââ- .
Name
ââ. 2
}
ââ2 3
$str
ââ3 J
{
ââJ K
userUid
ââK R
}
ââR S
$str
ââS \
{
ââ\ ]
bookId
ââ] c
}
ââc d
"
ââd e
)
ââe f
;
ââf g
return
ãã 
Json
ãã 
(
ãã  
new
ãã  #
OperationResult
ãã$ 3
(
ãã3 4
)
ãã4 5
.
ãã5 6

SetSuccess
ãã6 @
(
ãã@ A
)
ããA B
)
ããB C
;
ããC D
}
ää 
}
åå 
catch
ææ 
(
ææ 
	Exception
ææ 
ex
ææ 
)
ææ  
{
çç 
return
èè 
Json
èè 
(
èè 
new
èè 
OperationResult
èè  /
(
èè/ 0
)
èè0 1
.
èè1 2
SetFail
èè2 9
(
èè9 :
ex
èè: <
)
èè< =
)
èè= >
;
èè> ?
}
éé 
return
êê 
Json
êê 
(
êê 
new
êê 
OperationResult
êê +
(
êê+ ,
)
êê, -
.
êê- .
SetFail
êê. 5
(
êê5 6
)
êê6 7
)
êê7 8
;
êê8 9
}
ëë 	
public
îî 
async
îî 
Task
îî 
<
îî 

JsonResult
îî $
>
îî$ %
AddToIgnoreList
îî& 5
(
îî5 6
[
îî6 7
FromServices
îî7 C
]
îîC D
BookDbContext
îîE R
ctx
îîS V
,
îîV W
[
îîX Y
FromBody
îîY a
]
îîa b
Guid
îîc g
uid
îîh k
)
îîk l
{
ïï 	
var
ðð 
result
ðð 
=
ðð 
new
ðð 
OperationResult
ðð ,
(
ðð, -
)
ðð- .
;
ðð. /
try
ññ 
{
òò 
var
óó 
user
óó 
=
óó 
ctx
óó 
.
óó 
AppUsers
óó '
.
óó' (
First
óó( -
(
óó- .
q
óó. /
=>
óó0 2
q
óó3 4
.
óó4 5
Uid
óó5 8
==
óó9 ;
uid
óó< ?
)
óó? @
;
óó@ A
ctx
õõ 
.
õõ 
IgnoredUsers
õõ  
.
õõ  !
Add
õõ! $
(
õõ$ %
new
õõ% (
IgnoredUser
õõ) 4
(
õõ4 5
)
õõ5 6
{
õõ7 8

AppUserUid
õõ8 B
=
õõC D
user
õõE I
.
õõI J
Uid
õõJ M
}
õõM N
)
õõN O
;
õõO P
ctx
öö 
.
öö 
SaveChanges
öö 
(
öö  
)
öö  !
;
öö! "
log
÷÷ 
.
÷÷ 
Info
÷÷ 
(
÷÷ 
$"
÷÷ 
{
÷÷ 
User
÷÷  
.
÷÷  !
Identity
÷÷! )
.
÷÷) *
Name
÷÷* .
}
÷÷. /
$str
÷÷/ :
{
÷÷: ;
user
÷÷; ?
.
÷÷? @
FullName
÷÷@ H
}
÷÷H I
$str
÷÷I X
"
÷÷X Y
)
÷÷Y Z
;
÷÷Z [
return
øø 
Json
øø 
(
øø 
result
øø "
.
øø" #

SetSuccess
øø# -
(
øø- .
$"
øø. 0
$str
øø0 M
"
øøM N
)
øøN O
)
øøO P
;
øøP Q
}
ùù 
catch
úú 
(
úú 
	Exception
úú 
e
úú 
)
úú 
{
ûû 
return
üü 
Json
üü 
(
üü 
result
üü "
.
üü" #
SetFail
üü# *
(
üü* +
$"
üü+ -
$str
üü- X
"
üüX Y
)
üüY Z
)
üüZ [
;
üü[ \
}
ýý 
}
þþ 	
public
 
async
 
Task
 
<
 

JsonResult
 $
>
$ %"
RemoveFromIgnoreList
& :
(
: ;
[
; <
FromServices
< H
]
H I
BookDbContext
J W
ctx
X [
,
[ \
[
] ^
FromBody
^ f
]
f g
Guid
h l
uid
m p
)
p q
{
 	
var
 
result
 
=
 
new
 
OperationResult
 ,
(
, -
)
- .
;
. /
try
 
{
 
var
 
user
 
=
 
ctx
 
.
 
AppUsers
 '
.
' (
First
( -
(
- .
q
. /
=>
0 2
q
3 4
.
4 5
Uid
5 8
==
9 ;
uid
< ?
)
? @
;
@ A
var
 
ignored
 
=
 
ctx
 !
.
! "
IgnoredUsers
" .
.
. /
First
/ 4
(
4 5
q
5 6
=>
7 9
q
: ;
.
; <

AppUserUid
< F
==
G I
uid
J M
)
M N
;
N O
ctx
 
.
 
IgnoredUsers
  
.
  !
Remove
! '
(
' (
ignored
( /
)
/ 0
;
0 1
ctx
 
.
 
SaveChanges
 
(
  
)
  !
;
! "
log
 
.
 
Info
 
(
 
$"
 
{
 
User
  
.
  !
Identity
! )
.
) *
Name
* .
}
. /
$str
/ =
{
= >
user
> B
.
B C
FullName
C K
}
K L
$str
L ]
"
] ^
)
^ _
;
_ `
return
 
Json
 
(
 
result
 "
.
" #

SetSuccess
# -
(
- .
$"
. 0
$str
0 L
"
L M
)
M N
)
N O
;
O P
}
 
catch
 
(
 
	Exception
 
e
 
)
 
{
 
return
 
Json
 
(
 
result
 "
.
" #
SetFail
# *
(
* +
$"
+ -
$str
- V
"
V W
)
W X
)
X Y
;
Y Z
}
 
}
 	
public
 
async
 
Task
 
<
 

JsonResult
 $
>
$ %
	AddNotify
& /
(
/ 0
[
0 1
FromServices
1 =
]
= >
BookDbContext
? L
ctx
M P
,
P Q
[
R S
FromBody
S [
]
[ \
Guid
] a
uid
b e
)
e f
{
 	
var
 
result
 
=
 
new
 
OperationResult
 ,
(
, -
)
- .
;
. /
try
 
{
 
var
 
admin
 
=
 
ctx
 
.
  
Admins
  &
.
& '
First
' ,
(
, -
q
- .
=>
/ 1
q
2 3
.
3 4
Uid
4 7
==
8 :
uid
; >
)
> ?
;
? @
if
 
(
 
admin
 
.
 
AdminNotifies
 '
.
' (
Any
( +
(
+ ,
q
, -
=>
. 0
q
1 2
.
2 3
NotifyId
3 ;
==
< >
AdminNotifyTypes
? O
.
O P
General
P W
)
W X
==
X Z
false
Z _
)
_ `
{
 
ctx
 
.
 
AdminNotifies
 %
.
% &
Add
& )
(
) *
new
* -
AdminNotify
. 9
(
9 :
)
: ;
{
 
Uid
 
=
 
admin
 #
.
# $
Uid
$ '
,
' (
NotifyId
  
=
! "
AdminNotifyTypes
# 3
.
3 4
General
4 ;
}
 
)
 
;
 
ctx
   
.
   
SaveChanges
   #
(
  # $
)
  $ %
;
  % &
log
¡¡ 
.
¡¡ 
Info
¡¡ 
(
¡¡ 
$"
¡¡ 
{
¡¡  
User
¡¡  $
.
¡¡$ %
Identity
¡¡% -
.
¡¡- .
Name
¡¡. 2
}
¡¡2 3
$str
¡¡3 ?
{
¡¡? @
admin
¡¡@ E
.
¡¡E F
FullName
¡¡F N
}
¡¡N O
$str
¡¡O ^
"
¡¡^ _
)
¡¡_ `
;
¡¡` a
}
¢¢ 
return
££ 
Json
££ 
(
££ 
result
££ "
.
££" #

SetSuccess
££# -
(
££- .
$"
££. 0
$str
££0 N
{
££N O
admin
££O T
.
££T U
FullName
££U ]
}
££] ^
$str
££^ h
"
££h i
)
££i j
)
££j k
;
££k l
}
¤¤ 
catch
¥¥ 
(
¥¥ 
	Exception
¥¥ 
e
¥¥ 
)
¥¥ 
{
¦¦ 
return
§§ 
Json
§§ 
(
§§ 
result
§§ "
.
§§" #
SetFail
§§# *
(
§§* +
$"
§§+ -
$str
§§- a
"
§§a b
)
§§b c
)
§§c d
;
§§d e
}
¨¨ 
}
©© 	
public
«« 
async
«« 
Task
«« 
<
«« 

JsonResult
«« $
>
««$ %
RemoveNotify
««& 2
(
««2 3
[
««3 4
FromServices
««4 @
]
««@ A
BookDbContext
««B O
ctx
««P S
,
««S T
[
««U V
FromBody
««V ^
]
««^ _
Guid
««` d
uid
««e h
)
««h i
{
¬¬ 	
var
­­ 
result
­­ 
=
­­ 
new
­­ 
OperationResult
­­ ,
(
­­, -
)
­­- .
;
­­. /
try
®® 
{
¯¯ 
var
°° 
admin
°° 
=
°° 
ctx
°° 
.
°°  
Admins
°°  &
.
°°& '
FirstOrDefault
°°' 5
(
°°5 6
q
°°6 7
=>
°°8 :
q
°°; <
.
°°< =
Uid
°°= @
==
°°A C
uid
°°D G
)
°°G H
;
°°H I
if
±± 
(
±± 
admin
±± 
!=
±± 
null
±± !
)
±±! "
{
²² 
var
³³ 
notify
³³ 
=
³³  
ctx
³³! $
.
³³$ %
AdminNotifies
³³% 2
.
³³2 3
FirstOrDefault
³³3 A
(
³³A B
q
³³B C
=>
³³D F
q
³³G H
.
³³H I
Uid
³³I L
==
³³M O
admin
³³P U
.
³³U V
Uid
³³V Y
)
³³Y Z
;
³³Z [
if
´´ 
(
´´ 
notify
´´ 
!=
´´ !
null
´´" &
)
´´& '
{
µµ 
ctx
¶¶ 
.
¶¶ 
AdminNotifies
¶¶ )
.
¶¶) *
Remove
¶¶* 0
(
¶¶0 1
notify
¶¶1 7
)
¶¶7 8
;
¶¶8 9
ctx
·· 
.
·· 
SaveChanges
·· '
(
··' (
)
··( )
;
··) *
log
¸¸ 
.
¸¸ 
Info
¸¸  
(
¸¸  !
$"
¸¸! #
{
¸¸# $
User
¸¸$ (
.
¸¸( )
Identity
¸¸) 1
.
¸¸1 2
Name
¸¸2 6
}
¸¸6 7
$str
¸¸7 F
{
¸¸F G
admin
¸¸G L
.
¸¸L M
FullName
¸¸M U
}
¸¸U V
$str
¸¸V g
"
¸¸g h
)
¸¸h i
;
¸¸i j
}
¹¹ 
return
ºº 
Json
ºº 
(
ºº  
result
ºº  &
.
ºº& '

SetSuccess
ºº' 1
(
ºº1 2
$"
ºº2 4
$str
ºº4 R
{
ººR S
admin
ººS X
.
ººX Y
FullName
ººY a
}
ººa b
$str
ººb l
"
ººl m
)
ººm n
)
ººn o
;
ººo p
}
»» 
else
¼¼ 
{
½½ 
throw
¾¾ 
new
¾¾ 
	Exception
¾¾ '
(
¾¾' (
)
¾¾( )
;
¾¾) *
}
¿¿ 
}
ÀÀ 
catch
ÁÁ 
(
ÁÁ 
	Exception
ÁÁ 
e
ÁÁ 
)
ÁÁ 
{
ÂÂ 
return
ÃÃ 
Json
ÃÃ 
(
ÃÃ 
result
ÃÃ "
.
ÃÃ" #
SetFail
ÃÃ# *
(
ÃÃ* +
$"
ÃÃ+ -
$str
ÃÃ- \
"
ÃÃ\ ]
)
ÃÃ] ^
)
ÃÃ^ _
;
ÃÃ_ `
}
ÄÄ 
}
ÅÅ 	
public
ÇÇ 
async
ÇÇ 
Task
ÇÇ 
<
ÇÇ 

JsonResult
ÇÇ $
>
ÇÇ$ %

DeleteUser
ÇÇ& 0
(
ÇÇ0 1
[
ÇÇ1 2
FromServices
ÇÇ2 >
]
ÇÇ> ?
BookDbContext
ÇÇ@ M
ctx
ÇÇN Q
,
ÇÇQ R
[
ÇÇS T
FromBody
ÇÇT \
]
ÇÇ\ ]
Guid
ÇÇ^ b
uid
ÇÇc f
)
ÇÇf g
{
ÈÈ 	
var
ÉÉ 
result
ÉÉ 
=
ÉÉ 
new
ÉÉ 
OperationResult
ÉÉ ,
(
ÉÉ, -
)
ÉÉ- .
;
ÉÉ. /
try
ÊÊ 
{
ËË 
var
ÌÌ 
user
ÌÌ 
=
ÌÌ 
ctx
ÌÌ 
.
ÌÌ 
AppUsers
ÌÌ '
.
ÌÌ' (
First
ÌÌ( -
(
ÌÌ- .
q
ÌÌ. /
=>
ÌÌ0 2
q
ÌÌ3 4
.
ÌÌ4 5
Uid
ÌÌ5 8
==
ÌÌ9 ;
uid
ÌÌ< ?
)
ÌÌ? @
;
ÌÌ@ A
if
ÍÍ 
(
ÍÍ 
user
ÍÍ 
.
ÍÍ 
ReqestBooks
ÍÍ $
.
ÍÍ$ %
Any
ÍÍ% (
(
ÍÍ( )
)
ÍÍ) *
)
ÍÍ* +
{
ÎÎ 
ctx
ÏÏ 
.
ÏÏ 
RequestBooks
ÏÏ $
.
ÏÏ$ %
RemoveRange
ÏÏ% 0
(
ÏÏ0 1
user
ÏÏ1 5
.
ÏÏ5 6
ReqestBooks
ÏÏ6 A
)
ÏÏA B
;
ÏÏB C
}
ÐÐ 
if
ÒÒ 
(
ÒÒ 
user
ÒÒ 
.
ÒÒ 
RentHistory
ÒÒ $
.
ÒÒ$ %
Any
ÒÒ% (
(
ÒÒ( )
)
ÒÒ) *
)
ÒÒ* +
{
ÓÓ 
ctx
ÔÔ 
.
ÔÔ 
RentHistories
ÔÔ %
.
ÔÔ% &
RemoveRange
ÔÔ& 1
(
ÔÔ1 2
user
ÔÔ2 6
.
ÔÔ6 7
RentHistory
ÔÔ7 B
)
ÔÔB C
;
ÔÔC D
}
ÕÕ 
if
×× 
(
×× 
user
×× 
.
×× 
Reviews
××  
.
××  !
Any
××! $
(
××$ %
)
××% &
)
××& '
{
ØØ 
ctx
ÙÙ 
.
ÙÙ 
Reviews
ÙÙ 
.
ÙÙ  
RemoveRange
ÙÙ  +
(
ÙÙ+ ,
user
ÙÙ, 0
.
ÙÙ0 1
Reviews
ÙÙ1 8
)
ÙÙ8 9
;
ÙÙ9 :
}
ÚÚ 
if
ÜÜ 
(
ÜÜ 
user
ÜÜ 
is
ÜÜ 
Admin
ÜÜ !
)
ÜÜ! "
{
ÝÝ 
var
ÞÞ 
admin
ÞÞ 
=
ÞÞ 
user
ÞÞ  $
as
ÞÞ% '
Admin
ÞÞ( -
;
ÞÞ- .
if
ßß 
(
ßß 
admin
ßß 
.
ßß 
AdminNotifies
ßß +
.
ßß+ ,
Any
ßß, /
(
ßß/ 0
)
ßß0 1
)
ßß1 2
{
àà 
ctx
áá 
.
áá 
AdminNotifies
áá )
.
áá) *
RemoveRange
áá* 5
(
áá5 6
admin
áá6 ;
.
áá; <
AdminNotifies
áá< I
)
ááI J
;
ááJ K
}
ââ 
}
ãã 
ctx
åå 
.
åå 
AppUsers
åå 
.
åå 
Remove
åå #
(
åå# $
user
åå$ (
)
åå( )
;
åå) *
ctx
ææ 
.
ææ 
SaveChanges
ææ 
(
ææ  
)
ææ  !
;
ææ! "
log
çç 
.
çç 
Info
çç 
(
çç 
$"
çç 
{
çç 
User
çç  
.
çç  !
Identity
çç! )
.
çç) *
Name
çç* .
}
çç. /
$str
çç/ =
{
çç= >
user
çç> B
.
ççB C
FullName
ççC K
}
ççK L
"
ççL M
)
ççM N
;
ççN O
return
éé 
Json
éé 
(
éé 
result
éé "
.
éé" #

SetSuccess
éé# -
(
éé- .
$"
éé. 0
$str
éé0 =
{
éé= >
user
éé> B
.
ééB C
FullName
ééC K
}
ééK L
$str
ééL S
"
ééS T
)
ééT U
)
ééU V
;
ééV W
}
êê 
catch
ëë 
(
ëë 
	Exception
ëë 
e
ëë 
)
ëë 
{
ìì 
return
íí 
Json
íí 
(
íí 
result
íí "
.
íí" #
SetFail
íí# *
(
íí* +
$stríí+ 
)íí 
)íí 
;íí 
}
îî 
}
ïï 	
public
ññ 
async
ññ 
Task
ññ 
<
ññ 

JsonResult
ññ $
>
ññ$ %
AddUser
ññ& -
(
ññ- .
[
ññ. /
FromServices
ññ/ ;
]
ññ; <
BookDbContext
ññ= J
ctx
ññK N
,
ññN O
[
ññP Q
FromBody
ññQ Y
]
ññY Z
dynamic
ññ[ b
model
ññc h
)
ññh i
{
òò 	
var
óó 
result
óó 
=
óó 
new
óó 
OperationResult
óó ,
(
óó, -
)
óó- .
;
óó. /
try
ôô 
{
õõ 
var
öö 
login
öö 
=
öö 
(
öö 
string
öö #
)
öö# $
model
öö% *
.
öö* +
login
öö+ 0
;
öö0 1
var
÷÷ 
first
÷÷ 
=
÷÷ 
(
÷÷ 
string
÷÷ #
)
÷÷# $
model
÷÷$ )
.
÷÷) *
first
÷÷* /
;
÷÷/ 0
var
øø 
last
øø 
=
øø 
(
øø 
string
øø "
)
øø" #
model
øø# (
.
øø( )
last
øø) -
;
øø- .
var
ùù 
full
ùù 
=
ùù 
(
ùù 
string
ùù "
)
ùù" #
model
ùù# (
.
ùù( )
full
ùù) -
;
ùù- .
var
úú 
email
úú 
=
úú 
(
úú 
string
úú #
)
úú# $
model
úú$ )
.
úú) *
email
úú* /
;
úú/ 0
bool
ûû 
isAdmin
ûû 
=
ûû 
(
ûû  
bool
ûû  $
)
ûû$ %
model
ûû% *
.
ûû* +
admin
ûû+ 0
;
ûû0 1
if
ýý 
(
ýý 
string
ýý 
.
ýý  
IsNullOrWhiteSpace
ýý -
(
ýý- .
login
ýý. 3
)
ýý3 4
||
ýý5 7
ctx
ýý8 ;
.
ýý; <
AppUsers
ýý< D
.
ýýD E
Any
ýýE H
(
ýýH I
q
ýýI J
=>
ýýJ L
q
ýýL M
.
ýýM N
	LoginName
ýýN W
==
ýýW Y
login
ýýY ^
)
ýý^ _
)
ýý` a
{
þþ 
return
ÿÿ 
Json
ÿÿ 
(
ÿÿ  
result
ÿÿ  &
.
ÿÿ& '
SetFail
ÿÿ' .
(
ÿÿ. /
$str
ÿÿ/ U
)
ÿÿU V
)
ÿÿV W
;
ÿÿW X
}
		 
if
		 
(
		 
isAdmin
		 
)
		 
{
		 
var
		 
user
		 
=
		 
new
		 "
Admin
		# (
(
		( )
)
		) *
;
		* +
user
		 
.
		 
	LoginName
		 "
=
		# $
login
		% *
;
		* +
user
		 
.
		 
	FirstName
		 "
=
		# $
first
		% *
;
		* +
user
		 
.
		 
LastName
		 !
=
		" #
last
		$ (
;
		( )
user
		 
.
		 
FullName
		 !
=
		" #
full
		$ (
;
		( )
user
		 
.
		 
Email
		 
=
		  
email
		! &
;
		& '
user
		 
.
		 
AccessGroup
		 $
=
		% &
AccessGroupId
		' 4
.
		4 5
Admin
		5 :
;
		: ;
user
		 
.
		 
IsActive
		 !
=
		" #
true
		$ (
;
		( )
ctx
		 
.
		 
Admins
		 
.
		 
Add
		 "
(
		" #
user
		# '
)
		' (
;
		( )
ctx
		 
.
		 
SaveChanges
		 #
(
		# $
)
		$ %
;
		% &
}
		 
else
		 
{
		 
var
		 
user
		 
=
		 
new
		 "
AppUser
		# *
(
		* +
)
		+ ,
;
		, -
user
		 
.
		 
	LoginName
		 "
=
		# $
login
		% *
;
		* +
user
		 
.
		 
	FirstName
		 "
=
		# $
first
		% *
;
		* +
user
		 
.
		 
LastName
		 !
=
		" #
last
		$ (
;
		( )
user
		 
.
		 
FullName
		 !
=
		" #
full
		$ (
;
		( )
user
		 
.
		 
Email
		 
=
		  
email
		! &
;
		& '
user
		 
.
		 
AccessGroup
		 $
=
		% &
AccessGroupId
		' 4
.
		4 5
Common
		5 ;
;
		; <
user
		 
.
		 
IsActive
		 !
=
		" #
true
		$ (
;
		( )
ctx
		 
.
		 
AppUsers
		  
.
		  !
Add
		! $
(
		$ %
user
		% )
)
		) *
;
		* +
ctx
		 
.
		 
SaveChanges
		 #
(
		# $
)
		$ %
;
		% &
}
		 
log
		 
.
		 
Info
		 
(
		 
$"
		 
{
		 
User
		  
.
		  !
Identity
		! )
.
		) *
Name
		* .
}
		. /
$str
		/ :
{
		: ;
login
		; @
}
		@ A
"
		A B
)
		B C
;
		C D
return
		 
Json
		 
(
		 
result
		 "
.
		" #

SetSuccess
		# -
(
		- .
$"
		. 0
$str
		0 =
{
		= >
login
		> C
}
		C D
$str
		D M
"
		M N
)
		N O
)
		O P
;
		P Q
}
 	 	 
catch
¡	¡	 
(
¡	¡	 
	Exception
¡	¡	 
e
¡	¡	 
)
¡	¡	 
{
¢	¢	 
return
£	£	 
Json
£	£	 
(
£	£	 
result
£	£	 "
.
£	£	" #
SetFail
£	£	# *
(
£	£	* +
$str
£	£	+ Q
)
£	£	Q R
)
£	£	R S
;
£	£	S T
}
¤	¤	 
}
¥	¥	 	
public
§	§	 
async
§	§	 
Task
§	§	 
<
§	§	 

JsonResult
§	§	 $
>
§	§	$ %
EditUser
§	§	& .
(
§	§	. /
[
§	§	/ 0
FromServices
§	§	0 <
]
§	§	< =
BookDbContext
§	§	> K
ctx
§	§	L O
,
§	§	O P
[
§	§	Q R
FromBody
§	§	R Z
]
§	§	Z [
dynamic
§	§	\ c
model
§	§	d i
)
§	§	i j
{
¨	¨	 	
var
©	©	 
result
©	©	 
=
©	©	 
new
©	©	 
OperationResult
©	©	 ,
(
©	©	, -
)
©	©	- .
;
©	©	. /
try
ª	ª	 
{
«	«	 
var
¬	¬	 
login
¬	¬	 
=
¬	¬	 
(
¬	¬	 
string
¬	¬	 #
)
¬	¬	# $
model
¬	¬	$ )
.
¬	¬	) *
login
¬	¬	* /
;
¬	¬	/ 0
var
­	­	 
first
­	­	 
=
­	­	 
(
­	­	 
string
­	­	 #
)
­	­	# $
model
­	­	$ )
.
­	­	) *
first
­	­	* /
;
­	­	/ 0
var
®	®	 
last
®	®	 
=
®	®	 
(
®	®	 
string
®	®	 "
)
®	®	" #
model
®	®	# (
.
®	®	( )
last
®	®	) -
;
®	®	- .
var
¯	¯	 
full
¯	¯	 
=
¯	¯	 
(
¯	¯	 
string
¯	¯	 "
)
¯	¯	" #
model
¯	¯	# (
.
¯	¯	( )
full
¯	¯	) -
;
¯	¯	- .
var
°	°	 
email
°	°	 
=
°	°	 
(
°	°	 
string
°	°	 #
)
°	°	# $
model
°	°	$ )
.
°	°	) *
email
°	°	* /
;
°	°	/ 0
bool
±	±	 
isAdmin
±	±	 
=
±	±	 
(
±	±	  
bool
±	±	  $
)
±	±	$ %
model
±	±	% *
.
±	±	* +
admin
±	±	+ 0
;
±	±	0 1
AppUser
³	³	 
user
³	³	 
=
³	³	 
ctx
³	³	 "
.
³	³	" #
AppUsers
³	³	# +
.
³	³	+ ,
First
³	³	, 1
(
³	³	1 2
q
³	³	2 3
=>
³	³	3 5
q
³	³	5 6
.
³	³	6 7
	LoginName
³	³	7 @
==
³	³	@ B
login
³	³	B G
)
³	³	G H
;
³	³	H I
if
´	´	 
(
´	´	 
!
´	´	 
string
´	´	 
.
´	´	  
IsNullOrWhiteSpace
´	´	 .
(
´	´	. /
first
´	´	/ 4
)
´	´	4 5
)
´	´	5 6
user
µ	µ	 
.
µ	µ	 
	FirstName
µ	µ	 "
=
µ	µ	# $
first
µ	µ	% *
;
µ	µ	* +
if
¶	¶	 
(
¶	¶	 
!
¶	¶	 
string
¶	¶	 
.
¶	¶	  
IsNullOrWhiteSpace
¶	¶	 .
(
¶	¶	. /
last
¶	¶	/ 3
)
¶	¶	3 4
)
¶	¶	4 5
user
·	·	 
.
·	·	 
LastName
·	·	 !
=
·	·	" #
last
·	·	$ (
;
·	·	( )
if
¸	¸	 
(
¸	¸	 
!
¸	¸	 
string
¸	¸	 
.
¸	¸	  
IsNullOrWhiteSpace
¸	¸	 .
(
¸	¸	. /
full
¸	¸	/ 3
)
¸	¸	3 4
)
¸	¸	4 5
user
¹	¹	 
.
¹	¹	 
FullName
¹	¹	 !
=
¹	¹	" #
full
¹	¹	$ (
;
¹	¹	( )
if
º	º	 
(
º	º	 
!
º	º	 
string
º	º	 
.
º	º	  
IsNullOrWhiteSpace
º	º	 .
(
º	º	. /
email
º	º	/ 4
)
º	º	4 5
)
º	º	5 6
user
»	»	 
.
»	»	 
Email
»	»	 
=
»	»	  
email
»	»	! &
;
»	»	& '
if
¼	¼	 
(
¼	¼	 
isAdmin
¼	¼	 
)
¼	¼	 
{
½	½	 
user
¿	¿	 
.
¿	¿	 
AccessGroup
¿	¿	 $
=
¿	¿	% &
AccessGroupId
¿	¿	' 4
.
¿	¿	4 5
Admin
¿	¿	5 :
;
¿	¿	: ;
user
À	À	 
.
À	À	 
Discriminator
À	À	 &
=
À	À	' (
$str
À	À	) 0
;
À	À	0 1
}
Á	Á	 
else
Â	Â	 
{
Ã	Ã	 
user
Ä	Ä	 
.
Ä	Ä	 
AccessGroup
Ä	Ä	 $
=
Ä	Ä	% &
AccessGroupId
Ä	Ä	' 4
.
Ä	Ä	4 5
Common
Ä	Ä	5 ;
;
Ä	Ä	; <
user
Å	Å	 
.
Å	Å	 
Discriminator
Å	Å	 &
=
Å	Å	' (
$str
Å	Å	) 2
;
Å	Å	2 3
}
Æ	Æ	 
ctx
È	È	 
.
È	È	 
SaveChanges
È	È	 
(
È	È	  
)
È	È	  !
;
È	È	! "
log
É	É	 
.
É	É	 
Info
É	É	 
(
É	É	 
$"
É	É	 
{
É	É	 
User
É	É	  
.
É	É	  !
Identity
É	É	! )
.
É	É	) *
Name
É	É	* .
}
É	É	. /
$str
É	É	/ ;
{
É	É	; <
user
É	É	< @
.
É	É	@ A
FullName
É	É	A I
}
É	É	I J
"
É	É	J K
)
É	É	K L
;
É	É	L M
return
Ë	Ë	 
Json
Ë	Ë	 
(
Ë	Ë	 
result
Ë	Ë	 "
.
Ë	Ë	" #

SetSuccess
Ë	Ë	# -
(
Ë	Ë	- .
$"
Ë	Ë	. 0
$str
Ë	Ë	0 =
{
Ë	Ë	= >
user
Ë	Ë	> B
.
Ë	Ë	B C
FullName
Ë	Ë	C K
}
Ë	Ë	K L
$str
Ë	Ë	L T
"
Ë	Ë	T U
)
Ë	Ë	U V
)
Ë	Ë	V W
;
Ë	Ë	W X
}
Ì	Ì	 
catch
Í	Í	 
(
Í	Í	 
	Exception
Í	Í	 
e
Í	Í	 
)
Í	Í	 
{
Î	Î	 
return
Ï	Ï	 
Json
Ï	Ï	 
(
Ï	Ï	 
result
Ï	Ï	 "
.
Ï	Ï	" #
SetFail
Ï	Ï	# *
(
Ï	Ï	* +
$str
Ï	Ï	+ Q
)
Ï	Ï	Q R
)
Ï	Ï	R S
;
Ï	Ï	S T
}
Ð	Ð	 
}
Ñ	Ñ	 	
}
Ó	Ó	 
}Ô	Ô	 ®§
aC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Controllers\Api\ApiController.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Controllers# .
.. /
Api/ 2
{ 
public 

class 
ApiController 
:  
ControllerBase! /
{   
private!! 
IHostingEnvironment!! #
_hostingEnvironment!!$ 7
;!!7 8
private"" 
IBrowser"" 
_browser"" !
;""! "
private## 
readonly## 
	Microsoft## "
.##" #

Extensions### -
.##- .
Logging##. 5
.##5 6
ILogger##6 =
_log##> B
;##B C
public%% 
ApiController%% 
(%% 
IHostingEnvironment%% 0
hostingEnvironment%%1 C
,%%C D
ILogger%%E L
<%%L M
ApiController%%M Z
>%%Z [
log%%\ _
,%%_ `
IBrowserResolver%%a q
browserResolver	%%r 
)
%% 
{&& 	
_hostingEnvironment'' 
=''  !
hostingEnvironment''" 4
;''4 5
_browser(( 
=(( 
browserResolver(( &
.((& '
Browser((' .
;((. /
_log)) 
=)) 
log)) 
;)) 
}** 	
[-- 	
	Authorize--	 
(-- 
Policy-- 
=-- 
Data--  
.--  !
S--! "
.--" #

GroupAdmin--# -
)--- .
]--. /
public.. 
async.. 
Task.. 
<.. 
IActionResult.. '
>..' (
SetFile..) 0
(..0 1
)..1 2
{// 	
try00 
{11 
var22 
root22 
=22 
Path22 
.22  
GetDirectoryName22  0
(220 1
Assembly221 9
.229 : 
GetExecutingAssembly22: N
(22N O
)22O P
.22P Q
Location22Q Y
)22Y Z
+22[ \
$str22] h
;22h i
var44 
file44 
=44 
Request44 "
.44" #
Form44# '
.44' (
Files44( -
.44- .
FirstOrDefault44. <
(44< =
)44= >
;44> ?
if55 
(55 
file55 
==55 
null55  
)55  !
{66 
return77 

StatusCode77 %
(77% &
$num77& )
)77) *
;77* +
}88 
var99 
fileExtention99 !
=99" #
System99$ *
.99* +
IO99+ -
.99- .
Path99. 2
.992 3
GetExtension993 ?
(99? @)
ContentDispositionHeaderValue99@ ]
.:: 
Parse:: 
(:: 
file:: 
.::  
ContentDisposition::  2
)::2 3
.;; 
FileName;; 
.<< 
Trim<< 
(<< 
$char<< 
)<< 
)<< 
;<<  
if== 
(== 
fileExtention== !
====" $
$str==% '
)==' (
{>> 
}@@ 
;@@ 
varAA 
FileNameAA 
=AA 
fileAA #
.AA# $
FileNameAA$ ,
;AA, -
ifBB 
(BB 
_browserBB 
.BB 
TypeBB !
==BB" $
BrowserTypeBB% 0
.BB0 1
EdgeBB1 5
||BB6 8
_browserBB9 A
.BBA B
TypeBBB F
==BBG I
BrowserTypeBBJ U
.BBU V
IEBBV X
)BBX Y
{CC 
FileNameDD 
=DD 
fileDD #
.DD# $
FileNameDD$ ,
.DD, -
SplitDD- 2
(DD2 3
$charDD3 7
)DD7 8
.DD8 9
LastDD9 =
(DD= >
)DD> ?
;DD? @
}EE 
varHH 
fullPathHH 
=HH 
$@"HH "
{HH" #
rootHH# '
}HH' (
$strHH( /
{HH/ 0
fileHH0 4
.HH4 5
FileNameHH5 =
}HH= >
"HH> ?
;HH? @
ifII 
(II 
SystemII 
.II 
IOII 
.II 
FileII "
.II" #
ExistsII# )
(II) *
fullPathII* 2
)II2 3
)II3 4
{JJ 
}LL 
newMM 
SystemMM 
.MM 
IOMM 
.MM 
FileInfoMM &
(MM& '
fullPathMM' /
)MM/ 0
.MM0 1
	DirectoryMM1 :
.MM: ;
CreateMM; A
(MMA B
)MMB C
;MMC D
usingNN 
(NN 
varNN 
fsNN 
=NN 
SystemNN  &
.NN& '
IONN' )
.NN) *
FileNN* .
.NN. /
ExistsNN/ 5
(NN5 6
fullPathNN6 >
)NN> ?
?NN@ A
SystemNNB H
.NNH I
IONNI K
.NNK L
FileNNL P
.NNP Q
	OpenWriteNNQ Z
(NNZ [
fullPathNN[ c
)NNc d
:NNe f
SystemNNg m
.NNm n
IONNn p
.NNp q
FileNNq u
.NNu v
CreateNNv |
(NN| }
fullPath	NN} 
)
NN 
)
NN 
{OO 
filePP 
.PP 
CopyToPP 
(PP  
fsPP  "
)PP" #
;PP# $
fsQQ 
.QQ 
FlushQQ 
(QQ 
)QQ 
;QQ 
}RR 
throwTT 
newTT #
NotImplementedExceptionTT 1
(TT1 2
)TT2 3
;TT3 4
}UU 
catchVV 
(VV 
	ExceptionVV 
eVV 
)VV 
{WW 
NLogXX 
.XX 

LogManagerXX 
.XX  !
GetCurrentClassLoggerXX  5
(XX5 6
)XX6 7
.XX7 8
ErrorXX8 =
(XX= >
eXX> ?
)XX? @
;XX@ A
returnYY 

StatusCodeYY !
(YY! "
$numYY" %
)YY% &
;YY& '
}ZZ 
}[[ 	
[]] 	
	Authorize]]	 
(]] 
Policy]] 
=]] 
Data]]  
.]]  !
S]]! "
.]]" #

GroupAdmin]]# -
)]]- .
]]]. /
public^^ 
async^^ 
Task^^ 
<^^ 
IActionResult^^ '
>^^' (

RemoveFile^^) 3
(^^3 4
[^^4 5
	FromQuery^^5 >
]^^> ?
string^^? E
file^^F J
)^^J K
{__ 	
try`` 
{aa 
throwbb 
newbb #
NotImplementedExceptionbb 2
(bb2 3
)bb3 4
;bb4 5
}cc 
catchdd 
(dd 
	Exceptiondd 
edd 
)dd 
{ee 
NLogff 
.ff 

LogManagerff 
.ff  !
GetCurrentClassLoggerff  5
(ff5 6
)ff6 7
.ff7 8
Errorff8 =
(ff= >
eff> ?
)ff? @
;ff@ A
returngg 

StatusCodegg !
(gg! "
$numgg" %
)gg% &
;gg& '
}hh 
}ii 	
[mm 	
	Authorizemm	 
(mm 
Policymm 
=mm 
Datamm  
.mm  !
Smm! "
.mm" #
GroupCommonmm# .
)mm. /
]mm/ 0
publicnn 
asyncnn 
Tasknn 
<nn 
IActionResultnn '
>nn' (
	CheckFilenn) 2
(nn2 3
[nn3 4
FromServicesnn4 @
]nn@ A
BookDbContextnnB O
ctxnnP S
,nnS T
[nnU V
	FromQuerynnV _
]nn_ `
stringnn` f
filenng k
)nnk l
{oo 	
returnpp 

StatusCodepp 
(pp 
$numpp !
)pp! "
;pp" #
tryqq 
{rr 
varss 
rootss 
=ss 
Pathss 
.ss  
GetDirectoryNamess  0
(ss0 1
Assemblyss1 9
.ss9 : 
GetExecutingAssemblyss: N
(ssN O
)ssO P
.ssP Q
LocationssQ Y
)ssY Z
+ssZ [
$strss[ f
;ssf g
_logtt 
.tt 
LogDebugtt 
(tt 
roottt "
)tt" #
;tt# $
NLoguu 
.uu 

LogManageruu 
.uu  !
GetCurrentClassLoggeruu  5
(uu5 6
)uu6 7
.uu7 8
Debuguu8 =
(uu= >
_hostingEnvironmentuu> Q
.uuQ R
WebRootPathuuR ]
)uu] ^
;uu^ _
varvv 
uservv 
=vv 
ctxvv 
.vv 
AppUsersvv '
.vv' (
Firstvv( -
(vv- .
qvv. /
=>vv0 2
qvv3 4
.vv4 5
	LoginNamevv5 >
==vv? A
UservvB F
.vvF G
IdentityvvG O
.vvO P
NamevvP T
.vvT U
ReplacevvU \
(vv\ ]
$strvv] g
,vvg h
$strvvi k
)vvk l
)vvl m
;vvm n
varww 
bookww 
=ww 
ctxww 
.ww 
Ebooksww %
.ww% &
Firstww& +
(ww+ ,
qww, -
=>ww. 0
qww1 2
.ww2 3
Linkww3 7
==ww8 :
fileww; ?
)ww? @
;ww@ A
filexx 
=xx 

WebUtilityxx !
.xx! "
	UrlDecodexx" +
(xx+ ,
filexx, 0
)xx0 1
;xx1 2
varyy 
urlyy 
=yy 
$@"yy 
$stryy &
{yy& '
fileyy' +
}yy+ ,
"yy, -
;yy- .
varzz 
infzz 
=zz 
newzz 
FileInfozz &
(zz& '
$@"zz' *
{zz* +
rootzz+ /
}zz/ 0
$strzz0 8
{zz8 9
filezz9 =
}zz= >
"zz> ?
)zz? @
.zz@ A
ExistszzA G
;zzG H
if{{ 
({{ 
inf{{ 
){{ 
{|| 
return}} 

StatusCode}} %
(}}% &
$num}}& )
)}}) *
;}}* +
}~~ 
else 
{
 
return
 

StatusCode
 %
(
% &
$num
& )
)
) *
;
* +
}
 
}
 
catch
 
(
 
	Exception
 
e
 
)
 
{
 
NLog
 
.
 

LogManager
 
.
  #
GetCurrentClassLogger
  5
(
5 6
)
6 7
.
7 8
Error
8 =
(
= >
e
> ?
)
? @
;
@ A
return
 

StatusCode
 !
(
! "
$num
" %
)
% &
;
& '
}
 
}
 	
[
 	
	Authorize
	 
(
 
Policy
 
=
 
Data
  
.
  !
S
! "
.
" #
GroupCommon
# .
)
. /
]
/ 0
public
 
async
 
Task
 
<
 
IActionResult
 '
>
' (
GetFile
) 0
(
0 1
[
1 2
FromServices
2 >
]
> ?
BookDbContext
@ M
ctx
N Q
,
Q R
[
S T
	FromQuery
T ]
]
] ^
string
^ d
file
e i
)
i j
{
 	
try
 
{
 
var
 
root
 
=
 
Path
 
.
  
GetDirectoryName
  0
(
0 1
Assembly
1 9
.
9 :"
GetExecutingAssembly
: N
(
N O
)
O P
.
P Q
Location
Q Y
)
Y Z
+
[ \
$str
] h
;
h i
var
 
user
 
=
 
ctx
 
.
 
AppUsers
 '
.
' (
First
( -
(
- .
q
. /
=>
0 2
q
3 4
.
4 5
	LoginName
5 >
==
? A
User
B F
.
F G
Identity
G O
.
O P
Name
P T
.
T U
Replace
U \
(
\ ]
$str
] g
,
g h
$str
h j
)
j k
)
k l
;
l m
var
 
book
 
=
 
ctx
 
.
 
Ebooks
 %
.
% &
First
& +
(
+ ,
q
, -
=>
. 0
q
1 2
.
2 3
Link
3 7
==
8 :
file
; ?
)
? @
;
@ A
ctx
 
.
 
DownloadHistories
 %
.
% &
Add
& )
(
) *
new
* -
DownloadHistory
. =
(
= >
)
> ?
{
@ A
DownloadDate
A M
=
N O
DateTime
P X
.
X Y
Now
Y \
,
\ ]
User
^ b
=
c d
user
e i
,
i j
DownloadedBook
k y
=
z {
book| 
} 
) 
; 
file
 
=
 

WebUtility
 !
.
! "
	UrlDecode
" +
(
+ ,
file
, 0
)
0 1
;
1 2
var
 
url
 
=
 
$@"
 
$str
 &
{
& '
file
' +
}
+ ,
"
, -
;
- .
var
 
inf
 
=
 
new
 
FileInfo
 &
(
& '
$@"
' *
{
* +
root
+ /
}
/ 0
$str
0 8
{
8 9
file
9 =
}
= >
"
> ?
)
? @
.
@ A
Exists
A G
;
G H
if
 
(
 
inf
 
)
 
{
 
ctx
 
.
 
SaveChanges
 #
(
# $
)
$ %
;
% &
return
 
File
 
(
  
url
  #
,
# $
$str
% ?
,
? @
file
A E
)
E F
;
F G
}
 
else
 
{
 
return
 

StatusCode
 %
(
% &
$num
& )
)
) *
;
* +
}
 
}
   
catch
¡¡ 
(
¡¡ 
	Exception
¡¡ 
e
¡¡ 
)
¡¡ 
{
¢¢ 
NLog
££ 
.
££ 

LogManager
££ 
.
££  #
GetCurrentClassLogger
££  5
(
££5 6
)
££6 7
.
££7 8
Error
££8 =
(
££= >
e
££> ?
)
££? @
;
££@ A
return
¤¤ 

StatusCode
¤¤ !
(
¤¤! "
$num
¤¤" %
)
¤¤% &
;
¤¤& '
}
¥¥ 
}
¦¦ 	
[
©© 	
	Authorize
©©	 
(
©© 
Policy
©© 
=
©© 
Data
©©  
.
©©  !
S
©©! "
.
©©" #

GroupAdmin
©©# -
)
©©- .
]
©©. /
public
ªª 
async
ªª 
Task
ªª 
<
ªª 

JsonResult
ªª $
>
ªª$ %
HasRequests
ªª& 1
(
ªª1 2
[
ªª2 3
FromServices
ªª3 ?
]
ªª? @
BookDbContext
ªªA N
ctx
ªªO R
)
ªªR S
{
«« 	
try
¬¬ 
{
­­ 
if
®® 
(
®® 
User
®® 
.
®® 
Claims
®® 
.
®®  
FirstOrDefault
®®  .
(
®®. /
q
®®/ 0
=>
®®1 3
q
®®4 5
.
®®5 6
Value
®®6 ;
==
®®< >
Bia
®®? B
.
®®B C
Internal
®®C K
.
®®K L
BookLibrary
®®L W
.
®®W X
Data
®®X \
.
®®\ ]
S
®®] ^
.
®®^ _
Admin
®®_ d
)
®®d e
==
®®f h
null
®®i m
)
®®m n
{
¯¯ 
return
°° 
new
°° 

JsonResult
°° )
(
°°) *
new
°°* -
OperationResult
°°. =
(
°°= >
)
°°> ?
.
°°? @
SetFail
°°@ G
(
°°G H
)
°°H I
)
°°I J
;
°°J K
}
±± 
if
³³ 
(
³³ 
ctx
³³ 
.
³³ 
RequestBooks
³³ $
.
³³$ %
Any
³³% (
(
³³( )
)
³³) *
)
³³* +
{
´´ 
return
µµ 
new
µµ 

JsonResult
µµ )
(
µµ) *
new
µµ* -
OperationResult
µµ. =
(
µµ= >
)
µµ> ?
.
µµ? @

SetSuccess
µµ@ J
(
µµJ K
)
µµK L
)
µµL M
;
µµM N
}
¶¶ 
else
·· 
{
¸¸ 
return
¹¹ 
new
¹¹ 

JsonResult
¹¹ )
(
¹¹) *
new
¹¹* -
OperationResult
¹¹. =
(
¹¹= >
)
¹¹> ?
.
¹¹? @
SetFail
¹¹@ G
(
¹¹G H
)
¹¹H I
)
¹¹I J
;
¹¹J K
}
ºº 
}
»» 
catch
¼¼ 
(
¼¼ 
	Exception
¼¼ 
e
¼¼ 
)
¼¼ 
{
½½ 
return
¾¾ 
new
¾¾ 

JsonResult
¾¾ %
(
¾¾% &
new
¾¾& )
OperationResult
¾¾* 9
(
¾¾9 :
)
¾¾: ;
.
¾¾; <
SetFail
¾¾< C
(
¾¾C D
e
¾¾D E
)
¾¾E F
)
¾¾F G
;
¾¾G H
}
¿¿ 
}
ÀÀ 	
[
ÂÂ 	
	Authorize
ÂÂ	 
(
ÂÂ 
Policy
ÂÂ 
=
ÂÂ 
Data
ÂÂ  
.
ÂÂ  !
S
ÂÂ! "
.
ÂÂ" #

GroupAdmin
ÂÂ# -
)
ÂÂ- .
]
ÂÂ. /
public
ÃÃ 
async
ÃÃ 
Task
ÃÃ 
<
ÃÃ 

JsonResult
ÃÃ $
>
ÃÃ$ %

HasOverdue
ÃÃ& 0
(
ÃÃ0 1
[
ÃÃ1 2
FromServices
ÃÃ2 >
]
ÃÃ> ?
BookDbContext
ÃÃ@ M
ctx
ÃÃN Q
)
ÃÃQ R
{
ÄÄ 	
try
ÅÅ 
{
ÆÆ 
if
ÇÇ 
(
ÇÇ 
User
ÇÇ 
.
ÇÇ 
Claims
ÇÇ 
.
ÇÇ  
FirstOrDefault
ÇÇ  .
(
ÇÇ. /
q
ÇÇ/ 0
=>
ÇÇ1 3
q
ÇÇ4 5
.
ÇÇ5 6
Value
ÇÇ6 ;
==
ÇÇ< >
Bia
ÇÇ? B
.
ÇÇB C
Internal
ÇÇC K
.
ÇÇK L
BookLibrary
ÇÇL W
.
ÇÇW X
Data
ÇÇX \
.
ÇÇ\ ]
S
ÇÇ] ^
.
ÇÇ^ _
Admin
ÇÇ_ d
)
ÇÇd e
==
ÇÇf h
null
ÇÇi m
)
ÇÇm n
{
ÈÈ 
return
ÉÉ 
new
ÉÉ 

JsonResult
ÉÉ )
(
ÉÉ) *
new
ÉÉ* -
OperationResult
ÉÉ. =
(
ÉÉ= >
)
ÉÉ> ?
.
ÉÉ? @
SetFail
ÉÉ@ G
(
ÉÉG H
)
ÉÉH I
)
ÉÉI J
;
ÉÉJ K
}
ÊÊ 
if
ÌÌ 
(
ÌÌ 
ctx
ÌÌ 
.
ÌÌ 
RentHistories
ÌÌ %
.
ÌÌ% &
Where
ÌÌ& +
(
ÌÌ+ ,
q
ÌÌ, -
=>
ÌÌ- /
q
ÌÌ/ 0
.
ÌÌ0 1
ReturnedDate
ÌÌ1 =
==
ÌÌ= ?
null
ÌÌ? C
&&
ÌÌD F
DateTime
ÌÌG O
.
ÌÌO P
Now
ÌÌP S
.
ÌÌS T
Date
ÌÌT X
>
ÌÌY Z
q
ÌÌ[ \
.
ÌÌ\ ]
ExtendedDueDate
ÌÌ] l
)
ÌÌl m
.
ÌÌm n
Any
ÌÌn q
(
ÌÌq r
)
ÌÌr s
)
ÌÌs t
{
ÍÍ 
return
ÎÎ 
new
ÎÎ 

JsonResult
ÎÎ )
(
ÎÎ) *
new
ÎÎ* -
OperationResult
ÎÎ. =
(
ÎÎ= >
)
ÎÎ> ?
.
ÎÎ? @

SetSuccess
ÎÎ@ J
(
ÎÎJ K
)
ÎÎK L
)
ÎÎL M
;
ÎÎM N
}
ÏÏ 
else
ÐÐ 
{
ÑÑ 
return
ÒÒ 
new
ÒÒ 

JsonResult
ÒÒ )
(
ÒÒ) *
new
ÒÒ* -
OperationResult
ÒÒ. =
(
ÒÒ= >
)
ÒÒ> ?
.
ÒÒ? @
SetFail
ÒÒ@ G
(
ÒÒG H
)
ÒÒH I
)
ÒÒI J
;
ÒÒJ K
}
ÓÓ 
}
ÔÔ 
catch
ÕÕ 
(
ÕÕ 
	Exception
ÕÕ 
e
ÕÕ 
)
ÕÕ 
{
ÖÖ 
return
×× 
new
×× 

JsonResult
×× %
(
××% &
new
××& )
OperationResult
××* 9
(
××9 :
)
××: ;
.
××; <
SetFail
××< C
(
××C D
e
××D E
)
××E F
)
××F G
;
××G H
}
ØØ 
}
ÙÙ 	
}
ÚÚ 
}ÛÛ Î
^C:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Controllers\HomeController.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Controllers# .
{ 
public 

class 
HomeController 
:  !

Controller" ,
{ 
private 
Logger 
log 
; 
public 
HomeController 
( 
) 
{ 	
log 
= 
NLog 
. 

LogManager  
.  !!
GetCurrentClassLogger! 6
(6 7
)7 8
;8 9
} 	
[ 	
	Authorize	 
( 
Policy 
= 
Data  
.  !
S! "
." #
GroupCommon# .
). /
]/ 0
public 
IActionResult 
Index "
(" #
)# $
{ 	
return 
View 
( 
) 
; 
} 	
[   	
	Authorize  	 
(   
Policy   
=   
Data    
.    !
S  ! "
.  " #
GroupCommon  # .
)  . /
]  / 0
public!! 
IActionResult!! 
Arrangement!! (
(!!( )
)!!) *
{"" 	
return## 
View## 
(## 
)## 
;## 
}$$ 	
['' 	
	Authorize''	 
('' 
Policy'' 
='' 
Data''  
.''  !
S''! "
.''" #
GroupDeveloper''# 1
)''1 2
]''2 3
public)) 
IActionResult)) 
Privacy)) $
())$ %
)))% &
{** 	
return++ 
View++ 
(++ 
$str++ 
)++  
;++  !
},, 	
[.. 	
ResponseCache..	 
(.. 
Duration.. 
=..  !
$num.." #
,..# $
Location..% -
=... /!
ResponseCacheLocation..0 E
...E F
None..F J
,..J K
NoStore..L S
=..T U
true..V Z
)..Z [
]..[ \
public// 
IActionResult// 
Error// "
(//" #
)//# $
{00 	
return11 
View11 
(11 
new11 
ErrorViewModel11 *
{11+ ,
	RequestId11- 6
=117 8
Activity119 A
.11A B
Current11B I
?11I J
.11J K
Id11K M
??11N P
HttpContext11Q \
.11\ ]
TraceIdentifier11] l
}11m n
)11n o
;11o p
}22 	
}33 
}44 õ
bC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Controllers\SettingsController.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Controllers# .
{ 
public		 

class		 
SettingsController		 #
:		$ %

Controller		& 0
{

 
public 
IActionResult 
Info !
(! "
)" #
{ 	
return 
View 
( 
) 
; 
} 	
} 
} Ï§
aC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Controllers\VisitorController.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Controllers# .
{ 
public 

class 
VisitorController "
:# $

Controller% /
{ 
private 
Logger 
log 
; 
public 
VisitorController  
(  !
)! "
{ 	
log 
= 

LogManager 
. !
GetCurrentClassLogger 2
(2 3
)3 4
;4 5
} 	
public 
IActionResult 
Books "
(" #
[# $
FromServices$ 0
]0 1
BookDbContext2 ?
ctx@ C
)C D
{ 	
var 
books 
= 
ctx 
. 

PaperBooks &
.& '
OrderBy' .
(. /
q/ 0
=>1 3
q4 5
.5 6
TakenByUser6 A
)A B
.B C
ThenByC I
(I J
qJ K
=>L N
qO P
.P Q
TitleQ V
)V W
.W X
ToListX ^
(^ _
)_ `
;` a
return 
View 
( 
$str 
,  
books! &
)& '
;' (
} 	
public   
IActionResult   
Ebooks   #
(  # $
[  $ %
FromServices  % 1
]  1 2
BookDbContext  3 @
ctx  A D
)  D E
{!! 	
var"" 
books"" 
="" 
ctx"" 
."" 
Ebooks"" "
.""" #
ToList""# )
("") *
)""* +
;""+ ,
ViewBag## 
.## 
First## 
=## 
ctx## 
.##  
Arrangements##  ,
.##, -
Any##- 0
(##0 1
q##1 2
=>##3 5
q##6 7
.##7 8
AppUser##8 ?
.##? @
	LoginName##@ I
==##J L
User##M Q
.##Q R
Identity##R Z
.##Z [
Name##[ _
.##_ `
Replace##` g
(##g h
$str##h r
,##r s
$str##s u
)##u v
)##v w
;##w x
return$$ 
View$$ 
($$ 
$str$$ 
,$$  
books$$! &
)$$& '
;$$' (
}%% 	
['' 	
HttpGet''	 
]'' 
public(( 
IActionResult(( 
Book(( !
(((! "
[((" #
FromServices((# /
]((/ 0
BookDbContext((1 >
ctx((? B
,((B C
int((D G
id((H J
)((J K
{)) 	
var++ 
book++ 
=++ 
ctx++ 
.++ 
Books++  
.++  !
FirstOrDefault++! /
(++/ 0
q++0 1
=>++2 4
q++5 6
.++6 7
BiaId++7 <
==++= ?
id++@ B
)++B C
;++C D
if,, 
(,, 
book,, 
==,, 
null,, 
),, 
{-- 
return.. 
View.. 
(.. 
$str.. #
)..# $
;..$ %
}// 
if11 
(11 
book11 
is11 
Ebook11 
)11 
{22 
if33 
(33 
!33 
ctx33 
.33 
Arrangements33 $
.33$ %
Any33% (
(33( )
q33) *
=>33+ -
q33. /
.33/ 0
AppUser330 7
.337 8
	LoginName338 A
==33B D
User33E I
.33I J
Identity33J R
.33R S
Name33S W
.33W X
Replace33X _
(33_ `
$str33` j
,33j k
$str33l n
)33n o
)33o p
)33p q
{44 
return55 
LocalRedirect55 (
(55( )
$str55) :
)55: ;
;55; <
}66 
}77 
return99 
View99 
(99 
$str99 %
,99% &
book99' +
)99+ ,
;99, -
}:: 	
public== 
async== 
Task== 
<== 

JsonResult== $
>==$ %
RentBook==& .
(==. /
[==/ 0
FromServices==0 <
]==< =
BookDbContext==> K
ctx==L O
,==O P
[==Q R
FromServices==R ^
]==^ _
EmailService==` l
email==m r
,==r s
[==t u
FromBody==u }
]==} ~
int	== 
model
== 
)
== 
{>> 	
var?? 
result?? 
=?? 
new?? 
OperationResult?? ,
(??, -
)??- .
;??. /
tryAA 
{BB 
varCC 
userUidCC 
=CC 
UserCC "
.CC" #
IdentityCC# +
.CC+ ,
NameCC, 0
.CC0 1
ReplaceCC1 8
(CC8 9
$strCC9 C
,CCC D
$strCCE G
)CCG H
;CCH I
varDD 
bookIdDD 
=DD 
modelDD "
;DD" #
varEE 
dateEE 
=EE 
DateTimeEE #
.EE# $
NowEE$ '
;EE' (
varGG 
bookGG 
=GG 
ctxGG 
.GG 
BooksGG $
.GG$ %
FirstOrDefaultGG% 3
(GG3 4
qGG4 5
=>GG6 8
qGG9 :
.GG: ;
BiaIdGG; @
==GGA C
bookIdGGD J
)GGJ K
;GGK L
varHH 
userHH 
=HH 
ctxHH 
.HH 
AppUsersHH '
.HH' (
FirstHH( -
(HH- .
qHH. /
=>HH0 2
qHH3 4
.HH4 5
	LoginNameHH5 >
==HH? A
userUidHHB I
)HHI J
;HHJ K
ifJJ 
(JJ 
ctxJJ 
.JJ 

PaperBooksJJ "
.JJ" #
FirstJJ# (
(JJ( )
qJJ) *
=>JJ+ -
qJJ. /
.JJ/ 0
BiaIdJJ0 5
==JJ6 8
bookIdJJ9 ?
)JJ? @
.JJ@ A
TakenByUserJJA L
!=JJM O
nullJJP T
)JJT U
{KK 
returnLL 
JsonLL 
(LL  
newLL  #
OperationResultLL$ 3
(LL3 4
)LL4 5
.LL5 6
SetFailLL6 =
(LL= >
$strLL> Y
)LLY Z
)LLZ [
;LL[ \
}MM 
elseNN 
{OO 
ifPP 
(PP 
ctxPP 
.PP 
RequestBooksPP (
.PP( )
AnyPP) ,
(PP, -
qPP- .
=>PP/ 1
qPP2 3
.PP3 4

AppUserUidPP4 >
==PP? A
userPPB F
.PPF G
UidPPG J
&&PPK M
qPPN O
.PPO P
BookIdPPP V
==PPW Y
bookPPZ ^
.PP^ _
BiaIdPP_ d
)PPd e
)PPe f
{QQ 
returnRR 
JsonRR #
(RR# $
newRR$ '
OperationResultRR( 7
(RR7 8
)RR8 9
.RR9 :

SetSuccessRR: D
(RRD E
)RRE F
)RRF G
;RRG H
}SS 
varUU 
requestUU 
=UU  !
newUU" %
RequestBookUU& 1
(UU1 2
)UU2 3
{UU4 5

AppUserUidUU6 @
=UUA B
userUUC G
.UUG H
UidUUH K
,UUK L
BookIdUUM S
=UUT U
bookUUV Z
.UUZ [
BiaIdUU[ `
,UU` a
DateUUb f
=UUg h
DateTimeUUi q
.UUq r
NowUUr u
}UUv w
;UUw x
ctxVV 
.VV 
RequestBooksVV $
.VV$ %
AddVV% (
(VV( )
requestVV) 0
)VV0 1
;VV1 2
ctxWW 
.WW 
SaveChangesWW #
(WW# $
)WW$ %
;WW% &
logXX 
.XX 
InfoXX 
(XX 
$"XX 
{XX  
UserXX  $
.XX$ %
IdentityXX% -
.XX- .
NameXX. 2
}XX2 3
$strXX3 D
{XXD E
bookXXE I
.XXI J
BiaIdXXJ O
}XXO P
"XXP Q
)XXQ R
;XXR S
var[[ 
admins[[ 
=[[  
ctx[[! $
.[[$ %
AdminNotifies[[% 2
.[[2 3
Where[[3 8
([[8 9
q[[9 :
=>[[; =
q[[> ?
.[[? @
NotifyId[[@ H
==[[I K
AdminNotifyTypes[[L \
.[[\ ]
General[[] d
)[[d e
.[[e f
Select[[f l
([[l m
q[[m n
=>[[o q
q[[r s
.[[s t
Admin[[t y
)[[y z
;[[z {
if]] 
(]] 
!]] 
string]] 
.]]  
IsNullOrWhiteSpace]]  2
(]]2 3
user]]3 7
.]]7 8
Email]]8 =
)]]= >
)]]> ?
{^^ 
var__ 
config__ "
=__# $
new__% (
	Extension__) 2
.__2 3
MailConfiguration__3 D
(__D E
)__E F
{`` 
UserNameaa $
=aa% &
useraa' +
.aa+ ,
	FirstNameaa, 5
,aa5 6
BookIDbb "
=bb# $
requestbb% ,
.bb, -
BookIdbb- 3
,bb3 4
	BookTitlecc %
=cc& '
requestcc( /
.cc/ 0
Bookcc0 4
.cc4 5
Titlecc5 :
}dd 
;dd 
varee 
messageee #
=ee$ %
newee& )
MimeMessageee* 5
(ee5 6
)ee6 7
.ee7 8"
UserRequestMailMessageee8 N
(eeN O
configeeO U
)eeU V
;eeV W
messageff 
.ff  
Fromff  $
.ff$ %
Addff% (
(ff( )
newff) ,
MailboxAddressff- ;
(ff; <
Sff< =
.ff= >
MailBotff> E
)ffE F
)ffF G
;ffG H
messagegg 
.gg  
Togg  "
.gg" #
Addgg# &
(gg& '
newgg' *
MailboxAddressgg+ 9
(gg9 :
usergg: >
.gg> ?
Emailgg? D
)ggD E
)ggE F
;ggF G
emailhh 
.hh 
Sendhh "
(hh" #
messagehh# *
)hh* +
;hh+ ,
configjj 
=jj  
newjj! $
	Extensionjj% .
.jj. /
MailConfigurationjj/ @
(jj@ A
)jjA B
{kk 
UserNamell $
=ll% &
userll' +
.ll+ ,
	FirstNamell, 5
,ll5 6
BookIDmm "
=mm# $
requestmm% ,
.mm, -
BookIdmm- 3
,mm3 4
	BookTitlenn %
=nn& '
requestnn( /
.nn/ 0
Booknn0 4
.nn4 5
Titlenn5 :
}oo 
;oo 
ifqq 
(qq 
adminsqq "
.qq" #
Anyqq# &
(qq& '
)qq' (
)qq( )
{rr 
messagess #
=ss$ %
newss& )
MimeMessagess* 5
(ss5 6
)ss6 7
.ss7 8
AdminRequestMessagess8 K
(ssK L
configssL R
)ssR S
;ssS T
messagett #
.tt# $
Fromtt$ (
.tt( )
Addtt) ,
(tt, -
newtt- 0
MailboxAddresstt1 ?
(tt? @
Stt@ A
.ttA B
MailBotttB I
)ttI J
)ttJ K
;ttK L
foreachuu #
(uu$ %
varuu% (
adminuu) .
inuu/ 1
adminsuu2 8
)uu8 9
{vv 
messageww  '
.ww' (
Toww( *
.ww* +
Addww+ .
(ww. /
newww/ 2
MailboxAddressww3 A
(wwA B
adminwwB G
.wwG H
EmailwwH M
)wwM N
)wwN O
;wwO P
}xx 
emailyy !
.yy! "
Sendyy" &
(yy& '
messageyy' .
)yy. /
;yy/ 0
}zz 
}{{ 
else|| 
{}} 
if~~ 
(~~ 
admins~~ "
.~~" #
Any~~# &
(~~& '
)~~' (
)~~( )
{ 
var
 
message
  '
=
( )
new
* -
MimeMessage
. 9
(
9 :
)
: ;
;
; <
message
 #
.
# $
From
$ (
.
( )
Add
) ,
(
, -
new
- 0
MailboxAddress
1 ?
(
? @
S
@ A
.
A B
MailBot
B I
)
I J
)
J K
;
K L
foreach
 #
(
$ %
var
% (
admin
) .
in
/ 1
admins
2 8
)
8 9
{
 
message
  '
.
' (
To
( *
.
* +
Add
+ .
(
. /
new
/ 2
MailboxAddress
3 A
(
A B
admin
B G
.
G H
Email
H M
)
M N
)
N O
;
O P
}
 
message
 #
.
# $
Subject
$ +
=
, -
$str
. F
;
F G
message
 #
.
# $
Body
$ (
=
) *
new
+ .
TextPart
/ 7
(
7 8
)
8 9
{
 
Text
  $
=
% &
$"
' )
{
) *
user
* .
.
. /
	LoginName
/ 8
}
8 9
$str9 
" 
}
 
;
 
email
 !
.
! "
Send
" &
(
& '
message
' .
)
. /
;
/ 0
}
 
}
 
return
 
Json
 
(
  
new
  #
OperationResult
$ 3
(
3 4
)
4 5
.
5 6

SetSuccess
6 @
(
@ A
)
A B
)
B C
;
C D
}
 
}
 
catch
 
(
 
	Exception
 
ex
 
)
  
{
 
return
 
Json
 
(
 
new
 
OperationResult
  /
(
/ 0
)
0 1
.
1 2
SetFail
2 9
(
9 :
ex
: <
)
< =
)
= >
;
> ?
}
 
}
 	
public
 
async
 
Task
 
<
 

JsonResult
 $
>
$ %
DeclineRent
& 1
(
1 2
[
2 3
FromServices
3 ?
]
? @
BookDbContext
A N
ctx
O R
,
R S
[
T U
FromBody
U ]
]
] ^
int
_ b
bookId
c i
)
i j
{
 	
var
 
result
 
=
 
new
 
OperationResult
 ,
(
, -
)
- .
;
. /
try
 
{
 
var
 
userUid
 
=
 
User
 "
.
" #
Identity
# +
.
+ ,
Name
, 0
.
0 1
Replace
1 8
(
8 9
$str
9 C
,
C D
$str
E G
)
G H
;
H I
var
 
book
 
=
 
ctx
 
.
 
Books
 $
.
$ %
FirstOrDefault
% 3
(
3 4
q
4 5
=>
6 8
q
9 :
.
: ;
BiaId
; @
==
A C
bookId
D J
)
J K
;
K L
var
   
user
   
=
   
ctx
   
.
   
AppUsers
   '
.
  ' (
First
  ( -
(
  - .
q
  . /
=>
  0 2
q
  3 4
.
  4 5
	LoginName
  5 >
==
  ? A
userUid
  B I
)
  I J
;
  J K
var
¡¡ 
req
¡¡ 
=
¡¡ 
ctx
¡¡ 
.
¡¡ 
RequestBooks
¡¡ *
.
¡¡* +
FirstOrDefault
¡¡+ 9
(
¡¡9 :
q
¡¡: ;
=>
¡¡< >
q
¡¡? @
.
¡¡@ A
AppUser
¡¡A H
==
¡¡I K
user
¡¡L P
&&
¡¡Q S
q
¡¡T U
.
¡¡U V
Book
¡¡V Z
==
¡¡[ ]
book
¡¡^ b
)
¡¡b c
;
¡¡c d
if
¢¢ 
(
¢¢ 
req
¢¢ 
!=
¢¢ 
null
¢¢ 
)
¢¢  
{
££ 
ctx
¤¤ 
.
¤¤ 
RequestBooks
¤¤ $
.
¤¤$ %
Remove
¤¤% +
(
¤¤+ ,
req
¤¤, /
)
¤¤/ 0
;
¤¤0 1
ctx
¥¥ 
.
¥¥ 
SaveChanges
¥¥ #
(
¥¥# $
)
¥¥$ %
;
¥¥% &
return
¦¦ 
Json
¦¦ 
(
¦¦  
new
¦¦  #
OperationResult
¦¦$ 3
(
¦¦3 4
)
¦¦4 5
.
¦¦5 6

SetSuccess
¦¦6 @
(
¦¦@ A
)
¦¦A B
)
¦¦B C
;
¦¦C D
}
§§ 
}
¨¨ 
catch
©© 
(
©© 
	Exception
©© 
ex
©© 
)
©©  
{
ªª 
return
«« 
Json
«« 
(
«« 
new
«« 
OperationResult
««  /
(
««/ 0
)
««0 1
.
««1 2
SetFail
««2 9
(
««9 :
ex
««: <
)
««< =
)
««= >
;
««> ?
}
¬¬ 
return
­­ 
Json
­­ 
(
­­ 
new
­­ 
OperationResult
­­ +
(
­­+ ,
)
­­, -
.
­­- .
SetFail
­­. 5
(
­­5 6
)
­­6 7
)
­­7 8
;
­­8 9
}
®® 	
public
°° 
async
°° 
Task
°° 
<
°° 

JsonResult
°° $
>
°°$ % 
ConfirmArrangement
°°& 8
(
°°8 9
[
°°9 :
FromServices
°°: F
]
°°F G
BookDbContext
°°H U
ctx
°°V Y
,
°°Y Z
[
°°[ \
FromBody
°°\ d
]
°°d e
dynamic
°°f m
model
°°n s
)
°°s t
{
±± 	
var
²² 
result
²² 
=
²² 
new
²² 
OperationResult
²² ,
(
²², -
)
²²- .
;
²². /
try
³³ 
{
´´ 
var
µµ 
check
µµ 
=
µµ 
(
µµ 
bool
µµ !
)
µµ! "
model
µµ# (
.
µµ( )
Checked
µµ) 0
;
µµ0 1
var
¶¶ 
user
¶¶ 
=
¶¶ 
ctx
¶¶ 
.
¶¶ 
AppUsers
¶¶ '
.
¶¶' (
First
¶¶( -
(
¶¶- .
q
¶¶. /
=>
¶¶0 2
q
¶¶3 4
.
¶¶4 5
	LoginName
¶¶5 >
==
¶¶? A
User
¶¶B F
.
¶¶F G
Identity
¶¶G O
.
¶¶O P
Name
¶¶P T
.
¶¶T U
Replace
¶¶U \
(
¶¶\ ]
$str
¶¶] g
,
¶¶g h
$str
¶¶i k
)
¶¶k l
)
¶¶l m
;
¶¶m n
if
·· 
(
·· 
!
·· 
ctx
·· 
.
·· 
Arrangements
·· $
.
··$ %
Any
··% (
(
··( )
q
··) *
=>
··* ,
q
··, -
.
··- .

AppUserUid
··. 8
==
··8 :
user
··: >
.
··> ?
Uid
··? B
)
··B C
)
··C D
ctx
¸¸ 
.
¸¸ 
Arrangements
¸¸  
.
¸¸  !
Add
¸¸! $
(
¸¸$ %
new
¸¸% (
Arrangement
¸¸) 4
(
¸¸4 5
)
¸¸5 6
{
¹¹ 

AppUserUid
ºº 
=
ºº  
user
ºº! %
.
ºº% &
Uid
ºº& )
,
ºº) *
Date
»» 
=
»» 
DateTime
»» #
.
»»# $
Now
»»$ '
}
¼¼ 
)
¼¼ 
;
¼¼ 
ctx
¾¾ 
.
¾¾ 
SaveChanges
¾¾ 
(
¾¾  
)
¾¾  !
;
¾¾! "
return
¿¿ 
Json
¿¿ 
(
¿¿ 
new
¿¿ 
OperationResult
¿¿  /
(
¿¿/ 0
)
¿¿0 1
.
¿¿1 2

SetSuccess
¿¿2 <
(
¿¿< =
)
¿¿= >
)
¿¿> ?
;
¿¿? @
}
ÀÀ 
catch
ÁÁ 
(
ÁÁ 
	Exception
ÁÁ 
ex
ÁÁ 
)
ÁÁ  
{
ÂÂ 
return
ÃÃ 
Json
ÃÃ 
(
ÃÃ 
new
ÃÃ 
OperationResult
ÃÃ  /
(
ÃÃ/ 0
)
ÃÃ0 1
.
ÃÃ1 2
SetFail
ÃÃ2 9
(
ÃÃ9 :
ex
ÃÃ: <
)
ÃÃ< =
)
ÃÃ= >
;
ÃÃ> ?
}
ÄÄ 
}
ÆÆ 	
}
ÈÈ 
}ÉÉ §B
NC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Extensions.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
{		 
public

 

static

 
class

 

Extensions

 "
{ 
public 
static 
IEnumerable !
<! "

RentedBook" ,
>, -
ToRentedBooks. ;
(; <
this< @
IEnumerableA L
<L M
	PaperBookM V
>V W
booksX ]
)] ^
{ 	
var 
result 
= 
new 
List !
<! "

RentedBook" ,
>, -
(- .
). /
;/ 0
foreach 
( 
var 
book 
in  
books! &
)& '
{ 
var 
rent 
= 
book 
.  
RentHistory  +
.+ ,
OrderBy, 3
(3 4
q4 5
=>5 7
q7 8
.8 9
	TakenDate9 B
)B C
.C D
FirstD I
(I J
)J K
;K L
result 
. 
Add 
( 
new 

RentedBook )
() *
)* +
{ 
BiaId 
= 
book  
.  !
BiaId! &
,& '
Title 
= 
book  
.  !
Title! &
,& '
User 
= 
book 
.  
TakenByUser  +
?+ ,
., -
	LoginName- 6
,6 7

EndRenting 
=  
book! %
.% &
TakenDue& .
.. /
GetValueOrDefault/ @
(@ A
)A B
,B C
StartRenting  
=! "
rent# '
.' (
	TakenDate( 1
,1 2
} 
) 
; 
} 
return 
result 
; 
} 	
public 
static 
string 
GenerateLink )
() *
this* .
string/ 5
str6 9
)9 :
{   	
return%% 
str%% 
.%% 
Split%% 
(%% 
$char%% !
)%%! "
.%%" #
Last%%# '
(%%' (
)%%( )
;%%) *
}&& 	
public(( 
static(( 
UserBookViewModel(( '
ToUserBookViewModel((( ;
(((; <
this((< @
Book((A E
book((F J
)((J K
{)) 	
var** 
result** 
=** 
new** 
UserBookViewModel** .
(**. /
)**/ 0
{++ 
Isbn,, 
=,, 
book,, 
.,, 
Isbn,,  
,,,  !
BiaId-- 
=-- 
book-- 
.-- 
BiaId-- "
,--" #
Title.. 
=.. 
book.. 
... 
Title.. "
,.." #
Subtitle// 
=// 
book// 
.//  
Subtitle//  (
,//( )
Language00 
=00 
book00 
.00  
Language00  (
,00( )
Year11 
=11 
book11 
.11 
Year11  
,11  !
Edition22 
=22 
book22 
.22 
Edition22 &
,22& '
Pages33 
=33 
book33 
.33 
Pages33 "
,33" #

CoverImage44 
=44 
book44 !
.44! "

CoverImage44" ,
,44, -

Annotation55 
=55 
book55 !
.55! "

Annotation55" ,
,55, -
}66 
;66 
result77 
.77 
Authors77 
=77 
new77  
List77! %
<77% &
AuthorViewModel77& 5
>775 6
(776 7
)777 8
;778 9
foreach88 
(88 
var88 
author88 
in88  "
book88# '
.88' (
Authors88( /
)88/ 0
{99 
result:: 
.:: 
Authors:: 
.:: 
Add:: "
(::" #
new::# &
AuthorViewModel::' 6
(::6 7
)::7 8
{;; 
}== 
)== 
;== 
}>> 
result?? 
.?? 
Cathegories?? 
=??  
new??! $
List??% )
<??) *
CategoryViewModel??* ;
>??; <
(??< =
)??= >
;??> ?
result@@ 
.@@ 
Reviews@@ 
=@@ 
new@@  
List@@! %
<@@% &
ReviewViewModel@@& 5
>@@5 6
(@@6 7
)@@7 8
;@@8 9
returnBB 
resultBB 
;BB 
}CC 	
publicEE 
staticEE 
intEE 
SumCurrentRatingEE *
(EE* +
thisEE+ /
BookEE0 4
bookEE5 9
)EE9 :
{FF 	
varGG 
ratingGG 
=GG 
bookGG 
.GG 
ReviewsGG %
.GG% &
SelectGG& ,
(GG, -
qGG- .
=>GG/ 1
qGG2 3
.GG3 4
RatingGG4 :
)GG: ;
;GG; <
varHH 
currHH 
=HH 
ratingHH 
.HH 
SumHH !
(HH! "
)HH" #
;HH# $
varII 
countII 
=II 
ratingII 
.II 
CountII $
(II$ %
)II% &
;II& '
currJJ 
=JJ 
(JJ 
currJJ 
>JJ 
$numJJ 
)JJ 
?JJ 
currJJ  $
/JJ$ %
countJJ% *
:JJ+ ,
$numJJ- .
;JJ/ 0
returnKK 
currKK 
;KK 
}LL 	
publicNN 
staticNN 
stringNN 
FullNameNN %
(NN% &
thisNN& *
AuthorNN+ 1
authorNN2 8
)NN8 9
{OO 	
ifPP 
(PP 
stringPP 
.PP 
IsNullOrEmptyPP $
(PP$ %
authorPP% +
.PP+ ,

MiddleNamePP, 6
)PP6 7
)PP7 8
{QQ 
returnRR 
$"RR 
{RR 
authorRR  
.RR  !
	FirstNameRR! *
}RR* +
$strRR+ ,
{RR, -
authorRR- 3
.RR3 4
LastNameRR4 <
}RR< =
"RR= >
;RR> ?
}SS 
returnTT 
$"TT 
{TT 
authorTT 
.TT 
	FirstNameTT &
}TT& '
$strTT' (
{TT( )
authorTT) /
.TT/ 0

MiddleNameTT0 :
}TT: ;
$strTT; <
{TT< =
authorTT= C
.TTC D
LastNameTTD L
}TTL M
"TTM N
;TTN O
}UU 	
publicWW 
staticWW 
stringWW 
InitialsWW %
(WW% &
thisWW& *
AuthorWW+ 1
authorWW2 8
)WW8 9
{XX 	
ifYY 
(YY 
stringYY 
.YY 
IsNullOrEmptyYY $
(YY$ %
authorYY% +
.YY+ ,

MiddleNameYY, 6
)YY6 7
)YY7 8
{ZZ 
return[[ 
$"[[ 
{[[ 
author[[  
.[[  !
	FirstName[[! *
[[[* +
$num[[+ ,
][[, -
}[[- .
$str[[. 0
{[[0 1
author[[1 7
.[[7 8
LastName[[8 @
}[[@ A
"[[A B
;[[B C
}\\ 
return]] 
$"]] 
{]] 
author]] 
.]] 
	FirstName]] &
[]]& '
$num]]' (
]]]( )
}]]) *
$str]]* +
{]]+ ,
author]], 2
.]]2 3

MiddleName]]3 =
[]]= >
$num]]> ?
]]]? @
}]]@ A
$str]]A C
{]]C D
author]]D J
.]]J K
LastName]]K S
}]]S T
"]]T U
;]]U V
}^^ 	
}`` 
}aa ø
sC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Extentions\ActiveDirectoryUserNotFoundException.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
{ 
[ 
Serializable 
] 
public 

class 0
$ActiveDirectoryUserNotFoundException 5
:6 7
	Exception8 A
{ 
public		 0
$ActiveDirectoryUserNotFoundException		 3
(		3 4
)		4 5
:		6 7
base		8 <
(		< =
)		= >
{

 	
} 	
public 0
$ActiveDirectoryUserNotFoundException 3
(3 4
string4 :
message; B
)B C
:D E
baseF J
(J K
messageK R
)R S
{ 	
} 	
public 0
$ActiveDirectoryUserNotFoundException 3
(3 4
string4 :
message; B
,B C
	ExceptionD M
innerExceptionN \
)\ ]
:^ _
base` d
(d e
messagee l
,l m
innerExceptionn |
)| }
{ 	
} 	
	protected 0
$ActiveDirectoryUserNotFoundException 6
(6 7
SerializationInfo7 H
infoI M
,M N
StreamingContextO _
context` g
)g h
:i j
basek o
(o p
infop t
,t u
contextv }
)} ~
{ 	
} 	
public 
override 
string 
Message &
=>' )
base* .
.. /
Message/ 6
.6 7
Equals7 =
(= >
string> D
.D E
EmptyE J
)J K
?L M
$strN w
:x y
basez ~
.~ 
Message	 
;
 
} 
} Æ
WC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Extentions\AdHelper.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
{

 
public 

static 
class 
AdHelper  
{ 
public 
static 
AppUser &
NewUserFromActiveDirectory 8
(8 9
this9 =
AppUser> E
userF J
,J K
stringK Q
usernameR Z
)Z [
{ 	
using 
( 
var 
context 
=  
new! $
PrincipalContext% 5
(5 6
ContextType6 A
.A B
DomainB H
,H I
EnvironmentJ U
.U V"
GetEnvironmentVariableV l
(l m
$strm y
)y z
??{ }
Environment	~ 
.
 $
GetEnvironmentVariable
  
(
  ¡
$str
¡ «
)
« ¬
)
¬ ­
)
­ ®
{ 
using 
( 
var 
searcher #
=$ %
new& )
PrincipalSearcher* ;
(; <
new< ?
UserPrincipal@ M
(M N
contextN U
)U V
)V W
)W X
{ 
searcher 
. 
QueryFilter (
.( )
SamAccountName) 7
=8 9
username: B
;B C
var 
adInfo 
=  
(! "
UserPrincipal" /
)/ 0
searcher0 8
.8 9
FindOne9 @
(@ A
)A B
;B C
if 
( 
adInfo 
== !
null" &
)& '
{ 
throw 
new !0
$ActiveDirectoryUserNotFoundException" F
(F G
)G H
;H I
}   
user"" 
."" 
Uid"" 
="" 
adInfo"" %
.""% &
Guid""& *
??""+ -
Guid"". 2
.""2 3
NewGuid""3 :
("": ;
)""; <
;""< =
user## 
.## 
Email## 
=##  
adInfo##! '
.##' (
EmailAddress##( 4
;##4 5
user$$ 
.$$ 
IsActive$$ !
=$$" #
adInfo$$$ *
.$$* +
Enabled$$+ 2
??$$3 5
true$$6 :
;$$: ;
user%% 
.%% 
	FirstName%% "
=%%# $
adInfo%%% +
.%%+ ,
	GivenName%%, 5
;%%5 6
user&& 
.&& 
LastName&& !
=&&" #
adInfo&&$ *
.&&* +
Surname&&+ 2
;&&2 3
user'' 
.'' 
FullName'' !
=''" #
adInfo''$ *
.''* +
DisplayName''+ 6
;''6 7
user(( 
.(( 

DateJoined(( #
=(($ %
DateTime((& .
.((. /
Now((/ 2
;((2 3
user)) 
.)) 
	LoginName)) "
=))# $
username))% -
;))- .
return++ 
user++ 
;++  
},, 
}-- 
}.. 	
}// 
}00 ¾`
gC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Middleware\LocalAuthorityMiddleware.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #

Middleware# -
{ 
public 

class $
LocalAuthorityMiddleware )
{ 
private 
readonly 
RequestDelegate (
_next) .
;. /
private 
readonly 
ILogger  
_log! %
;% &
private 
readonly 
IConfiguration '
_config( /
;/ 0
public $
LocalAuthorityMiddleware '
(' (
RequestDelegate( 7
next8 <
,< =
ILogger> E
<E F$
LocalAuthorityMiddlewareF ^
>^ _
log` c
,c d
IConfigurationf t
configuration	u 
)
 
{ 	
_next 
= 
next 
; 
_log 
= 
log 
; 
_config 
= 
configuration '
;' (
} 	
public 
async 
Task 
Invoke  
(  !
HttpContext! ,
context- 4
,4 5
BookDbContext6 C
ctxD G
)G H
{ 	
try 
{ 
_log   
.   
LogDebug   
(   
$str   @
)  @ A
;  A B
if"" 
("" 
context"" 
."" 
User""  
.""  !
Identity""! )
."") *
IsAuthenticated""* 9
)""9 :
{## 
_log$$ 
.$$ 
LogDebug$$ !
($$! "
$"$$" $
$str$$$ K
{$$K L
context$$L S
.$$S T
User$$T X
.$$X Y
Identity$$Y a
.$$a b
Name$$b f
}$$f g
$str$$g h
"$$h i
)$$i j
;$$j k
string&& 
sam&& 
;&& 
try'' 
{(( 
sam)) 
=)) 
context)) %
.))% &
User))& *
.))* +
Identity))+ 3
.))3 4
Name))4 8
.))8 9
Split))9 >
())> ?
$char))? C
)))C D
[))D E
$num))E F
]))F G
;))G H
}** 
catch++ 
(++ $
IndexOutOfRangeException++ 3
)++3 4
{,, 
sam-- 
=-- 
context-- %
.--% &
User--& *
.--* +
Identity--+ 3
.--3 4
Name--4 8
;--8 9
}.. 
var// 
us// 
=// 
ctx//  
.//  !
AppUsers//! )
.//) *
Where//* /
(/// 0
res//0 3
=>//4 6
res//7 :
.//: ;
	LoginName//; D
==//E G
sam//H K
)//K L
;//L M
var00 
dbUser00 
=00  
us00! #
.00# $
SingleOrDefault00$ 3
(003 4
)004 5
;005 6
if11 
(11 
dbUser11 
==11 !
null11" &
)11& '
{22 
_log33 
.33 

LogWarning33 '
(33' (
$str33( Q
)33Q R
;33R S
AppUser44 
user44  $
;44$ %
AccessGroupId55 %
AccessGroup55& 1
;551 2
var66 
claims66 "
=66# $
new66% (
List66) -
<66- .
Claim66. 3
>663 4
(664 5
)665 6
;666 7
if77 
(77 
_config77 #
[77# $
$str77$ 1
]771 2
.772 3
Split773 8
(778 9
$char779 <
)77< =
.77= >
Any77> A
(77A B
dev77B E
=>77F H
dev77I L
.77L M
Contains77M U
(77U V
sam77V Y
)77Y Z
)77Z [
)77[ \
{88 
user99  
=99! "
new99# &
Admin99' ,
(99, -
)99- .
;99. /
AccessGroup:: '
=::( )
AccessGroupId::* 7
.::7 8
	Developer::8 A
;::A B
claims;; "
.;;" #
Add;;# &
(;;& '
new;;' *
Claim;;+ 0
(;;0 1
Data;;1 5
.;;5 6
S;;6 7
.;;7 8
AccessLevelClaim;;8 H
,;;H I
AccessGroupId;;J W
.;;W X
	Developer;;X a
.;;a b
ToString;;b j
(;;j k
);;k l
);;l m
);;m n
;;;n o
}<< 
else== 
if== 
(==  !
_config==! (
[==( )
$str==) 8
]==8 9
.==9 :
Split==: ?
(==? @
$char==@ C
)==C D
.==D E
Any==E H
(==H I
adm==I L
=>==M O
adm==P S
.==S T
Contains==T \
(==\ ]
sam==] `
)==` a
)==a b
)==b c
{>> 
user??  
=??! "
new??# &
Admin??' ,
(??, -
)??- .
;??. /
AccessGroup@@ '
=@@( )
AccessGroupId@@* 7
.@@7 8
Admin@@8 =
;@@= >
claimsAA "
.AA" #
AddAA# &
(AA& '
newAA' *
ClaimAA+ 0
(AA0 1
DataAA1 5
.AA5 6
SAA6 7
.AA7 8
AccessLevelClaimAA8 H
,AAH I
AccessGroupIdAAJ W
.AAW X
AdminAAX ]
.AA] ^
ToStringAA^ f
(AAf g
)AAg h
)AAh i
)AAi j
;AAj k
}BB 
elseCC 
{DD 
AccessGroupEE '
=EE( )
AccessGroupIdEE* 7
.EE7 8
CommonEE8 >
;EE> ?
userFF  
=FF! "
newFF# &
AppUserFF' .
(FF. /
)FF/ 0
;FF0 1
claimsGG "
.GG" #
AddGG# &
(GG& '
newGG' *
ClaimGG+ 0
(GG0 1
DataGG1 5
.GG5 6
SGG6 7
.GG7 8
AccessLevelClaimGG8 H
,GGH I
AccessGroupIdGGJ W
.GGW X
CommonGGX ^
.GG^ _
ToStringGG_ g
(GGg h
)GGh i
)GGi j
)GGj k
;GGk l
}HH 
tryJJ 
{KK 
dbUserLL "
=LL# $
userLL% )
.LL) *&
NewUserFromActiveDirectoryLL* D
(LLD E
samLLE H
)LLH I
;LLI J
contextNN #
.NN# $
ItemsNN$ )
[NN) *
$strNN* 3
]NN3 4
=NN5 6
dbUserNN7 =
;NN= >
}OO 
catchPP 
(PP 0
$ActiveDirectoryUserNotFoundExceptionPP C
exPPD F
)PPF G
{QQ 
_logRR  
.RR  !

LogWarningRR! +
(RR+ ,
exRR, .
,RR. /
$"RR0 2
$strRR2 7
{RR7 8
contextRR8 ?
.RR? @
UserRR@ D
.RRD E
IdentityRRE M
.RRM N
NameRRN R
}RRR S
$strRRS c
"RRc d
)RRd e
;RRe f
contextSS #
.SS# $
ItemsSS$ )
[SS) *
$strSS* 8
]SS8 9
=SS: ;
contextSS< C
.SSC D
RequestSSD K
.SSK L
PathSSL P
.SSP Q
ValueSSQ V
;SSV W
contextTT #
.TT# $
RequestTT$ +
.TT+ ,
PathTT, 0
=TT1 2
$strTT3 J
;TTJ K
awaitUU !
_nextUU" '
(UU' (
contextUU( /
)UU/ 0
;UU0 1
returnVV "
;VV" #
}WW 
dbUserZZ 
.ZZ 
AccessGroupZZ *
=ZZ+ ,
AccessGroupZZ- 8
;ZZ8 9
foreach[[ 
([[  !
var[[! $
claim[[% *
in[[+ -
claims[[. 4
)[[4 5
{\\ 
(]] 
(]] 
ClaimsIdentity]] ,
)]], -
context]]. 5
.]]5 6
User]]6 :
.]]: ;
Identity]]; C
)]]C D
.]]D E
AddClaim]]E M
(]]M N
claim]]N S
)]]S T
;]]T U
}^^ 
ctx`` 
.`` 
AppUsers`` $
.``$ %
Add``% (
(``( )
dbUser``) /
)``/ 0
;``0 1
ctxaa 
.aa 
SaveChangesaa '
(aa' (
)aa( )
;aa) *
_logbb 
.bb 
LogTracebb %
(bb% &
$strbb& Q
)bbQ R
;bbR S
awaitcc 
ctxcc !
.cc! "
SaveChangesAsynccc" 2
(cc2 3
)cc3 4
;cc4 5
awaitee 
_nextee #
(ee# $
contextee$ +
)ee+ ,
;ee, -
}ff 
elsegg 
{hh 
ifii 
(ii 
!ii 
dbUserii #
.ii# $
IsActiveii$ ,
)ii, -
{jj 
contextkk #
.kk# $
Itemskk$ )
[kk) *
$strkk* 8
]kk8 9
=kk: ;
contextkk< C
.kkC D
RequestkkD K
.kkK L
PathkkL P
.kkP Q
ValuekkQ V
;kkV W
contextll #
.ll# $
Requestll$ +
.ll+ ,
Pathll, 0
=ll1 2
$strll3 J
;llJ K
awaitmm !
_nextmm" '
(mm' (
contextmm( /
)mm/ 0
;mm0 1
}nn 
elseoo 
ifoo 
(oo  !
dbUseroo! '
.oo' (
AccessGroupoo( 3
!=oo4 6
$numoo7 8
)oo8 9
{pp 
varqq 
claimsqq  &
=qq' (
(qq) *
dbUserqq* 0
.qq0 1
AccessGroupqq1 <
)qq< =
.qq= >
GetClaimsValuesqq> M
(qqM N
)qqN O
;qqO P
(rr 
(rr 
ClaimsIdentityrr ,
)rr, -
contextrr- 4
.rr4 5
Userrr5 9
.rr9 :
Identityrr: B
)rrB C
.rrC D
	AddClaimsrrD M
(rrM N
claimsrrN T
)rrT U
;rrU V
contexttt #
.tt# $
Itemstt$ )
[tt) *
$strtt* 3
]tt3 4
=tt5 6
dbUsertt7 =
;tt= >
_logvv  
.vv  !

LogWarningvv! +
(vv+ ,
$"vv, .
$strvv. U
{vvU V
contextvvV ]
.vv] ^
Uservv^ b
.vvb c
Identityvvc k
.vvk l
Namevvl p
}vvp q
$strvvq w
"vvw x
)vvx y
;vvy z
}ww 
awaitxx 
_nextxx #
(xx# $
contextxx$ +
)xx+ ,
;xx, -
}yy 
}zz 
else{{ 
{|| 
_log}} 
.}} 
LogTrace}} !
(}}! "
$"}}" $
$str}}$ T
{}}T U
context}}U \
.}}\ ]
User}}] a
.}}a b
Identity}}b j
.}}j k
Name}}k o
}}}o p
"}}p q
)}}q r
;}}r s
await~~ 
_next~~ 
(~~  
context~~  '
)~~' (
;~~( )
} 
}
 
catch
 
(
 
	Exception
 
ex
 
)
  
when
! %
(
& '
!
' (
System
( .
.
. /
Diagnostics
/ :
.
: ;
Debugger
; C
.
C D

IsAttached
D N
)
N O
{
 
_log
 
.
 
LogError
 
(
 
ex
  
,
  !
$str
" C
)
C D
;
D E
await
 
_next
 
(
 
context
 #
)
# $
;
$ %
}
 
}
 	
}
 
} ¹$
VC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\AddBookForm.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
.		" #
Models		# )
{

 
[ 
DataContract 
] 
[ 
Serializable 
] 
public 

class 
AddBookForm 
{ 
[ 	

DataMember	 
( 
Name 
= 
$str "
)" #
]# $
public 
int 
Id 
{ 
get 
; 
set  
;  !
}" #
[ 	

DataMember	 
( 
Name 
= 
$str "
)" #
]# $
public 
string 
Title 
{ 
get !
;! "
set# &
;& '
}( )
[ 	

DataMember	 
( 
Name 
= 
$str %
)% &
]& '
public 
string 
Subtitle 
{  
get! $
;$ %
set& )
;) *
}+ ,
[ 	

DataMember	 
( 
Name 
= 
$str '
)' (
]( )
public 
string 

Annotation  
{! "
get# &
;& '
set( +
;+ ,
}- .
[ 	

DataMember	 
( 
Name 
= 
$str !
)! "
]" #
public 
string 
Isbn 
{ 
get  
;  !
set" %
;% &
}' (
[ 	

DataMember	 
( 
Name 
= 
$str !
)! "
]" #
public 
string 
Link 
{ 
get  
;  !
set" %
;% &
}' (
[ 	

DataMember	 
( 
Name 
= 
$str '
)' (
]( )
public 
string 

CoverImage  
{! "
get# &
;& '
set( +
;+ ,
}- .
[ 	

DataMember	 
( 
Name 
= 
$str !
)! "
]" #
public 
int 
? 
Year 
{ 
get 
; 
set  #
;# $
}% &
[   	

DataMember  	 
(   
Name   
=   
$str   "
)  " #
]  # $
public!! 
int!! 
?!! 
Pages!! 
{!! 
get!! 
;!!  
set!!! $
;!!$ %
}!!& '
["" 	

DataMember""	 
("" 
Name"" 
="" 
$str"" $
)""$ %
]""% &
public## 
int## 
?## 
Edition## 
{## 
get## !
;##! "
set### &
;##& '
}##( )
[$$ 	

DataMember$$	 
($$ 
Name$$ 
=$$ 
$str$$ &
)$$& '
]$$' (
public%% 
bool%% 
	PaperBook%% 
{%% 
get%%  #
;%%# $
set%%% (
;%%( )
}%%* +
[&& 	

DataMember&&	 
(&& 
Name&& 
=&& 
$str&& %
)&&% &
]&&& '
public'' 

LanguageId'' 
Language'' "
{''# $
get''% (
;''( )
set''* -
;''- .
}''/ 0
[(( 	

DataMember((	 
((( 
Name(( 
=(( 
$str(( $
)(($ %
]((% &
public)) 
IEnumerable)) 
<)) 
Guid)) 
>))  
Authors))! (
{))) *
get))+ .
;)). /
set))0 3
;))3 4
}))5 6
[** 	

DataMember**	 
(** 
Name** 
=** 
$str** (
)**( )
]**) *
public++ 
IEnumerable++ 
<++ 
int++ 
>++ 

Categories++  *
{+++ ,
get++- 0
;++0 1
set++2 5
;++5 6
}++7 8
},, 
}-- ²
YC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\AddReviewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 
AddReviewModel 
{		 
public

 
int

 
BookId

 
{

 
get

 
;

  
set

! $
;

$ %
}

& '
public 
int 
Rating 
{ 
get 
;  
set! $
;$ %
}& '
public 
string 
Text 
{ 
get  
;  !
set" %
;% &
}' (
} 
} ï

ZC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\AuthorViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 
AuthorViewModel  
{		 
public

 
Guid

 
AuthoUid

 
{

 
get

 "
;

" #
set

$ '
;

' (
}

) *
public 
string 
	FirstName 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
LastName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 

MiddleName  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
string 
FullName 
{ 	
get 
{ 
return 
$" 
{ 
	FirstName #
}# $
$str$ %
{% &

MiddleName& 0
}0 1
$str1 2
{2 3
LastName3 ;
}; <
"< =
;= >
} 
} 	
} 
} ­
\C:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\CategoryViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 
CategoryViewModel "
{		 
public

 
int

 

CategoryId

 
{

 
get

  #
;

# $
set

% (
;

( )
}

* +
public 
string 
CategoryName "
{# $
get% (
;( )
set* -
;- .
}/ 0
} 
} ä
YC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\EBookViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 
EBookViewModel 
:  
UserBookViewModel  1
{		 
public

 
string

 
Format

 
{

 
get

 "
;

" #
set

$ '
;

' (
}

) *
public 
string 
Size 
{ 
get  
;  !
set" %
;% &
}' (
public 
string 
Link 
{ 
get  
;  !
set" %
;% &
}' (
} 
} ë
YC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\ErrorViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 
ErrorViewModel 
{ 
public 
string 
	RequestId 
{  !
get" %
;% &
set' *
;* +
}, -
public		 
bool		 
ShowRequestId		 !
=>		" $
!		% &
string		& ,
.		, -
IsNullOrEmpty		- :
(		: ;
	RequestId		; D
)		D E
;		E F
}

 
} 
]C:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\PaperBookViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 
PaperBookViewModel #
:# $
UserBookViewModel$ 5
{		 
public

 
bool

 
Rented

 
{

 
get

  
;

  !
set

" %
;

% &
}

' (
public 
User 
User 
{ 
get 
; 
set  #
;# $
}% &
public 
DateTime 
StartRenting $
{% &
get' *
;* +
set, /
;/ 0
}1 2
public 
DateTime 

EndRenting "
{# $
get% (
;( )
set* -
;- .
}/ 0
} 
} ¼
UC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\RentedBook.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 

RentedBook 
{		 
public

 
int

 
BiaId

 
{

 
get

 
;

 
set

  #
;

# $
}

% &
public 
string 
Title 
{ 
get !
;! "
set" %
;% &
}& '
public 
string 
User 
{ 
get  
;  !
set" %
;% &
}' (
public 
DateTime 
StartRenting $
{% &
get' *
;* +
set, /
;/ 0
}1 2
public 
DateTime 

EndRenting "
{# $
get% (
;( )
set* -
;- .
}/ 0
public 

RentStatus 
Status  
{ 	
get 
{ 
return 
( 

EndRenting "
<=" $
DateTime$ ,
., -
Today- 2
)2 3
?3 4

RentStatus5 ?
.? @
Early@ E
:E F

RentStatusG Q
.Q R
LateR V
;V W
} 
} 	
} 
public 

enum 

RentStatus 
{ 
Early 
, 
Late 
} 
} è
ZC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\ReviewViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public		 

class		 
ReviewViewModel		  
{

 
public 
Guid 
	ReviewUid 
{ 
get  #
;# $
set% (
;( )
}* +
public 
string 
Book 
{ 
get  
;  !
set" %
;% &
}' (
public 
string 
Review 
{ 
get "
;" #
set$ '
;' (
}) *
public 
User 
User 
{ 
get 
; 
set  #
;# $
}% &
public 
int 
Rating 
{ 
get 
;  
set! $
;$ %
}& '
} 
} ì
\C:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\SettingsViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public		 

class		 
SettingsViewModel		 "
{

 
public 
IEnumerable 
< 
AppUser "
>" #
Users$ )
{* +
get, /
;/ 0
set1 4
;4 5
}6 7
public 
IEnumerable 
< 
Author !
>! "
Authors# *
{+ ,
get- 0
;0 1
set2 5
;5 6
}7 8
public 
IEnumerable 
< 
Category #
># $

Categories% /
{0 1
get2 5
;5 6
set7 :
;: ;
}< =
} 
} 
OC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\User.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public		 

class		 
User		 
{

 
public 
string 
FullName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
ImageUrl 
{  
get! $
;$ %
set& )
;) *
}+ ,
} 
} $
\C:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\UserBookViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{		 
public

 

class

 
UserBookViewModel

 "
{ 
[ 	
Display	 
( 
Name 
= 
$str 
) 
]  
public 
string 
Isbn 
{ 
get  
;  !
set" %
;% &
}' (
[ 	
Display	 
( 
Name 
= 
$str 
) 
] 
public 
int 
BiaId 
{ 
get 
; 
set  #
;# $
}% &
[ 	
Display	 
( 
Name 
= 
$str "
)" #
]# $
public 
string 
Title 
{ 
get !
;! "
set# &
;& '
}( )
[ 	
Display	 
( 
Name 
= 
$str &
)& '
]' (
public 
string 
Subtitle 
{  
get! $
;$ %
set& )
;) *
}+ ,
[ 	
Display	 
( 
Name 
= 
$str 
) 
]  
public 

LanguageId 
Language "
{# $
get% (
;( )
set* -
;- .
}/ 0
[ 	
Display	 
( 
Name 
= 
$str  
)  !
]! "
public 
ICollection 
< 
AuthorViewModel *
>* +
Authors, 3
{4 5
get6 9
;9 :
set; >
;> ?
}@ A
[ 	
Display	 
( 
Name 
= 
$str #
)# $
]$ %
public 
ICollection 
< 
CategoryViewModel ,
>, -
Cathegories. 9
{: ;
get< ?
;? @
setA D
;D E
}F G
[!! 	
Display!!	 
(!! 
Name!! 
=!! 
$str!!  
)!!  !
]!!! "
public"" 
ICollection"" 
<"" 
ReviewViewModel"" *
>""* +
Reviews"", 3
{""4 5
get""6 9
;""9 :
set""; >
;""> ?
}""@ A
[$$ 	
Display$$	 
($$ 
Name$$ 
=$$ 
$str$$ 
)$$ 
]$$ 
public%% 
int%% 
?%% 
Year%% 
{%% 
get%% 
;%% 
set%%  #
;%%# $
}%%% &
['' 	
Display''	 
('' 
Name'' 
='' 
$str'' !
)''! "
]''" #
public(( 
int(( 
?(( 
Edition(( 
{(( 
get(( !
;((! "
set((# &
;((& '
}((( )
[** 	
Display**	 
(** 
Name** 
=** 
$str** 
)** 
]**  
public++ 
int++ 
?++ 
Pages++ 
{++ 
get++ 
;++  
set++! $
;++$ %
}++& '
[-- 	
Display--	 
(-- 
Name-- 
=-- 
$str-- !
)--! "
]--" #
public.. 
string.. 

CoverImage..  
{..! "
get..# &
;..& '
set..( +
;..+ ,
}..- .
[00 	
Display00	 
(00 
Name00 
=00 
$str00 "
)00" #
]00# $
public11 
string11 

Annotation11  
{11! "
get11# &
;11& '
set11( +
;11+ ,
}11- .
[33 	
Display33	 
(33 
Name33 
=33 
$str33 !
)33! "
]33" #
public44 
int44 
AverageRating44  
{44! "
get44# &
;44& '
set44( +
;44+ ,
}44- .
}66 
}77 Ä
SC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\OperationResult.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
{

 
public 

class 
OperationResult  
{ 
public 
string 
Status 
{ 
get "
;" #
set$ '
;' (
}) *
public 
string 
Details 
{ 
get  #
;# $
set% (
;( )
}* +
public 
string 
ExceptionData #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 
	Exception 
	Exception "
=># %
GetException& 2
(2 3
)3 4
;4 5
private 
	Exception 

_exception $
;$ %
public 
	Exception 
GetException %
(% &
)& '
{ 	
if 
( 
ExceptionData 
==  
null! %
)% &
return 
null 
; 
return   

_exception   
??    
SetException  ! -
(  - .
)  . /
;  / 0
}!! 	
public## 
OperationResult## 

SetSuccess## )
(##) *
string##* 0
details##1 8
=##8 9
null##9 =
)##= >
{$$ 	
Status%% 
=%% 
$str%% 
;%% 
if&& 
(&& 
!&& 
string&& 
.&& 
IsNullOrEmpty&& %
(&&% &
details&&& -
)&&- .
)&&. /
{'' 
Details(( 
=(( 
details(( !
;((! "
})) 
return** 
this** 
;** 
}++ 	
public-- 
OperationResult-- 
SetFail-- &
(--& '
string--' -
details--. 5
)--5 6
{.. 	
Status// 
=// 
$str// 
;// 
Details00 
=00 
details00 
;00 
return11 
this11 
;11 
}22 	
public44 
OperationResult44 
SetFail44 &
(44& '
	Exception44' 0
ex441 3
=444 5
null446 :
)44: ;
{55 	
Status66 
=66 
$str66 
;66 
if77 
(77 
ex77 
!=77 
null77 
)77 
{88 
Details99 
=99 
ex99 
.99 
Message99 $
;99$ %
}:: 
return;; 
this;; 
;;; 
}<< 	
private>> 
	Exception>> 
SetException>> &
(>>& '
)>>' (
{?? 	
try@@ 
{AA 
usingBB 
(BB 
varBB 
streamBB !
=BB" #
newBB$ '
MemoryStreamBB( 4
(BB4 5
ConvertBB5 <
.BB< =
FromBase64StringBB= M
(BBM N
ExceptionDataBBN [
)BB[ \
)BB\ ]
)BB] ^
{CC 

_exceptionDD 
=DD  
(DD! "
	ExceptionDD" +
)DD+ ,
newDD, /
BinaryFormatterDD0 ?
(DD? @
)DD@ A
.DDA B
DeserializeDDB M
(DDM N
streamDDN T
)DDT U
;DDU V
returnEE 

_exceptionEE %
;EE% &
}FF 
}GG 
catchHH 
{II 
returnJJ 
nullJJ 
;JJ 
}KK 
}LL 	
}MM 
}NN ¿
KC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Program.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
{ 
public 

class 
Program 
{ 
public 
static 
void 
Main 
(  
string  &
[& '
]' (
args) -
)- .
{ 	
var 
_log 
= 
NLog 
. 

LogManager &
.& '
LoadConfiguration' 8
(8 9
S9 :
.: ;

NLogConfig; E
)E F
.F G!
GetCurrentClassLoggerG \
(\ ]
)] ^
;^ _
_log 
. 
Debug 
( 
$str 
) 
; 
try 
{ 
_log 
. 
Info 
( 
$str -
)- .
;. / 
CreateWebHostBuilder $
($ %
args% )
)) *
.* +
Build+ 0
(0 1
)1 2
.2 3
Run3 6
(6 7
)7 8
;8 9
} 
catch 
( 
	Exception 
ex 
)  
{ 
_log 
. 
Error 
( 
ex 
, 
$str B
)B C
;C D
throw 
; 
} 
finally   
{!! 
NLog## 
.## 

LogManager## 
.##  
Shutdown##  (
(##( )
)##) *
;##* +
}$$ 
}%% 	
public'' 
static'' 
IWebHostBuilder'' % 
CreateWebHostBuilder''& :
('': ;
string''; A
[''A B
]''B C
args''D H
)''H I
=>''J L
WebHost(( 
.((  
CreateDefaultBuilder(( (
(((( )
args(() -
)((- .
.)) 

UseStartup)) 
<)) 
Startup)) #
>))# $
())$ %
)))% &
.** 
UseNLog** 
(** 
)** 
;** 
}++ 
},, Õ
EC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\S.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
{ 
public		 

class		 
S		 
{

 
public 
const 
string 

NLogConfig &
=' (
$str) 6
;6 7
public 
static 
void 
Initializate '
(' (
IConfiguration( 6
configuration7 D
)D E
{ 	
MailUser 
= 
configuration $
.$ %

GetSection% /
(/ 0
$str0 :
): ;
.; <
Get< ?
<? @
string@ F
>F G
(G H
)H I
;I J
MailPassword 
= 
configuration (
.( )

GetSection) 3
(3 4
$str4 B
)B C
.C D
GetD G
<G H
stringH N
>N O
(O P
)P Q
;Q R
MailBot 
= 
configuration #
.# $

GetSection$ .
(. /
$str/ :
): ;
.; <
Get< ?
<? @
string@ F
>F G
(G H
)H I
;I J
MailHost 
= 
configuration $
.$ %

GetSection% /
(/ 0
$str0 <
)< =
.= >
Get> A
<A B
stringB H
>H I
(I J
)J K
;K L
} 	
public 
static 
string 
MailHost %
=& '
$str( 8
;8 9
public 
static 
string 
MailBot $
=% &
$str' >
;> ?
public 
static 
string 
MailUser %
=& '
$str( 7
;7 8
public 
static 
string 
MailPassword )
=* +
$str, <
;< =
public   
const   
int   
MaxBook    
=  ! "
$num  # %
;  % &
}!! 
}"" @
KC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Startup.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
{ 
public 

class 
Startup 
{ 
public 
Startup 
( 
IConfiguration %
configuration& 3
)3 4
{ 	
Configuration 
= 
configuration )
;) *
S 
. 
Initializate 
( 
configuration (
)( )
;) *
} 	
public!! 
IConfiguration!! 
Configuration!! +
{!!, -
get!!. 1
;!!1 2
}!!3 4
public$$ 
async$$ 
void$$ 
ConfigureServices$$ +
($$+ ,
IServiceCollection$$, >
services$$? G
)$$G H
{%% 	
services&& 
.&& 
	Configure&& 
<&& 
CookiePolicyOptions&& 2
>&&2 3
(&&3 4
options&&4 ;
=>&&< >
{'' 
options)) 
.)) 
CheckConsentNeeded)) *
=))+ ,
context))- 4
=>))5 7
true))8 <
;))< =
options** 
.** !
MinimumSameSitePolicy** -
=**. /
SameSiteMode**0 <
.**< =
None**= A
;**A B
}++ 
)++ 
;++ 
services99 
.99 
AddDbContext99 !
<99! "
BookDbContext99" /
>99/ 0
(990 1
options991 8
=>999 ;
options99< C
.99C D
UseMySql99D L
(99L M
Configuration:: "
.::" #
GetConnectionString::# 6
(::6 7
Data::7 ;
.::; <
S::< =
.::= > 
ConnectionStringName::> R
)::R S
,::S T
optionsBuilder;; #
=>;;$ &
optionsBuilder;;' 5
.;;5 6
MigrationsAssembly;;6 H
(;;H I
typeof;;I O
(;;O P
BookDbContext;;P ]
);;] ^
.;;^ _
	Namespace;;_ h
);;h i
);;i j
)<< 
;<< 
servicesAA 
.AA 
AddTransientAA !
(AA! "
qAA" #
=>AA$ &
newAA' *
EmailServiceAA+ 7
(AA7 8
SAA8 9
.AA9 :
MailHostAA: B
,AAB C
SAAD E
.AAE F
MailUserAAF N
,AAN O
SAAP Q
.AAQ R
MailPasswordAAR ^
)AA^ _
)AA_ `
;AA` a
servicesCC 
.CC 
AddDetectionCoreCC %
(CC% &
)CC& '
.CC' (

AddBrowserCC( 2
(CC2 3
)CC3 4
;CC4 5
servicesEE 
.EE 
AddMvcEE 
(EE 
)EE 
.EE #
SetCompatibilityVersionEE 5
(EE5 6 
CompatibilityVersionEE6 J
.EEJ K
Version_2_2EEK V
)EEV W
;EEW X
servicesFF 
.FF 
AddAuthenticationFF &
(FF& '
	MicrosoftFF' 0
.FF0 1

AspNetCoreFF1 ;
.FF; <
ServerFF< B
.FFB C
IISIntegrationFFC Q
.FFQ R
IISDefaultsFFR ]
.FF] ^ 
AuthenticationSchemeFF^ r
)FFr s
;FFs t
servicesGG 
.GG 
AddAuthorizationGG %
(GG% &
optionsGG& -
=>GG. 0
{HH 
optionsII 
.II 
	AddPolicyII !
(II! "
DataII" &
.II& '
SII' (
.II( )
GroupDeveloperII) 7
,II7 8
policyII9 ?
=>II@ B
policyIIC I
.III J
RequireClaimIIJ V
(IIV W
DataIIW [
.II[ \
SII\ ]
.II] ^
AccessLevelClaimII^ n
,IIn o
newIIp s
[IIs t
]IIt u
{IIv w
DataIIx |
.II| }
SII} ~
.II~ 
	Developer	II 
}
II 
)
II 
)
II 
;
II 
optionsJJ 
.JJ 
	AddPolicyJJ !
(JJ! "
DataJJ" &
.JJ& '
SJJ' (
.JJ( )

GroupAdminJJ) 3
,JJ3 4
policyJJ5 ;
=>JJ< >
policyJJ? E
.JJE F
RequireClaimJJF R
(JJR S
DataJJS W
.JJW X
SJJX Y
.JJY Z
AccessLevelClaimJJZ j
,JJj k
newJJl o
[JJo p
]JJp q
{JJr s
DataJJt x
.JJx y
SJJy z
.JJz {
Admin	JJ{ 
}
JJ 
)
JJ 
)
JJ 
;
JJ 
optionsKK 
.KK 
	AddPolicyKK !
(KK! "
DataKK" &
.KK& '
SKK' (
.KK( )
GroupCommonKK) 4
,KK4 5
policyKK6 <
=>KK= ?
policyKK@ F
.KKF G
RequireClaimKKG S
(KKS T
DataKKT X
.KKX Y
SKKY Z
.KKZ [
AccessLevelClaimKK[ k
,KKk l
newKKm p
[KKp q
]KKq r
{KKs t
DataKKu y
.KKy z
SKKz {
.KK{ |
Common	KK| 
}
KK 
)
KK 
)
KK 
;
KK 
}MM 
)MM 
;MM 
}NN 	
publicQQ 
asyncQQ 
voidQQ 
	ConfigureQQ #
(QQ# $
IApplicationBuilderQQ$ 7
appQQ8 ;
,QQ; <
IHostingEnvironmentQQ= P
envQQQ T
)QQT U
{RR 	
ifTT 
(TT 
envTT 
.TT 
IsDevelopmentTT !
(TT! "
)TT" #
)TT# $
{UU 
appVV 
.VV %
UseDeveloperExceptionPageVV -
(VV- .
)VV. /
;VV/ 0
}XX 
elseYY 
{ZZ 
app[[ 
.[[ 
UseExceptionHandler[[ '
([[' (
$str[[( 3
)[[3 4
;[[4 5
app]] 
.]] 
UseHsts]] 
(]] 
)]] 
;]] 
}^^ 
appcc 
.cc 
UseHttpsRedirectioncc #
(cc# $
)cc$ %
;cc% &
appdd 
.dd 
UseStaticFilesdd 
(dd 
)dd  
;dd  !
appgg 
.gg 
UseMiddlewaregg 
<gg $
LocalAuthorityMiddlewaregg 6
>gg6 7
(gg7 8
)gg8 9
;gg9 :
appii 
.ii 
UseMvcii 
(ii 
routesii 
=>ii  
{jj 
routeskk 
.kk 
MapRoutekk 
(kk  
namell 
:ll 
$strll #
,ll# $
templatemm 
:mm 
$strmm F
)mmF G
;mmG H
}nn 
)nn 
;nn 
}oo 	
privateqq 
staticqq 
voidqq 
UpdateDatabaseqq *
(qq* +
IApplicationBuilderqq+ >
appqq? B
)qqB C
{rr 	
usingtt 
(tt 
vartt 
serviceScopett #
=tt$ %
apptt& )
.tt) *
ApplicationServicestt* =
.uu 
GetRequiredServiceuu #
<uu# $ 
IServiceScopeFactoryuu$ 8
>uu8 9
(uu9 :
)uu: ;
.vv 
CreateScopevv 
(vv 
)vv 
)vv 
{ww 
usingxx 
(xx 
varxx 
contextxx "
=xx# $
serviceScopexx% 1
.xx1 2
ServiceProviderxx2 A
.xxA B

GetServicexxB L
<xxL M
BookDbContextxxM Z
>xxZ [
(xx[ \
)xx\ ]
)xx] ^
{yy 
contextzz 
.zz 
Databasezz $
.zz$ %
Migratezz% ,
(zz, -
)zz- .
;zz. /
}{{ 
}|| 
}}} 	
}~~ 
} 
lC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ViewComponents\BooksActionsViewComponent.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
.		" #
ViewComponents		# 1
{

 
public 

class %
BooksActionsViewComponent *
:+ ,
ViewComponent- :
{ 
private 
BookDbContext 
_ctx "
;" #
public %
BooksActionsViewComponent (
(( )
BookDbContext) 6
ctx7 :
): ;
{ 	
_ctx 
= 
ctx 
; 
} 	
public  
IViewComponentResult #
Invoke$ *
(* +
int+ .
id/ 1
)1 2
{ 	
var 
book 
= 
_ctx 
. 
Books !
.! "
FirstOrDefault" 0
(0 1
b1 2
=>3 5
b6 7
.7 8
BiaId8 =
==> @
idA C
)C D
;D E
if 
( 
book 
is 
Ebook 
) 
{ 
var 
ebook 
= 
book  
as! #
Ebook$ )
;) *
return 
View 
( 
$str <
,< =
new> A
EBookViewModelB P
(P Q
)Q R
{S T
BiaIdU Z
=[ \
id] _
,_ `
Linka e
=f g
ebookh m
.m n
Linkn r
}r s
)s t
;t u
} 
if 
( 
book 
is 
	PaperBook !
)! "
{ 
var 
paper 
= 
book  
as! #
	PaperBook$ -
;- .
return   
View   
(   
$str   A
,  A B
paper  C H
)  H I
;  I J
}!! 
return## 
View## 
(## 
$str## 7
)##7 8
;##8 9
}$$ 	
}%% 
}&& ä	
pC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ViewComponents\BrowserDetectionViewComponent.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
.		" #
ViewComponents		# 1
{

 
public 

class )
BrowserDetectionViewComponent .
:. /
ViewComponent0 =
{ 
public  
IViewComponentResult #
Invoke$ *
(* +
)+ ,
{ 	
var 
type 
= 
Request 
. 
Browser &
(& '
)' (
.( )
Type) -
;- .
if 
( 
type 
!= 
BrowserType #
.# $
Chrome$ *
&&+ -
type. 2
!=3 5
BrowserType6 A
.A B
OperaB G
)G H
{ 
return 
View 
( 
$str 0
)0 1
;1 2
} 
return 
View 
( 
$str )
)) *
;* +
} 	
} 
} ­	
iC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ViewComponents\CathegoryViewComponent.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
.		" #
ViewComponents		# 1
{

 
public 

class "
CathegoryViewComponent '
:( )
ViewComponent* 7
{ 
private 
BookDbContext 
_ctx "
;" #
public "
CathegoryViewComponent %
(% &
BookDbContext& 3
ctx4 7
)7 8
{ 	
_ctx 
= 
ctx 
; 
} 	
public  
IViewComponentResult #
Invoke$ *
(* +
)+ ,
{ 	
var 
all 
= 
_ctx 
. 

Categories %
.% &
ToList& ,
(, -
)- .
;. /
return 
View 
( 
$str 8
,8 9
all: =
)= >
;> ?
} 	
} 
} Û;
uC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ViewComponents\CustomSelectListItemsViewComponent.cs
	namespace

 	
Bia


 
.

 
Internal

 
.

 
BookLibrary

 "
.

" #
ViewComponents

# 1
{ 
public 

class .
"CustomSelectListItemsViewComponent 3
:3 4
ViewComponent5 B
{ 
private 
BookDbContext 
_ctx "
;" #
public .
"CustomSelectListItemsViewComponent 1
(1 2
BookDbContext2 ?
ctx@ C
)C D
{ 	
_ctx 
= 
ctx 
; 
} 	
public  
IViewComponentResult #
Invoke$ *
(* + 
ViewComponentContext+ ?
context@ G
)G H
{ 	
switch 
( 
context 
. 
Method "
." #
ToLower# *
(* +
)+ ,
), -
{ 
case 
$str 
: 
return  &
Authors' .
(. /
context/ 6
.6 7
Id7 9
)9 :
;: ;
case 
$str  
:  !
return" (
	Cathegory) 2
(2 3
context3 :
.: ;
Id; =
)= >
;> ?
default 
: 
return 
null  $
;$ %
} 
} 	
private  
IViewComponentResult $
Authors% ,
(, -
int- 0
id1 3
)3 4
{   	
var!! 
all!! 
=!! 
_ctx!! 
.!! 
Authors!! "
;!!" #
var"" 
checkedAuthors"" 
=""  
_ctx""! %
.""% &
BookAuthors""& 1
.""1 2
Where""2 7
(""7 8
q""8 9
=>"": <
q""= >
.""> ?
BookId""? E
==""F H
id""I K
)""K L
.## 
Join## 
(## 
all## 
,## 
ba## 
=>##  
ba##! #
.### $
	AuthorUid##$ -
,##- .
a##/ 0
=>##1 3
a##4 5
.##5 6
	AuthorUid##6 ?
,##? @
(##A B
ba##B D
,##D E
a##E F
)##F G
=>##H J
a##K L
)##L M
.$$ 
ToList$$ 
($$ 
)$$ 
;$$ 
if&& 
(&& 
all&& 
.&& 
Any&& 
(&& 
)&& 
)&& 
{'' 
var(( 
top(( 
=(( 
new(( 
List(( "
<((" #
SelectListItem((# 1
>((1 2
(((2 3
)((3 4
;((4 5
foreach)) 
()) 
var)) 
cur))  
in))! #
all))$ '
)))' (
{** 
var++ 
current++ 
=++  !
new++" %
SelectListItem++& 4
(++4 5
)++5 6
{,, 
Text-- 
=-- 
cur-- "
.--" #
FullName--# +
(--+ ,
)--, -
,--- .
Value.. 
=.. 
cur..  #
...# $
	AuthorUid..$ -
...- .
ToString... 6
(..6 7
)..7 8
,..8 9
Selected//  
=//! "
checkedAuthors//# 1
.//1 2
Contains//2 :
(//: ;
cur//; >
)//> ?
}00 
;00 
top11 
.11 
Add11 
(11 
current11 #
)11# $
;11$ %
}22 
return44 
View44 
(44 
$str44 <
,44< =
top44> A
)44A B
;44B C
}55 
else66 
{77 
return88 
View88 
(88 
$str88 <
,88< =
new88> A
List88B F
<88F G
SelectListItem88G U
>88U V
(88V W
)88W X
)88X Y
;88Y Z
}99 
};; 	
private==  
IViewComponentResult== $
	Cathegory==% .
(==. /
int==/ 2
id==3 5
)==5 6
{>> 	
var?? 
all?? 
=?? 
_ctx?? 
.?? 

Categories?? %
;??% &
var@@ 
checekCategories@@  
=@@! "
_ctx@@# '
.@@' (
BookCategories@@( 6
.@@6 7
Where@@7 <
(@@< =
q@@= >
=>@@? A
q@@B C
.@@C D
BookId@@D J
==@@K M
id@@N P
)@@P Q
.AA 
JoinAA 
(AA 
allAA 
,AA 
baAA 
=>AA  
baAA! #
.AA# $

CategoryIdAA$ .
,AA. /
aAA0 1
=>AA2 4
aAA5 6
.AA6 7

CategoryIdAA7 A
,AAA B
(AAC D
baAAD F
,AAF G
aAAH I
)AAI J
=>AAK M
aAAN O
)AAO P
.BB 
ToListBB 
(BB 
)BB 
;BB 
ifDD 
(DD 
allDD 
.DD 
AnyDD 
(DD 
)DD 
)DD 
{EE 
varFF 
topFF 
=FF 
newFF 
ListFF "
<FF" #
SelectListItemFF# 1
>FF1 2
(FF2 3
)FF3 4
;FF4 5
foreachGG 
(GG 
varGG 
curGG  
inGG! #
allGG$ '
)GG' (
{HH 
varII 
currentII 
=II  !
newII" %
SelectListItemII& 4
(II4 5
)II5 6
{JJ 
TextKK 
=KK 
curKK "
.KK" #
CategoryNameKK# /
,KK/ 0
ValueLL 
=LL 
curLL  #
.LL# $

CategoryIdLL$ .
.LL. /
ToStringLL/ 7
(LL7 8
)LL8 9
,LL9 :
SelectedMM  
=MM! "
checekCategoriesMM# 3
.MM3 4
ContainsMM4 <
(MM< =
curMM= @
)MM@ A
}NN 
;NN 
topOO 
.OO 
AddOO 
(OO 
currentOO #
)OO# $
;OO$ %
}PP 
returnQQ 
ViewQQ 
(QQ 
$strQQ <
,QQ< =
topQQ> A
)QQA B
;QQB C
}RR 
elseSS 
{TT 
returnUU 
ViewUU 
(UU 
$strUU <
,UU< =
newUU> A
ListUUB F
<UUF G
SelectListItemUUG U
>UUU V
(UUV W
)UUW X
)UUX Y
;UUY Z
}VV 
}WW 	
}YY 
public]] 

class]]  
ViewComponentContext]] %
{^^ 
public__ 
string__ 
Method__ 
{__ 
get__ "
;__" #
set__$ '
;__' (
}__) *
public`` 
int`` 
Id`` 
{`` 
get`` 
;`` 
set``  
;``  !
}``" #
publicaa 
stringaa 
[aa 
]aa 
Argsaa 
{aa 
getaa "
;aa" #
setaa$ '
;aa' (
}aa) *
}bb 
}cc 
eC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ViewComponents\ModalViewComponent.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
.		" #
ViewComponents		# 1
{

 
public 

class 
ModalViewComponent #
:$ %
ViewComponent& 3
{ 
private 
BookDbContext 
_ctx "
;" #
public 
ModalViewComponent !
(! "
BookDbContext" /
ctx0 3
)3 4
{ 	
_ctx 
= 
ctx 
; 
} 	
public  
IViewComponentResult #
Invoke$ *
(* +
string+ 1
str2 5
)5 6
{ 	
switch 
( 
str 
) 
{ 
case 
$str 
: 
return  &
View' +
(+ ,
$str, A
)A B
;B C
case 
$str  
:  !
return" (
View) -
(- .
$str. E
)E F
;F G
case 
$str !
:! "
return# )
View* .
(. /
$str/ G
)G H
;H I
case 
$str #
:# $
return% +
View, 0
(0 1
$str1 K
)K L
;L M
case 
$str #
:# $
return% +
View, 0
(0 1
$str1 K
)K L
;L M
case 
$str  
:  !
return" (
View) -
(- .
$str. E
)E F
;F G
case 
$str #
:# $
return% +
View, 0
(0 1
$str1 K
)K L
;L M
case 
$str 
:  
return! '
View( ,
(, -
$str- C
)C D
;D E
case   
$str   )
:  ) *
return  + 1
View  2 6
(  6 7
$str  7 W
)  W X
;  X Y
default!! 
:!! 
return!! 
null!!  $
;!!$ %
}"" 
}## 	
}$$ 
}%% ¨.
oC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ViewComponents\SelectListItemsViewComponent.cs
	namespace

 	
Bia


 
.

 
Internal

 
.

 
BookLibrary

 "
.

" #
ViewComponents

# 1
{ 
public 

class (
SelectListItemsViewComponent -
:. /
ViewComponent0 =
{ 
private 
BookDbContext 
_ctx "
;" #
public (
SelectListItemsViewComponent +
(+ ,
BookDbContext, 9
ctx: =
)= >
{ 	
_ctx 
= 
ctx 
; 
} 	
public  
IViewComponentResult #
Invoke$ *
(* +
string+ 1
str2 5
)5 6
{ 	
switch 
( 
str 
. 
ToLower 
(  
)  !
)! "
{ 
case 
$str 
: 
return  &
Authors' .
(. /
)/ 0
;0 1
case 
$str  
:  !
return" (
	Cathegory) 2
(2 3
)3 4
;4 5
case 
$str 
: 
return $
Users% *
(* +
)+ ,
;, -
default 
: 
return 
null  $
;$ %
} 
} 	
private    
IViewComponentResult   $
Authors  % ,
(  , -
)  - .
{!! 	
var"" 
all"" 
="" 
_ctx"" 
."" 
Authors"" "
;""" #
if## 
(## 
all## 
.## 
Any## 
(## 
)## 
)## 
{$$ 
var%% 
top%% 
=%% 
all%% 
.&& 
Select&& 
(&& 
st&& 
=>&& !
new&&" %
SelectListItem&&& 4
(&&4 5
)&&5 6
{&&7 8
Text&&9 =
=&&> ?
st&&@ B
.&&B C
FullName&&C K
(&&K L
)&&L M
,&&M N
Value&&O T
=&&U V
st&&W Y
.&&Y Z
	AuthorUid&&Z c
.&&c d
ToString&&d l
(&&l m
)&&m n
}&&o p
)&&p q
.'' 
ToList'' 
('' 
)'' 
;'' 
return)) 
View)) 
()) 
$str)) <
,))< =
top))> A
)))A B
;))B C
}** 
else++ 
{,, 
return-- 
View-- 
(-- 
$str-- <
,--< =
new--> A
List--B F
<--F G
SelectListItem--G U
>--U V
(--V W
)--W X
)--X Y
;--Y Z
}.. 
}00 	
private22  
IViewComponentResult22 $
	Cathegory22% .
(22. /
)22/ 0
{33 	
var44 
all44 
=44 
_ctx44 
.44 

Categories44 %
;44% &
if55 
(55 
all55 
.55 
Any55 
(55 
)55 
)55 
{66 
var77 
top77 
=77 
all77 
.88 
Select88 
(88 
st88 
=>88 !
new88" %
SelectListItem88& 4
(884 5
)885 6
{887 8
Text889 =
=88> ?
st88@ B
.88B C
CategoryName88C O
,88O P
Value88Q V
=88W X
st88Y [
.88[ \

CategoryId88\ f
.88f g
ToString88g o
(88o p
)88p q
}88r s
)88s t
.99 
ToList99 
(99 
)99 
;99 
return;; 
View;; 
(;; 
$str;; <
,;;< =
top;;> A
);;A B
;;;B C
}<< 
else== 
{>> 
return?? 
View?? 
(?? 
$str?? <
,??< =
new??> A
List??B F
<??F G
SelectListItem??G U
>??U V
(??V W
)??W X
)??X Y
;??Y Z
}@@ 
}AA 	
privateCC  
IViewComponentResultCC $
UsersCC% *
(CC* +
)CC+ ,
{DD 	
varEE 
allEE 
=EE 
_ctxEE 
.EE 
AppUsersEE #
;EE# $
ifFF 
(FF 
allFF 
.FF 
AnyFF 
(FF 
)FF 
)FF 
{GG 
varHH 
topHH 
=HH 
allHH 
.II 
SelectII 
(II 
stII 
=>II !
newII" %
SelectListItemII& 4
(II4 5
)II5 6
{II7 8
TextII9 =
=II> ?
stII@ B
.IIB C
FullNameIIC K
,IIK L
ValueIIM R
=IIS T
stIIU W
.IIW X
UidIIX [
.II[ \
ToStringII\ d
(IId e
)IIe f
}IIg h
)IIh i
.JJ 
ToListJJ 
(JJ 
)JJ 
;JJ 
returnLL 
ViewLL 
(LL 
$strLL <
,LL< =
topLL> A
)LLA B
;LLB C
}MM 
elseNN 
{OO 
returnPP 
ViewPP 
(PP 
$strPP <
,PP< =
newPP> A
ListPPB F
<PPF G
SelectListItemPPG U
>PPU V
(PPV W
)PPW X
)PPX Y
;PPY Z
}QQ 
}RR 	
}SS 
}TT 