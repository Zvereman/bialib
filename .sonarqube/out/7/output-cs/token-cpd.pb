¥
QC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ConnectionStr.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
{ 
public 

class 
ConnectionStr 
{		 
public

 
string

 
dbConnection

 "
{

# $
get

% (
;

( )
set

* -
;

- .
}

/ 0
=

1 2
string

3 9
.

9 :
Empty

: ?
;

? @
} 
} «P
aC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Controllers\AccountController.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Controllers# .
{ 
public 

class 
AccountController "
:# $

Controller% /
{ 
private 
Logger 
log 
; 
public 
AccountController  
(  !
)! "
{ 	
log 
= 

LogManager 
. !
GetCurrentClassLogger 2
(2 3
)3 4
;4 5
} 	
public 
IActionResult 
Read !
(! "
[" #
FromServices# /
]/ 0
BookDbContext1 >
ctx? B
)B C
{ 	
var 
user 
= 
User 
. 
Identity $
.$ %
Name% )
.) *
Replace* 1
(1 2
$str2 <
,< =
$str> @
)@ A
;A B
var 

paperBooks 
= 
ctx  
.  !
RentHistories! .
. 
Where 
( 
q 
=> 
q 
. 
User "
." #
	LoginName# ,
==- /
user0 4
&&5 7
q8 9
.9 :
ReturnedDate: F
!=G I
nullJ N
)N O
. 
Select 
( 
q 
=> 
q 
. 
	TakenBook (
)( )
. 
Distinct 
( 
) 
. 
ToList 
( 
) 
; 
var 
eBooks 
= 
ctx 
. 
DownloadHistories .
.   
Where   
(   
q   
=>   
q   
.   
User   "
.  " #
	LoginName  # ,
==  - /
user  0 4
)  4 5
.!! 
Select!! 
(!! 
q!! 
=>!! 
q!! 
.!! 
DownloadedBook!! -
)!!- .
."" 
Distinct"" 
("" 
)"" 
.## 
ToList## 
(## 
)## 
;## 
var$$ 
list$$ 
=$$ 
new$$ 
List$$ 
<$$  
Book$$  $
>$$$ %
($$% &
)$$& '
;$$' (
if%% 
(%% 

paperBooks%% 
.%% 
Any%% 
(%% 
)%% 
)%%  
list&& 
.&& 
AddRange&& 
(&& 

paperBooks&& (
)&&( )
;&&) *
if'' 
('' 
eBooks'' 
.'' 
Any'' 
('' 
)'' 
)'' 
list(( 
.(( 
AddRange(( 
((( 

paperBooks(( (
)((( )
;(() *
return)) 
View)) 
()) 
$str)) 
,)) 
list)) #
)))# $
;))$ %
}** 	
public++ 
IActionResult++ 
Reading++ $
(++$ %
[++% &
FromServices++& 2
]++2 3
BookDbContext++4 A
ctx++B E
)++E F
{,, 	
var-- 
userName-- 
=-- 
User-- 
.--  
Identity--  (
.--( )
Name--) -
.--- .
Replace--. 5
(--5 6
$str--6 @
,--@ A
$str--A C
)--C D
;--D E
var.. 
user.. 
=.. 
ctx.. 
... 
AppUsers.. #
...# $
First..$ )
(..) *
q..* +
=>.., .
q../ 0
...0 1
	LoginName..1 :
==..; =
userName..> F
)..F G
;..G H
var// 

paperBooks// 
=// 
ctx//  
.//  !

PaperBooks//! +
.00 
Where00 
(00 
q00 
=>00 
q00 
.00 
TakenByUser00 )
==00) +
user00+ /
)00/ 0
.11 
ToList11 
(11 
)11 
;11 
return33 
View33 
(33 
$str33 !
,33! "

paperBooks33" ,
)33, -
;33- .
}44 	
public55 
IActionResult55 
Requests55 %
(55% &
[55& '
FromServices55' 3
]553 4
BookDbContext555 B
ctx55C F
)55F G
{66 	
var77 
user77 
=77 
User77 
.77 
Identity77 $
.77$ %
Name77% )
.77) *
Replace77* 1
(771 2
$str772 <
,77< =
$str77> @
)77@ A
;77A B
var88 
book88 
=88 
ctx88 
.88 
RequestBooks88 '
.99 
Where99 
(99 
q99 
=>99 
q99 
.99 
AppUser99 %
.99% &
	LoginName99& /
==990 2
user993 7
)997 8
.:: 
Select:: 
(:: 
q:: 
=>:: 
(:: 
	PaperBook:: '
)::' (
q::( )
.::) *
Book::* .
)::. /
.;; 
AsEnumerable;; 
(;; 
);; 
;;;  
return== 
View== 
(== 
$str== "
,==" #
book==$ (
)==( )
;==) *
}>> 	
public@@ 
async@@ 
Task@@ 
<@@ 

JsonResult@@ $
>@@$ %
	AddReview@@& /
(@@/ 0
[@@0 1
FromServices@@1 =
]@@= >
BookDbContext@@? L
ctx@@M P
,@@P Q
[@@Q R
FromBody@@R Z
]@@Z [
AddReviewModel@@\ j
model@@k p
)@@p q
{AA 	
varBB 
resultBB 
=BB 
newBB 
OperationResultBB ,
(BB, -
)BB- .
;BB. /
tryCC 
{DD 
varEE 
bookEE 
=EE 
ctxEE 
.EE 
BooksEE $
.EE$ %
FirstOrDefaultEE% 3
(EE3 4
qEE4 5
=>EE6 8
qEE9 :
.EE: ;
BiaIdEE; @
==EEA C
modelEED I
.EEI J
BookIdEEJ P
)EEP Q
;EEQ R
varFF 
userFF 
=FF 
ctxFF 
.FF 
AppUsersFF '
.FF' (
FirstOrDefaultFF( 6
(FF6 7
qFF7 8
=>FF9 ;
qFF< =
.FF= >
	LoginNameFF> G
==FFH J
UserFFK O
.FFO P
IdentityFFP X
.FFX Y
NameFFY ]
.FF] ^
ReplaceFF^ e
(FFe f
$strFFf p
,FFp q
$strFFr t
)FFt u
)FFu v
;FFv w
ifHH 
(HH 
bookHH 
==HH 
nullHH 
)HH  
{II 
returnJJ 
JsonJJ 
(JJ  
resultJJ  &
.JJ& '
SetFailJJ' .
(JJ. /
$strJJ/ A
)JJA B
)JJB C
;JJC D
}KK 
ifMM 
(MM 
userMM 
==MM 
nullMM  
)MM  !
{NN 
returnOO 
JsonOO 
(OO  
resultOO  &
.OO& '
SetFailOO' .
(OO. /
$strOO/ G
)OOG H
)OOH I
;OOI J
}PP 
ifRR 
(RR 
ctxRR 
.RR 
ReviewsRR 
.RR  
AnyRR  #
(RR# $
qRR$ %
=>RR& (
qRR) *
.RR* +
BookIdRR+ 1
==RR2 4
bookRR5 9
.RR9 :
BiaIdRR: ?
&&RR@ B
qRRC D
.RRD E

RatedByUidRRE O
==RRP R
userRRS W
.RRW X
UidRRX [
)RR[ \
)RR\ ]
{SS 
returnTT 
JsonTT 
(TT  
resultTT  &
.TT& '
SetFailTT' .
(TT. /
$strTT/ G
)TTG H
)TTH I
;TTI J
}UU 
varWW 
reviewWW 
=WW 
newWW  
ReviewWW! '
(WW' (
)WW( )
{XX 
TextYY 
=YY 
modelYY  
.YY  !
TextYY! %
,YY% &
RatingZZ 
=ZZ 
modelZZ "
.ZZ" #
RatingZZ# )
,ZZ) *

RatedByUid[[ 
=[[  
user[[! %
.[[% &
Uid[[& )
,[[) *
BookId\\ 
=\\ 
book\\ !
.\\! "
BiaId\\" '
}]] 
;]] 
ctx__ 
.__ 
Reviews__ 
.__ 
Add__ 
(__  
review__  &
)__& '
;__' (
ctx`` 
.`` 
SaveChanges`` 
(``  
)``  !
;``! "
bookaa 
.aa 
AverageRatingaa "
=aa# $
bookaa% )
.aa) *
SumCurrentRatingaa* :
(aa: ;
)aa; <
;aa< =
ctxbb 
.bb 
SaveChangesbb 
(bb  
)bb  !
;bb! "
returndd 
Jsondd 
(dd 
resultdd "
.dd" #

SetSuccessdd# -
(dd- .
$strdd. ?
)dd? @
)dd@ A
;ddA B
}ee 
catchff 
(ff 
	Exceptionff 
eff 
)ff 
{gg 
returnhh 
Jsonhh 
(hh 
resulthh "
.hh" #
SetFailhh# *
(hh* +
ehh+ ,
)hh, -
)hh- .
;hh. /
}ii 
}jj 	
}kk 
}ll ≤„
_C:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Controllers\AdminController.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Controllers# .
{ 
[ 
	Authorize 
( 
Policy 
= 
Data 
. 
S 
. 

GroupAdmin )
)) *
]* +
public 

class 
AdminController  
:! "

Controller# -
{   
private!! 
readonly!! 
IHostingEnvironment!! ,
_hostingEnvironment!!- @
;!!@ A
private"" 
readonly"" 
IConfiguration"" '
_config""( /
;""/ 0
private## 
readonly## 
IBrowser## !
_browser##" *
;##* +
private$$ 
Logger$$ 
log$$ 
;$$ 
public%% 
AdminController%% 
(%% 
IConfiguration%% -
configuration%%. ;
,%%; <
IHostingEnvironment%%= P
hostingEnvironment%%Q c
,%%c d
IBrowserResolver%%e u
browserResolver	%%v Ö
)
%%Ö Ü
{&& 	
log'' 
='' 
NLog'' 
.'' 

LogManager'' !
.''! "!
GetCurrentClassLogger''" 7
(''7 8
)''8 9
;''9 :
_config(( 
=(( 
configuration(( #
;((# $
_hostingEnvironment)) 
=))  !
hostingEnvironment))" 4
;))4 5
_browser** 
=** 
browserResolver** &
.**& '
Browser**' .
;**. /
}++ 	
public-- 
IActionResult-- 
Manage-- #
(--# $
[--$ %
FromServices--% 1
]--1 2
BookDbContext--3 @
ctx--A D
)--D E
{.. 	
var// 
books// 
=// 
ctx// 
.// 
Books// !
.//! "
AsEnumerable//" .
(//. /
)/// 0
;//0 1
return00 
View00 
(00 
$str00  
,00  !
books00" '
)00' (
;00( )
}11 	
public33 
IActionResult33 

TakenBooks33 '
(33' (
[33( )
FromServices33) 5
]335 6
BookDbContext337 D
ctx33E H
)33H I
{44 	
var55 
books55 
=55 
ctx55 
.55 
RentHistories55 )
.55) *
Where55* /
(55/ 0
q550 1
=>552 4
q555 6
.556 7
ReturnedDate557 C
==55D F
null55G K
)55K L
.55L M
OrderByDescending55M ^
(55^ _
q55_ `
=>55a c
q55d e
.55e f
ExtendedDueDate55f u
)55u v
.55v w
ToList55w }
(55} ~
)55~ 
;	55 Ä
return66 
View66 
(66 
$str66 #
,66# $
books66% *
)66* +
;66+ ,
}77 	
public99 
IActionResult99 
Reviews99 $
(99$ %
[99% &
FromServices99& 2
]992 3
BookDbContext994 A
ctx99B E
)99E F
{:: 	
var;; 
reviews;; 
=;; 
ctx;; 
.;; 
Reviews;; %
.;;% &
OrderBy;;& -
(;;- .
q;;. /
=>;;0 2
q;;3 4
.;;4 5
Book;;5 9
);;9 :
.;;: ;
AsEnumerable;;; G
(;;G H
);;H I
;;;I J
return<< 
View<< 
(<< 
$str<< !
,<<! "
reviews<<# *
)<<* +
;<<+ ,
}== 	
publicEE 
IActionResultEE 
CreateEE #
(EE# $
[EE$ %
FromServicesEE% 1
]EE1 2
BookDbContextEE3 @
ctxEEA D
)EED E
{FF 	
varGG 
bookGG 
=GG 
newGG 
BookGG 
(GG  
)GG  !
;GG! "
ctxHH 
.HH 
BooksHH 
.HH 
AddHH 
(HH 
bookHH 
)HH 
;HH  
ctxII 
.II 
SaveChangesII 
(II 
)II 
;II 
returnKK 
RedirectKK 
(KK 
$"KK 
$strKK .
{KK. /
bookKK/ 3
.KK3 4
BiaIdKK4 9
}KK9 :
"KK: ;
)KK; <
;KK< =
}LL 	
publicTT 
IActionResultTT 
BookTT !
(TT! "
[TT" #
FromServicesTT# /
]TT/ 0
BookDbContextTT1 >
ctxTT? B
,TTB C
intTTD G
idTTH J
)TTJ K
{UU 	
varVV 
bookVV 
=VV 
ctxVV 
.VV 
BooksVV  
.VV  !
FirstVV! &
(VV& '
qVV' (
=>VV) +
qVV, -
.VV- .
BiaIdVV. 3
==VV4 6
idVV7 9
)VV9 :
;VV: ;
returnWW 
ViewWW 
(WW 
$strWW 
,WW 
bookWW  $
)WW$ %
;WW% &
}XX 	
publicZZ 
IActionResultZZ 
RequestsZZ %
(ZZ% &
[ZZ& '
FromServicesZZ' 3
]ZZ3 4
BookDbContextZZ5 B
ctxZZC F
)ZZF G
{[[ 	
var\\ 
requests\\ 
=\\ 
ctx\\ 
.\\ 
RequestBooks\\ +
.\\+ ,
OrderBy\\, 3
(\\3 4
q\\4 5
=>\\6 8
q\\9 :
.\\: ;
Date\\; ?
)\\? @
;\\@ A
return]] 
View]] 
(]] 
$str]] "
,]]" #
requests]]$ ,
)]], -
;]]- .
}^^ 	
public`` 
IActionResult`` 
Settings`` %
(``% &
[``& '
FromServices``' 3
]``3 4
BookDbContext``5 B
ctx``C F
)``F G
{aa 	
varbb 
usersbb 
=bb 
ctxbb 
.bb 
AppUsersbb $
.bb$ %
ToListbb% +
(bb+ ,
)bb, -
;bb- .
varcc 
authorscc 
=cc 
ctxcc 
.cc 
Authorscc %
.cc% &
ToListcc& ,
(cc, -
)cc- .
;cc. /
vardd 
categorydd 
=dd 
ctxdd 
.dd 

Categoriesdd )
.dd) *
ToListdd* 0
(dd0 1
)dd1 2
;dd2 3
varee 
settingsee 
=ee 
newee 
SettingsViewModelee 0
(ee0 1
)ee1 2
{ff 
Usersgg 
=gg 
usersgg 
,gg 
Authorshh 
=hh 
authorshh !
,hh! "

Categoriesii 
=ii 
categoryii %
}jj 
;jj 
returnkk 
Viewkk 
(kk 
$strkk "
,kk" #
settingskk$ ,
)kk, -
;kk- .
}ll 	
publicnn 
IActionResultnn 
Usersnn "
(nn" #
[nn# $
FromServicesnn$ 0
]nn0 1
BookDbContextnn2 ?
ctxnn@ C
)nnC D
{oo 	
varpp 
userspp 
=pp 
ctxpp 
.pp 
AppUserspp $
.pp$ %
ToListpp% +
(pp+ ,
)pp, -
;pp- .
varqq 
ignoredqq 
=qq 
ctxqq 
.qq 
IgnoredUsersqq *
.qq* +
ToListqq+ 1
(qq1 2
)qq2 3
;qq3 4
returnrr 
Viewrr 
(rr 
$strrr 
,rr  
usersrr! &
)rr& '
;rr' (
}ss 	
publicuu 
IActionResultuu 
selectedUseruu )
(uu) *
[uu* +
FromServicesuu+ 7
]uu7 8
BookDbContextuu9 F
ctxuuG J
,uuJ K
[uuL M
	FromQueryuuM V
]uuV W
GuiduuX \
uiduu] `
)uu` a
{vv 	
varww 
userww 
=ww 
ctxww 
.ww 
AppUsersww #
.ww# $
Firstww$ )
(ww) *
qww* +
=>ww+ -
qww- .
.ww. /
Uidww/ 2
==ww2 4
uidww4 7
)ww7 8
;ww8 9
varxx 
dowloadsxx 
=xx 
ctxxx 
.xx 
DownloadHistoriesxx 0
.xx0 1
ToListxx1 7
(xx7 8
)xx8 9
;xx9 :
varyy 
uploadsyy 
=yy 
ctxyy 
.yy 
UploadHistoriesyy -
.yy- .
ToListyy. 4
(yy4 5
)yy5 6
;yy6 7
returnzz 
Viewzz 
(zz 
$strzz 
,zz 
userzz  $
)zz$ %
;zz% &
}{{ 	
public~~ 
async~~ 
Task~~ 
<~~ 

JsonResult~~ $
>~~$ %
	AddAuthor~~& /
(~~/ 0
[~~0 1
FromServices~~1 =
]~~= >
BookDbContext~~? L
ctx~~M P
,~~P Q
[~~R S
FromBody~~S [
]~~[ \
dynamic~~] d
model~~e j
)~~j k
{ 	
var
ÄÄ 
result
ÄÄ 
=
ÄÄ 
new
ÄÄ 
OperationResult
ÄÄ ,
(
ÄÄ, -
)
ÄÄ- .
;
ÄÄ. /
try
ÇÇ 
{
ÉÉ 
var
ÑÑ 
first
ÑÑ 
=
ÑÑ 
(
ÑÑ 
string
ÑÑ #
)
ÑÑ# $
model
ÑÑ$ )
.
ÑÑ) *
	FirstName
ÑÑ* 3
;
ÑÑ3 4
var
ÖÖ 
last
ÖÖ 
=
ÖÖ 
(
ÖÖ 
string
ÖÖ "
)
ÖÖ" #
model
ÖÖ# (
.
ÖÖ( )
LastName
ÖÖ) 1
;
ÖÖ1 2
var
ÜÜ 
midle
ÜÜ 
=
ÜÜ 
(
ÜÜ 
string
ÜÜ #
)
ÜÜ# $
model
ÜÜ$ )
.
ÜÜ) *

MiddleName
ÜÜ* 4
;
ÜÜ4 5
var
àà 
author
àà 
=
àà 
ctx
àà  
.
àà  !
Authors
àà! (
.
àà( )
FirstOrDefault
àà) 7
(
àà7 8
a
àà8 9
=>
àà: <
a
àà= >
.
àà> ?
	FirstName
àà? H
.
ààH I
ToLower
ààI P
(
ààP Q
)
ààQ R
==
ààS U
first
ààV [
.
àà[ \
ToLower
àà\ c
(
ààc d
)
ààd e
&&
ââ; =
a
ââ> ?
.
ââ? @
LastName
ââ@ H
.
ââH I
ToLower
ââI P
(
ââP Q
)
ââQ R
==
ââS U
last
ââV Z
.
ââZ [
ToLower
ââ[ b
(
ââb c
)
ââc d
&&
ää; =
a
ää> ?
.
ää? @

MiddleName
ää@ J
.
ääJ K
ToLower
ääK R
(
ääR S
)
ääS T
==
ääU W
midle
ääX ]
.
ää] ^
ToLower
ää^ e
(
ääe f
)
ääf g
)
ääg h
;
ääh i
if
ãã 
(
ãã 
author
ãã 
!=
ãã 
null
ãã "
)
ãã" #
{
åå 
return
çç 
Json
çç 
(
çç  
new
çç  #
OperationResult
çç$ 3
(
çç3 4
)
çç4 5
.
çç5 6
SetFail
çç6 =
(
çç= >
$str
çç> b
)
ççb c
)
ççc d
;
ççd e
}
éé 
else
èè 
{
êê 
author
ëë 
=
ëë 
new
ëë  
Author
ëë! '
(
ëë' (
)
ëë( )
{
íí 
	AuthorUid
ìì !
=
ìì" #
Guid
ìì$ (
.
ìì( )
NewGuid
ìì) 0
(
ìì0 1
)
ìì1 2
,
ìì2 3
	FirstName
îî !
=
îî" #
first
îî$ )
,
îî) *

MiddleName
ïï "
=
ïï# $
midle
ïï% *
,
ïï* +
LastName
ññ  
=
ññ! "
last
ññ# '
}
óó 
;
óó 
ctx
òò 
.
òò 
Authors
òò 
.
òò  
Add
òò  #
(
òò# $
author
òò$ *
)
òò* +
;
òò+ ,
ctx
ôô 
.
ôô 
SaveChanges
ôô #
(
ôô# $
)
ôô$ %
;
ôô% &
var
öö 
res
öö 
=
öö 
new
öö !
OperationResult
öö" 1
(
öö1 2
)
öö2 3
.
öö3 4

SetSuccess
öö4 >
(
öö> ?
)
öö? @
;
öö@ A
res
õõ 
.
õõ 
Details
õõ 
=
õõ  !
JsonConvert
õõ" -
.
õõ- .
SerializeObject
õõ. =
(
õõ= >
new
õõ> A
{
õõB C
name
õõD H
=
õõI J
author
õõK Q
.
õõQ R
FullName
õõR Z
(
õõZ [
)
õõ[ \
,
õõ\ ]
value
õõ^ c
=
õõd e
author
õõf l
.
õõl m
	AuthorUid
õõm v
,
õõv w
details
õõx 
=õõÄ Å
$strõõÇ í
}õõì î
)õõî ï
;õõï ñ
log
úú 
.
úú 
Info
úú 
(
úú 
$"
úú 
{
úú  
User
úú  $
.
úú$ %
Identity
úú% -
.
úú- .
Name
úú. 2
}
úú2 3
$str
úú3 5
{
úú5 6
res
úú6 9
.
úú9 :
Details
úú: A
}
úúA B
"
úúB C
)
úúC D
;
úúD E
return
ùù 
Json
ùù 
(
ùù  
res
ùù  #
)
ùù# $
;
ùù$ %
}
ûû 
}
üü 
catch
†† 
(
†† 
	Exception
†† 
ex
†† 
)
††  
{
°° 
log
¢¢ 
.
¢¢ 
Error
¢¢ 
(
¢¢ 
ex
¢¢ 
)
¢¢ 
;
¢¢ 
return
££ 
Json
££ 
(
££ 
new
££ 
OperationResult
££  /
(
££/ 0
)
££0 1
.
££1 2
SetFail
££2 9
(
££9 :
ex
££: <
)
££< =
)
££= >
;
££> ?
}
§§ 
}
•• 	
public
®® 
async
®® 
Task
®® 
<
®® 

JsonResult
®® $
>
®®$ %

EditAuthor
®®& 0
(
®®0 1
[
®®1 2
FromServices
®®2 >
]
®®> ?
BookDbContext
®®@ M
ctx
®®N Q
,
®®Q R
[
®®S T
FromBody
®®T \
]
®®\ ]
dynamic
®®^ e
model
®®f k
)
®®k l
{
©© 	
try
™™ 
{
´´ 
var
¨¨ 
id
¨¨ 
=
¨¨ 
(
¨¨ 
Guid
¨¨ 
)
¨¨ 
model
¨¨ $
.
¨¨$ %
Id
¨¨% '
;
¨¨' (
var
≠≠ 
first
≠≠ 
=
≠≠ 
(
≠≠ 
string
≠≠ #
)
≠≠# $
model
≠≠$ )
.
≠≠) *
	FirstName
≠≠* 3
;
≠≠3 4
var
ÆÆ 
last
ÆÆ 
=
ÆÆ 
(
ÆÆ 
string
ÆÆ "
)
ÆÆ" #
model
ÆÆ# (
.
ÆÆ( )
LastName
ÆÆ) 1
;
ÆÆ1 2
var
ØØ 
midle
ØØ 
=
ØØ 
(
ØØ 
string
ØØ #
)
ØØ# $
model
ØØ$ )
.
ØØ) *

MiddleName
ØØ* 4
;
ØØ4 5
var
±± 
author
±± 
=
±± 
ctx
±±  
.
±±  !
Authors
±±! (
.
±±( )
First
±±) .
(
±±. /
q
±±/ 0
=>
±±1 3
q
±±4 5
.
±±5 6
	AuthorUid
±±6 ?
==
±±@ B
id
±±C E
)
±±E F
;
±±F G
if
≥≥ 
(
≥≥ 
author
≥≥ 
.
≥≥ 
	FirstName
≥≥ $
==
≥≥% '
first
≥≥( -
&&
≥≥. 0
author
≥≥1 7
.
≥≥7 8
LastName
≥≥8 @
==
≥≥A C
last
≥≥D H
&&
≥≥I K
author
≥≥L R
.
≥≥R S

MiddleName
≥≥S ]
==
≥≥^ `
midle
≥≥a f
)
≥≥f g
{
¥¥ 
return
µµ 
Json
µµ 
(
µµ  
new
µµ  #
OperationResult
µµ$ 3
(
µµ3 4
)
µµ4 5
.
µµ5 6
SetFail
µµ6 =
(
µµ= >
$str
µµ> e
)
µµe f
)
µµf g
;
µµg h
}
∂∂ 
author
∏∏ 
.
∏∏ 
	FirstName
∏∏  
=
∏∏! "
first
∏∏# (
;
∏∏( )
author
ππ 
.
ππ 

MiddleName
ππ !
=
ππ" #
midle
ππ$ )
;
ππ) *
author
∫∫ 
.
∫∫ 
LastName
∫∫ 
=
∫∫  !
last
∫∫" &
;
∫∫& '
ctx
ºº 
.
ºº 
SaveChanges
ºº 
(
ºº  
)
ºº  !
;
ºº! "
var
ΩΩ 
res
ΩΩ 
=
ΩΩ 
new
ΩΩ 
OperationResult
ΩΩ -
(
ΩΩ- .
)
ΩΩ. /
.
ΩΩ/ 0

SetSuccess
ΩΩ0 :
(
ΩΩ: ;
)
ΩΩ; <
;
ΩΩ< =
res
ææ 
.
ææ 
Details
ææ 
=
ææ 
JsonConvert
ææ )
.
ææ) *
SerializeObject
ææ* 9
(
ææ9 :
new
ææ: =
{
ææ> ?
uid
ææ@ C
=
ææD E
author
ææF L
.
ææL M
	AuthorUid
ææM V
.
ææV W
ToString
ææW _
(
ææ_ `
)
ææ` a
,
ææa b
details
ææc j
=
ææk l
$strææm É
}ææÑ Ö
)ææÖ Ü
;ææÜ á
log
øø 
.
øø 
Info
øø 
(
øø 
$"
øø 
{
øø 
User
øø  
.
øø  !
Identity
øø! )
.
øø) *
Name
øø* .
}
øø. /
$str
øø/ 1
{
øø1 2
res
øø2 5
.
øø5 6
Details
øø6 =
}
øø= >
"
øø> ?
)
øø? @
;
øø@ A
return
¿¿ 
Json
¿¿ 
(
¿¿ 
res
¿¿ 
)
¿¿  
;
¿¿  !
}
¡¡ 
catch
¬¬ 
(
¬¬ 
	Exception
¬¬ 
ex
¬¬ 
)
¬¬  
{
√√ 
return
ƒƒ 
Json
ƒƒ 
(
ƒƒ 
new
ƒƒ 
OperationResult
ƒƒ  /
(
ƒƒ/ 0
)
ƒƒ0 1
.
ƒƒ1 2
SetFail
ƒƒ2 9
(
ƒƒ9 :
ex
ƒƒ: <
)
ƒƒ< =
)
ƒƒ= >
;
ƒƒ> ?
}
≈≈ 
}
∆∆ 	
public
…… 
async
…… 
Task
…… 
<
…… 

JsonResult
…… $
>
……$ %
AddCathegory
……& 2
(
……2 3
[
……3 4
FromServices
……4 @
]
……@ A
BookDbContext
……B O
ctx
……P S
,
……S T
[
……U V
FromBody
……V ^
]
……^ _
string
……a g
str
……h k
)
……k l
{
   	
var
ÀÀ 
result
ÀÀ 
=
ÀÀ 
new
ÀÀ 
OperationResult
ÀÀ ,
(
ÀÀ, -
)
ÀÀ- .
;
ÀÀ. /
str
ÃÃ 
=
ÃÃ 
str
ÃÃ 
.
ÃÃ 
Trim
ÃÃ 
(
ÃÃ 
)
ÃÃ 
.
ÃÃ 
ToLower
ÃÃ $
(
ÃÃ$ %
)
ÃÃ% &
;
ÃÃ& '
if
ÕÕ 
(
ÕÕ 
ctx
ÕÕ 
.
ÕÕ 

Categories
ÕÕ 
.
ÕÕ 
Any
ÕÕ "
(
ÕÕ" #
q
ÕÕ# $
=>
ÕÕ% '
q
ÕÕ( )
.
ÕÕ) *
CategoryName
ÕÕ* 6
==
ÕÕ7 9
str
ÕÕ: =
)
ÕÕ= >
)
ÕÕ> ?
{
ŒŒ 
return
œœ 
Json
œœ 
(
œœ 
result
œœ "
.
œœ" #
SetFail
œœ# *
(
œœ* +
$str
œœ+ L
)
œœL M
)
œœM N
;
œœN O
}
–– 
else
—— 
{
““ 
try
”” 
{
‘‘ 
var
’’ 
category
’’  
=
’’! "
new
’’# &
Category
’’' /
(
’’/ 0
)
’’0 1
{
’’2 3
CategoryName
’’4 @
=
’’A B
str
’’C F
}
’’G H
;
’’H I
ctx
÷÷ 
.
÷÷ 

Categories
÷÷ "
.
÷÷" #
Add
÷÷# &
(
÷÷& '
category
÷÷' /
)
÷÷/ 0
;
÷÷0 1
ctx
◊◊ 
.
◊◊ 
SaveChanges
◊◊ #
(
◊◊# $
)
◊◊$ %
;
◊◊% &
var
ÿÿ 
res
ÿÿ 
=
ÿÿ 
new
ÿÿ !
OperationResult
ÿÿ" 1
(
ÿÿ1 2
)
ÿÿ2 3
.
ÿÿ3 4

SetSuccess
ÿÿ4 >
(
ÿÿ> ?
)
ÿÿ? @
;
ÿÿ@ A
res
ŸŸ 
.
ŸŸ 
Details
ŸŸ 
=
ŸŸ  !
JsonConvert
ŸŸ" -
.
ŸŸ- .
SerializeObject
ŸŸ. =
(
ŸŸ= >
new
ŸŸ> A
{
ŸŸB C
name
ŸŸD H
=
ŸŸI J
category
ŸŸK S
.
ŸŸS T
CategoryName
ŸŸT `
,
ŸŸ` a
value
ŸŸb g
=
ŸŸh i
category
ŸŸj r
.
ŸŸr s

CategoryId
ŸŸs }
,
ŸŸ} ~
detailsŸŸ Ü
=ŸŸá à
$strŸŸâ û
}ŸŸü †
)ŸŸ† °
;ŸŸ° ¢
log
⁄⁄ 
.
⁄⁄ 
Info
⁄⁄ 
(
⁄⁄ 
$"
⁄⁄ 
{
⁄⁄  
User
⁄⁄  $
.
⁄⁄$ %
Identity
⁄⁄% -
.
⁄⁄- .
Name
⁄⁄. 2
}
⁄⁄2 3
$str
⁄⁄3 5
{
⁄⁄5 6
res
⁄⁄6 9
.
⁄⁄9 :
Details
⁄⁄: A
}
⁄⁄A B
"
⁄⁄B C
)
⁄⁄C D
;
⁄⁄D E
return
€€ 
Json
€€ 
(
€€  
res
€€  #
)
€€# $
;
€€$ %
}
‹‹ 
catch
›› 
(
›› 
	Exception
››  
ex
››! #
)
››# $
{
ﬁﬁ 
log
ﬂﬂ 
.
ﬂﬂ 
Error
ﬂﬂ 
(
ﬂﬂ 
ex
ﬂﬂ  
)
ﬂﬂ  !
;
ﬂﬂ! "
return
‡‡ 
Json
‡‡ 
(
‡‡  
new
‡‡  #
OperationResult
‡‡$ 3
(
‡‡3 4
)
‡‡4 5
.
‡‡5 6
SetFail
‡‡6 =
(
‡‡= >
ex
‡‡> @
)
‡‡@ A
)
‡‡A B
;
‡‡B C
}
·· 
}
‚‚ 
}
„„ 	
public
ÂÂ 
async
ÂÂ 
Task
ÂÂ 
<
ÂÂ 

JsonResult
ÂÂ $
>
ÂÂ$ %
EditCategory
ÂÂ& 2
(
ÂÂ2 3
[
ÂÂ3 4
FromServices
ÂÂ4 @
]
ÂÂ@ A
BookDbContext
ÂÂB O
ctx
ÂÂP S
,
ÂÂS T
[
ÂÂU V
FromBody
ÂÂV ^
]
ÂÂ^ _
dynamic
ÂÂ` g
model
ÂÂh m
)
ÂÂm n
{
ÊÊ 	
try
ÁÁ 
{
ËË 
var
ÈÈ 
id
ÈÈ 
=
ÈÈ 
(
ÈÈ 
int
ÈÈ 
)
ÈÈ 
model
ÈÈ #
.
ÈÈ# $
Id
ÈÈ$ &
;
ÈÈ& '
var
ÍÍ 
categoryName
ÍÍ  
=
ÍÍ! "
(
ÍÍ# $
string
ÍÍ$ *
)
ÍÍ* +
model
ÍÍ+ 0
.
ÍÍ0 1
CategoryName
ÍÍ1 =
;
ÍÍ= >
var
ÏÏ 
category
ÏÏ 
=
ÏÏ 
ctx
ÏÏ "
.
ÏÏ" #

Categories
ÏÏ# -
.
ÏÏ- .
First
ÏÏ. 3
(
ÏÏ3 4
q
ÏÏ4 5
=>
ÏÏ6 8
q
ÏÏ9 :
.
ÏÏ: ;

CategoryId
ÏÏ; E
==
ÏÏF H
id
ÏÏI K
)
ÏÏK L
;
ÏÏL M
if
ÓÓ 
(
ÓÓ 
category
ÓÓ 
.
ÓÓ 
CategoryName
ÓÓ )
==
ÓÓ* ,
categoryName
ÓÓ- 9
)
ÓÓ9 :
{
ÔÔ 
return
 
Json
 
(
  
new
  #
OperationResult
$ 3
(
3 4
)
4 5
.
5 6
SetFail
6 =
(
= >
$str
> e
)
e f
)
f g
;
g h
}
ÒÒ 
category
ÛÛ 
.
ÛÛ 
CategoryName
ÛÛ %
=
ÛÛ& '
categoryName
ÛÛ( 4
;
ÛÛ4 5
ctx
ıı 
.
ıı 
SaveChanges
ıı 
(
ıı  
)
ıı  !
;
ıı! "
var
ˆˆ 
res
ˆˆ 
=
ˆˆ 
new
ˆˆ 
OperationResult
ˆˆ -
(
ˆˆ- .
)
ˆˆ. /
.
ˆˆ/ 0

SetSuccess
ˆˆ0 :
(
ˆˆ: ;
)
ˆˆ; <
;
ˆˆ< =
res
˜˜ 
.
˜˜ 
Details
˜˜ 
=
˜˜ 
JsonConvert
˜˜ )
.
˜˜) *
SerializeObject
˜˜* 9
(
˜˜9 :
new
˜˜: =
{
˜˜> ?
id
˜˜@ B
=
˜˜C D
category
˜˜E M
.
˜˜M N

CategoryId
˜˜N X
.
˜˜X Y
ToString
˜˜Y a
(
˜˜a b
)
˜˜b c
,
˜˜c d
details
˜˜e l
=
˜˜m n
$str˜˜o ä
}˜˜ã å
)˜˜å ç
;˜˜ç é
log
¯¯ 
.
¯¯ 
Info
¯¯ 
(
¯¯ 
$"
¯¯ 
{
¯¯ 
User
¯¯  
.
¯¯  !
Identity
¯¯! )
.
¯¯) *
Name
¯¯* .
}
¯¯. /
$str
¯¯/ 1
{
¯¯1 2
res
¯¯2 5
.
¯¯5 6
Details
¯¯6 =
}
¯¯= >
"
¯¯> ?
)
¯¯? @
;
¯¯@ A
return
˘˘ 
Json
˘˘ 
(
˘˘ 
res
˘˘ 
)
˘˘  
;
˘˘  !
}
˙˙ 
catch
˚˚ 
(
˚˚ 
	Exception
˚˚ 
ex
˚˚ 
)
˚˚  
{
¸¸ 
return
˝˝ 
Json
˝˝ 
(
˝˝ 
new
˝˝ 
OperationResult
˝˝  /
(
˝˝/ 0
)
˝˝0 1
.
˝˝1 2
SetFail
˝˝2 9
(
˝˝9 :
ex
˝˝: <
)
˝˝< =
)
˝˝= >
;
˝˝> ?
}
˛˛ 
}
ˇˇ 	
public
ÅÅ 
async
ÅÅ 
Task
ÅÅ 
<
ÅÅ 

JsonResult
ÅÅ $
>
ÅÅ$ %
AddBook
ÅÅ& -
(
ÅÅ- .
[
ÅÅ. /
FromServices
ÅÅ/ ;
]
ÅÅ; <
BookDbContext
ÅÅ= J
ctx
ÅÅK N
,
ÅÅN O
[
ÅÅP Q
FromBody
ÅÅQ Y
]
ÅÅY Z
AddBookForm
ÅÅ[ f
book
ÅÅg k
)
ÅÅk l
{
ÇÇ 	
try
ÉÉ 
{
ÑÑ 
var
ÖÖ 
user
ÖÖ 
=
ÖÖ 
ctx
ÖÖ 
.
ÖÖ 
AppUsers
ÖÖ '
.
ÖÖ' (
First
ÖÖ( -
(
ÖÖ- .
q
ÖÖ. /
=>
ÖÖ0 2
q
ÖÖ3 4
.
ÖÖ4 5
	LoginName
ÖÖ5 >
==
ÖÖ? A
User
ÖÖB F
.
ÖÖF G
Identity
ÖÖG O
.
ÖÖO P
Name
ÖÖP T
.
ÖÖT U
Replace
ÖÖU \
(
ÖÖ\ ]
$str
ÖÖ] g
,
ÖÖg h
$str
ÖÖi k
)
ÖÖk l
)
ÖÖl m
;
ÖÖm n
if
ÜÜ 
(
ÜÜ 
book
ÜÜ 
==
ÜÜ 
null
ÜÜ  
)
ÜÜ  !
throw
áá 
new
áá #
ArgumentNullException
áá 3
(
áá3 4
$str
áá4 M
)
ááM N
;
ááN O
var
ââ 
Title
ââ 
=
ââ 
book
ââ  
.
ââ  !
Title
ââ! &
;
ââ& '
var
ää 
Subtitle
ää 
=
ää 
book
ää #
.
ää# $
Subtitle
ää$ ,
;
ää, -
var
ãã 

Annotation
ãã 
=
ãã  
book
ãã! %
.
ãã% &

Annotation
ãã& 0
;
ãã0 1
var
åå 
Language
åå 
=
åå 
book
åå #
.
åå# $
Language
åå$ ,
;
åå, -
var
çç 
Edition
çç 
=
çç 
book
çç "
.
çç" #
Edition
çç# *
;
çç* +
var
éé 
Year
éé 
=
éé 
book
éé 
.
éé  
Year
éé  $
;
éé$ %
var
èè 
Isbn
èè 
=
èè 
book
èè 
.
èè  
Isbn
èè  $
;
èè$ %
var
êê 
Pages
êê 
=
êê 
book
êê  
.
êê  !
Pages
êê! &
;
êê& '
var
ëë 
Authors
ëë 
=
ëë 
book
ëë "
.
ëë" #
Authors
ëë# *
;
ëë* +
var
íí 
Cathegories
íí 
=
íí  !
book
íí" &
.
íí& '

Categories
íí' 1
;
íí1 2
var
ìì 

PapperBook
ìì 
=
ìì  
book
ìì! %
.
ìì% &
	PaperBook
ìì& /
;
ìì/ 0
var
îî 
Link
îî 
=
îî 
book
îî 
.
îî  
Link
îî  $
;
îî$ %
var
ïï 

CoverImage
ïï 
=
ïï  
(
ïï! "
string
ïï" (
.
ïï( )
IsNullOrEmpty
ïï) 6
(
ïï6 7
book
ïï7 ;
.
ïï; <

CoverImage
ïï< F
)
ïïF G
)
ïïG H
?
ïïI J
null
ïïK O
:
ïïP Q
$@"
ïïR U
$str
ïïU d
{
ïïd e
book
ïïe i
.
ïïi j

CoverImage
ïïj t
}
ïït u
"
ïïu v
;
ïïv w
var
óó 
result
óó 
=
óó 
new
óó  
OperationResult
óó! 0
(
óó0 1
)
óó1 2
;
óó2 3
Book
ôô 
newBook
ôô 
;
ôô 
if
öö 
(
öö 

PapperBook
öö 
==
öö !
true
öö" &
)
öö& '
{
õõ 
if
úú 
(
úú 
Isbn
úú 
.
úú 
Length
úú #
>
úú$ %
$num
úú& (
)
úú( )
throw
ùù 
new
ùù !
	Exception
ùù" +
(
ùù+ ,
$str
ùù, S
)
ùùS T
;
ùùT U
var
ûû 
uniqIsbn
ûû  
=
ûû! "
ctx
ûû# &
.
ûû& '
Books
ûû' ,
.
ûû, -
FirstOrDefault
ûû- ;
(
ûû; <
b
ûû< =
=>
ûû> @
b
ûûA B
.
ûûB C
Isbn
ûûC G
==
ûûH J
Isbn
ûûK O
)
ûûO P
;
ûûP Q
if
üü 
(
üü 
uniqIsbn
üü  
!=
üü! #
null
üü$ (
)
üü( )
{
†† 
throw
°° 
new
°° !
	Exception
°°" +
(
°°+ ,
$str
°°, X
)
°°X Y
;
°°Y Z
}
¢¢ 
newBook
££ 
=
££ 
new
££ !
	PaperBook
££" +
(
££+ ,
)
££, -
{
§§ 
Title
•• 
=
•• 
Title
••  %
,
••% &
Subtitle
¶¶  
=
¶¶! "
Subtitle
¶¶# +
,
¶¶+ ,

Annotation
ßß "
=
ßß# $

Annotation
ßß% /
,
ßß/ 0
Pages
®® 
=
®® 
Pages
®®  %
,
®®% &
Year
©© 
=
©© 
Year
©© #
,
©©# $
Isbn
™™ 
=
™™ 
Isbn
™™ #
,
™™# $
Language
´´  
=
´´! "
Language
´´# +
,
´´+ ,
Edition
¨¨ 
=
¨¨  !
Edition
¨¨" )
,
¨¨) *

CoverImage
≠≠ "
=
≠≠# $

CoverImage
≠≠% /
}
ÆÆ 
;
ÆÆ 
ctx
∞∞ 
.
∞∞ 

PaperBooks
∞∞ "
.
∞∞" #
Add
∞∞# &
(
∞∞& '
(
∞∞' (
	PaperBook
∞∞( 1
)
∞∞1 2
newBook
∞∞2 9
)
∞∞9 :
;
∞∞: ;
ctx
±± 
.
±± 
SaveChanges
±± #
(
±±# $
)
±±$ %
;
±±% &
}
≤≤ 
else
≥≥ 
{
¥¥ 
if
µµ 
(
µµ 
string
µµ 
.
µµ 
IsNullOrEmpty
µµ ,
(
µµ, -
Link
µµ- 1
)
µµ1 2
)
µµ2 3
{
∂∂ 
return
∑∑ 
Json
∑∑ #
(
∑∑# $
new
∑∑$ '
OperationResult
∑∑( 7
(
∑∑7 8
)
∑∑8 9
.
∑∑9 :
SetFail
∑∑: A
(
∑∑A B
$str
∑∑B k
)
∑∑k l
)
∑∑l m
;
∑∑m n
}
∏∏ 
newBook
∫∫ 
=
∫∫ 
new
∫∫ !
Ebook
∫∫" '
(
∫∫' (
)
∫∫( )
{
ªª 
Title
ºº 
=
ºº 
Title
ºº  %
,
ºº% &
Subtitle
ΩΩ  
=
ΩΩ! "
Subtitle
ΩΩ# +
,
ΩΩ+ ,

Annotation
ææ "
=
ææ# $

Annotation
ææ% /
,
ææ/ 0
Pages
øø 
=
øø 
Pages
øø  %
,
øø% &
Year
¿¿ 
=
¿¿ 
Year
¿¿ #
,
¿¿# $
Isbn
¡¡ 
=
¡¡ 
Isbn
¡¡ #
,
¡¡# $
Language
¬¬  
=
¬¬! "
Language
¬¬# +
,
¬¬+ ,
Edition
√√ 
=
√√  !
Edition
√√" )
,
√√) *
Link
ƒƒ 
=
ƒƒ 
Link
ƒƒ #
.
ƒƒ# $
GenerateLink
ƒƒ$ 0
(
ƒƒ0 1
)
ƒƒ1 2
,
ƒƒ2 3

CoverImage
≈≈ "
=
≈≈# $

CoverImage
≈≈% /
}
∆∆ 
;
∆∆ 
ctx
»» 
.
»» 
Ebooks
»» 
.
»» 
Add
»» "
(
»»" #
(
»»# $
Ebook
»»$ )
)
»») *
newBook
»»* 1
)
»»1 2
;
»»2 3
ctx
…… 
.
…… 
SaveChanges
…… #
(
……# $
)
……$ %
;
……% &
}
   
var
ÃÃ 
	newAutors
ÃÃ 
=
ÃÃ 
ctx
ÃÃ  #
.
ÃÃ# $
Authors
ÃÃ$ +
.
ÃÃ+ ,
Where
ÃÃ, 1
(
ÃÃ1 2
q
ÃÃ2 3
=>
ÃÃ4 6
Authors
ÃÃ7 >
.
ÃÃ> ?
Contains
ÃÃ? G
(
ÃÃG H
q
ÃÃH I
.
ÃÃI J
	AuthorUid
ÃÃJ S
)
ÃÃS T
)
ÃÃT U
;
ÃÃU V
if
ÕÕ 
(
ÕÕ 
	newAutors
ÕÕ 
.
ÕÕ 
Any
ÕÕ !
(
ÕÕ! "
)
ÕÕ" #
)
ÕÕ# $
{
ŒŒ 
var
œœ 
list
œœ 
=
œœ 
	newAutors
œœ (
.
–– 
Select
–– 
(
––  
q
––  !
=>
––" $
new
––% (

BookAuthor
––) 3
(
––3 4
)
––4 5
{
––6 7
BookId
––8 >
=
––? @
newBook
––A H
.
––H I
BiaId
––I N
,
––N O
	AuthorUid
––P Y
=
––Z [
q
––\ ]
.
––] ^
	AuthorUid
––^ g
}
––h i
)
––i j
.
—— 
AsEnumerable
—— %
(
——% &
)
——& '
;
——' (
ctx
““ 
.
““ 
BookAuthors
““ #
.
““# $
AddRange
““$ ,
(
““, -
list
““- 1
)
““1 2
;
““2 3
}
”” 
var
’’ 
newCathegories
’’ "
=
’’# $
ctx
’’% (
.
’’( )

Categories
’’) 3
.
’’3 4
Where
’’4 9
(
’’9 :
q
’’: ;
=>
’’< >
Cathegories
’’? J
.
’’J K
Contains
’’K S
(
’’S T
q
’’T U
.
’’U V

CategoryId
’’V `
)
’’` a
)
’’a b
;
’’b c
if
÷÷ 
(
÷÷ 
newCathegories
÷÷ "
.
÷÷" #
Any
÷÷# &
(
÷÷& '
)
÷÷' (
)
÷÷( )
{
◊◊ 
var
ÿÿ 
list
ÿÿ 
=
ÿÿ 
newCathegories
ÿÿ -
.
ÿÿ- .
Select
ÿÿ. 4
(
ÿÿ4 5
q
ÿÿ5 6
=>
ÿÿ7 9
new
ÿÿ: =
BookCategory
ÿÿ> J
(
ÿÿJ K
)
ÿÿK L
{
ÿÿM N

CategoryId
ÿÿO Y
=
ÿÿZ [
q
ÿÿ\ ]
.
ÿÿ] ^

CategoryId
ÿÿ^ h
,
ÿÿh i
BookId
ÿÿj p
=
ÿÿq r
newBook
ÿÿs z
.
ÿÿz {
BiaIdÿÿ{ Ä
}ÿÿÅ Ç
)ÿÿÇ É
.ÿÿÉ Ñ
AsEnumerableÿÿÑ ê
(ÿÿê ë
)ÿÿë í
;ÿÿí ì
ctx
ŸŸ 
.
ŸŸ 
BookCategories
ŸŸ &
.
ŸŸ& '
AddRange
ŸŸ' /
(
ŸŸ/ 0
list
ŸŸ0 4
)
ŸŸ4 5
;
ŸŸ5 6
}
⁄⁄ 
ctx
‹‹ 
.
‹‹ 
UploadHistories
‹‹ #
.
‹‹# $
Add
‹‹$ '
(
‹‹' (
new
‹‹( +
UploadHistory
‹‹, 9
(
‹‹9 :
)
‹‹: ;
{
‹‹< =
BookId
‹‹> D
=
‹‹E F
newBook
‹‹G N
.
‹‹N O
BiaId
‹‹O T
,
‹‹T U

AppUserUid
‹‹V `
=
‹‹a b
user
‹‹c g
.
‹‹g h
Uid
‹‹h k
,
‹‹k l

UploadDate
‹‹m w
=
‹‹x y
DateTime‹‹z Ç
.‹‹Ç É
Now‹‹É Ü
}‹‹Ü á
)‹‹á à
;‹‹à â
ctx
ﬁﬁ 
.
ﬁﬁ 
SaveChanges
ﬁﬁ 
(
ﬁﬁ  
)
ﬁﬁ  !
;
ﬁﬁ! "
log
ﬂﬂ 
.
ﬂﬂ 
Info
ﬂﬂ 
(
ﬂﬂ 
$"
ﬂﬂ 
{
ﬂﬂ 
User
ﬂﬂ  
.
ﬂﬂ  !
Identity
ﬂﬂ! )
.
ﬂﬂ) *
Name
ﬂﬂ* .
}
ﬂﬂ. /
$str
ﬂﬂ/ >
{
ﬂﬂ> ?
book
ﬂﬂ? C
.
ﬂﬂC D
Id
ﬂﬂD F
}
ﬂﬂF G
"
ﬂﬂG H
)
ﬂﬂH I
;
ﬂﬂI J
return
‡‡ 
Json
‡‡ 
(
‡‡ 
new
‡‡ 
OperationResult
‡‡  /
(
‡‡/ 0
)
‡‡0 1
.
‡‡1 2

SetSuccess
‡‡2 <
(
‡‡< =
)
‡‡= >
)
‡‡> ?
;
‡‡? @
}
·· 
catch
‚‚ 
(
‚‚ 
	Exception
‚‚ 
ex
‚‚ 
)
‚‚  
{
„„ 
log
‰‰ 
.
‰‰ 
Error
‰‰ 
(
‰‰ 
ex
‰‰ 
)
‰‰ 
;
‰‰ 
return
ÂÂ 
Json
ÂÂ 
(
ÂÂ 
new
ÂÂ 
OperationResult
ÂÂ  /
(
ÂÂ/ 0
)
ÂÂ0 1
.
ÂÂ1 2
SetFail
ÂÂ2 9
(
ÂÂ9 :
ex
ÂÂ: <
)
ÂÂ< =
)
ÂÂ= >
;
ÂÂ> ?
}
ÊÊ 
}
ÁÁ 	
[
ÈÈ 	
HttpPost
ÈÈ	 
]
ÈÈ 
public
ÍÍ 
async
ÍÍ 
Task
ÍÍ 
<
ÍÍ 

JsonResult
ÍÍ $
>
ÍÍ$ %
AddCover
ÍÍ& .
(
ÍÍ. /
[
ÍÍ/ 0
FromServices
ÍÍ0 <
]
ÍÍ< =
BookDbContext
ÍÍ> K
ctx
ÍÍL O
)
ÍÍO P
{
ÎÎ 	
var
ÓÓ 
result
ÓÓ 
=
ÓÓ 
new
ÓÓ 
OperationResult
ÓÓ ,
(
ÓÓ, -
)
ÓÓ- .
;
ÓÓ. /
try
ÔÔ 
{
 
var
ÒÒ 
file
ÒÒ 
=
ÒÒ 
Request
ÒÒ "
.
ÒÒ" #
Form
ÒÒ# '
.
ÒÒ' (
Files
ÒÒ( -
.
ÒÒ- .
FirstOrDefault
ÒÒ. <
(
ÒÒ< =
)
ÒÒ= >
;
ÒÒ> ?
if
ÚÚ 
(
ÚÚ 
file
ÚÚ 
==
ÚÚ 
null
ÚÚ  
)
ÚÚ  !
{
ÛÛ 
return
ÙÙ 
Json
ÙÙ 
(
ÙÙ  
result
ÙÙ  &
.
ÙÙ& '
SetFail
ÙÙ' .
(
ÙÙ. /
$str
ÙÙ/ A
)
ÙÙA B
)
ÙÙB C
;
ÙÙC D
}
ıı 
var
˜˜ 
fileExtention
˜˜ !
=
˜˜" #
System
˜˜$ *
.
˜˜* +
IO
˜˜+ -
.
˜˜- .
Path
˜˜. 2
.
˜˜2 3
GetExtension
˜˜3 ?
(
˜˜? @+
ContentDispositionHeaderValue
˜˜@ ]
.
¯¯ 
Parse
¯¯ 
(
¯¯ 
file
¯¯ 
.
¯¯   
ContentDisposition
¯¯  2
)
¯¯2 3
.
˘˘ 
FileName
˘˘ 
.
˙˙ 
Trim
˙˙ 
(
˙˙ 
$char
˙˙ 
)
˙˙ 
)
˙˙ 
;
˙˙  
if
˚˚ 
(
˚˚ 
fileExtention
˚˚ !
==
˚˚" $
$str
˚˚% '
)
˚˚' (
{
¸¸ 
return
˝˝ 
Json
˝˝ 
(
˝˝  
result
˝˝  &
.
˝˝& '
SetFail
˝˝' .
(
˝˝. /
$str
˝˝/ =
)
˝˝= >
)
˝˝> ?
;
˝˝? @
}
˛˛ 
;
˛˛ 
var
ÄÄ 
	coverName
ÄÄ 
=
ÄÄ 
file
ÄÄ  $
.
ÄÄ$ %
FileName
ÄÄ% -
;
ÄÄ- .
if
ÇÇ 
(
ÇÇ 
_browser
ÇÇ 
.
ÇÇ 
Type
ÇÇ !
==
ÇÇ" $
BrowserType
ÇÇ% 0
.
ÇÇ0 1
Edge
ÇÇ1 5
||
ÇÇ6 8
_browser
ÇÇ9 A
.
ÇÇA B
Type
ÇÇB F
==
ÇÇG I
BrowserType
ÇÇJ U
.
ÇÇU V
IE
ÇÇV X
)
ÇÇX Y
{
ÉÉ 
	coverName
ÑÑ 
=
ÑÑ 
file
ÑÑ  $
.
ÑÑ$ %
FileName
ÑÑ% -
.
ÑÑ- .
Split
ÑÑ. 3
(
ÑÑ3 4
$char
ÑÑ4 8
)
ÑÑ8 9
.
ÑÑ9 :
Last
ÑÑ: >
(
ÑÑ> ?
)
ÑÑ? @
;
ÑÑ@ A
}
ÖÖ 
var
áá 
uriPath
áá 
=
áá 
$@"
áá !
$str
áá! 0
{
áá0 1
file
áá1 5
.
áá5 6
FileName
áá6 >
}
áá> ?
"
áá? @
;
áá@ A
var
àà 
fullPath
àà 
=
àà 
$@"
àà "
{
àà" #!
_hostingEnvironment
àà# 6
.
àà6 7
WebRootPath
àà7 B
}
ààB C
$str
ààC R
{
ààR S
file
ààS W
.
ààW X
FileName
ààX `
}
àà` a
"
ààa b
;
ààb c
if
ââ 
(
ââ 
System
ââ 
.
ââ 
IO
ââ 
.
ââ 
File
ââ "
.
ââ" #
Exists
ââ# )
(
ââ) *
fullPath
ââ* 2
)
ââ2 3
)
ââ3 4
{
ää 
return
ãã 
Json
ãã 
(
ãã  
result
ãã  &
.
ãã& '
SetFail
ãã' .
(
ãã. /
$strãã/ Ü
)ããÜ á
)ããá à
;ããà â
}
åå 
new
çç 
System
çç 
.
çç 
IO
çç 
.
çç 
FileInfo
çç &
(
çç& '
fullPath
çç' /
)
çç/ 0
.
çç0 1
	Directory
çç1 :
.
çç: ;
Create
çç; A
(
ççA B
)
ççB C
;
ççC D
using
éé 
(
éé 
var
éé 
fs
éé 
=
éé 
System
éé  &
.
éé& '
IO
éé' )
.
éé) *
File
éé* .
.
éé. /
Exists
éé/ 5
(
éé5 6
fullPath
éé6 >
)
éé> ?
?
éé@ A
System
ééB H
.
ééH I
IO
ééI K
.
ééK L
File
ééL P
.
ééP Q
	OpenWrite
ééQ Z
(
ééZ [
fullPath
éé[ c
)
ééc d
:
éée f
System
éég m
.
éém n
IO
één p
.
éép q
File
ééq u
.
ééu v
Create
éév |
(
éé| }
fullPathéé} Ö
)ééÖ Ü
)ééÜ á
{
èè 
file
êê 
.
êê 
CopyTo
êê 
(
êê  
fs
êê  "
)
êê" #
;
êê# $
fs
ëë 
.
ëë 
Flush
ëë 
(
ëë 
)
ëë 
;
ëë 
}
íí 
return
ññ 
Json
ññ 
(
ññ 
result
ññ "
.
ññ" #

SetSuccess
ññ# -
(
ññ- .
$str
ññ. I
)
ññI J
)
ññJ K
;
ññK L
}
óó 
catch
òò 
(
òò 
	Exception
òò 
e
òò 
)
òò 
{
ôô 
log
öö 
.
öö 
Error
öö 
(
öö 
e
öö 
)
öö 
;
öö 
return
õõ 
Json
õõ 
(
õõ 
result
õõ "
.
õõ" #
SetFail
õõ# *
(
õõ* +
e
õõ+ ,
)
õõ, -
)
õõ- .
;
õõ. /
}
úú 
}
ùù 	
[
üü 	
HttpPost
üü	 
]
üü 
public
†† 
async
†† 
Task
†† 
<
†† 

JsonResult
†† $
>
††$ %
SetFile
††& -
(
††- .
[
††. /
FromServices
††/ ;
]
††; <
BookDbContext
††= J
ctx
††K N
)
††N O
{
°° 	
try
¢¢ 
{
££ 
var
§§ 
result
§§ 
=
§§ 
new
§§  
OperationResult
§§! 0
(
§§0 1
)
§§1 2
;
§§2 3
var
•• 
file
•• 
=
•• 
Request
•• "
.
••" #
Form
••# '
.
••' (
Files
••( -
.
••- .
FirstOrDefault
••. <
(
••< =
)
••= >
;
••> ?
if
¶¶ 
(
¶¶ 
file
¶¶ 
==
¶¶ 
null
¶¶  
)
¶¶  !
{
ßß 
return
®® 
Json
®® 
(
®®  
result
®®  &
.
®®& '
SetFail
®®' .
(
®®. /
$str
®®/ ?
)
®®? @
)
®®@ A
;
®®A B
}
©© 
var
™™ 
fileExtention
™™ !
=
™™" #
System
™™$ *
.
™™* +
IO
™™+ -
.
™™- .
Path
™™. 2
.
™™2 3
GetExtension
™™3 ?
(
™™? @+
ContentDispositionHeaderValue
™™@ ]
.
´´ 
Parse
´´ 
(
´´ 
file
´´ 
.
´´   
ContentDisposition
´´  2
)
´´2 3
.
¨¨ 
FileName
¨¨ 
.
≠≠ 
Trim
≠≠ 
(
≠≠ 
$char
≠≠ 
)
≠≠ 
)
≠≠ 
;
≠≠  
if
ÆÆ 
(
ÆÆ 
fileExtention
ÆÆ !
==
ÆÆ" $
$str
ÆÆ% '
)
ÆÆ' (
{
ØØ 
return
∞∞ 
Json
∞∞ 
(
∞∞  
result
∞∞  &
.
∞∞& '
SetFail
∞∞' .
(
∞∞. /
$str
∞∞/ 9
)
∞∞9 :
)
∞∞: ;
;
∞∞; <
}
±± 
;
±± 
var
≤≤ 
FileName
≤≤ 
=
≤≤ 
file
≤≤ #
.
≤≤# $
FileName
≤≤$ ,
;
≤≤, -
if
≥≥ 
(
≥≥ 
_browser
≥≥ 
.
≥≥ 
Type
≥≥ !
==
≥≥" $
BrowserType
≥≥% 0
.
≥≥0 1
Edge
≥≥1 5
||
≥≥6 8
_browser
≥≥9 A
.
≥≥A B
Type
≥≥B F
==
≥≥G I
BrowserType
≥≥J U
.
≥≥U V
IE
≥≥V X
)
≥≥X Y
{
¥¥ 
FileName
µµ 
=
µµ 
file
µµ #
.
µµ# $
FileName
µµ$ ,
.
µµ, -
Split
µµ- 2
(
µµ2 3
$char
µµ3 7
)
µµ7 8
.
µµ8 9
Last
µµ9 =
(
µµ= >
)
µµ> ?
;
µµ? @
}
∂∂ 
var
∏∏ 
fullPath
∏∏ 
=
∏∏ 
$@"
∏∏ "
{
∏∏" #!
_hostingEnvironment
∏∏# 6
.
∏∏6 7
WebRootPath
∏∏7 B
}
∏∏B C
$str
∏∏C K
{
∏∏K L
file
∏∏L P
.
∏∏P Q
FileName
∏∏Q Y
}
∏∏Y Z
"
∏∏Z [
;
∏∏[ \
if
ππ 
(
ππ 
System
ππ 
.
ππ 
IO
ππ 
.
ππ 
File
ππ "
.
ππ" #
Exists
ππ# )
(
ππ) *
fullPath
ππ* 2
)
ππ2 3
)
ππ3 4
{
∫∫ 
return
ªª 
Json
ªª 
(
ªª  
result
ªª  &
.
ªª& '
SetFail
ªª' .
(
ªª. /
$str
ªª/ 
)ªª Ä
)ªªÄ Å
;ªªÅ Ç
}
ºº 
new
ΩΩ 
System
ΩΩ 
.
ΩΩ 
IO
ΩΩ 
.
ΩΩ 
FileInfo
ΩΩ &
(
ΩΩ& '
fullPath
ΩΩ' /
)
ΩΩ/ 0
.
ΩΩ0 1
	Directory
ΩΩ1 :
.
ΩΩ: ;
Create
ΩΩ; A
(
ΩΩA B
)
ΩΩB C
;
ΩΩC D
using
ææ 
(
ææ 
var
ææ 
fs
ææ 
=
ææ 
System
ææ  &
.
ææ& '
IO
ææ' )
.
ææ) *
File
ææ* .
.
ææ. /
Exists
ææ/ 5
(
ææ5 6
fullPath
ææ6 >
)
ææ> ?
?
ææ@ A
System
ææB H
.
ææH I
IO
ææI K
.
ææK L
File
ææL P
.
ææP Q
	OpenWrite
ææQ Z
(
ææZ [
fullPath
ææ[ c
)
ææc d
:
ææe f
System
ææg m
.
ææm n
IO
ææn p
.
ææp q
File
ææq u
.
ææu v
Create
ææv |
(
ææ| }
fullPathææ} Ö
)ææÖ Ü
)ææÜ á
{
øø 
file
¿¿ 
.
¿¿ 
CopyTo
¿¿ 
(
¿¿  
fs
¿¿  "
)
¿¿" #
;
¿¿# $
fs
¡¡ 
.
¡¡ 
Flush
¡¡ 
(
¡¡ 
)
¡¡ 
;
¡¡ 
}
¬¬ 
return
√√ 
Json
√√ 
(
√√ 
result
√√ "
.
√√" #

SetSuccess
√√# -
(
√√- .
$str
√√. D
)
√√D E
)
√√E F
;
√√F G
}
ƒƒ 
catch
≈≈ 
(
≈≈ 
	Exception
≈≈ 
e
≈≈ 
)
≈≈ 
{
∆∆ 
NLog
«« 
.
«« 

LogManager
«« 
.
««  #
GetCurrentClassLogger
««  5
(
««5 6
)
««6 7
.
««7 8
Error
««8 =
(
««= >
e
««> ?
)
««? @
;
««@ A
return
»» 
Json
»» 
(
»» 
$str
»» -
)
»»- .
;
»». /
}
…… 
}
   	
public
ÃÃ 
async
ÃÃ 
Task
ÃÃ 
<
ÃÃ 

JsonResult
ÃÃ $
>
ÃÃ$ %
EditBook
ÃÃ& .
(
ÃÃ. /
[
ÃÃ/ 0
FromServices
ÃÃ0 <
]
ÃÃ< =
BookDbContext
ÃÃ> K
ctx
ÃÃL O
,
ÃÃO P
[
ÃÃQ R
FromBody
ÃÃR Z
]
ÃÃZ [
AddBookForm
ÃÃ\ g
model
ÃÃh m
)
ÃÃm n
{
ÕÕ 	
var
ŒŒ 
result
ŒŒ 
=
ŒŒ 
new
ŒŒ 
OperationResult
ŒŒ ,
(
ŒŒ, -
)
ŒŒ- .
;
ŒŒ. /
try
–– 
{
—— 
if
““ 
(
““ 
model
““ 
.
““ 
Authors
““ !
!=
““" $
null
““% )
)
““) *
{
”” 
var
‘‘ 
authors
‘‘ 
=
‘‘  !
ctx
‘‘" %
.
‘‘% &
Authors
‘‘& -
.
‘‘- .
Where
‘‘. 3
(
‘‘3 4
q
‘‘4 5
=>
‘‘6 8
model
‘‘9 >
.
‘‘> ?
Authors
‘‘? F
.
‘‘F G
Contains
‘‘G O
(
‘‘O P
q
‘‘P Q
.
‘‘Q R
	AuthorUid
‘‘R [
)
‘‘[ \
)
‘‘\ ]
;
‘‘] ^
if
’’ 
(
’’ 
authors
’’ 
.
’’  
Count
’’  %
(
’’% &
)
’’& '
!=
’’( *
model
’’+ 0
.
’’0 1
Authors
’’1 8
.
’’8 9
Count
’’9 >
(
’’> ?
)
’’? @
)
’’@ A
{
÷÷ 
return
◊◊ 
Json
◊◊ #
(
◊◊# $
result
◊◊$ *
.
◊◊* +
SetFail
◊◊+ 2
(
◊◊2 3
$str
◊◊3 j
)
◊◊j k
)
◊◊k l
;
◊◊l m
}
ÿÿ 
}
ŸŸ 
if
€€ 
(
€€ 
model
€€ 
.
€€ 

Categories
€€ $
!=
€€% '
null
€€( ,
)
€€, -
{
‹‹ 
var
›› 

categories
›› "
=
››# $
ctx
››% (
.
››( )

Categories
››) 3
.
››3 4
Where
››4 9
(
››9 :
q
››: ;
=>
››< >
model
››? D
.
››D E

Categories
››E O
.
››O P
Contains
››P X
(
››X Y
q
››Y Z
.
››Z [

CategoryId
››[ e
)
››e f
)
››f g
;
››g h
if
ﬁﬁ 
(
ﬁﬁ 

categories
ﬁﬁ "
.
ﬁﬁ" #
Count
ﬁﬁ# (
(
ﬁﬁ( )
)
ﬁﬁ) *
!=
ﬁﬁ+ -
model
ﬁﬁ. 3
.
ﬁﬁ3 4

Categories
ﬁﬁ4 >
.
ﬁﬁ> ?
Count
ﬁﬁ? D
(
ﬁﬁD E
)
ﬁﬁE F
)
ﬁﬁF G
{
ﬂﬂ 
return
‡‡ 
Json
‡‡ #
(
‡‡# $
result
‡‡$ *
.
‡‡* +
SetFail
‡‡+ 2
(
‡‡2 3
$str
‡‡3 l
)
‡‡l m
)
‡‡m n
;
‡‡n o
}
·· 
}
‚‚ 
var
‰‰ 
book
‰‰ 
=
‰‰ 
ctx
‰‰ 
.
‰‰ 
Books
‰‰ $
.
‰‰$ %
FirstOrDefault
‰‰% 3
(
‰‰3 4
q
‰‰4 5
=>
‰‰6 8
q
‰‰9 :
.
‰‰: ;
BiaId
‰‰; @
==
‰‰A C
model
‰‰D I
.
‰‰I J
Id
‰‰J L
)
‰‰L M
;
‰‰M N
if
ÂÂ 
(
ÂÂ 
book
ÂÂ 
==
ÂÂ 
null
ÂÂ  
)
ÂÂ  !
{
ÊÊ 
return
ÁÁ 
Json
ÁÁ 
(
ÁÁ  
result
ÁÁ  &
.
ÁÁ& '
SetFail
ÁÁ' .
(
ÁÁ. /
$str
ÁÁ/ U
)
ÁÁU V
)
ÁÁV W
;
ÁÁW X
}
ËË 
if
ÍÍ 
(
ÍÍ 
model
ÍÍ 
.
ÍÍ 
Title
ÍÍ 
!=
ÍÍ  "
null
ÍÍ# '
)
ÍÍ' (
if
ÎÎ 
(
ÎÎ 
model
ÎÎ 
.
ÎÎ 
Title
ÎÎ #
!=
ÎÎ$ &
book
ÎÎ' +
.
ÎÎ+ ,
Title
ÎÎ, 1
)
ÎÎ1 2
{
ÏÏ 
book
ÌÌ 
.
ÌÌ 
Title
ÌÌ "
=
ÌÌ# $
model
ÌÌ% *
.
ÌÌ* +
Title
ÌÌ+ 0
;
ÌÌ0 1
}
ÓÓ 
if
ÔÔ 
(
ÔÔ 
model
ÔÔ 
.
ÔÔ 
Subtitle
ÔÔ "
!=
ÔÔ# %
null
ÔÔ& *
)
ÔÔ* +
if
 
(
 
model
 
.
 
Subtitle
 &
!=
' )
book
* .
.
. /
Subtitle
/ 7
)
7 8
{
ÒÒ 
book
ÚÚ 
.
ÚÚ 
Subtitle
ÚÚ %
=
ÚÚ& '
model
ÚÚ( -
.
ÚÚ- .
Subtitle
ÚÚ. 6
;
ÚÚ6 7
}
ÛÛ 
if
ÙÙ 
(
ÙÙ 
model
ÙÙ 
.
ÙÙ 

Annotation
ÙÙ $
!=
ÙÙ% '
null
ÙÙ( ,
)
ÙÙ, -
if
ıı 
(
ıı 
model
ıı 
.
ıı 

Annotation
ıı (
!=
ıı) +
book
ıı, 0
.
ıı0 1

Annotation
ıı1 ;
)
ıı; <
{
ˆˆ 
book
˜˜ 
.
˜˜ 

Annotation
˜˜ '
=
˜˜( )
model
˜˜* /
.
˜˜/ 0

Annotation
˜˜0 :
;
˜˜: ;
}
¯¯ 
if
˘˘ 
(
˘˘ 
model
˘˘ 
.
˘˘ 

CoverImage
˘˘ $
!=
˘˘% '
null
˘˘( ,
)
˘˘, -
if
˙˙ 
(
˙˙ 
model
˙˙ 
.
˙˙ 

CoverImage
˙˙ (
!=
˙˙) +
book
˙˙, 0
.
˙˙0 1

CoverImage
˙˙1 ;
)
˙˙; <
{
˚˚ 
book
¸¸ 
.
¸¸ 

CoverImage
¸¸ '
=
¸¸( )
$@"
¸¸* -
$str
¸¸- <
{
¸¸< =
model
¸¸= B
.
¸¸B C

CoverImage
¸¸C M
}
¸¸M N
"
¸¸N O
;
¸¸O P
}
˝˝ 
if
˛˛ 
(
˛˛ 
model
˛˛ 
.
˛˛ 
Year
˛˛ 
!=
˛˛ !
null
˛˛" &
)
˛˛& '
if
ˇˇ 
(
ˇˇ 
model
ˇˇ 
.
ˇˇ 
Year
ˇˇ "
!=
ˇˇ# %
book
ˇˇ& *
.
ˇˇ* +
Year
ˇˇ+ /
)
ˇˇ/ 0
{
ÄÄ 
book
ÅÅ 
.
ÅÅ 
Year
ÅÅ !
=
ÅÅ" #
model
ÅÅ$ )
.
ÅÅ) *
Year
ÅÅ* .
;
ÅÅ. /
}
ÇÇ 
if
ÉÉ 
(
ÉÉ 
model
ÉÉ 
.
ÉÉ 
Isbn
ÉÉ 
!=
ÉÉ !
null
ÉÉ" &
)
ÉÉ& '
{
ÑÑ 
if
ÖÖ 
(
ÖÖ 
model
ÖÖ 
.
ÖÖ 
Isbn
ÖÖ "
.
ÖÖ" #
Length
ÖÖ# )
>
ÖÖ* +
$num
ÖÖ, .
)
ÖÖ. /
throw
ÜÜ 
new
ÜÜ !
	Exception
ÜÜ" +
(
ÜÜ+ ,
$str
ÜÜ, S
)
ÜÜS T
;
ÜÜT U
if
áá 
(
áá 
model
áá 
.
áá 
Isbn
áá "
==
áá# %
book
áá& *
.
áá* +
Isbn
áá+ /
)
áá/ 0
{
àà 
book
ââ 
.
ââ 
Isbn
ââ !
=
ââ" #
model
ââ$ )
.
ââ) *
Isbn
ââ* .
;
ââ. /
}
ää 
else
ãã 
{
åå 
var
çç 
uiqIsbnColl
çç '
=
çç( )
ctx
çç* -
.
çç- .
Books
çç. 3
.
çç3 4
Where
çç4 9
(
çç9 :
b
çç: ;
=>
çç< >
b
çç? @
.
çç@ A
Isbn
ççA E
==
ççF H
model
ççI N
.
ççN O
Isbn
ççO S
)
ççS T
;
ççT U
if
éé 
(
éé 
uiqIsbnColl
éé '
.
éé' (
Count
éé( -
(
éé- .
)
éé. /
>
éé0 1
$num
éé2 3
)
éé3 4
{
èè 
throw
êê !
new
êê" %
	Exception
êê& /
(
êê/ 0
$str
êê0 \
)
êê\ ]
;
êê] ^
}
ëë 
else
íí 
book
ìì  
.
ìì  !
Isbn
ìì! %
=
ìì& '
model
ìì( -
.
ìì- .
Isbn
ìì. 2
;
ìì2 3
}
îî 
}
ïï 
if
òò 
(
òò 
model
òò 
.
òò 
Language
òò "
!=
òò# %
book
òò& *
.
òò* +
Language
òò+ 3
)
òò3 4
{
ôô 
book
öö 
.
öö 
Language
öö !
=
öö" #
model
öö$ )
.
öö) *
Language
öö* 2
;
öö2 3
}
õõ 
if
úú 
(
úú 
model
úú 
.
úú 
Edition
úú !
!=
úú" $
null
úú% )
)
úú) *
if
ùù 
(
ùù 
model
ùù 
.
ùù 
Edition
ùù %
!=
ùù& (
book
ùù) -
.
ùù- .
Edition
ùù. 5
)
ùù5 6
{
ûû 
book
üü 
.
üü 
Edition
üü $
=
üü% &
model
üü' ,
.
üü, -
Edition
üü- 4
;
üü4 5
}
†† 
if
°° 
(
°° 
model
°° 
.
°° 
Pages
°° 
!=
°°  "
null
°°# '
)
°°' (
if
¢¢ 
(
¢¢ 
model
¢¢ 
.
¢¢ 
Pages
¢¢ #
!=
¢¢$ &
book
¢¢' +
.
¢¢+ ,
Pages
¢¢, 1
)
¢¢1 2
{
££ 
book
§§ 
.
§§ 
Pages
§§ "
=
§§# $
model
§§% *
.
§§* +
Pages
§§+ 0
;
§§0 1
}
•• 
if
ßß 
(
ßß 
string
ßß 
.
ßß  
IsNullOrWhiteSpace
ßß -
(
ßß- .
model
ßß. 3
.
ßß3 4
Link
ßß4 8
)
ßß8 9
==
ßß: <
false
ßß= B
)
ßßB C
{
®® 
var
©© 
ebook
©© 
=
©© 
book
©©  $
as
©©% '
Ebook
©©( -
;
©©- .
ebook
™™ 
.
™™ 
Link
™™ 
=
™™  
model
™™! &
.
™™& '
Link
™™' +
;
™™+ ,
}
´´ 
if
≠≠ 
(
≠≠ 
model
≠≠ 
.
≠≠ 
Authors
≠≠ !
!=
≠≠" $
null
≠≠% )
)
≠≠) *
{
ÆÆ 
var
ØØ 
deleted
ØØ 
=
ØØ  !
ctx
∞∞ 
.
∞∞ 
BookAuthors
∞∞ '
.
∞∞' (
Where
∞∞( -
(
∞∞- .
q
∞∞. /
=>
∞∞0 2
q
∞∞3 4
.
∞∞4 5
BookId
∞∞5 ;
==
∞∞< >
book
∞∞? C
.
∞∞C D
BiaId
∞∞D I
&&
∞∞J L
!
∞∞M N
model
∞∞N S
.
∞∞S T
Authors
∞∞T [
.
∞∞[ \
Contains
∞∞\ d
(
∞∞d e
q
∞∞e f
.
∞∞f g
	AuthorUid
∞∞g p
)
∞∞p q
)
∞∞q r
;
∞∞r s
if
±± 
(
±± 
deleted
±± 
.
±±  
Any
±±  #
(
±±# $
)
±±$ %
)
±±% &
{
≤≤ 
ctx
≥≥ 
.
≥≥ 
BookAuthors
≥≥ '
.
≥≥' (
RemoveRange
≥≥( 3
(
≥≥3 4
deleted
≥≥4 ;
)
≥≥; <
;
≥≥< =
}
¥¥ 
foreach
∂∂ 
(
∂∂ 
var
∂∂  
author
∂∂! '
in
∂∂( *
model
∂∂+ 0
.
∂∂0 1
Authors
∂∂1 8
)
∂∂8 9
{
∑∑ 
if
∏∏ 
(
∏∏ 
!
∏∏ 
book
∏∏ !
.
∏∏! "
Authors
∏∏" )
.
∏∏) *
Any
∏∏* -
(
∏∏- .
q
∏∏. /
=>
∏∏0 2
q
∏∏3 4
.
∏∏4 5
	AuthorUid
∏∏5 >
==
∏∏? A
author
∏∏B H
)
∏∏H I
)
∏∏I J
{
ππ 
var
∫∫ 

bookAuthor
∫∫  *
=
∫∫+ ,
new
∫∫- 0

BookAuthor
∫∫1 ;
(
∫∫; <
)
∫∫< =
{
ªª 
BookId
ºº  &
=
ºº' (
book
ºº) -
.
ºº- .
BiaId
ºº. 3
,
ºº3 4
	AuthorUid
ΩΩ  )
=
ΩΩ* +
author
ΩΩ, 2
}
ææ 
;
ææ 
ctx
øø 
.
øø  
BookAuthors
øø  +
.
øø+ ,
Add
øø, /
(
øø/ 0

bookAuthor
øø0 :
)
øø: ;
;
øø; <
}
¿¿ 
}
¡¡ 
}
¬¬ 
else
√√ 
{
ƒƒ 
var
≈≈ 
deleted
≈≈ 
=
≈≈  !
ctx
≈≈" %
.
≈≈% &
BookAuthors
≈≈& 1
.
≈≈1 2
Where
≈≈2 7
(
≈≈7 8
q
≈≈8 9
=>
≈≈: <
q
≈≈= >
.
≈≈> ?
BookId
≈≈? E
==
≈≈F H
book
≈≈I M
.
≈≈M N
BiaId
≈≈N S
)
≈≈S T
;
≈≈T U
if
∆∆ 
(
∆∆ 
deleted
∆∆ 
.
∆∆  
Any
∆∆  #
(
∆∆# $
)
∆∆$ %
)
∆∆% &
ctx
«« 
.
«« 
BookAuthors
«« '
.
««' (
RemoveRange
««( 3
(
««3 4
deleted
««4 ;
)
««; <
;
««< =
}
»» 
if
   
(
   
model
   
.
   

Categories
   $
!=
  % '
null
  ( ,
)
  , -
{
ÀÀ 
var
ÃÃ 
deleted
ÃÃ 
=
ÃÃ  !
ctx
ÕÕ 
.
ÕÕ 
BookCategories
ÕÕ *
.
ŒŒ 
Where
ŒŒ "
(
ŒŒ" #
q
ŒŒ# $
=>
ŒŒ% '
q
ŒŒ( )
.
ŒŒ) *
BookId
ŒŒ* 0
==
ŒŒ1 3
book
ŒŒ4 8
.
ŒŒ8 9
BiaId
ŒŒ9 >
&&
ŒŒ? A
!
ŒŒB C
model
ŒŒC H
.
ŒŒH I

Categories
ŒŒI S
.
ŒŒS T
Contains
ŒŒT \
(
ŒŒ\ ]
q
ŒŒ] ^
.
ŒŒ^ _

CategoryId
ŒŒ_ i
)
ŒŒi j
)
ŒŒj k
;
ŒŒk l
if
œœ 
(
œœ 
deleted
œœ 
.
œœ  
Any
œœ  #
(
œœ# $
)
œœ$ %
)
œœ% &
{
–– 
ctx
—— 
.
—— 
BookCategories
—— *
.
——* +
RemoveRange
——+ 6
(
——6 7
deleted
——7 >
)
——> ?
;
——? @
}
““ 
foreach
‘‘ 
(
‘‘ 
var
‘‘  
category
‘‘! )
in
‘‘* ,
model
‘‘- 2
.
‘‘2 3

Categories
‘‘3 =
)
‘‘= >
{
’’ 
if
÷÷ 
(
÷÷ 
!
÷÷ 
book
÷÷ !
.
÷÷! "
Cathegories
÷÷" -
.
÷÷- .
Any
÷÷. 1
(
÷÷1 2
q
÷÷2 3
=>
÷÷4 6
q
÷÷7 8
.
÷÷8 9

CategoryId
÷÷9 C
==
÷÷D F
category
÷÷G O
)
÷÷O P
)
÷÷P Q
{
◊◊ 
var
ÿÿ 
bookCategory
ÿÿ  ,
=
ÿÿ- .
new
ÿÿ/ 2
BookCategory
ÿÿ3 ?
(
ÿÿ? @
)
ÿÿ@ A
{
ŸŸ 
BookId
⁄⁄  &
=
⁄⁄' (
book
⁄⁄) -
.
⁄⁄- .
BiaId
⁄⁄. 3
,
⁄⁄3 4

CategoryId
€€  *
=
€€+ ,
category
€€- 5
}
‹‹ 
;
‹‹ 
ctx
›› 
.
››  
BookCategories
››  .
.
››. /
Add
››/ 2
(
››2 3
bookCategory
››3 ?
)
››? @
;
››@ A
}
ﬁﬁ 
}
ﬂﬂ 
}
‡‡ 
else
·· 
{
‚‚ 
var
„„ 
deleted
„„ 
=
„„  !
ctx
„„" %
.
„„% &
BookCategories
„„& 4
.
„„4 5
Where
„„5 :
(
„„: ;
q
„„; <
=>
„„= ?
q
„„@ A
.
„„A B
BookId
„„B H
==
„„I K
book
„„L P
.
„„P Q
BiaId
„„Q V
)
„„V W
;
„„W X
if
‰‰ 
(
‰‰ 
deleted
‰‰ 
.
‰‰  
Any
‰‰  #
(
‰‰# $
)
‰‰$ %
)
‰‰% &
ctx
ÂÂ 
.
ÂÂ 
BookCategories
ÂÂ *
.
ÂÂ* +
RemoveRange
ÂÂ+ 6
(
ÂÂ6 7
deleted
ÂÂ7 >
)
ÂÂ> ?
;
ÂÂ? @
}
ÊÊ 
ctx
ËË 
.
ËË 
SaveChanges
ËË 
(
ËË  
)
ËË  !
;
ËË! "
log
ÈÈ 
.
ÈÈ 
Info
ÈÈ 
(
ÈÈ 
$"
ÈÈ 
{
ÈÈ 
User
ÈÈ  
.
ÈÈ  !
Identity
ÈÈ! )
.
ÈÈ) *
Name
ÈÈ* .
}
ÈÈ. /
$str
ÈÈ/ ;
{
ÈÈ; <
book
ÈÈ< @
.
ÈÈ@ A
BiaId
ÈÈA F
}
ÈÈF G
"
ÈÈG H
)
ÈÈH I
;
ÈÈI J
return
ÍÍ 
Json
ÍÍ 
(
ÍÍ 
result
ÍÍ "
.
ÍÍ" #

SetSuccess
ÍÍ# -
(
ÍÍ- .
)
ÍÍ. /
)
ÍÍ/ 0
;
ÍÍ0 1
}
ÎÎ 
catch
ÏÏ 
(
ÏÏ 
	Exception
ÏÏ 
e
ÏÏ 
)
ÏÏ 
{
ÌÌ 
log
ÓÓ 
.
ÓÓ 
Error
ÓÓ 
(
ÓÓ 
e
ÓÓ 
)
ÓÓ 
;
ÓÓ 
return
ÔÔ 
Json
ÔÔ 
(
ÔÔ 
result
ÔÔ "
.
ÔÔ" #
SetFail
ÔÔ# *
(
ÔÔ* +
e
ÔÔ+ ,
)
ÔÔ, -
)
ÔÔ- .
;
ÔÔ. /
}
 
}
ÒÒ 	
public
ÛÛ 
async
ÛÛ 
Task
ÛÛ 
<
ÛÛ 

JsonResult
ÛÛ $
>
ÛÛ$ %

DeleteBook
ÛÛ& 0
(
ÛÛ0 1
[
ÛÛ1 2
FromServices
ÛÛ2 >
]
ÛÛ> ?
BookDbContext
ÛÛ@ M
ctx
ÛÛN Q
,
ÛÛQ R
[
ÛÛS T
FromBody
ÛÛT \
]
ÛÛ\ ]
int
ÛÛ^ a
id
ÛÛb d
)
ÛÛd e
{
ÙÙ 	
var
ıı 
result
ıı 
=
ıı 
new
ıı 
OperationResult
ıı ,
(
ıı, -
)
ıı- .
;
ıı. /
try
˜˜ 
{
¯¯ 
var
˘˘ 
book
˘˘ 
=
˘˘ 
ctx
˘˘ 
.
˘˘ 
Books
˘˘ $
.
˘˘$ %
FirstOrDefault
˘˘% 3
(
˘˘3 4
q
˘˘4 5
=>
˘˘6 8
q
˘˘9 :
.
˘˘: ;
BiaId
˘˘; @
==
˘˘A C
id
˘˘D F
)
˘˘F G
;
˘˘G H
if
˚˚ 
(
˚˚ 
book
˚˚ 
is
˚˚ 
	PaperBook
˚˚ %
)
˚˚% &
{
¸¸ 
var
˝˝ 
papper
˝˝ 
=
˝˝  
book
˝˝! %
as
˝˝& (
	PaperBook
˝˝) 2
;
˝˝2 3
if
˛˛ 
(
˛˛ 
papper
˛˛ 
.
˛˛ 
TakenByUser
˛˛ *
!=
˛˛+ -
null
˛˛. 2
)
˛˛2 3
{
ˇˇ 
return
ÄÄ 
Json
ÄÄ #
(
ÄÄ# $
new
ÄÄ$ '
OperationResult
ÄÄ( 7
(
ÄÄ7 8
)
ÄÄ8 9
.
ÄÄ9 :
SetFail
ÄÄ: A
(
ÄÄA B
$"
ÄÄB D
$str
ÄÄD j
{
ÄÄj k
papper
ÄÄk q
.
ÄÄq r
TakenByUser
ÄÄr }
.
ÄÄ} ~
FullNameÄÄ~ Ü
}ÄÄÜ á
"ÄÄá à
)ÄÄà â
)ÄÄâ ä
;ÄÄä ã
}
ÅÅ 
var
ÉÉ 
rentbook
ÉÉ  
=
ÉÉ! "
ctx
ÉÉ# &
.
ÉÉ& '
RentHistories
ÉÉ' 4
.
ÉÉ4 5
Where
ÉÉ5 :
(
ÉÉ: ;
q
ÉÉ; <
=>
ÉÉ= ?
q
ÉÉ@ A
.
ÉÉA B
	TakenBook
ÉÉB K
==
ÉÉL N
papper
ÉÉO U
)
ÉÉU V
;
ÉÉV W
if
ÑÑ 
(
ÑÑ 
rentbook
ÑÑ  
.
ÑÑ  !
Any
ÑÑ! $
(
ÑÑ$ %
)
ÑÑ% &
)
ÑÑ& '
ctx
ÖÖ 
.
ÖÖ 
RentHistories
ÖÖ )
.
ÖÖ) *
RemoveRange
ÖÖ* 5
(
ÖÖ5 6
rentbook
ÖÖ6 >
)
ÖÖ> ?
;
ÖÖ? @
}
ÜÜ 
var
àà 

authorbook
àà 
=
àà  
ctx
àà! $
.
àà$ %
BookAuthors
àà% 0
.
àà0 1
Where
àà1 6
(
àà6 7
q
àà7 8
=>
àà9 ;
q
àà< =
.
àà= >
BookId
àà> D
==
ààE G
book
ààH L
.
ààL M
BiaId
ààM R
)
ààR S
;
ààS T
var
ââ 
cathegoryBook
ââ !
=
ââ" #
ctx
ââ$ '
.
ââ' (
BookCategories
ââ( 6
.
ââ6 7
Where
ââ7 <
(
ââ< =
q
ââ= >
=>
ââ? A
q
ââB C
.
ââC D
BookId
ââD J
==
ââK M
book
ââN R
.
ââR S
BiaId
ââS X
)
ââX Y
;
ââY Z
var
ää 
reviews
ää 
=
ää 
ctx
ää !
.
ää! "
Reviews
ää" )
.
ää) *
Where
ää* /
(
ää/ 0
q
ää0 1
=>
ää2 4
q
ää5 6
.
ää6 7
BookId
ää7 =
==
ää> @
book
ääA E
.
ääE F
BiaId
ääF K
)
ääK L
;
ääL M
var
ãã 
requests
ãã 
=
ãã 
ctx
ãã "
.
ãã" #
RequestBooks
ãã# /
.
ãã/ 0
Where
ãã0 5
(
ãã5 6
q
ãã6 7
=>
ãã8 :
q
ãã; <
.
ãã< =
BookId
ãã= C
==
ããD F
book
ããG K
.
ããK L
BiaId
ããL Q
)
ããQ R
;
ããR S
if
çç 
(
çç 
book
çç 
is
çç 
Ebook
çç !
)
çç! "
{
éé 
var
èè 
ebook
èè 
=
èè 
book
èè  $
as
èè% '
Ebook
èè( -
;
èè- .
var
êê 
	downloads
êê !
=
êê" #
ctx
êê$ '
.
êê' (
DownloadHistories
êê( 9
.
êê9 :
Where
êê: ?
(
êê? @
q
êê@ A
=>
êêB D
q
êêE F
.
êêF G
DownloadedBook
êêG U
==
êêV X
ebook
êêY ^
)
êê^ _
;
êê_ `
if
ëë 
(
ëë 
	downloads
ëë !
.
ëë! "
Any
ëë" %
(
ëë% &
)
ëë& '
)
ëë' (
ctx
íí 
.
íí 
DownloadHistories
íí -
.
íí- .
RemoveRange
íí. 9
(
íí9 :
	downloads
íí: C
)
ííC D
;
ííD E
var
ìì 
fullPath
ìì  
=
ìì! "
$@"
ìì# &
{
ìì& '!
_hostingEnvironment
ìì' :
.
ìì: ;
WebRootPath
ìì; F
}
ììF G
$str
ììG O
{
ììO P
ebook
ììP U
.
ììU V
Link
ììV Z
}
ììZ [
"
ìì[ \
;
ìì\ ]
if
îî 
(
îî 
System
îî 
.
îî 
IO
îî !
.
îî! "
File
îî" &
.
îî& '
Exists
îî' -
(
îî- .
fullPath
îî. 6
)
îî6 7
)
îî7 8
{
ïï 
System
ññ 
.
ññ 
IO
ññ !
.
ññ! "
File
ññ" &
.
ññ& '
Delete
ññ' -
(
ññ- .
fullPath
ññ. 6
)
ññ6 7
;
ññ7 8
}
óó 
}
òò 
if
öö 
(
öö 
reviews
öö 
.
öö 
Any
öö 
(
öö  
)
öö  !
)
öö! "
ctx
õõ 
.
õõ 
Reviews
õõ 
.
õõ  
RemoveRange
õõ  +
(
õõ+ ,
reviews
õõ, 3
)
õõ3 4
;
õõ4 5
if
úú 
(
úú 
cathegoryBook
úú !
.
úú! "
Any
úú" %
(
úú% &
)
úú& '
)
úú' (
ctx
ùù 
.
ùù 
BookCategories
ùù &
.
ùù& '
RemoveRange
ùù' 2
(
ùù2 3
cathegoryBook
ùù3 @
)
ùù@ A
;
ùùA B
if
ûû 
(
ûû 

authorbook
ûû 
.
ûû 
Any
ûû "
(
ûû" #
)
ûû# $
)
ûû$ %
ctx
üü 
.
üü 
BookAuthors
üü #
.
üü# $
RemoveRange
üü$ /
(
üü/ 0

authorbook
üü0 :
)
üü: ;
;
üü; <
if
†† 
(
†† 
requests
†† 
.
†† 
Any
††  
(
††  !
)
††! "
)
††" #
ctx
°° 
.
°° 
RequestBooks
°° $
.
°°$ %
RemoveRange
°°% 0
(
°°0 1
requests
°°1 9
)
°°9 :
;
°°: ;
ctx
££ 
.
££ 
SaveChanges
££ 
(
££  
)
££  !
;
££! "
ctx
§§ 
.
§§ 
Books
§§ 
.
§§ 
Remove
§§  
(
§§  !
book
§§! %
)
§§% &
;
§§& '
ctx
•• 
.
•• 
SaveChanges
•• 
(
••  
)
••  !
;
••! "
log
ßß 
.
ßß 
Info
ßß 
(
ßß 
$"
ßß 
{
ßß 
User
ßß  
.
ßß  !
Identity
ßß! )
.
ßß) *
Name
ßß* .
}
ßß. /
$str
ßß/ =
{
ßß= >
book
ßß> B
.
ßßB C
BiaId
ßßC H
}
ßßH I
$str
ßßI J
{
ßßJ K
book
ßßK O
.
ßßO P
Title
ßßP U
}
ßßU V
"
ßßV W
)
ßßW X
;
ßßX Y
return
®® 
Json
®® 
(
®® 
result
®® "
.
®®" #

SetSuccess
®®# -
(
®®- .
)
®®. /
)
®®/ 0
;
®®0 1
}
©© 
catch
™™ 
(
™™ 
	Exception
™™ 
e
™™ 
)
™™ 
{
´´ 
return
¨¨ 
Json
¨¨ 
(
¨¨ 
new
¨¨ 
OperationResult
¨¨  /
(
¨¨/ 0
)
¨¨0 1
.
¨¨1 2
SetFail
¨¨2 9
(
¨¨9 :
e
¨¨: ;
)
¨¨; <
)
¨¨< =
;
¨¨= >
}
≠≠ 
}
ÆÆ 	
public
∞∞ 
async
∞∞ 
Task
∞∞ 
<
∞∞ 

JsonResult
∞∞ $
>
∞∞$ %
RentBook
∞∞& .
(
∞∞. /
[
∞∞/ 0
FromServices
∞∞0 <
]
∞∞< =
BookDbContext
∞∞> K
ctx
∞∞L O
,
∞∞O P
[
∞∞Q R
FromServices
∞∞R ^
]
∞∞^ _
EmailService
∞∞_ k
email
∞∞l q
,
∞∞q r
[
∞∞s t
FromBody
∞∞t |
]
∞∞| }
dynamic∞∞~ Ö
model∞∞Ü ã
)∞∞ã å
{
±± 	
try
≤≤ 
{
≥≥ 
var
¥¥ 
id
¥¥ 
=
¥¥ 
(
¥¥ 
int
¥¥ 
)
¥¥ 
model
¥¥ #
.
¥¥# $
Id
¥¥$ &
;
¥¥& '
var
µµ 
userName
µµ 
=
µµ 
(
µµ  
Guid
µµ  $
)
µµ$ %
model
µµ% *
.
µµ* +
User
µµ+ /
;
µµ/ 0
var
∂∂ 
rentDate
∂∂ 
=
∂∂ 
(
∂∂  
DateTime
∂∂  (
)
∂∂( )
model
∂∂) .
.
∂∂. /
Date
∂∂/ 3
;
∂∂3 4
if
∏∏ 
(
∏∏ 
rentDate
∏∏ 
<
∏∏ 
DateTime
∏∏ '
.
∏∏' (
Now
∏∏( +
)
∏∏+ ,
{
ππ 
return
∫∫ 
Json
∫∫ 
(
∫∫  
new
∫∫  #
OperationResult
∫∫$ 3
(
∫∫3 4
)
∫∫4 5
{
∫∫6 7
Details
∫∫8 ?
=
∫∫@ A
$str
∫∫B Y
}
∫∫Z [
)
∫∫[ \
;
∫∫\ ]
}
ªª 
var
ææ 
book
ææ 
=
ææ 
ctx
ææ 
.
ææ 

PaperBooks
ææ )
.
ææ) *
First
ææ* /
(
ææ/ 0
b
ææ0 1
=>
ææ2 4
b
ææ5 6
.
ææ6 7
BiaId
ææ7 <
==
ææ= ?
id
ææ@ B
)
ææB C
;
ææC D
if
øø 
(
øø 
book
øø 
!=
øø 
null
øø  
)
øø  !
{
¿¿ 
if
¡¡ 
(
¡¡ 
book
¡¡ 
.
¡¡ 
TakenByUser
¡¡ (
==
¡¡) +
null
¡¡, 0
)
¡¡0 1
{
¬¬ 
var
√√ 
user
√√  
=
√√! "
ctx
√√# &
.
√√& '
AppUsers
√√' /
.
√√/ 0
FirstOrDefault
√√0 >
(
√√> ?
q
√√? @
=>
√√A C
q
√√D E
.
√√E F
Uid
√√F I
==
√√J L
userName
√√M U
)
√√U V
;
√√V W
if
≈≈ 
(
≈≈ 
ctx
≈≈ 
.
≈≈  

PaperBooks
≈≈  *
.
≈≈* +
Count
≈≈+ 0
(
≈≈0 1
q
≈≈1 2
=>
≈≈3 5
q
≈≈6 7
.
≈≈7 8
TakenByUser
≈≈8 C
==
≈≈D F
user
≈≈G K
)
≈≈K L
>
≈≈M N
S
≈≈O P
.
≈≈P Q
MaxBook
≈≈Q X
)
≈≈X Y
{
∆∆ 
return
«« "
Json
««# '
(
««' (
new
««( +
OperationResult
««, ;
(
««; <
)
««< =
.
««= >
SetFail
««> E
(
««E F
$"
««F H
$str
««H o
{
««o p
S
««p q
.
««q r
MaxBook
««r y
}
««y z
$str
««z 
"«« Ä
)««Ä Å
)««Å Ç
;««Ç É
}
»» 
var
   
request
   #
=
  $ %
ctx
  & )
.
  ) *
RequestBooks
  * 6
.
  6 7
FirstOrDefault
  7 E
(
  E F
q
  F G
=>
  H J
q
  K L
.
  L M
BookId
  M S
==
  T V
book
  W [
.
  [ \
BiaId
  \ a
&&
  b d
q
  e f
.
  f g

AppUserUid
  g q
==
  r t
user
  u y
.
  y z
Uid
  z }
)
  } ~
;
  ~ 
if
ÀÀ 
(
ÀÀ 
request
ÀÀ #
!=
ÀÀ$ &
null
ÀÀ' +
)
ÀÀ+ ,
{
ÃÃ 
ctx
ÕÕ 
.
ÕÕ  
RequestBooks
ÕÕ  ,
.
ÕÕ, -
Remove
ÕÕ- 3
(
ÕÕ3 4
request
ÕÕ4 ;
)
ÕÕ; <
;
ÕÕ< =
}
ŒŒ 
ctx
–– 
.
–– 
RentHistories
–– )
.
––) *
Add
––* -
(
––- .
new
––. 1
RentHistory
––2 =
(
––= >
)
––> ?
{
—— 
Uid
““ 
=
““  !
Guid
““" &
.
““& '
NewGuid
““' .
(
““. /
)
““/ 0
,
““0 1
ExtendedDueDate
”” +
=
””, -
rentDate
””. 6
,
””6 7
	TakenDate
‘‘ %
=
‘‘& '
DateTime
‘‘( 0
.
‘‘0 1
Now
‘‘1 4
,
‘‘4 5
	TakenBook
’’ %
=
’’& '
book
’’( ,
,
’’, -
User
÷÷  
=
÷÷! "
user
÷÷# '
}
◊◊ 
)
◊◊ 
;
◊◊ 
book
ÿÿ 
.
ÿÿ 
TakenByUserUid
ÿÿ +
=
ÿÿ, -
user
ÿÿ. 2
.
ÿÿ2 3
Uid
ÿÿ3 6
;
ÿÿ6 7
book
ŸŸ 
.
ŸŸ 
TakenDue
ŸŸ %
=
ŸŸ& '
rentDate
ŸŸ( 0
;
ŸŸ0 1
ctx
⁄⁄ 
.
⁄⁄ 
SaveChanges
⁄⁄ '
(
⁄⁄' (
)
⁄⁄( )
;
⁄⁄) *
var
ﬁﬁ 
admins
ﬁﬁ "
=
ﬁﬁ# $
ctx
ﬁﬁ% (
.
ﬁﬁ( )
AdminNotifies
ﬁﬁ) 6
.
ﬁﬁ6 7
Where
ﬁﬁ7 <
(
ﬁﬁ< =
q
ﬁﬁ= >
=>
ﬁﬁ? A
q
ﬁﬁB C
.
ﬁﬁC D
NotifyId
ﬁﬁD L
==
ﬁﬁM O
AdminNotifyTypes
ﬁﬁP `
.
ﬁﬁ` a
General
ﬁﬁa h
)
ﬁﬁh i
.
ﬁﬁi j
Select
ﬁﬁj p
(
ﬁﬁp q
q
ﬁﬁq r
=>
ﬁﬁs u
q
ﬁﬁv w
.
ﬁﬁw x
Admin
ﬁﬁx }
)
ﬁﬁ} ~
;
ﬁﬁ~ 
if
ﬂﬂ 
(
ﬂﬂ 
!
ﬂﬂ 
string
ﬂﬂ #
.
ﬂﬂ# $ 
IsNullOrWhiteSpace
ﬂﬂ$ 6
(
ﬂﬂ6 7
user
ﬂﬂ7 ;
.
ﬂﬂ; <
Email
ﬂﬂ< A
)
ﬂﬂA B
)
ﬂﬂB C
{
‡‡ 
var
‚‚ 
config
‚‚  &
=
‚‚' (
new
‚‚) ,
	Extension
‚‚- 6
.
‚‚6 7
MailConfiguration
‚‚7 H
(
‚‚H I
)
‚‚I J
{
„„ 
UserName
‰‰  (
=
‰‰) *
user
‰‰+ /
.
‰‰/ 0
	FirstName
‰‰0 9
,
‰‰9 :
BookID
ÂÂ  &
=
ÂÂ' (
book
ÂÂ) -
.
ÂÂ- .
BiaId
ÂÂ. 3
,
ÂÂ3 4
Date
ÊÊ  $
=
ÊÊ% &
rentDate
ÊÊ' /
.
ÊÊ/ 0
ToString
ÊÊ0 8
(
ÊÊ8 9
$str
ÊÊ9 E
)
ÊÊE F
,
ÊÊF G
	BookTitle
ÁÁ  )
=
ÁÁ* +
book
ÁÁ, 0
.
ÁÁ0 1
Title
ÁÁ1 6
}
ËË 
;
ËË 
var
ÈÈ 
message
ÈÈ  '
=
ÈÈ( )
new
ÈÈ* -
MimeMessage
ÈÈ. 9
(
ÈÈ9 :
)
ÈÈ: ;
.
ÈÈ; <'
UserRequestConfirmMessage
ÈÈ< U
(
ÈÈU V
config
ÈÈV \
)
ÈÈ\ ]
;
ÈÈ] ^
message
ÍÍ #
.
ÍÍ# $
From
ÍÍ$ (
.
ÍÍ( )
Add
ÍÍ) ,
(
ÍÍ, -
new
ÍÍ- 0
MailboxAddress
ÍÍ1 ?
(
ÍÍ? @
S
ÍÍ@ A
.
ÍÍA B
MailBot
ÍÍB I
)
ÍÍI J
)
ÍÍJ K
;
ÍÍK L
message
ÎÎ #
.
ÎÎ# $
To
ÎÎ$ &
.
ÎÎ& '
Add
ÎÎ' *
(
ÎÎ* +
new
ÎÎ+ .
MailboxAddress
ÎÎ/ =
(
ÎÎ= >
user
ÎÎ> B
.
ÎÎB C
Email
ÎÎC H
)
ÎÎH I
)
ÎÎI J
;
ÎÎJ K
email
ÏÏ !
.
ÏÏ! "
Send
ÏÏ" &
(
ÏÏ& '
message
ÏÏ' .
)
ÏÏ. /
;
ÏÏ/ 0
}
ÓÓ 
else
ÔÔ 
{
 
if
ÚÚ 
(
ÚÚ  
admins
ÚÚ  &
.
ÚÚ& '
Any
ÚÚ' *
(
ÚÚ* +
)
ÚÚ+ ,
)
ÚÚ, -
{
ÛÛ 
var
ÙÙ  #
message
ÙÙ$ +
=
ÙÙ, -
new
ÙÙ. 1
MimeMessage
ÙÙ2 =
(
ÙÙ= >
)
ÙÙ> ?
;
ÙÙ? @
message
ıı  '
.
ıı' (
From
ıı( ,
.
ıı, -
Add
ıı- 0
(
ıı0 1
new
ıı1 4
MailboxAddress
ıı5 C
(
ııC D
S
ııD E
.
ııE F
MailBot
ııF M
)
ııM N
)
ııN O
;
ııO P
foreach
ˆˆ  '
(
ˆˆ( )
var
ˆˆ) ,
admin
ˆˆ- 2
in
ˆˆ3 5
admins
ˆˆ6 <
)
ˆˆ< =
{
˜˜  !
message
¯¯$ +
.
¯¯+ ,
To
¯¯, .
.
¯¯. /
Add
¯¯/ 2
(
¯¯2 3
new
¯¯3 6
MailboxAddress
¯¯7 E
(
¯¯E F
admin
¯¯F K
.
¯¯K L
Email
¯¯L Q
)
¯¯Q R
)
¯¯R S
;
¯¯S T
}
˘˘  !
message
˙˙  '
.
˙˙' (
Subject
˙˙( /
=
˙˙0 1
$str
˙˙2 J
;
˙˙J K
message
˚˚  '
.
˚˚' (
Body
˚˚( ,
=
˚˚- .
new
˚˚/ 2
TextPart
˚˚3 ;
(
˚˚; <
)
˚˚< =
{
¸¸  !
Text
˝˝$ (
=
˝˝) *
$"
˝˝+ -
{
˝˝- .
user
˝˝. 2
.
˝˝2 3
	LoginName
˝˝3 <
}
˝˝< =
$str
˝˝= v
"
˝˝v w
}
˛˛  !
;
˛˛! "
email
ˇˇ  %
.
ˇˇ% &
Send
ˇˇ& *
(
ˇˇ* +
message
ˇˇ+ 2
)
ˇˇ2 3
;
ˇˇ3 4
}
ÄÄ 
}
ÅÅ 
log
ÇÇ 
.
ÇÇ 
Info
ÇÇ  
(
ÇÇ  !
$"
ÇÇ! #
{
ÇÇ# $
User
ÇÇ$ (
.
ÇÇ( )
Identity
ÇÇ) 1
.
ÇÇ1 2
Name
ÇÇ2 6
}
ÇÇ6 7
$str
ÇÇ7 C
{
ÇÇC D
book
ÇÇD H
.
ÇÇH I
BiaId
ÇÇI N
}
ÇÇN O
$str
ÇÇO S
{
ÇÇS T
book
ÇÇT X
.
ÇÇX Y
TakenByUser
ÇÇY d
.
ÇÇd e
FullName
ÇÇe m
}
ÇÇm n
"
ÇÇn o
)
ÇÇo p
;
ÇÇp q
return
ÉÉ 
Json
ÉÉ #
(
ÉÉ# $
new
ÉÉ$ '
OperationResult
ÉÉ( 7
(
ÉÉ7 8
)
ÉÉ8 9
.
ÉÉ9 :

SetSuccess
ÉÉ: D
(
ÉÉD E
)
ÉÉE F
)
ÉÉF G
;
ÉÉG H
}
ÑÑ 
else
ÖÖ 
{
ÜÜ 
return
áá 
Json
áá #
(
áá# $
new
áá$ '
OperationResult
áá( 7
(
áá7 8
)
áá8 9
.
áá9 :
SetFail
áá: A
(
ááA B
$"
ááB D
$str
ááD ]
{
áá] ^
book
áá^ b
.
ááb c
TakenByUser
áác n
.
áán o
FullName
ááo w
}
ááw x
"
ááx y
)
ááy z
)
ááz {
;
áá{ |
}
àà 
}
ââ 
else
ää 
{
ãã 
return
åå 
Json
åå 
(
åå  
new
åå  #
OperationResult
åå$ 3
(
åå3 4
)
åå4 5
{
åå6 7
Details
åå8 ?
=
åå@ A
$str
ååB Q
}
ååR S
)
ååS T
;
ååT U
}
çç 
}
éé 
catch
èè 
(
èè 
	Exception
èè 
e
èè 
)
èè 
{
êê 
log
ëë 
.
ëë 
Error
ëë 
(
ëë 
e
ëë 
)
ëë 
;
ëë 
return
íí 
Json
íí 
(
íí 
new
íí 
OperationResult
íí  /
(
íí/ 0
)
íí0 1
.
íí1 2
SetFail
íí2 9
(
íí9 :
e
íí: ;
)
íí; <
)
íí< =
;
íí= >
}
ìì 
}
îî 	
public
ññ 
async
ññ 
Task
ññ 
<
ññ 

JsonResult
ññ $
>
ññ$ %
PassBook
ññ& .
(
ññ. /
[
ññ/ 0
FromServices
ññ0 <
]
ññ< =
BookDbContext
ññ> K
ctx
ññL O
,
ññO P
[
ññQ R
FromServices
ññR ^
]
ññ^ _
EmailService
ññ` l
email
ññm r
,
ññr s
[
ññt u
FromBody
ññu }
]
ññ} ~
Guidññ É
idññÑ Ü
)ññÜ á
{
óó 	
var
òò 
result
òò 
=
òò 
new
òò 
OperationResult
òò ,
(
òò, -
)
òò- .
;
òò. /
try
ôô 
{
öö 
var
õõ 
rent
õõ 
=
õõ 
ctx
õõ 
.
õõ 
RentHistories
õõ ,
.
õõ, -
First
õõ- 2
(
õõ2 3
q
õõ3 4
=>
õõ5 7
q
õõ8 9
.
õõ9 :
Uid
õõ: =
==
õõ> @
id
õõA C
)
õõC D
;
õõD E
var
úú 
book
úú 
=
úú 
rent
úú 
.
úú  
	TakenBook
úú  )
;
úú) *
var
ùù 
user
ùù 
=
ùù 
rent
ùù 
.
ùù  
User
ùù  $
;
ùù$ %
book
ûû 
.
ûû 
TakenByUserUid
ûû #
=
ûû$ %
null
ûû& *
;
ûû* +
book
üü 
.
üü 
TakenDue
üü 
=
üü 
null
üü  $
;
üü$ %
rent
†† 
.
†† 
ReturnedDate
†† !
=
††" #
DateTime
††$ ,
.
††, -
Now
††- 0
;
††0 1
ctx
¢¢ 
.
¢¢ 
SaveChanges
¢¢ 
(
¢¢  
)
¢¢  !
;
¢¢! "
log
££ 
.
££ 
Info
££ 
(
££ 
$"
££ 
{
££ 
User
££  
.
££  !
Identity
££! )
.
££) *
Name
££* .
}
££. /
$str
££/ ;
{
££; <
book
££< @
.
££@ A
BiaId
££A F
}
££F G
"
££G H
)
££H I
;
££I J
var
¶¶ 
admins
¶¶ 
=
¶¶ 
ctx
¶¶  
.
¶¶  !
AdminNotifies
¶¶! .
.
¶¶. /
Where
¶¶/ 4
(
¶¶4 5
q
¶¶5 6
=>
¶¶7 9
q
¶¶: ;
.
¶¶; <
NotifyId
¶¶< D
==
¶¶E G
AdminNotifyTypes
¶¶H X
.
¶¶X Y
General
¶¶Y `
)
¶¶` a
.
¶¶a b
Select
¶¶b h
(
¶¶h i
q
¶¶i j
=>
¶¶k m
q
¶¶n o
.
¶¶o p
Admin
¶¶p u
)
¶¶u v
;
¶¶v w
if
®® 
(
®® 
!
®® 
string
®® 
.
®®  
IsNullOrWhiteSpace
®® .
(
®®. /
user
®®/ 3
.
®®3 4
Email
®®4 9
)
®®9 :
)
®®: ;
{
©© 
var
™™ 
config
™™ 
=
™™  
new
™™! $
	Extension
™™% .
.
™™. /
MailConfiguration
™™/ @
(
™™@ A
)
™™A B
{
´´ 
UserName
¨¨  
=
¨¨! "
user
¨¨# '
.
¨¨' (
	FirstName
¨¨( 1
,
¨¨1 2
BookID
≠≠ 
=
≠≠  
book
≠≠! %
.
≠≠% &
BiaId
≠≠& +
,
≠≠+ ,
	BookTitle
ÆÆ !
=
ÆÆ" #
book
ÆÆ$ (
.
ÆÆ( )
Title
ÆÆ) .
}
ØØ 
;
ØØ 
var
∞∞ 
message
∞∞ 
=
∞∞  !
new
∞∞" %
MimeMessage
∞∞& 1
(
∞∞1 2
)
∞∞2 3
.
∞∞3 4#
UserReturnBookMessage
∞∞4 I
(
∞∞I J
config
∞∞J P
)
∞∞P Q
;
∞∞Q R
message
±± 
.
±± 
From
±±  
.
±±  !
Add
±±! $
(
±±$ %
new
±±% (
MailboxAddress
±±) 7
(
±±7 8
S
±±8 9
.
±±9 :
MailBot
±±: A
)
±±A B
)
±±B C
;
±±C D
message
≤≤ 
.
≤≤ 
To
≤≤ 
.
≤≤ 
Add
≤≤ "
(
≤≤" #
new
≤≤# &
MailboxAddress
≤≤' 5
(
≤≤5 6
user
≤≤6 :
.
≤≤: ;
Email
≤≤; @
)
≤≤@ A
)
≤≤A B
;
≤≤B C
email
≥≥ 
.
≥≥ 
Send
≥≥ 
(
≥≥ 
message
≥≥ &
)
≥≥& '
;
≥≥' (
}
¥¥ 
else
µµ 
{
∂∂ 
foreach
∑∑ 
(
∑∑ 
var
∑∑  
admin
∑∑! &
in
∑∑' )
admins
∑∑* 0
)
∑∑0 1
{
∏∏ 
var
ππ 
message
ππ #
=
ππ$ %
new
ππ& )
MimeMessage
ππ* 5
(
ππ5 6
)
ππ6 7
;
ππ7 8
message
∫∫ 
.
∫∫  
From
∫∫  $
.
∫∫$ %
Add
∫∫% (
(
∫∫( )
new
∫∫) ,
MailboxAddress
∫∫- ;
(
∫∫; <
S
∫∫< =
.
∫∫= >
MailBot
∫∫> E
)
∫∫E F
)
∫∫F G
;
∫∫G H
message
ªª 
.
ªª  
To
ªª  "
.
ªª" #
Add
ªª# &
(
ªª& '
new
ªª' *
MailboxAddress
ªª+ 9
(
ªª9 :
admin
ªª: ?
.
ªª? @
Email
ªª@ E
)
ªªE F
)
ªªF G
;
ªªG H
message
ºº 
.
ºº  
Subject
ºº  '
=
ºº( )
$str
ºº* B
;
ººB C
message
ΩΩ 
.
ΩΩ  
Body
ΩΩ  $
=
ΩΩ% &
new
ΩΩ' *
TextPart
ΩΩ+ 3
(
ΩΩ3 4
)
ΩΩ4 5
{
ææ 
Text
øø  
=
øø! "
$"
øø# %
{
øø% &
user
øø& *
.
øø* +
	LoginName
øø+ 4
}
øø4 5
$strøø5 Ñ
"øøÑ Ö
}
¿¿ 
;
¿¿ 
email
¡¡ 
.
¡¡ 
Send
¡¡ "
(
¡¡" #
message
¡¡# *
)
¡¡* +
;
¡¡+ ,
}
¬¬ 
}
√√ 
return
ƒƒ 
Json
ƒƒ 
(
ƒƒ 
result
ƒƒ "
.
ƒƒ" #

SetSuccess
ƒƒ# -
(
ƒƒ- .
$str
ƒƒ. ;
)
ƒƒ; <
)
ƒƒ< =
;
ƒƒ= >
}
≈≈ 
catch
∆∆ 
(
∆∆ 
	Exception
∆∆ 
e
∆∆ 
)
∆∆ 
{
«« 
log
»» 
.
»» 
Error
»» 
(
»» 
e
»» 
)
»» 
;
»» 
return
…… 
Json
…… 
(
…… 
result
…… "
.
……" #
SetFail
……# *
(
……* +
e
……+ ,
)
……, -
)
……- .
;
……. /
}
   
}
ÃÃ 	
public
ŒŒ 
async
ŒŒ 
Task
ŒŒ 
<
ŒŒ 

JsonResult
ŒŒ $
>
ŒŒ$ %
ProlongBook
ŒŒ& 1
(
ŒŒ1 2
[
ŒŒ2 3
FromServices
ŒŒ3 ?
]
ŒŒ? @
BookDbContext
ŒŒA N
ctx
ŒŒO R
,
ŒŒR S
[
ŒŒT U
FromBody
ŒŒU ]
]
ŒŒ] ^
dynamic
ŒŒ` g
model
ŒŒh m
)
ŒŒm n
{
œœ 	
var
–– 
result
–– 
=
–– 
new
–– 
OperationResult
–– ,
(
––, -
)
––- .
;
––. /
try
—— 
{
““ 
var
”” 
id
”” 
=
”” 
(
”” 
Guid
”” 
)
”” 
model
”” $
.
””$ %
Id
””% '
;
””' (
var
‘‘ 
date
‘‘ 
=
‘‘ 
(
‘‘ 
DateTime
‘‘ $
)
‘‘$ %
model
‘‘% *
.
‘‘* +
Date
‘‘+ /
;
‘‘/ 0
if
÷÷ 
(
÷÷ 
date
÷÷ 
<
÷÷ 
DateTime
÷÷ #
.
÷÷# $
Now
÷÷$ '
)
÷÷' (
{
◊◊ 
return
ÿÿ 
Json
ÿÿ 
(
ÿÿ  
new
ÿÿ  #
OperationResult
ÿÿ$ 3
(
ÿÿ3 4
)
ÿÿ4 5
{
ÿÿ6 7
Details
ÿÿ8 ?
=
ÿÿ@ A
$str
ÿÿB Y
}
ÿÿZ [
)
ÿÿ[ \
;
ÿÿ\ ]
}
ŸŸ 
var
€€ 
rent
€€ 
=
€€ 
ctx
€€ 
.
€€ 
RentHistories
€€ ,
.
€€, -
FirstOrDefault
€€- ;
(
€€; <
q
€€< =
=>
€€> @
q
€€A B
.
€€B C
Uid
€€C F
==
€€G I
id
€€J L
)
€€L M
;
€€M N
var
‹‹ 
book
‹‹ 
=
‹‹ 
rent
‹‹ 
.
‹‹  
	TakenBook
‹‹  )
;
‹‹) *
book
›› 
.
›› 
TakenDue
›› 
=
›› 
date
››  $
;
››$ %
rent
ﬁﬁ 
.
ﬁﬁ 
ExtendedDueDate
ﬁﬁ $
=
ﬁﬁ% &
date
ﬁﬁ' +
;
ﬁﬁ+ ,
rent
ﬂﬂ 
.
ﬂﬂ  
ExtendedTimesCount
ﬂﬂ '
++
ﬂﬂ' )
;
ﬂﬂ) *
ctx
‡‡ 
.
‡‡ 
SaveChanges
‡‡ 
(
‡‡  
)
‡‡  !
;
‡‡! "
log
„„ 
.
„„ 
Info
„„ 
(
„„ 
$"
„„ 
{
„„ 
User
„„  
.
„„  !
Identity
„„! )
.
„„) *
Name
„„* .
}
„„. /
$str
„„/ >
{
„„> ?
book
„„? C
.
„„C D
BiaId
„„D I
}
„„I J
"
„„J K
)
„„K L
;
„„L M
return
‰‰ 
Json
‰‰ 
(
‰‰ 
new
‰‰ 
OperationResult
‰‰  /
(
‰‰/ 0
)
‰‰0 1
.
‰‰1 2

SetSuccess
‰‰2 <
(
‰‰< =
)
‰‰= >
)
‰‰> ?
;
‰‰? @
}
ÂÂ 
catch
ÊÊ 
(
ÊÊ 
	Exception
ÊÊ 
e
ÊÊ 
)
ÊÊ 
{
ÁÁ 
log
ËË 
.
ËË 
Error
ËË 
(
ËË 
e
ËË 
)
ËË 
;
ËË 
return
ÈÈ 
Json
ÈÈ 
(
ÈÈ 
new
ÈÈ 
OperationResult
ÈÈ  /
(
ÈÈ/ 0
)
ÈÈ0 1
.
ÈÈ1 2
SetFail
ÈÈ2 9
(
ÈÈ9 :
e
ÈÈ: ;
)
ÈÈ; <
)
ÈÈ< =
;
ÈÈ= >
}
ÍÍ 
}
ÎÎ 	
public
ÌÌ 
async
ÌÌ 
Task
ÌÌ 
<
ÌÌ 

JsonResult
ÌÌ $
>
ÌÌ$ %
DeleteReview
ÌÌ& 2
(
ÌÌ2 3
[
ÌÌ3 4
FromServices
ÌÌ4 @
]
ÌÌ@ A
BookDbContext
ÌÌB O
ctx
ÌÌP S
,
ÌÌS T
[
ÌÌU V
FromBody
ÌÌV ^
]
ÌÌ^ _
Guid
ÌÌ` d
uid
ÌÌe h
)
ÌÌh i
{
ÓÓ 	
var
ÔÔ 
result
ÔÔ 
=
ÔÔ 
new
ÔÔ 
OperationResult
ÔÔ ,
(
ÔÔ, -
)
ÔÔ- .
;
ÔÔ. /
try
 
{
ÒÒ 
var
ÚÚ 
review
ÚÚ 
=
ÚÚ 
ctx
ÚÚ  
.
ÚÚ  !
Reviews
ÚÚ! (
.
ÚÚ( )
FirstOrDefault
ÚÚ) 7
(
ÚÚ7 8
q
ÚÚ8 9
=>
ÚÚ: <
q
ÚÚ= >
.
ÚÚ> ?
Uid
ÚÚ? B
==
ÚÚC E
uid
ÚÚF I
)
ÚÚI J
;
ÚÚJ K
var
ÛÛ 
book
ÛÛ 
=
ÛÛ 
review
ÛÛ !
.
ÛÛ! "
Book
ÛÛ" &
;
ÛÛ& '
ctx
ÙÙ 
.
ÙÙ 
Reviews
ÙÙ 
.
ÙÙ 
Remove
ÙÙ "
(
ÙÙ" #
review
ÙÙ# )
)
ÙÙ) *
;
ÙÙ* +
ctx
ıı 
.
ıı 
SaveChanges
ıı 
(
ıı  
)
ıı  !
;
ıı! "
book
ˆˆ 
.
ˆˆ 
AverageRating
ˆˆ "
=
ˆˆ# $
book
ˆˆ% )
.
ˆˆ) *
SumCurrentRating
ˆˆ* :
(
ˆˆ: ;
)
ˆˆ; <
;
ˆˆ< =
ctx
˜˜ 
.
˜˜ 
SaveChanges
˜˜ 
(
˜˜  
)
˜˜  !
;
˜˜! "
log
¯¯ 
.
¯¯ 
Info
¯¯ 
(
¯¯ 
$"
¯¯ 
{
¯¯ 
User
¯¯  
.
¯¯  !
Identity
¯¯! )
.
¯¯) *
Name
¯¯* .
}
¯¯. /
$str
¯¯/ ?
{
¯¯? @
book
¯¯@ D
.
¯¯D E
BiaId
¯¯E J
}
¯¯J K
"
¯¯K L
)
¯¯L M
;
¯¯M N
return
˘˘ 
Json
˘˘ 
(
˘˘ 
result
˘˘ "
.
˘˘" #

SetSuccess
˘˘# -
(
˘˘- .
$str
˘˘. <
)
˘˘< =
)
˘˘= >
;
˘˘> ?
}
˙˙ 
catch
˚˚ 
(
˚˚ 
	Exception
˚˚ 
e
˚˚ 
)
˚˚ 
{
¸¸ 
log
˝˝ 
.
˝˝ 
Error
˝˝ 
(
˝˝ 
e
˝˝ 
)
˝˝ 
;
˝˝ 
return
˛˛ 
Json
˛˛ 
(
˛˛ 
new
˛˛ 
OperationResult
˛˛  /
(
˛˛/ 0
)
˛˛0 1
.
˛˛1 2
SetFail
˛˛2 9
(
˛˛9 :
e
˛˛: ;
)
˛˛; <
)
˛˛< =
;
˛˛= >
}
ˇˇ 
return
ÄÄ 
Json
ÄÄ 
(
ÄÄ 
result
ÄÄ 
.
ÄÄ 
SetFail
ÄÄ &
(
ÄÄ& '
)
ÄÄ' (
)
ÄÄ( )
;
ÄÄ) *
}
ÅÅ 	
public
ÉÉ 
async
ÉÉ 
Task
ÉÉ 
<
ÉÉ 

JsonResult
ÉÉ $
>
ÉÉ$ %
DeleteAuthor
ÉÉ& 2
(
ÉÉ2 3
[
ÉÉ3 4
FromServices
ÉÉ4 @
]
ÉÉ@ A
BookDbContext
ÉÉB O
ctx
ÉÉP S
,
ÉÉS T
[
ÉÉU V
FromBody
ÉÉV ^
]
ÉÉ^ _
Guid
ÉÉ` d
id
ÉÉe g
)
ÉÉg h
{
ÑÑ 	
var
ÖÖ 
result
ÖÖ 
=
ÖÖ 
new
ÖÖ 
OperationResult
ÖÖ ,
(
ÖÖ, -
)
ÖÖ- .
;
ÖÖ. /
try
ÜÜ 
{
áá 
var
àà 
author
àà 
=
àà 
ctx
àà  
.
àà  !
Authors
àà! (
.
àà( )
FirstOrDefault
àà) 7
(
àà7 8
q
àà8 9
=>
àà: <
q
àà= >
.
àà> ?
	AuthorUid
àà? H
==
ààI K
id
ààL N
)
ààN O
;
ààO P
if
ââ 
(
ââ 
author
ââ 
==
ââ 
null
ââ "
)
ââ" #
{
ää 
return
ãã 
Json
ãã 
(
ãã  
result
ãã  &
.
ãã& '
SetFail
ãã' .
(
ãã. /
$str
ãã/ @
)
ãã@ A
)
ããA B
;
ããB C
}
åå 
var
éé 
bookAuthors
éé 
=
éé  !
ctx
éé" %
.
éé% &
BookAuthors
éé& 1
.
éé1 2
Where
éé2 7
(
éé7 8
q
éé8 9
=>
éé: <
q
éé= >
.
éé> ?
	AuthorUid
éé? H
==
ééI K
author
ééL R
.
ééR S
	AuthorUid
ééS \
)
éé\ ]
.
éé] ^
ToList
éé^ d
(
ééd e
)
éée f
;
ééf g
if
èè 
(
èè 
bookAuthors
èè 
.
èè  
Any
èè  #
(
èè# $
)
èè$ %
)
èè% &
{
êê 
ctx
ëë 
.
ëë 
BookAuthors
ëë #
.
ëë# $
RemoveRange
ëë$ /
(
ëë/ 0
bookAuthors
ëë0 ;
)
ëë; <
;
ëë< =
}
íí 
ctx
îî 
.
îî 
SaveChanges
îî 
(
îî  
)
îî  !
;
îî! "
ctx
ïï 
.
ïï 
Authors
ïï 
.
ïï 
Remove
ïï "
(
ïï" #
author
ïï# )
)
ïï) *
;
ïï* +
ctx
ññ 
.
ññ 
SaveChanges
ññ 
(
ññ  
)
ññ  !
;
ññ! "
log
òò 
.
òò 
Info
òò 
(
òò 
$"
òò 
{
òò 
User
òò  
.
òò  !
Identity
òò! )
.
òò) *
Name
òò* .
}
òò. /
$str
òò/ ?
{
òò? @
author
òò@ F
.
òòF G
FullName
òòG O
(
òòO P
)
òòP Q
}
òòQ R
"
òòR S
)
òòS T
;
òòT U
return
ôô 
Json
ôô 
(
ôô 
result
ôô "
.
ôô" #

SetSuccess
ôô# -
(
ôô- .
$str
ôô. <
)
ôô< =
)
ôô= >
;
ôô> ?
}
öö 
catch
õõ 
(
õõ 
	Exception
õõ 
e
õõ 
)
õõ 
{
úú 
log
ùù 
.
ùù 
Error
ùù 
(
ùù 
e
ùù 
)
ùù 
;
ùù 
return
ûû 
Json
ûû 
(
ûû 
result
ûû "
.
ûû" #
SetFail
ûû# *
(
ûû* +
)
ûû+ ,
)
ûû, -
;
ûû- .
}
üü 
}
°° 	
public
££ 
async
££ 
Task
££ 
<
££ 

JsonResult
££ $
>
££$ %
DeleteCategory
££& 4
(
££4 5
[
££5 6
FromServices
££6 B
]
££B C
BookDbContext
££D Q
ctx
££R U
,
££U V
[
££W X
FromBody
££X `
]
££` a
int
££b e
id
££f h
)
££h i
{
§§ 	
var
•• 
result
•• 
=
•• 
new
•• 
OperationResult
•• ,
(
••, -
)
••- .
;
••. /
try
¶¶ 
{
ßß 
var
®® 
category
®® 
=
®® 
ctx
®® "
.
®®" #

Categories
®®# -
.
®®- .
FirstOrDefault
®®. <
(
®®< =
q
®®= >
=>
®®? A
q
®®B C
.
®®C D

CategoryId
®®D N
==
®®O Q
id
®®R T
)
®®T U
;
®®U V
if
©© 
(
©© 
category
©© 
==
©© 
null
©©  $
)
©©$ %
{
™™ 
return
´´ 
Json
´´ 
(
´´  
result
´´  &
.
´´& '
SetFail
´´' .
(
´´. /
$str
´´/ E
)
´´E F
)
´´F G
;
´´G H
}
¨¨ 
var
ÆÆ 
bookCategories
ÆÆ "
=
ÆÆ# $
ctx
ÆÆ% (
.
ÆÆ( )
BookCategories
ÆÆ) 7
.
ÆÆ7 8
Where
ÆÆ8 =
(
ÆÆ= >
q
ÆÆ> ?
=>
ÆÆ@ B
q
ÆÆC D
.
ÆÆD E

CategoryId
ÆÆE O
==
ÆÆP R
category
ÆÆS [
.
ÆÆ[ \

CategoryId
ÆÆ\ f
)
ÆÆf g
.
ÆÆg h
ToList
ÆÆh n
(
ÆÆn o
)
ÆÆo p
;
ÆÆp q
if
ØØ 
(
ØØ 
bookCategories
ØØ "
.
ØØ" #
Any
ØØ# &
(
ØØ& '
)
ØØ' (
)
ØØ( )
{
∞∞ 
ctx
±± 
.
±± 
BookCategories
±± &
.
±±& '
RemoveRange
±±' 2
(
±±2 3
bookCategories
±±3 A
)
±±A B
;
±±B C
}
≤≤ 
ctx
¥¥ 
.
¥¥ 
SaveChanges
¥¥ 
(
¥¥  
)
¥¥  !
;
¥¥! "
ctx
µµ 
.
µµ 

Categories
µµ 
.
µµ 
Remove
µµ %
(
µµ% &
category
µµ& .
)
µµ. /
;
µµ/ 0
ctx
∂∂ 
.
∂∂ 
SaveChanges
∂∂ 
(
∂∂  
)
∂∂  !
;
∂∂! "
log
∑∑ 
.
∑∑ 
Info
∑∑ 
(
∑∑ 
$"
∑∑ 
{
∑∑ 
User
∑∑  
.
∑∑  !
Identity
∑∑! )
.
∑∑) *
Name
∑∑* .
}
∑∑. /
$str
∑∑/ A
{
∑∑A B
category
∑∑B J
}
∑∑J K
"
∑∑K L
)
∑∑L M
;
∑∑M N
return
∏∏ 
Json
∏∏ 
(
∏∏ 
result
∏∏ "
.
∏∏" #

SetSuccess
∏∏# -
(
∏∏- .
$str
∏∏. A
)
∏∏A B
)
∏∏B C
;
∏∏C D
}
ππ 
catch
∫∫ 
(
∫∫ 
	Exception
∫∫ 
e
∫∫ 
)
∫∫ 
{
ªª 
log
ºº 
.
ºº 
Error
ºº 
(
ºº 
e
ºº 
)
ºº 
;
ºº 
return
ΩΩ 
Json
ΩΩ 
(
ΩΩ 
result
ΩΩ "
.
ΩΩ" #
SetFail
ΩΩ# *
(
ΩΩ* +
)
ΩΩ+ ,
)
ΩΩ, -
;
ΩΩ- .
}
ææ 
}
¿¿ 	
public
¬¬ 
ActionResult
¬¬ 

AuthorList
¬¬ &
(
¬¬& '
[
¬¬' (
FromServices
¬¬( 4
]
¬¬4 5
BookDbContext
¬¬6 C
ctx
¬¬D G
)
¬¬G H
{
√√ 	
var
ƒƒ 
list
ƒƒ 
=
ƒƒ 
ctx
ƒƒ 
.
ƒƒ 
Authors
ƒƒ "
.
≈≈ 
Select
≈≈ 
(
≈≈ 
st
≈≈ 
=>
≈≈ 
new
≈≈ !
SelectListItem
≈≈" 0
(
≈≈0 1
)
≈≈1 2
{
≈≈3 4
Text
≈≈5 9
=
≈≈: ;
st
≈≈< >
.
≈≈> ?
FullName
≈≈? G
(
≈≈G H
)
≈≈H I
,
≈≈I J
Value
≈≈K P
=
≈≈Q R
st
≈≈S U
.
≈≈U V
	AuthorUid
≈≈V _
.
≈≈_ `
ToString
≈≈` h
(
≈≈h i
)
≈≈i j
}
≈≈k l
)
≈≈l m
.
∆∆ 
ToList
∆∆ 
(
∆∆ 
)
∆∆ 
;
∆∆ 
return
»» 
PartialView
»» 
(
»» 
$str
»» M
,
»»M N
list
»»O S
)
»»S T
;
»»T U
}
…… 	
public
   
ActionResult
   
CategoryList
   (
(
  ( )
[
  ) *
FromServices
  * 6
]
  6 7
BookDbContext
  8 E
ctx
  F I
)
  I J
{
ÀÀ 	
var
ÃÃ 
top
ÃÃ 
=
ÃÃ 
ctx
ÃÃ 
.
ÃÃ 

Categories
ÃÃ $
.
ÕÕ 
Select
ÕÕ 
(
ÕÕ 
st
ÕÕ 
=>
ÕÕ 
new
ÕÕ !
SelectListItem
ÕÕ" 0
(
ÕÕ0 1
)
ÕÕ1 2
{
ÕÕ3 4
Text
ÕÕ5 9
=
ÕÕ: ;
st
ÕÕ< >
.
ÕÕ> ?
CategoryName
ÕÕ? K
,
ÕÕK L
Value
ÕÕM R
=
ÕÕS T
st
ÕÕU W
.
ÕÕW X

CategoryId
ÕÕX b
.
ÕÕb c
ToString
ÕÕc k
(
ÕÕk l
)
ÕÕl m
}
ÕÕn o
)
ÕÕo p
.
ŒŒ 
ToList
ŒŒ 
(
ŒŒ 
)
ŒŒ 
;
ŒŒ 
return
–– 
PartialView
–– 
(
–– 
$str
–– ?
,
––? @
top
––A D
)
––D E
;
––E F
}
—— 	
public
”” 
async
”” 
Task
”” 
<
”” 

JsonResult
”” $
>
””$ %
DeclineRent
””& 1
(
””1 2
[
””2 3
FromServices
””3 ?
]
””? @
BookDbContext
””A N
ctx
””O R
,
””R S
[
””T U
FromBody
””U ]
]
””] ^
dynamic
””_ f
model
””g l
)
””l m
{
‘‘ 	
var
’’ 
result
’’ 
=
’’ 
new
’’ 
OperationResult
’’ ,
(
’’, -
)
’’- .
;
’’. /
try
◊◊ 
{
ÿÿ 
var
ŸŸ 
bookId
ŸŸ 
=
ŸŸ 
(
ŸŸ 
int
ŸŸ !
)
ŸŸ! "
model
ŸŸ" '
.
ŸŸ' (
book
ŸŸ( ,
;
ŸŸ, -
var
⁄⁄ 
userUid
⁄⁄ 
=
⁄⁄ 
(
⁄⁄ 
Guid
⁄⁄ #
)
⁄⁄# $
model
⁄⁄$ )
.
⁄⁄) *
user
⁄⁄* .
;
⁄⁄. /
var
€€ 
book
€€ 
=
€€ 
ctx
€€ 
.
€€ 
Books
€€ $
.
€€$ %
FirstOrDefault
€€% 3
(
€€3 4
q
€€4 5
=>
€€6 8
q
€€9 :
.
€€: ;
BiaId
€€; @
==
€€A C
bookId
€€D J
)
€€J K
;
€€K L
var
‹‹ 
user
‹‹ 
=
‹‹ 
ctx
‹‹ 
.
‹‹ 
AppUsers
‹‹ '
.
‹‹' (
First
‹‹( -
(
‹‹- .
q
‹‹. /
=>
‹‹0 2
q
‹‹3 4
.
‹‹4 5
Uid
‹‹5 8
==
‹‹9 ;
userUid
‹‹< C
)
‹‹C D
;
‹‹D E
var
›› 
req
›› 
=
›› 
ctx
›› 
.
›› 
RequestBooks
›› *
.
››* +
FirstOrDefault
››+ 9
(
››9 :
q
››: ;
=>
››< >
q
››? @
.
››@ A
AppUser
››A H
==
››I K
user
››L P
&&
››Q S
q
››T U
.
››U V
Book
››V Z
==
››[ ]
book
››^ b
)
››b c
;
››c d
if
ﬁﬁ 
(
ﬁﬁ 
req
ﬁﬁ 
!=
ﬁﬁ 
null
ﬁﬁ 
)
ﬁﬁ  
{
ﬂﬂ 
ctx
‡‡ 
.
‡‡ 
RequestBooks
‡‡ $
.
‡‡$ %
Remove
‡‡% +
(
‡‡+ ,
req
‡‡, /
)
‡‡/ 0
;
‡‡0 1
ctx
·· 
.
·· 
SaveChanges
·· #
(
··# $
)
··$ %
;
··% &
log
‚‚ 
.
‚‚ 
Info
‚‚ 
(
‚‚ 
$"
‚‚ 
{
‚‚  
User
‚‚  $
.
‚‚$ %
Identity
‚‚% -
.
‚‚- .
Name
‚‚. 2
}
‚‚2 3
$str
‚‚3 J
{
‚‚J K
userUid
‚‚K R
}
‚‚R S
$str
‚‚S \
{
‚‚\ ]
bookId
‚‚] c
}
‚‚c d
"
‚‚d e
)
‚‚e f
;
‚‚f g
return
„„ 
Json
„„ 
(
„„  
new
„„  #
OperationResult
„„$ 3
(
„„3 4
)
„„4 5
.
„„5 6

SetSuccess
„„6 @
(
„„@ A
)
„„A B
)
„„B C
;
„„C D
}
‰‰ 
}
ÂÂ 
catch
ÊÊ 
(
ÊÊ 
	Exception
ÊÊ 
ex
ÊÊ 
)
ÊÊ  
{
ÁÁ 
return
ËË 
Json
ËË 
(
ËË 
new
ËË 
OperationResult
ËË  /
(
ËË/ 0
)
ËË0 1
.
ËË1 2
SetFail
ËË2 9
(
ËË9 :
ex
ËË: <
)
ËË< =
)
ËË= >
;
ËË> ?
}
ÈÈ 
return
ÍÍ 
Json
ÍÍ 
(
ÍÍ 
new
ÍÍ 
OperationResult
ÍÍ +
(
ÍÍ+ ,
)
ÍÍ, -
.
ÍÍ- .
SetFail
ÍÍ. 5
(
ÍÍ5 6
)
ÍÍ6 7
)
ÍÍ7 8
;
ÍÍ8 9
}
ÎÎ 	
public
ÓÓ 
async
ÓÓ 
Task
ÓÓ 
<
ÓÓ 

JsonResult
ÓÓ $
>
ÓÓ$ %
AddToIgnoreList
ÓÓ& 5
(
ÓÓ5 6
[
ÓÓ6 7
FromServices
ÓÓ7 C
]
ÓÓC D
BookDbContext
ÓÓE R
ctx
ÓÓS V
,
ÓÓV W
[
ÓÓX Y
FromBody
ÓÓY a
]
ÓÓa b
Guid
ÓÓc g
uid
ÓÓh k
)
ÓÓk l
{
ÔÔ 	
var
 
result
 
=
 
new
 
OperationResult
 ,
(
, -
)
- .
;
. /
try
ÒÒ 
{
ÚÚ 
var
ÛÛ 
user
ÛÛ 
=
ÛÛ 
ctx
ÛÛ 
.
ÛÛ 
AppUsers
ÛÛ '
.
ÛÛ' (
First
ÛÛ( -
(
ÛÛ- .
q
ÛÛ. /
=>
ÛÛ0 2
q
ÛÛ3 4
.
ÛÛ4 5
Uid
ÛÛ5 8
==
ÛÛ9 ;
uid
ÛÛ< ?
)
ÛÛ? @
;
ÛÛ@ A
ctx
ıı 
.
ıı 
IgnoredUsers
ıı  
.
ıı  !
Add
ıı! $
(
ıı$ %
new
ıı% (
IgnoredUser
ıı) 4
(
ıı4 5
)
ıı5 6
{
ıı7 8

AppUserUid
ıı8 B
=
ııC D
user
ııE I
.
ııI J
Uid
ııJ M
}
ııM N
)
ııN O
;
ııO P
ctx
ˆˆ 
.
ˆˆ 
SaveChanges
ˆˆ 
(
ˆˆ  
)
ˆˆ  !
;
ˆˆ! "
log
˜˜ 
.
˜˜ 
Info
˜˜ 
(
˜˜ 
$"
˜˜ 
{
˜˜ 
User
˜˜  
.
˜˜  !
Identity
˜˜! )
.
˜˜) *
Name
˜˜* .
}
˜˜. /
$str
˜˜/ :
{
˜˜: ;
user
˜˜; ?
.
˜˜? @
FullName
˜˜@ H
}
˜˜H I
$str
˜˜I X
"
˜˜X Y
)
˜˜Y Z
;
˜˜Z [
return
¯¯ 
Json
¯¯ 
(
¯¯ 
result
¯¯ "
.
¯¯" #

SetSuccess
¯¯# -
(
¯¯- .
$"
¯¯. 0
$str
¯¯0 M
"
¯¯M N
)
¯¯N O
)
¯¯O P
;
¯¯P Q
}
˘˘ 
catch
˙˙ 
(
˙˙ 
	Exception
˙˙ 
e
˙˙ 
)
˙˙ 
{
˚˚ 
return
¸¸ 
Json
¸¸ 
(
¸¸ 
result
¸¸ "
.
¸¸" #
SetFail
¸¸# *
(
¸¸* +
$"
¸¸+ -
$str
¸¸- X
"
¸¸X Y
)
¸¸Y Z
)
¸¸Z [
;
¸¸[ \
}
˝˝ 
}
˛˛ 	
public
ÄÄ 
async
ÄÄ 
Task
ÄÄ 
<
ÄÄ 

JsonResult
ÄÄ $
>
ÄÄ$ %"
RemoveFromIgnoreList
ÄÄ& :
(
ÄÄ: ;
[
ÄÄ; <
FromServices
ÄÄ< H
]
ÄÄH I
BookDbContext
ÄÄJ W
ctx
ÄÄX [
,
ÄÄ[ \
[
ÄÄ] ^
FromBody
ÄÄ^ f
]
ÄÄf g
Guid
ÄÄh l
uid
ÄÄm p
)
ÄÄp q
{
ÅÅ 	
var
ÇÇ 
result
ÇÇ 
=
ÇÇ 
new
ÇÇ 
OperationResult
ÇÇ ,
(
ÇÇ, -
)
ÇÇ- .
;
ÇÇ. /
try
ÉÉ 
{
ÑÑ 
var
ÖÖ 
user
ÖÖ 
=
ÖÖ 
ctx
ÖÖ 
.
ÖÖ 
AppUsers
ÖÖ '
.
ÖÖ' (
First
ÖÖ( -
(
ÖÖ- .
q
ÖÖ. /
=>
ÖÖ0 2
q
ÖÖ3 4
.
ÖÖ4 5
Uid
ÖÖ5 8
==
ÖÖ9 ;
uid
ÖÖ< ?
)
ÖÖ? @
;
ÖÖ@ A
var
áá 
ignored
áá 
=
áá 
ctx
áá !
.
áá! "
IgnoredUsers
áá" .
.
áá. /
First
áá/ 4
(
áá4 5
q
áá5 6
=>
áá7 9
q
áá: ;
.
áá; <

AppUserUid
áá< F
==
ááG I
uid
ááJ M
)
ááM N
;
ááN O
ctx
àà 
.
àà 
IgnoredUsers
àà  
.
àà  !
Remove
àà! '
(
àà' (
ignored
àà( /
)
àà/ 0
;
àà0 1
ctx
ââ 
.
ââ 
SaveChanges
ââ 
(
ââ  
)
ââ  !
;
ââ! "
log
ää 
.
ää 
Info
ää 
(
ää 
$"
ää 
{
ää 
User
ää  
.
ää  !
Identity
ää! )
.
ää) *
Name
ää* .
}
ää. /
$str
ää/ =
{
ää= >
user
ää> B
.
ääB C
FullName
ääC K
}
ääK L
$str
ääL ]
"
ää] ^
)
ää^ _
;
ää_ `
return
ãã 
Json
ãã 
(
ãã 
result
ãã "
.
ãã" #

SetSuccess
ãã# -
(
ãã- .
$"
ãã. 0
$str
ãã0 L
"
ããL M
)
ããM N
)
ããN O
;
ããO P
}
åå 
catch
çç 
(
çç 
	Exception
çç 
e
çç 
)
çç 
{
éé 
return
èè 
Json
èè 
(
èè 
result
èè "
.
èè" #
SetFail
èè# *
(
èè* +
$"
èè+ -
$str
èè- V
"
èèV W
)
èèW X
)
èèX Y
;
èèY Z
}
êê 
}
ëë 	
public
ìì 
async
ìì 
Task
ìì 
<
ìì 

JsonResult
ìì $
>
ìì$ %
	AddNotify
ìì& /
(
ìì/ 0
[
ìì0 1
FromServices
ìì1 =
]
ìì= >
BookDbContext
ìì? L
ctx
ììM P
,
ììP Q
[
ììR S
FromBody
ììS [
]
ìì[ \
Guid
ìì] a
uid
ììb e
)
ììe f
{
îî 	
var
ïï 
result
ïï 
=
ïï 
new
ïï 
OperationResult
ïï ,
(
ïï, -
)
ïï- .
;
ïï. /
try
ññ 
{
óó 
var
òò 
admin
òò 
=
òò 
ctx
òò 
.
òò  
Admins
òò  &
.
òò& '
First
òò' ,
(
òò, -
q
òò- .
=>
òò/ 1
q
òò2 3
.
òò3 4
Uid
òò4 7
==
òò8 :
uid
òò; >
)
òò> ?
;
òò? @
if
ôô 
(
ôô 
admin
ôô 
.
ôô 
AdminNotifies
ôô '
.
ôô' (
Any
ôô( +
(
ôô+ ,
q
ôô, -
=>
ôô. 0
q
ôô1 2
.
ôô2 3
NotifyId
ôô3 ;
==
ôô< >
AdminNotifyTypes
ôô? O
.
ôôO P
General
ôôP W
)
ôôW X
==
ôôX Z
false
ôôZ _
)
ôô_ `
{
öö 
ctx
õõ 
.
õõ 
AdminNotifies
õõ %
.
õõ% &
Add
õõ& )
(
õõ) *
new
õõ* -
AdminNotify
õõ. 9
(
õõ9 :
)
õõ: ;
{
úú 
Uid
ùù 
=
ùù 
admin
ùù #
.
ùù# $
Uid
ùù$ '
,
ùù' (
NotifyId
ûû  
=
ûû! "
AdminNotifyTypes
ûû# 3
.
ûû3 4
General
ûû4 ;
}
üü 
)
üü 
;
üü 
ctx
†† 
.
†† 
SaveChanges
†† #
(
††# $
)
††$ %
;
††% &
log
°° 
.
°° 
Info
°° 
(
°° 
$"
°° 
{
°°  
User
°°  $
.
°°$ %
Identity
°°% -
.
°°- .
Name
°°. 2
}
°°2 3
$str
°°3 ?
{
°°? @
admin
°°@ E
.
°°E F
FullName
°°F N
}
°°N O
$str
°°O ^
"
°°^ _
)
°°_ `
;
°°` a
}
¢¢ 
return
££ 
Json
££ 
(
££ 
result
££ "
.
££" #

SetSuccess
££# -
(
££- .
$"
££. 0
$str
££0 N
{
££N O
admin
££O T
.
££T U
FullName
££U ]
}
££] ^
$str
££^ h
"
££h i
)
££i j
)
££j k
;
££k l
}
§§ 
catch
•• 
(
•• 
	Exception
•• 
e
•• 
)
•• 
{
¶¶ 
return
ßß 
Json
ßß 
(
ßß 
result
ßß "
.
ßß" #
SetFail
ßß# *
(
ßß* +
$"
ßß+ -
$str
ßß- a
"
ßßa b
)
ßßb c
)
ßßc d
;
ßßd e
}
®® 
}
©© 	
public
´´ 
async
´´ 
Task
´´ 
<
´´ 

JsonResult
´´ $
>
´´$ %
RemoveNotify
´´& 2
(
´´2 3
[
´´3 4
FromServices
´´4 @
]
´´@ A
BookDbContext
´´B O
ctx
´´P S
,
´´S T
[
´´U V
FromBody
´´V ^
]
´´^ _
Guid
´´` d
uid
´´e h
)
´´h i
{
¨¨ 	
var
≠≠ 
result
≠≠ 
=
≠≠ 
new
≠≠ 
OperationResult
≠≠ ,
(
≠≠, -
)
≠≠- .
;
≠≠. /
try
ÆÆ 
{
ØØ 
var
∞∞ 
admin
∞∞ 
=
∞∞ 
ctx
∞∞ 
.
∞∞  
Admins
∞∞  &
.
∞∞& '
FirstOrDefault
∞∞' 5
(
∞∞5 6
q
∞∞6 7
=>
∞∞8 :
q
∞∞; <
.
∞∞< =
Uid
∞∞= @
==
∞∞A C
uid
∞∞D G
)
∞∞G H
;
∞∞H I
if
±± 
(
±± 
admin
±± 
!=
±± 
null
±± !
)
±±! "
{
≤≤ 
var
≥≥ 
notify
≥≥ 
=
≥≥  
ctx
≥≥! $
.
≥≥$ %
AdminNotifies
≥≥% 2
.
≥≥2 3
FirstOrDefault
≥≥3 A
(
≥≥A B
q
≥≥B C
=>
≥≥D F
q
≥≥G H
.
≥≥H I
Uid
≥≥I L
==
≥≥M O
admin
≥≥P U
.
≥≥U V
Uid
≥≥V Y
)
≥≥Y Z
;
≥≥Z [
if
¥¥ 
(
¥¥ 
notify
¥¥ 
!=
¥¥ !
null
¥¥" &
)
¥¥& '
{
µµ 
ctx
∂∂ 
.
∂∂ 
AdminNotifies
∂∂ )
.
∂∂) *
Remove
∂∂* 0
(
∂∂0 1
notify
∂∂1 7
)
∂∂7 8
;
∂∂8 9
ctx
∑∑ 
.
∑∑ 
SaveChanges
∑∑ '
(
∑∑' (
)
∑∑( )
;
∑∑) *
log
∏∏ 
.
∏∏ 
Info
∏∏  
(
∏∏  !
$"
∏∏! #
{
∏∏# $
User
∏∏$ (
.
∏∏( )
Identity
∏∏) 1
.
∏∏1 2
Name
∏∏2 6
}
∏∏6 7
$str
∏∏7 F
{
∏∏F G
admin
∏∏G L
.
∏∏L M
FullName
∏∏M U
}
∏∏U V
$str
∏∏V g
"
∏∏g h
)
∏∏h i
;
∏∏i j
}
ππ 
return
∫∫ 
Json
∫∫ 
(
∫∫  
result
∫∫  &
.
∫∫& '

SetSuccess
∫∫' 1
(
∫∫1 2
$"
∫∫2 4
$str
∫∫4 R
{
∫∫R S
admin
∫∫S X
.
∫∫X Y
FullName
∫∫Y a
}
∫∫a b
$str
∫∫b l
"
∫∫l m
)
∫∫m n
)
∫∫n o
;
∫∫o p
}
ªª 
else
ºº 
{
ΩΩ 
throw
ææ 
new
ææ 
	Exception
ææ '
(
ææ' (
)
ææ( )
;
ææ) *
}
øø 
}
¿¿ 
catch
¡¡ 
(
¡¡ 
	Exception
¡¡ 
e
¡¡ 
)
¡¡ 
{
¬¬ 
return
√√ 
Json
√√ 
(
√√ 
result
√√ "
.
√√" #
SetFail
√√# *
(
√√* +
$"
√√+ -
$str
√√- \
"
√√\ ]
)
√√] ^
)
√√^ _
;
√√_ `
}
ƒƒ 
}
≈≈ 	
public
«« 
async
«« 
Task
«« 
<
«« 

JsonResult
«« $
>
««$ %

DeleteUser
««& 0
(
««0 1
[
««1 2
FromServices
««2 >
]
««> ?
BookDbContext
««@ M
ctx
««N Q
,
««Q R
[
««S T
FromBody
««T \
]
««\ ]
Guid
««^ b
uid
««c f
)
««f g
{
»» 	
var
…… 
result
…… 
=
…… 
new
…… 
OperationResult
…… ,
(
……, -
)
……- .
;
……. /
try
   
{
ÀÀ 
var
ÃÃ 
user
ÃÃ 
=
ÃÃ 
ctx
ÃÃ 
.
ÃÃ 
AppUsers
ÃÃ '
.
ÃÃ' (
First
ÃÃ( -
(
ÃÃ- .
q
ÃÃ. /
=>
ÃÃ0 2
q
ÃÃ3 4
.
ÃÃ4 5
Uid
ÃÃ5 8
==
ÃÃ9 ;
uid
ÃÃ< ?
)
ÃÃ? @
;
ÃÃ@ A
if
ÕÕ 
(
ÕÕ 
user
ÕÕ 
.
ÕÕ 
ReqestBooks
ÕÕ $
.
ÕÕ$ %
Any
ÕÕ% (
(
ÕÕ( )
)
ÕÕ) *
)
ÕÕ* +
{
ŒŒ 
ctx
œœ 
.
œœ 
RequestBooks
œœ $
.
œœ$ %
RemoveRange
œœ% 0
(
œœ0 1
user
œœ1 5
.
œœ5 6
ReqestBooks
œœ6 A
)
œœA B
;
œœB C
}
–– 
if
““ 
(
““ 
user
““ 
.
““ 
RentHistory
““ $
.
““$ %
Any
““% (
(
““( )
)
““) *
)
““* +
{
”” 
ctx
‘‘ 
.
‘‘ 
RentHistories
‘‘ %
.
‘‘% &
RemoveRange
‘‘& 1
(
‘‘1 2
user
‘‘2 6
.
‘‘6 7
RentHistory
‘‘7 B
)
‘‘B C
;
‘‘C D
}
’’ 
if
◊◊ 
(
◊◊ 
user
◊◊ 
.
◊◊ 
Reviews
◊◊  
.
◊◊  !
Any
◊◊! $
(
◊◊$ %
)
◊◊% &
)
◊◊& '
{
ÿÿ 
ctx
ŸŸ 
.
ŸŸ 
Reviews
ŸŸ 
.
ŸŸ  
RemoveRange
ŸŸ  +
(
ŸŸ+ ,
user
ŸŸ, 0
.
ŸŸ0 1
Reviews
ŸŸ1 8
)
ŸŸ8 9
;
ŸŸ9 :
}
⁄⁄ 
if
‹‹ 
(
‹‹ 
user
‹‹ 
is
‹‹ 
Admin
‹‹ !
)
‹‹! "
{
›› 
var
ﬁﬁ 
admin
ﬁﬁ 
=
ﬁﬁ 
user
ﬁﬁ  $
as
ﬁﬁ% '
Admin
ﬁﬁ( -
;
ﬁﬁ- .
if
ﬂﬂ 
(
ﬂﬂ 
admin
ﬂﬂ 
.
ﬂﬂ 
AdminNotifies
ﬂﬂ +
.
ﬂﬂ+ ,
Any
ﬂﬂ, /
(
ﬂﬂ/ 0
)
ﬂﬂ0 1
)
ﬂﬂ1 2
{
‡‡ 
ctx
·· 
.
·· 
AdminNotifies
·· )
.
··) *
RemoveRange
··* 5
(
··5 6
admin
··6 ;
.
··; <
AdminNotifies
··< I
)
··I J
;
··J K
}
‚‚ 
}
„„ 
ctx
ÂÂ 
.
ÂÂ 
AppUsers
ÂÂ 
.
ÂÂ 
Remove
ÂÂ #
(
ÂÂ# $
user
ÂÂ$ (
)
ÂÂ( )
;
ÂÂ) *
ctx
ÊÊ 
.
ÊÊ 
SaveChanges
ÊÊ 
(
ÊÊ  
)
ÊÊ  !
;
ÊÊ! "
log
ÁÁ 
.
ÁÁ 
Info
ÁÁ 
(
ÁÁ 
$"
ÁÁ 
{
ÁÁ 
User
ÁÁ  
.
ÁÁ  !
Identity
ÁÁ! )
.
ÁÁ) *
Name
ÁÁ* .
}
ÁÁ. /
$str
ÁÁ/ =
{
ÁÁ= >
user
ÁÁ> B
.
ÁÁB C
FullName
ÁÁC K
}
ÁÁK L
"
ÁÁL M
)
ÁÁM N
;
ÁÁN O
return
ÈÈ 
Json
ÈÈ 
(
ÈÈ 
result
ÈÈ "
.
ÈÈ" #

SetSuccess
ÈÈ# -
(
ÈÈ- .
$"
ÈÈ. 0
$str
ÈÈ0 =
{
ÈÈ= >
user
ÈÈ> B
.
ÈÈB C
FullName
ÈÈC K
}
ÈÈK L
$str
ÈÈL S
"
ÈÈS T
)
ÈÈT U
)
ÈÈU V
;
ÈÈV W
}
ÍÍ 
catch
ÎÎ 
(
ÎÎ 
	Exception
ÎÎ 
e
ÎÎ 
)
ÎÎ 
{
ÏÏ 
return
ÌÌ 
Json
ÌÌ 
(
ÌÌ 
result
ÌÌ "
.
ÌÌ" #
SetFail
ÌÌ# *
(
ÌÌ* +
$strÌÌ+ ã
)ÌÌã å
)ÌÌå ç
;ÌÌç é
}
ÓÓ 
}
ÔÔ 	
public
ÒÒ 
async
ÒÒ 
Task
ÒÒ 
<
ÒÒ 

JsonResult
ÒÒ $
>
ÒÒ$ %
AddUser
ÒÒ& -
(
ÒÒ- .
[
ÒÒ. /
FromServices
ÒÒ/ ;
]
ÒÒ; <
BookDbContext
ÒÒ= J
ctx
ÒÒK N
,
ÒÒN O
[
ÒÒP Q
FromBody
ÒÒQ Y
]
ÒÒY Z
dynamic
ÒÒ[ b
model
ÒÒc h
)
ÒÒh i
{
ÚÚ 	
var
ÛÛ 
result
ÛÛ 
=
ÛÛ 
new
ÛÛ 
OperationResult
ÛÛ ,
(
ÛÛ, -
)
ÛÛ- .
;
ÛÛ. /
try
ÙÙ 
{
ıı 
var
ˆˆ 
login
ˆˆ 
=
ˆˆ 
(
ˆˆ 
string
ˆˆ #
)
ˆˆ# $
model
ˆˆ% *
.
ˆˆ* +
login
ˆˆ+ 0
;
ˆˆ0 1
var
˜˜ 
first
˜˜ 
=
˜˜ 
(
˜˜ 
string
˜˜ #
)
˜˜# $
model
˜˜$ )
.
˜˜) *
first
˜˜* /
;
˜˜/ 0
var
¯¯ 
last
¯¯ 
=
¯¯ 
(
¯¯ 
string
¯¯ "
)
¯¯" #
model
¯¯# (
.
¯¯( )
last
¯¯) -
;
¯¯- .
var
˘˘ 
full
˘˘ 
=
˘˘ 
(
˘˘ 
string
˘˘ "
)
˘˘" #
model
˘˘# (
.
˘˘( )
full
˘˘) -
;
˘˘- .
var
˙˙ 
email
˙˙ 
=
˙˙ 
(
˙˙ 
string
˙˙ #
)
˙˙# $
model
˙˙$ )
.
˙˙) *
email
˙˙* /
;
˙˙/ 0
bool
˚˚ 
isAdmin
˚˚ 
=
˚˚ 
(
˚˚  
bool
˚˚  $
)
˚˚$ %
model
˚˚% *
.
˚˚* +
admin
˚˚+ 0
;
˚˚0 1
if
˝˝ 
(
˝˝ 
string
˝˝ 
.
˝˝  
IsNullOrWhiteSpace
˝˝ -
(
˝˝- .
login
˝˝. 3
)
˝˝3 4
||
˝˝5 7
ctx
˝˝8 ;
.
˝˝; <
AppUsers
˝˝< D
.
˝˝D E
Any
˝˝E H
(
˝˝H I
q
˝˝I J
=>
˝˝J L
q
˝˝L M
.
˝˝M N
	LoginName
˝˝N W
==
˝˝W Y
login
˝˝Y ^
)
˝˝^ _
)
˝˝` a
{
˛˛ 
return
ˇˇ 
Json
ˇˇ 
(
ˇˇ  
result
ˇˇ  &
.
ˇˇ& '
SetFail
ˇˇ' .
(
ˇˇ. /
$str
ˇˇ/ U
)
ˇˇU V
)
ˇˇV W
;
ˇˇW X
}
Ä	Ä	 
if
Ç	Ç	 
(
Ç	Ç	 
isAdmin
Ç	Ç	 
)
Ç	Ç	 
{
É	É	 
var
Ñ	Ñ	 
user
Ñ	Ñ	 
=
Ñ	Ñ	 
new
Ñ	Ñ	 "
Admin
Ñ	Ñ	# (
(
Ñ	Ñ	( )
)
Ñ	Ñ	) *
;
Ñ	Ñ	* +
user
Ö	Ö	 
.
Ö	Ö	 
	LoginName
Ö	Ö	 "
=
Ö	Ö	# $
login
Ö	Ö	% *
;
Ö	Ö	* +
user
Ü	Ü	 
.
Ü	Ü	 
	FirstName
Ü	Ü	 "
=
Ü	Ü	# $
first
Ü	Ü	% *
;
Ü	Ü	* +
user
á	á	 
.
á	á	 
LastName
á	á	 !
=
á	á	" #
last
á	á	$ (
;
á	á	( )
user
à	à	 
.
à	à	 
FullName
à	à	 !
=
à	à	" #
full
à	à	$ (
;
à	à	( )
user
â	â	 
.
â	â	 
Email
â	â	 
=
â	â	  
email
â	â	! &
;
â	â	& '
user
ã	ã	 
.
ã	ã	 
AccessGroup
ã	ã	 $
=
ã	ã	% &
AccessGroupId
ã	ã	' 4
.
ã	ã	4 5
Admin
ã	ã	5 :
;
ã	ã	: ;
user
å	å	 
.
å	å	 
IsActive
å	å	 !
=
å	å	" #
true
å	å	$ (
;
å	å	( )
ctx
ç	ç	 
.
ç	ç	 
Admins
ç	ç	 
.
ç	ç	 
Add
ç	ç	 "
(
ç	ç	" #
user
ç	ç	# '
)
ç	ç	' (
;
ç	ç	( )
ctx
é	é	 
.
é	é	 
SaveChanges
é	é	 #
(
é	é	# $
)
é	é	$ %
;
é	é	% &
}
è	è	 
else
ê	ê	 
{
ë	ë	 
var
í	í	 
user
í	í	 
=
í	í	 
new
í	í	 "
AppUser
í	í	# *
(
í	í	* +
)
í	í	+ ,
;
í	í	, -
user
ì	ì	 
.
ì	ì	 
	LoginName
ì	ì	 "
=
ì	ì	# $
login
ì	ì	% *
;
ì	ì	* +
user
î	î	 
.
î	î	 
	FirstName
î	î	 "
=
î	î	# $
first
î	î	% *
;
î	î	* +
user
ï	ï	 
.
ï	ï	 
LastName
ï	ï	 !
=
ï	ï	" #
last
ï	ï	$ (
;
ï	ï	( )
user
ñ	ñ	 
.
ñ	ñ	 
FullName
ñ	ñ	 !
=
ñ	ñ	" #
full
ñ	ñ	$ (
;
ñ	ñ	( )
user
ó	ó	 
.
ó	ó	 
Email
ó	ó	 
=
ó	ó	  
email
ó	ó	! &
;
ó	ó	& '
user
ò	ò	 
.
ò	ò	 
AccessGroup
ò	ò	 $
=
ò	ò	% &
AccessGroupId
ò	ò	' 4
.
ò	ò	4 5
Common
ò	ò	5 ;
;
ò	ò	; <
user
ô	ô	 
.
ô	ô	 
IsActive
ô	ô	 !
=
ô	ô	" #
true
ô	ô	$ (
;
ô	ô	( )
ctx
ö	ö	 
.
ö	ö	 
AppUsers
ö	ö	  
.
ö	ö	  !
Add
ö	ö	! $
(
ö	ö	$ %
user
ö	ö	% )
)
ö	ö	) *
;
ö	ö	* +
ctx
õ	õ	 
.
õ	õ	 
SaveChanges
õ	õ	 #
(
õ	õ	# $
)
õ	õ	$ %
;
õ	õ	% &
}
ú	ú	 
log
ù	ù	 
.
ù	ù	 
Info
ù	ù	 
(
ù	ù	 
$"
ù	ù	 
{
ù	ù	 
User
ù	ù	  
.
ù	ù	  !
Identity
ù	ù	! )
.
ù	ù	) *
Name
ù	ù	* .
}
ù	ù	. /
$str
ù	ù	/ :
{
ù	ù	: ;
login
ù	ù	; @
}
ù	ù	@ A
"
ù	ù	A B
)
ù	ù	B C
;
ù	ù	C D
return
ü	ü	 
Json
ü	ü	 
(
ü	ü	 
result
ü	ü	 "
.
ü	ü	" #

SetSuccess
ü	ü	# -
(
ü	ü	- .
$"
ü	ü	. 0
$str
ü	ü	0 =
{
ü	ü	= >
login
ü	ü	> C
}
ü	ü	C D
$str
ü	ü	D M
"
ü	ü	M N
)
ü	ü	N O
)
ü	ü	O P
;
ü	ü	P Q
}
†	†	 
catch
°	°	 
(
°	°	 
	Exception
°	°	 
e
°	°	 
)
°	°	 
{
¢	¢	 
return
£	£	 
Json
£	£	 
(
£	£	 
result
£	£	 "
.
£	£	" #
SetFail
£	£	# *
(
£	£	* +
$str
£	£	+ Q
)
£	£	Q R
)
£	£	R S
;
£	£	S T
}
§	§	 
}
•	•	 	
public
ß	ß	 
async
ß	ß	 
Task
ß	ß	 
<
ß	ß	 

JsonResult
ß	ß	 $
>
ß	ß	$ %
EditUser
ß	ß	& .
(
ß	ß	. /
[
ß	ß	/ 0
FromServices
ß	ß	0 <
]
ß	ß	< =
BookDbContext
ß	ß	> K
ctx
ß	ß	L O
,
ß	ß	O P
[
ß	ß	Q R
FromBody
ß	ß	R Z
]
ß	ß	Z [
dynamic
ß	ß	\ c
model
ß	ß	d i
)
ß	ß	i j
{
®	®	 	
var
©	©	 
result
©	©	 
=
©	©	 
new
©	©	 
OperationResult
©	©	 ,
(
©	©	, -
)
©	©	- .
;
©	©	. /
try
™	™	 
{
´	´	 
var
¨	¨	 
login
¨	¨	 
=
¨	¨	 
(
¨	¨	 
string
¨	¨	 #
)
¨	¨	# $
model
¨	¨	$ )
.
¨	¨	) *
login
¨	¨	* /
;
¨	¨	/ 0
var
≠	≠	 
first
≠	≠	 
=
≠	≠	 
(
≠	≠	 
string
≠	≠	 #
)
≠	≠	# $
model
≠	≠	$ )
.
≠	≠	) *
first
≠	≠	* /
;
≠	≠	/ 0
var
Æ	Æ	 
last
Æ	Æ	 
=
Æ	Æ	 
(
Æ	Æ	 
string
Æ	Æ	 "
)
Æ	Æ	" #
model
Æ	Æ	# (
.
Æ	Æ	( )
last
Æ	Æ	) -
;
Æ	Æ	- .
var
Ø	Ø	 
full
Ø	Ø	 
=
Ø	Ø	 
(
Ø	Ø	 
string
Ø	Ø	 "
)
Ø	Ø	" #
model
Ø	Ø	# (
.
Ø	Ø	( )
full
Ø	Ø	) -
;
Ø	Ø	- .
var
∞	∞	 
email
∞	∞	 
=
∞	∞	 
(
∞	∞	 
string
∞	∞	 #
)
∞	∞	# $
model
∞	∞	$ )
.
∞	∞	) *
email
∞	∞	* /
;
∞	∞	/ 0
bool
±	±	 
isAdmin
±	±	 
=
±	±	 
(
±	±	  
bool
±	±	  $
)
±	±	$ %
model
±	±	% *
.
±	±	* +
admin
±	±	+ 0
;
±	±	0 1
AppUser
≥	≥	 
user
≥	≥	 
=
≥	≥	 
ctx
≥	≥	 "
.
≥	≥	" #
AppUsers
≥	≥	# +
.
≥	≥	+ ,
First
≥	≥	, 1
(
≥	≥	1 2
q
≥	≥	2 3
=>
≥	≥	3 5
q
≥	≥	5 6
.
≥	≥	6 7
	LoginName
≥	≥	7 @
==
≥	≥	@ B
login
≥	≥	B G
)
≥	≥	G H
;
≥	≥	H I
if
¥	¥	 
(
¥	¥	 
!
¥	¥	 
string
¥	¥	 
.
¥	¥	  
IsNullOrWhiteSpace
¥	¥	 .
(
¥	¥	. /
first
¥	¥	/ 4
)
¥	¥	4 5
)
¥	¥	5 6
user
µ	µ	 
.
µ	µ	 
	FirstName
µ	µ	 "
=
µ	µ	# $
first
µ	µ	% *
;
µ	µ	* +
if
∂	∂	 
(
∂	∂	 
!
∂	∂	 
string
∂	∂	 
.
∂	∂	  
IsNullOrWhiteSpace
∂	∂	 .
(
∂	∂	. /
last
∂	∂	/ 3
)
∂	∂	3 4
)
∂	∂	4 5
user
∑	∑	 
.
∑	∑	 
LastName
∑	∑	 !
=
∑	∑	" #
last
∑	∑	$ (
;
∑	∑	( )
if
∏	∏	 
(
∏	∏	 
!
∏	∏	 
string
∏	∏	 
.
∏	∏	  
IsNullOrWhiteSpace
∏	∏	 .
(
∏	∏	. /
full
∏	∏	/ 3
)
∏	∏	3 4
)
∏	∏	4 5
user
π	π	 
.
π	π	 
FullName
π	π	 !
=
π	π	" #
full
π	π	$ (
;
π	π	( )
if
∫	∫	 
(
∫	∫	 
!
∫	∫	 
string
∫	∫	 
.
∫	∫	  
IsNullOrWhiteSpace
∫	∫	 .
(
∫	∫	. /
email
∫	∫	/ 4
)
∫	∫	4 5
)
∫	∫	5 6
user
ª	ª	 
.
ª	ª	 
Email
ª	ª	 
=
ª	ª	  
email
ª	ª	! &
;
ª	ª	& '
if
º	º	 
(
º	º	 
isAdmin
º	º	 
)
º	º	 
{
Ω	Ω	 
user
ø	ø	 
.
ø	ø	 
AccessGroup
ø	ø	 $
=
ø	ø	% &
AccessGroupId
ø	ø	' 4
.
ø	ø	4 5
Admin
ø	ø	5 :
;
ø	ø	: ;
user
¿	¿	 
.
¿	¿	 
Discriminator
¿	¿	 &
=
¿	¿	' (
$str
¿	¿	) 0
;
¿	¿	0 1
}
¡	¡	 
else
¬	¬	 
{
√	√	 
user
ƒ	ƒ	 
.
ƒ	ƒ	 
AccessGroup
ƒ	ƒ	 $
=
ƒ	ƒ	% &
AccessGroupId
ƒ	ƒ	' 4
.
ƒ	ƒ	4 5
Common
ƒ	ƒ	5 ;
;
ƒ	ƒ	; <
user
≈	≈	 
.
≈	≈	 
Discriminator
≈	≈	 &
=
≈	≈	' (
$str
≈	≈	) 2
;
≈	≈	2 3
}
∆	∆	 
ctx
»	»	 
.
»	»	 
SaveChanges
»	»	 
(
»	»	  
)
»	»	  !
;
»	»	! "
log
…	…	 
.
…	…	 
Info
…	…	 
(
…	…	 
$"
…	…	 
{
…	…	 
User
…	…	  
.
…	…	  !
Identity
…	…	! )
.
…	…	) *
Name
…	…	* .
}
…	…	. /
$str
…	…	/ ;
{
…	…	; <
user
…	…	< @
.
…	…	@ A
FullName
…	…	A I
}
…	…	I J
"
…	…	J K
)
…	…	K L
;
…	…	L M
return
À	À	 
Json
À	À	 
(
À	À	 
result
À	À	 "
.
À	À	" #

SetSuccess
À	À	# -
(
À	À	- .
$"
À	À	. 0
$str
À	À	0 =
{
À	À	= >
user
À	À	> B
.
À	À	B C
FullName
À	À	C K
}
À	À	K L
$str
À	À	L T
"
À	À	T U
)
À	À	U V
)
À	À	V W
;
À	À	W X
}
Ã	Ã	 
catch
Õ	Õ	 
(
Õ	Õ	 
	Exception
Õ	Õ	 
e
Õ	Õ	 
)
Õ	Õ	 
{
Œ	Œ	 
return
œ	œ	 
Json
œ	œ	 
(
œ	œ	 
result
œ	œ	 "
.
œ	œ	" #
SetFail
œ	œ	# *
(
œ	œ	* +
$str
œ	œ	+ Q
)
œ	œ	Q R
)
œ	œ	R S
;
œ	œ	S T
}
–	–	 
}
—	—	 	
}
”	”	 
}‘	‘	 Æß
aC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Controllers\Api\ApiController.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Controllers# .
.. /
Api/ 2
{ 
public 

class 
ApiController 
:  
ControllerBase! /
{   
private!! 
IHostingEnvironment!! #
_hostingEnvironment!!$ 7
;!!7 8
private"" 
IBrowser"" 
_browser"" !
;""! "
private## 
readonly## 
	Microsoft## "
.##" #

Extensions### -
.##- .
Logging##. 5
.##5 6
ILogger##6 =
_log##> B
;##B C
public%% 
ApiController%% 
(%% 
IHostingEnvironment%% 0
hostingEnvironment%%1 C
,%%C D
ILogger%%E L
<%%L M
ApiController%%M Z
>%%Z [
log%%\ _
,%%_ `
IBrowserResolver%%a q
browserResolver	%%r Å
)
%%Å Ç
{&& 	
_hostingEnvironment'' 
=''  !
hostingEnvironment''" 4
;''4 5
_browser(( 
=(( 
browserResolver(( &
.((& '
Browser((' .
;((. /
_log)) 
=)) 
log)) 
;)) 
}** 	
[-- 	
	Authorize--	 
(-- 
Policy-- 
=-- 
Data--  
.--  !
S--! "
.--" #

GroupAdmin--# -
)--- .
]--. /
public.. 
async.. 
Task.. 
<.. 
IActionResult.. '
>..' (
SetFile..) 0
(..0 1
)..1 2
{// 	
try00 
{11 
var22 
root22 
=22 
Path22 
.22  
GetDirectoryName22  0
(220 1
Assembly221 9
.229 : 
GetExecutingAssembly22: N
(22N O
)22O P
.22P Q
Location22Q Y
)22Y Z
+22[ \
$str22] h
;22h i
var44 
file44 
=44 
Request44 "
.44" #
Form44# '
.44' (
Files44( -
.44- .
FirstOrDefault44. <
(44< =
)44= >
;44> ?
if55 
(55 
file55 
==55 
null55  
)55  !
{66 
return77 

StatusCode77 %
(77% &
$num77& )
)77) *
;77* +
}88 
var99 
fileExtention99 !
=99" #
System99$ *
.99* +
IO99+ -
.99- .
Path99. 2
.992 3
GetExtension993 ?
(99? @)
ContentDispositionHeaderValue99@ ]
.:: 
Parse:: 
(:: 
file:: 
.::  
ContentDisposition::  2
)::2 3
.;; 
FileName;; 
.<< 
Trim<< 
(<< 
$char<< 
)<< 
)<< 
;<<  
if== 
(== 
fileExtention== !
====" $
$str==% '
)==' (
{>> 
}@@ 
;@@ 
varAA 
FileNameAA 
=AA 
fileAA #
.AA# $
FileNameAA$ ,
;AA, -
ifBB 
(BB 
_browserBB 
.BB 
TypeBB !
==BB" $
BrowserTypeBB% 0
.BB0 1
EdgeBB1 5
||BB6 8
_browserBB9 A
.BBA B
TypeBBB F
==BBG I
BrowserTypeBBJ U
.BBU V
IEBBV X
)BBX Y
{CC 
FileNameDD 
=DD 
fileDD #
.DD# $
FileNameDD$ ,
.DD, -
SplitDD- 2
(DD2 3
$charDD3 7
)DD7 8
.DD8 9
LastDD9 =
(DD= >
)DD> ?
;DD? @
}EE 
varHH 
fullPathHH 
=HH 
$@"HH "
{HH" #
rootHH# '
}HH' (
$strHH( /
{HH/ 0
fileHH0 4
.HH4 5
FileNameHH5 =
}HH= >
"HH> ?
;HH? @
ifII 
(II 
SystemII 
.II 
IOII 
.II 
FileII "
.II" #
ExistsII# )
(II) *
fullPathII* 2
)II2 3
)II3 4
{JJ 
}LL 
newMM 
SystemMM 
.MM 
IOMM 
.MM 
FileInfoMM &
(MM& '
fullPathMM' /
)MM/ 0
.MM0 1
	DirectoryMM1 :
.MM: ;
CreateMM; A
(MMA B
)MMB C
;MMC D
usingNN 
(NN 
varNN 
fsNN 
=NN 
SystemNN  &
.NN& '
IONN' )
.NN) *
FileNN* .
.NN. /
ExistsNN/ 5
(NN5 6
fullPathNN6 >
)NN> ?
?NN@ A
SystemNNB H
.NNH I
IONNI K
.NNK L
FileNNL P
.NNP Q
	OpenWriteNNQ Z
(NNZ [
fullPathNN[ c
)NNc d
:NNe f
SystemNNg m
.NNm n
IONNn p
.NNp q
FileNNq u
.NNu v
CreateNNv |
(NN| }
fullPath	NN} Ö
)
NNÖ Ü
)
NNÜ á
{OO 
filePP 
.PP 
CopyToPP 
(PP  
fsPP  "
)PP" #
;PP# $
fsQQ 
.QQ 
FlushQQ 
(QQ 
)QQ 
;QQ 
}RR 
throwTT 
newTT #
NotImplementedExceptionTT 1
(TT1 2
)TT2 3
;TT3 4
}UU 
catchVV 
(VV 
	ExceptionVV 
eVV 
)VV 
{WW 
NLogXX 
.XX 

LogManagerXX 
.XX  !
GetCurrentClassLoggerXX  5
(XX5 6
)XX6 7
.XX7 8
ErrorXX8 =
(XX= >
eXX> ?
)XX? @
;XX@ A
returnYY 

StatusCodeYY !
(YY! "
$numYY" %
)YY% &
;YY& '
}ZZ 
}[[ 	
[]] 	
	Authorize]]	 
(]] 
Policy]] 
=]] 
Data]]  
.]]  !
S]]! "
.]]" #

GroupAdmin]]# -
)]]- .
]]]. /
public^^ 
async^^ 
Task^^ 
<^^ 
IActionResult^^ '
>^^' (

RemoveFile^^) 3
(^^3 4
[^^4 5
	FromQuery^^5 >
]^^> ?
string^^? E
file^^F J
)^^J K
{__ 	
try`` 
{aa 
throwbb 
newbb #
NotImplementedExceptionbb 2
(bb2 3
)bb3 4
;bb4 5
}cc 
catchdd 
(dd 
	Exceptiondd 
edd 
)dd 
{ee 
NLogff 
.ff 

LogManagerff 
.ff  !
GetCurrentClassLoggerff  5
(ff5 6
)ff6 7
.ff7 8
Errorff8 =
(ff= >
eff> ?
)ff? @
;ff@ A
returngg 

StatusCodegg !
(gg! "
$numgg" %
)gg% &
;gg& '
}hh 
}ii 	
[mm 	
	Authorizemm	 
(mm 
Policymm 
=mm 
Datamm  
.mm  !
Smm! "
.mm" #
GroupCommonmm# .
)mm. /
]mm/ 0
publicnn 
asyncnn 
Tasknn 
<nn 
IActionResultnn '
>nn' (
	CheckFilenn) 2
(nn2 3
[nn3 4
FromServicesnn4 @
]nn@ A
BookDbContextnnB O
ctxnnP S
,nnS T
[nnU V
	FromQuerynnV _
]nn_ `
stringnn` f
filenng k
)nnk l
{oo 	
returnpp 

StatusCodepp 
(pp 
$numpp !
)pp! "
;pp" #
tryqq 
{rr 
varss 
rootss 
=ss 
Pathss 
.ss  
GetDirectoryNamess  0
(ss0 1
Assemblyss1 9
.ss9 : 
GetExecutingAssemblyss: N
(ssN O
)ssO P
.ssP Q
LocationssQ Y
)ssY Z
+ssZ [
$strss[ f
;ssf g
_logtt 
.tt 
LogDebugtt 
(tt 
roottt "
)tt" #
;tt# $
NLoguu 
.uu 

LogManageruu 
.uu  !
GetCurrentClassLoggeruu  5
(uu5 6
)uu6 7
.uu7 8
Debuguu8 =
(uu= >
_hostingEnvironmentuu> Q
.uuQ R
WebRootPathuuR ]
)uu] ^
;uu^ _
varvv 
uservv 
=vv 
ctxvv 
.vv 
AppUsersvv '
.vv' (
Firstvv( -
(vv- .
qvv. /
=>vv0 2
qvv3 4
.vv4 5
	LoginNamevv5 >
==vv? A
UservvB F
.vvF G
IdentityvvG O
.vvO P
NamevvP T
.vvT U
ReplacevvU \
(vv\ ]
$strvv] g
,vvg h
$strvvi k
)vvk l
)vvl m
;vvm n
varww 
bookww 
=ww 
ctxww 
.ww 
Ebooksww %
.ww% &
Firstww& +
(ww+ ,
qww, -
=>ww. 0
qww1 2
.ww2 3
Linkww3 7
==ww8 :
fileww; ?
)ww? @
;ww@ A
filexx 
=xx 

WebUtilityxx !
.xx! "
	UrlDecodexx" +
(xx+ ,
filexx, 0
)xx0 1
;xx1 2
varyy 
urlyy 
=yy 
$@"yy 
$stryy &
{yy& '
fileyy' +
}yy+ ,
"yy, -
;yy- .
varzz 
infzz 
=zz 
newzz 
FileInfozz &
(zz& '
$@"zz' *
{zz* +
rootzz+ /
}zz/ 0
$strzz0 8
{zz8 9
filezz9 =
}zz= >
"zz> ?
)zz? @
.zz@ A
ExistszzA G
;zzG H
if{{ 
({{ 
inf{{ 
){{ 
{|| 
return}} 

StatusCode}} %
(}}% &
$num}}& )
)}}) *
;}}* +
}~~ 
else 
{
ÄÄ 
return
ÅÅ 

StatusCode
ÅÅ %
(
ÅÅ% &
$num
ÅÅ& )
)
ÅÅ) *
;
ÅÅ* +
}
ÇÇ 
}
ÉÉ 
catch
ÑÑ 
(
ÑÑ 
	Exception
ÑÑ 
e
ÑÑ 
)
ÑÑ 
{
ÖÖ 
NLog
ÜÜ 
.
ÜÜ 

LogManager
ÜÜ 
.
ÜÜ  #
GetCurrentClassLogger
ÜÜ  5
(
ÜÜ5 6
)
ÜÜ6 7
.
ÜÜ7 8
Error
ÜÜ8 =
(
ÜÜ= >
e
ÜÜ> ?
)
ÜÜ? @
;
ÜÜ@ A
return
áá 

StatusCode
áá !
(
áá! "
$num
áá" %
)
áá% &
;
áá& '
}
àà 
}
ââ 	
[
ãã 	
	Authorize
ãã	 
(
ãã 
Policy
ãã 
=
ãã 
Data
ãã  
.
ãã  !
S
ãã! "
.
ãã" #
GroupCommon
ãã# .
)
ãã. /
]
ãã/ 0
public
åå 
async
åå 
Task
åå 
<
åå 
IActionResult
åå '
>
åå' (
GetFile
åå) 0
(
åå0 1
[
åå1 2
FromServices
åå2 >
]
åå> ?
BookDbContext
åå@ M
ctx
ååN Q
,
ååQ R
[
ååS T
	FromQuery
ååT ]
]
åå] ^
string
åå^ d
file
ååe i
)
ååi j
{
çç 	
try
éé 
{
èè 
var
êê 
root
êê 
=
êê 
Path
êê 
.
êê  
GetDirectoryName
êê  0
(
êê0 1
Assembly
êê1 9
.
êê9 :"
GetExecutingAssembly
êê: N
(
êêN O
)
êêO P
.
êêP Q
Location
êêQ Y
)
êêY Z
+
êê[ \
$str
êê] h
;
êêh i
var
ëë 
user
ëë 
=
ëë 
ctx
ëë 
.
ëë 
AppUsers
ëë '
.
ëë' (
First
ëë( -
(
ëë- .
q
ëë. /
=>
ëë0 2
q
ëë3 4
.
ëë4 5
	LoginName
ëë5 >
==
ëë? A
User
ëëB F
.
ëëF G
Identity
ëëG O
.
ëëO P
Name
ëëP T
.
ëëT U
Replace
ëëU \
(
ëë\ ]
$str
ëë] g
,
ëëg h
$str
ëëh j
)
ëëj k
)
ëëk l
;
ëël m
var
íí 
book
íí 
=
íí 
ctx
íí 
.
íí 
Ebooks
íí %
.
íí% &
First
íí& +
(
íí+ ,
q
íí, -
=>
íí. 0
q
íí1 2
.
íí2 3
Link
íí3 7
==
íí8 :
file
íí; ?
)
íí? @
;
íí@ A
ctx
ìì 
.
ìì 
DownloadHistories
ìì %
.
ìì% &
Add
ìì& )
(
ìì) *
new
ìì* -
DownloadHistory
ìì. =
(
ìì= >
)
ìì> ?
{
ìì@ A
DownloadDate
ììA M
=
ììN O
DateTime
ììP X
.
ììX Y
Now
ììY \
,
ìì\ ]
User
ìì^ b
=
ììc d
user
ììe i
,
ììi j
DownloadedBook
ììk y
=
ììz {
bookìì| Ä
}ììÄ Å
)ììÅ Ç
;ììÇ É
file
îî 
=
îî 

WebUtility
îî !
.
îî! "
	UrlDecode
îî" +
(
îî+ ,
file
îî, 0
)
îî0 1
;
îî1 2
var
ïï 
url
ïï 
=
ïï 
$@"
ïï 
$str
ïï &
{
ïï& '
file
ïï' +
}
ïï+ ,
"
ïï, -
;
ïï- .
var
ññ 
inf
ññ 
=
ññ 
new
ññ 
FileInfo
ññ &
(
ññ& '
$@"
ññ' *
{
ññ* +
root
ññ+ /
}
ññ/ 0
$str
ññ0 8
{
ññ8 9
file
ññ9 =
}
ññ= >
"
ññ> ?
)
ññ? @
.
ññ@ A
Exists
ññA G
;
ññG H
if
óó 
(
óó 
inf
óó 
)
óó 
{
òò 
ctx
ôô 
.
ôô 
SaveChanges
ôô #
(
ôô# $
)
ôô$ %
;
ôô% &
return
öö 
File
öö 
(
öö  
url
öö  #
,
öö# $
$str
öö% ?
,
öö? @
file
ööA E
)
ööE F
;
ööF G
}
õõ 
else
úú 
{
ùù 
return
ûû 

StatusCode
ûû %
(
ûû% &
$num
ûû& )
)
ûû) *
;
ûû* +
}
üü 
}
†† 
catch
°° 
(
°° 
	Exception
°° 
e
°° 
)
°° 
{
¢¢ 
NLog
££ 
.
££ 

LogManager
££ 
.
££  #
GetCurrentClassLogger
££  5
(
££5 6
)
££6 7
.
££7 8
Error
££8 =
(
££= >
e
££> ?
)
££? @
;
££@ A
return
§§ 

StatusCode
§§ !
(
§§! "
$num
§§" %
)
§§% &
;
§§& '
}
•• 
}
¶¶ 	
[
©© 	
	Authorize
©©	 
(
©© 
Policy
©© 
=
©© 
Data
©©  
.
©©  !
S
©©! "
.
©©" #

GroupAdmin
©©# -
)
©©- .
]
©©. /
public
™™ 
async
™™ 
Task
™™ 
<
™™ 

JsonResult
™™ $
>
™™$ %
HasRequests
™™& 1
(
™™1 2
[
™™2 3
FromServices
™™3 ?
]
™™? @
BookDbContext
™™A N
ctx
™™O R
)
™™R S
{
´´ 	
try
¨¨ 
{
≠≠ 
if
ÆÆ 
(
ÆÆ 
User
ÆÆ 
.
ÆÆ 
Claims
ÆÆ 
.
ÆÆ  
FirstOrDefault
ÆÆ  .
(
ÆÆ. /
q
ÆÆ/ 0
=>
ÆÆ1 3
q
ÆÆ4 5
.
ÆÆ5 6
Value
ÆÆ6 ;
==
ÆÆ< >
Bia
ÆÆ? B
.
ÆÆB C
Internal
ÆÆC K
.
ÆÆK L
BookLibrary
ÆÆL W
.
ÆÆW X
Data
ÆÆX \
.
ÆÆ\ ]
S
ÆÆ] ^
.
ÆÆ^ _
Admin
ÆÆ_ d
)
ÆÆd e
==
ÆÆf h
null
ÆÆi m
)
ÆÆm n
{
ØØ 
return
∞∞ 
new
∞∞ 

JsonResult
∞∞ )
(
∞∞) *
new
∞∞* -
OperationResult
∞∞. =
(
∞∞= >
)
∞∞> ?
.
∞∞? @
SetFail
∞∞@ G
(
∞∞G H
)
∞∞H I
)
∞∞I J
;
∞∞J K
}
±± 
if
≥≥ 
(
≥≥ 
ctx
≥≥ 
.
≥≥ 
RequestBooks
≥≥ $
.
≥≥$ %
Any
≥≥% (
(
≥≥( )
)
≥≥) *
)
≥≥* +
{
¥¥ 
return
µµ 
new
µµ 

JsonResult
µµ )
(
µµ) *
new
µµ* -
OperationResult
µµ. =
(
µµ= >
)
µµ> ?
.
µµ? @

SetSuccess
µµ@ J
(
µµJ K
)
µµK L
)
µµL M
;
µµM N
}
∂∂ 
else
∑∑ 
{
∏∏ 
return
ππ 
new
ππ 

JsonResult
ππ )
(
ππ) *
new
ππ* -
OperationResult
ππ. =
(
ππ= >
)
ππ> ?
.
ππ? @
SetFail
ππ@ G
(
ππG H
)
ππH I
)
ππI J
;
ππJ K
}
∫∫ 
}
ªª 
catch
ºº 
(
ºº 
	Exception
ºº 
e
ºº 
)
ºº 
{
ΩΩ 
return
ææ 
new
ææ 

JsonResult
ææ %
(
ææ% &
new
ææ& )
OperationResult
ææ* 9
(
ææ9 :
)
ææ: ;
.
ææ; <
SetFail
ææ< C
(
ææC D
e
ææD E
)
ææE F
)
ææF G
;
ææG H
}
øø 
}
¿¿ 	
[
¬¬ 	
	Authorize
¬¬	 
(
¬¬ 
Policy
¬¬ 
=
¬¬ 
Data
¬¬  
.
¬¬  !
S
¬¬! "
.
¬¬" #

GroupAdmin
¬¬# -
)
¬¬- .
]
¬¬. /
public
√√ 
async
√√ 
Task
√√ 
<
√√ 

JsonResult
√√ $
>
√√$ %

HasOverdue
√√& 0
(
√√0 1
[
√√1 2
FromServices
√√2 >
]
√√> ?
BookDbContext
√√@ M
ctx
√√N Q
)
√√Q R
{
ƒƒ 	
try
≈≈ 
{
∆∆ 
if
«« 
(
«« 
User
«« 
.
«« 
Claims
«« 
.
««  
FirstOrDefault
««  .
(
««. /
q
««/ 0
=>
««1 3
q
««4 5
.
««5 6
Value
««6 ;
==
««< >
Bia
««? B
.
««B C
Internal
««C K
.
««K L
BookLibrary
««L W
.
««W X
Data
««X \
.
««\ ]
S
««] ^
.
««^ _
Admin
««_ d
)
««d e
==
««f h
null
««i m
)
««m n
{
»» 
return
…… 
new
…… 

JsonResult
…… )
(
……) *
new
……* -
OperationResult
……. =
(
……= >
)
……> ?
.
……? @
SetFail
……@ G
(
……G H
)
……H I
)
……I J
;
……J K
}
   
if
ÃÃ 
(
ÃÃ 
ctx
ÃÃ 
.
ÃÃ 
RentHistories
ÃÃ %
.
ÃÃ% &
Where
ÃÃ& +
(
ÃÃ+ ,
q
ÃÃ, -
=>
ÃÃ- /
q
ÃÃ/ 0
.
ÃÃ0 1
ReturnedDate
ÃÃ1 =
==
ÃÃ= ?
null
ÃÃ? C
&&
ÃÃD F
DateTime
ÃÃG O
.
ÃÃO P
Now
ÃÃP S
.
ÃÃS T
Date
ÃÃT X
>
ÃÃY Z
q
ÃÃ[ \
.
ÃÃ\ ]
ExtendedDueDate
ÃÃ] l
)
ÃÃl m
.
ÃÃm n
Any
ÃÃn q
(
ÃÃq r
)
ÃÃr s
)
ÃÃs t
{
ÕÕ 
return
ŒŒ 
new
ŒŒ 

JsonResult
ŒŒ )
(
ŒŒ) *
new
ŒŒ* -
OperationResult
ŒŒ. =
(
ŒŒ= >
)
ŒŒ> ?
.
ŒŒ? @

SetSuccess
ŒŒ@ J
(
ŒŒJ K
)
ŒŒK L
)
ŒŒL M
;
ŒŒM N
}
œœ 
else
–– 
{
—— 
return
““ 
new
““ 

JsonResult
““ )
(
““) *
new
““* -
OperationResult
““. =
(
““= >
)
““> ?
.
““? @
SetFail
““@ G
(
““G H
)
““H I
)
““I J
;
““J K
}
”” 
}
‘‘ 
catch
’’ 
(
’’ 
	Exception
’’ 
e
’’ 
)
’’ 
{
÷÷ 
return
◊◊ 
new
◊◊ 

JsonResult
◊◊ %
(
◊◊% &
new
◊◊& )
OperationResult
◊◊* 9
(
◊◊9 :
)
◊◊: ;
.
◊◊; <
SetFail
◊◊< C
(
◊◊C D
e
◊◊D E
)
◊◊E F
)
◊◊F G
;
◊◊G H
}
ÿÿ 
}
ŸŸ 	
}
⁄⁄ 
}€€ Œ
^C:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Controllers\HomeController.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Controllers# .
{ 
public 

class 
HomeController 
:  !

Controller" ,
{ 
private 
Logger 
log 
; 
public 
HomeController 
( 
) 
{ 	
log 
= 
NLog 
. 

LogManager  
.  !!
GetCurrentClassLogger! 6
(6 7
)7 8
;8 9
} 	
[ 	
	Authorize	 
( 
Policy 
= 
Data  
.  !
S! "
." #
GroupCommon# .
). /
]/ 0
public 
IActionResult 
Index "
(" #
)# $
{ 	
return 
View 
( 
) 
; 
} 	
[   	
	Authorize  	 
(   
Policy   
=   
Data    
.    !
S  ! "
.  " #
GroupCommon  # .
)  . /
]  / 0
public!! 
IActionResult!! 
Arrangement!! (
(!!( )
)!!) *
{"" 	
return## 
View## 
(## 
)## 
;## 
}$$ 	
['' 	
	Authorize''	 
('' 
Policy'' 
='' 
Data''  
.''  !
S''! "
.''" #
GroupDeveloper''# 1
)''1 2
]''2 3
public)) 
IActionResult)) 
Privacy)) $
())$ %
)))% &
{** 	
return++ 
View++ 
(++ 
$str++ 
)++  
;++  !
},, 	
[.. 	
ResponseCache..	 
(.. 
Duration.. 
=..  !
$num.." #
,..# $
Location..% -
=... /!
ResponseCacheLocation..0 E
...E F
None..F J
,..J K
NoStore..L S
=..T U
true..V Z
)..Z [
]..[ \
public// 
IActionResult// 
Error// "
(//" #
)//# $
{00 	
return11 
View11 
(11 
new11 
ErrorViewModel11 *
{11+ ,
	RequestId11- 6
=117 8
Activity119 A
.11A B
Current11B I
?11I J
.11J K
Id11K M
??11N P
HttpContext11Q \
.11\ ]
TraceIdentifier11] l
}11m n
)11n o
;11o p
}22 	
}33 
}44 ı
bC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Controllers\SettingsController.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Controllers# .
{ 
public		 

class		 
SettingsController		 #
:		$ %

Controller		& 0
{

 
public 
IActionResult 
Info !
(! "
)" #
{ 	
return 
View 
( 
) 
; 
} 	
} 
} œß
aC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Controllers\VisitorController.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Controllers# .
{ 
public 

class 
VisitorController "
:# $

Controller% /
{ 
private 
Logger 
log 
; 
public 
VisitorController  
(  !
)! "
{ 	
log 
= 

LogManager 
. !
GetCurrentClassLogger 2
(2 3
)3 4
;4 5
} 	
public 
IActionResult 
Books "
(" #
[# $
FromServices$ 0
]0 1
BookDbContext2 ?
ctx@ C
)C D
{ 	
var 
books 
= 
ctx 
. 

PaperBooks &
.& '
OrderBy' .
(. /
q/ 0
=>1 3
q4 5
.5 6
TakenByUser6 A
)A B
.B C
ThenByC I
(I J
qJ K
=>L N
qO P
.P Q
TitleQ V
)V W
.W X
ToListX ^
(^ _
)_ `
;` a
return 
View 
( 
$str 
,  
books! &
)& '
;' (
} 	
public   
IActionResult   
Ebooks   #
(  # $
[  $ %
FromServices  % 1
]  1 2
BookDbContext  3 @
ctx  A D
)  D E
{!! 	
var"" 
books"" 
="" 
ctx"" 
."" 
Ebooks"" "
.""" #
ToList""# )
("") *
)""* +
;""+ ,
ViewBag## 
.## 
First## 
=## 
ctx## 
.##  
Arrangements##  ,
.##, -
Any##- 0
(##0 1
q##1 2
=>##3 5
q##6 7
.##7 8
AppUser##8 ?
.##? @
	LoginName##@ I
==##J L
User##M Q
.##Q R
Identity##R Z
.##Z [
Name##[ _
.##_ `
Replace##` g
(##g h
$str##h r
,##r s
$str##s u
)##u v
)##v w
;##w x
return$$ 
View$$ 
($$ 
$str$$ 
,$$  
books$$! &
)$$& '
;$$' (
}%% 	
['' 	
HttpGet''	 
]'' 
public(( 
IActionResult(( 
Book(( !
(((! "
[((" #
FromServices((# /
]((/ 0
BookDbContext((1 >
ctx((? B
,((B C
int((D G
id((H J
)((J K
{)) 	
var++ 
book++ 
=++ 
ctx++ 
.++ 
Books++  
.++  !
FirstOrDefault++! /
(++/ 0
q++0 1
=>++2 4
q++5 6
.++6 7
BiaId++7 <
==++= ?
id++@ B
)++B C
;++C D
if,, 
(,, 
book,, 
==,, 
null,, 
),, 
{-- 
return.. 
View.. 
(.. 
$str.. #
)..# $
;..$ %
}// 
if11 
(11 
book11 
is11 
Ebook11 
)11 
{22 
if33 
(33 
!33 
ctx33 
.33 
Arrangements33 $
.33$ %
Any33% (
(33( )
q33) *
=>33+ -
q33. /
.33/ 0
AppUser330 7
.337 8
	LoginName338 A
==33B D
User33E I
.33I J
Identity33J R
.33R S
Name33S W
.33W X
Replace33X _
(33_ `
$str33` j
,33j k
$str33l n
)33n o
)33o p
)33p q
{44 
return55 
LocalRedirect55 (
(55( )
$str55) :
)55: ;
;55; <
}66 
}77 
return99 
View99 
(99 
$str99 %
,99% &
book99' +
)99+ ,
;99, -
}:: 	
public== 
async== 
Task== 
<== 

JsonResult== $
>==$ %
RentBook==& .
(==. /
[==/ 0
FromServices==0 <
]==< =
BookDbContext==> K
ctx==L O
,==O P
[==Q R
FromServices==R ^
]==^ _
EmailService==` l
email==m r
,==r s
[==t u
FromBody==u }
]==} ~
int	== Ç
model
==É à
)
==à â
{>> 	
var?? 
result?? 
=?? 
new?? 
OperationResult?? ,
(??, -
)??- .
;??. /
tryAA 
{BB 
varCC 
userUidCC 
=CC 
UserCC "
.CC" #
IdentityCC# +
.CC+ ,
NameCC, 0
.CC0 1
ReplaceCC1 8
(CC8 9
$strCC9 C
,CCC D
$strCCE G
)CCG H
;CCH I
varDD 
bookIdDD 
=DD 
modelDD "
;DD" #
varEE 
dateEE 
=EE 
DateTimeEE #
.EE# $
NowEE$ '
;EE' (
varGG 
bookGG 
=GG 
ctxGG 
.GG 
BooksGG $
.GG$ %
FirstOrDefaultGG% 3
(GG3 4
qGG4 5
=>GG6 8
qGG9 :
.GG: ;
BiaIdGG; @
==GGA C
bookIdGGD J
)GGJ K
;GGK L
varHH 
userHH 
=HH 
ctxHH 
.HH 
AppUsersHH '
.HH' (
FirstHH( -
(HH- .
qHH. /
=>HH0 2
qHH3 4
.HH4 5
	LoginNameHH5 >
==HH? A
userUidHHB I
)HHI J
;HHJ K
ifJJ 
(JJ 
ctxJJ 
.JJ 

PaperBooksJJ "
.JJ" #
FirstJJ# (
(JJ( )
qJJ) *
=>JJ+ -
qJJ. /
.JJ/ 0
BiaIdJJ0 5
==JJ6 8
bookIdJJ9 ?
)JJ? @
.JJ@ A
TakenByUserJJA L
!=JJM O
nullJJP T
)JJT U
{KK 
returnLL 
JsonLL 
(LL  
newLL  #
OperationResultLL$ 3
(LL3 4
)LL4 5
.LL5 6
SetFailLL6 =
(LL= >
$strLL> Y
)LLY Z
)LLZ [
;LL[ \
}MM 
elseNN 
{OO 
ifPP 
(PP 
ctxPP 
.PP 
RequestBooksPP (
.PP( )
AnyPP) ,
(PP, -
qPP- .
=>PP/ 1
qPP2 3
.PP3 4

AppUserUidPP4 >
==PP? A
userPPB F
.PPF G
UidPPG J
&&PPK M
qPPN O
.PPO P
BookIdPPP V
==PPW Y
bookPPZ ^
.PP^ _
BiaIdPP_ d
)PPd e
)PPe f
{QQ 
returnRR 
JsonRR #
(RR# $
newRR$ '
OperationResultRR( 7
(RR7 8
)RR8 9
.RR9 :

SetSuccessRR: D
(RRD E
)RRE F
)RRF G
;RRG H
}SS 
varUU 
requestUU 
=UU  !
newUU" %
RequestBookUU& 1
(UU1 2
)UU2 3
{UU4 5

AppUserUidUU6 @
=UUA B
userUUC G
.UUG H
UidUUH K
,UUK L
BookIdUUM S
=UUT U
bookUUV Z
.UUZ [
BiaIdUU[ `
,UU` a
DateUUb f
=UUg h
DateTimeUUi q
.UUq r
NowUUr u
}UUv w
;UUw x
ctxVV 
.VV 
RequestBooksVV $
.VV$ %
AddVV% (
(VV( )
requestVV) 0
)VV0 1
;VV1 2
ctxWW 
.WW 
SaveChangesWW #
(WW# $
)WW$ %
;WW% &
logXX 
.XX 
InfoXX 
(XX 
$"XX 
{XX  
UserXX  $
.XX$ %
IdentityXX% -
.XX- .
NameXX. 2
}XX2 3
$strXX3 D
{XXD E
bookXXE I
.XXI J
BiaIdXXJ O
}XXO P
"XXP Q
)XXQ R
;XXR S
var[[ 
admins[[ 
=[[  
ctx[[! $
.[[$ %
AdminNotifies[[% 2
.[[2 3
Where[[3 8
([[8 9
q[[9 :
=>[[; =
q[[> ?
.[[? @
NotifyId[[@ H
==[[I K
AdminNotifyTypes[[L \
.[[\ ]
General[[] d
)[[d e
.[[e f
Select[[f l
([[l m
q[[m n
=>[[o q
q[[r s
.[[s t
Admin[[t y
)[[y z
;[[z {
if]] 
(]] 
!]] 
string]] 
.]]  
IsNullOrWhiteSpace]]  2
(]]2 3
user]]3 7
.]]7 8
Email]]8 =
)]]= >
)]]> ?
{^^ 
var__ 
config__ "
=__# $
new__% (
	Extension__) 2
.__2 3
MailConfiguration__3 D
(__D E
)__E F
{`` 
UserNameaa $
=aa% &
useraa' +
.aa+ ,
	FirstNameaa, 5
,aa5 6
BookIDbb "
=bb# $
requestbb% ,
.bb, -
BookIdbb- 3
,bb3 4
	BookTitlecc %
=cc& '
requestcc( /
.cc/ 0
Bookcc0 4
.cc4 5
Titlecc5 :
}dd 
;dd 
varee 
messageee #
=ee$ %
newee& )
MimeMessageee* 5
(ee5 6
)ee6 7
.ee7 8"
UserRequestMailMessageee8 N
(eeN O
configeeO U
)eeU V
;eeV W
messageff 
.ff  
Fromff  $
.ff$ %
Addff% (
(ff( )
newff) ,
MailboxAddressff- ;
(ff; <
Sff< =
.ff= >
MailBotff> E
)ffE F
)ffF G
;ffG H
messagegg 
.gg  
Togg  "
.gg" #
Addgg# &
(gg& '
newgg' *
MailboxAddressgg+ 9
(gg9 :
usergg: >
.gg> ?
Emailgg? D
)ggD E
)ggE F
;ggF G
emailhh 
.hh 
Sendhh "
(hh" #
messagehh# *
)hh* +
;hh+ ,
configjj 
=jj  
newjj! $
	Extensionjj% .
.jj. /
MailConfigurationjj/ @
(jj@ A
)jjA B
{kk 
UserNamell $
=ll% &
userll' +
.ll+ ,
	FirstNamell, 5
,ll5 6
BookIDmm "
=mm# $
requestmm% ,
.mm, -
BookIdmm- 3
,mm3 4
	BookTitlenn %
=nn& '
requestnn( /
.nn/ 0
Booknn0 4
.nn4 5
Titlenn5 :
}oo 
;oo 
ifqq 
(qq 
adminsqq "
.qq" #
Anyqq# &
(qq& '
)qq' (
)qq( )
{rr 
messagess #
=ss$ %
newss& )
MimeMessagess* 5
(ss5 6
)ss6 7
.ss7 8
AdminRequestMessagess8 K
(ssK L
configssL R
)ssR S
;ssS T
messagett #
.tt# $
Fromtt$ (
.tt( )
Addtt) ,
(tt, -
newtt- 0
MailboxAddresstt1 ?
(tt? @
Stt@ A
.ttA B
MailBotttB I
)ttI J
)ttJ K
;ttK L
foreachuu #
(uu$ %
varuu% (
adminuu) .
inuu/ 1
adminsuu2 8
)uu8 9
{vv 
messageww  '
.ww' (
Toww( *
.ww* +
Addww+ .
(ww. /
newww/ 2
MailboxAddressww3 A
(wwA B
adminwwB G
.wwG H
EmailwwH M
)wwM N
)wwN O
;wwO P
}xx 
emailyy !
.yy! "
Sendyy" &
(yy& '
messageyy' .
)yy. /
;yy/ 0
}zz 
}{{ 
else|| 
{}} 
if~~ 
(~~ 
admins~~ "
.~~" #
Any~~# &
(~~& '
)~~' (
)~~( )
{ 
var
ÄÄ 
message
ÄÄ  '
=
ÄÄ( )
new
ÄÄ* -
MimeMessage
ÄÄ. 9
(
ÄÄ9 :
)
ÄÄ: ;
;
ÄÄ; <
message
ÅÅ #
.
ÅÅ# $
From
ÅÅ$ (
.
ÅÅ( )
Add
ÅÅ) ,
(
ÅÅ, -
new
ÅÅ- 0
MailboxAddress
ÅÅ1 ?
(
ÅÅ? @
S
ÅÅ@ A
.
ÅÅA B
MailBot
ÅÅB I
)
ÅÅI J
)
ÅÅJ K
;
ÅÅK L
foreach
ÇÇ #
(
ÇÇ$ %
var
ÇÇ% (
admin
ÇÇ) .
in
ÇÇ/ 1
admins
ÇÇ2 8
)
ÇÇ8 9
{
ÉÉ 
message
ÑÑ  '
.
ÑÑ' (
To
ÑÑ( *
.
ÑÑ* +
Add
ÑÑ+ .
(
ÑÑ. /
new
ÑÑ/ 2
MailboxAddress
ÑÑ3 A
(
ÑÑA B
admin
ÑÑB G
.
ÑÑG H
Email
ÑÑH M
)
ÑÑM N
)
ÑÑN O
;
ÑÑO P
}
ÖÖ 
message
ÜÜ #
.
ÜÜ# $
Subject
ÜÜ$ +
=
ÜÜ, -
$str
ÜÜ. F
;
ÜÜF G
message
áá #
.
áá# $
Body
áá$ (
=
áá) *
new
áá+ .
TextPart
áá/ 7
(
áá7 8
)
áá8 9
{
àà 
Text
ââ  $
=
ââ% &
$"
ââ' )
{
ââ) *
user
ââ* .
.
ââ. /
	LoginName
ââ/ 8
}
ââ8 9
$strââ9 à
"ââà â
}
ää 
;
ää 
email
ãã !
.
ãã! "
Send
ãã" &
(
ãã& '
message
ãã' .
)
ãã. /
;
ãã/ 0
}
åå 
}
çç 
return
èè 
Json
èè 
(
èè  
new
èè  #
OperationResult
èè$ 3
(
èè3 4
)
èè4 5
.
èè5 6

SetSuccess
èè6 @
(
èè@ A
)
èèA B
)
èèB C
;
èèC D
}
êê 
}
ëë 
catch
íí 
(
íí 
	Exception
íí 
ex
íí 
)
íí  
{
ìì 
return
îî 
Json
îî 
(
îî 
new
îî 
OperationResult
îî  /
(
îî/ 0
)
îî0 1
.
îî1 2
SetFail
îî2 9
(
îî9 :
ex
îî: <
)
îî< =
)
îî= >
;
îî> ?
}
ïï 
}
ññ 	
public
òò 
async
òò 
Task
òò 
<
òò 

JsonResult
òò $
>
òò$ %
DeclineRent
òò& 1
(
òò1 2
[
òò2 3
FromServices
òò3 ?
]
òò? @
BookDbContext
òòA N
ctx
òòO R
,
òòR S
[
òòT U
FromBody
òòU ]
]
òò] ^
int
òò_ b
bookId
òòc i
)
òòi j
{
ôô 	
var
öö 
result
öö 
=
öö 
new
öö 
OperationResult
öö ,
(
öö, -
)
öö- .
;
öö. /
try
úú 
{
ùù 
var
ûû 
userUid
ûû 
=
ûû 
User
ûû "
.
ûû" #
Identity
ûû# +
.
ûû+ ,
Name
ûû, 0
.
ûû0 1
Replace
ûû1 8
(
ûû8 9
$str
ûû9 C
,
ûûC D
$str
ûûE G
)
ûûG H
;
ûûH I
var
üü 
book
üü 
=
üü 
ctx
üü 
.
üü 
Books
üü $
.
üü$ %
FirstOrDefault
üü% 3
(
üü3 4
q
üü4 5
=>
üü6 8
q
üü9 :
.
üü: ;
BiaId
üü; @
==
üüA C
bookId
üüD J
)
üüJ K
;
üüK L
var
†† 
user
†† 
=
†† 
ctx
†† 
.
†† 
AppUsers
†† '
.
††' (
First
††( -
(
††- .
q
††. /
=>
††0 2
q
††3 4
.
††4 5
	LoginName
††5 >
==
††? A
userUid
††B I
)
††I J
;
††J K
var
°° 
req
°° 
=
°° 
ctx
°° 
.
°° 
RequestBooks
°° *
.
°°* +
FirstOrDefault
°°+ 9
(
°°9 :
q
°°: ;
=>
°°< >
q
°°? @
.
°°@ A
AppUser
°°A H
==
°°I K
user
°°L P
&&
°°Q S
q
°°T U
.
°°U V
Book
°°V Z
==
°°[ ]
book
°°^ b
)
°°b c
;
°°c d
if
¢¢ 
(
¢¢ 
req
¢¢ 
!=
¢¢ 
null
¢¢ 
)
¢¢  
{
££ 
ctx
§§ 
.
§§ 
RequestBooks
§§ $
.
§§$ %
Remove
§§% +
(
§§+ ,
req
§§, /
)
§§/ 0
;
§§0 1
ctx
•• 
.
•• 
SaveChanges
•• #
(
••# $
)
••$ %
;
••% &
return
¶¶ 
Json
¶¶ 
(
¶¶  
new
¶¶  #
OperationResult
¶¶$ 3
(
¶¶3 4
)
¶¶4 5
.
¶¶5 6

SetSuccess
¶¶6 @
(
¶¶@ A
)
¶¶A B
)
¶¶B C
;
¶¶C D
}
ßß 
}
®® 
catch
©© 
(
©© 
	Exception
©© 
ex
©© 
)
©©  
{
™™ 
return
´´ 
Json
´´ 
(
´´ 
new
´´ 
OperationResult
´´  /
(
´´/ 0
)
´´0 1
.
´´1 2
SetFail
´´2 9
(
´´9 :
ex
´´: <
)
´´< =
)
´´= >
;
´´> ?
}
¨¨ 
return
≠≠ 
Json
≠≠ 
(
≠≠ 
new
≠≠ 
OperationResult
≠≠ +
(
≠≠+ ,
)
≠≠, -
.
≠≠- .
SetFail
≠≠. 5
(
≠≠5 6
)
≠≠6 7
)
≠≠7 8
;
≠≠8 9
}
ÆÆ 	
public
∞∞ 
async
∞∞ 
Task
∞∞ 
<
∞∞ 

JsonResult
∞∞ $
>
∞∞$ % 
ConfirmArrangement
∞∞& 8
(
∞∞8 9
[
∞∞9 :
FromServices
∞∞: F
]
∞∞F G
BookDbContext
∞∞H U
ctx
∞∞V Y
,
∞∞Y Z
[
∞∞[ \
FromBody
∞∞\ d
]
∞∞d e
dynamic
∞∞f m
model
∞∞n s
)
∞∞s t
{
±± 	
var
≤≤ 
result
≤≤ 
=
≤≤ 
new
≤≤ 
OperationResult
≤≤ ,
(
≤≤, -
)
≤≤- .
;
≤≤. /
try
≥≥ 
{
¥¥ 
var
µµ 
check
µµ 
=
µµ 
(
µµ 
bool
µµ !
)
µµ! "
model
µµ# (
.
µµ( )
Checked
µµ) 0
;
µµ0 1
var
∂∂ 
user
∂∂ 
=
∂∂ 
ctx
∂∂ 
.
∂∂ 
AppUsers
∂∂ '
.
∂∂' (
First
∂∂( -
(
∂∂- .
q
∂∂. /
=>
∂∂0 2
q
∂∂3 4
.
∂∂4 5
	LoginName
∂∂5 >
==
∂∂? A
User
∂∂B F
.
∂∂F G
Identity
∂∂G O
.
∂∂O P
Name
∂∂P T
.
∂∂T U
Replace
∂∂U \
(
∂∂\ ]
$str
∂∂] g
,
∂∂g h
$str
∂∂i k
)
∂∂k l
)
∂∂l m
;
∂∂m n
if
∑∑ 
(
∑∑ 
!
∑∑ 
ctx
∑∑ 
.
∑∑ 
Arrangements
∑∑ $
.
∑∑$ %
Any
∑∑% (
(
∑∑( )
q
∑∑) *
=>
∑∑* ,
q
∑∑, -
.
∑∑- .

AppUserUid
∑∑. 8
==
∑∑8 :
user
∑∑: >
.
∑∑> ?
Uid
∑∑? B
)
∑∑B C
)
∑∑C D
ctx
∏∏ 
.
∏∏ 
Arrangements
∏∏  
.
∏∏  !
Add
∏∏! $
(
∏∏$ %
new
∏∏% (
Arrangement
∏∏) 4
(
∏∏4 5
)
∏∏5 6
{
ππ 

AppUserUid
∫∫ 
=
∫∫  
user
∫∫! %
.
∫∫% &
Uid
∫∫& )
,
∫∫) *
Date
ªª 
=
ªª 
DateTime
ªª #
.
ªª# $
Now
ªª$ '
}
ºº 
)
ºº 
;
ºº 
ctx
ææ 
.
ææ 
SaveChanges
ææ 
(
ææ  
)
ææ  !
;
ææ! "
return
øø 
Json
øø 
(
øø 
new
øø 
OperationResult
øø  /
(
øø/ 0
)
øø0 1
.
øø1 2

SetSuccess
øø2 <
(
øø< =
)
øø= >
)
øø> ?
;
øø? @
}
¿¿ 
catch
¡¡ 
(
¡¡ 
	Exception
¡¡ 
ex
¡¡ 
)
¡¡  
{
¬¬ 
return
√√ 
Json
√√ 
(
√√ 
new
√√ 
OperationResult
√√  /
(
√√/ 0
)
√√0 1
.
√√1 2
SetFail
√√2 9
(
√√9 :
ex
√√: <
)
√√< =
)
√√= >
;
√√> ?
}
ƒƒ 
}
∆∆ 	
}
»» 
}…… ßB
NC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Extensions.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
{		 
public

 

static

 
class

 

Extensions

 "
{ 
public 
static 
IEnumerable !
<! "

RentedBook" ,
>, -
ToRentedBooks. ;
(; <
this< @
IEnumerableA L
<L M
	PaperBookM V
>V W
booksX ]
)] ^
{ 	
var 
result 
= 
new 
List !
<! "

RentedBook" ,
>, -
(- .
). /
;/ 0
foreach 
( 
var 
book 
in  
books! &
)& '
{ 
var 
rent 
= 
book 
.  
RentHistory  +
.+ ,
OrderBy, 3
(3 4
q4 5
=>5 7
q7 8
.8 9
	TakenDate9 B
)B C
.C D
FirstD I
(I J
)J K
;K L
result 
. 
Add 
( 
new 

RentedBook )
() *
)* +
{ 
BiaId 
= 
book  
.  !
BiaId! &
,& '
Title 
= 
book  
.  !
Title! &
,& '
User 
= 
book 
.  
TakenByUser  +
?+ ,
., -
	LoginName- 6
,6 7

EndRenting 
=  
book! %
.% &
TakenDue& .
.. /
GetValueOrDefault/ @
(@ A
)A B
,B C
StartRenting  
=! "
rent# '
.' (
	TakenDate( 1
,1 2
} 
) 
; 
} 
return 
result 
; 
} 	
public 
static 
string 
GenerateLink )
() *
this* .
string/ 5
str6 9
)9 :
{   	
return%% 
str%% 
.%% 
Split%% 
(%% 
$char%% !
)%%! "
.%%" #
Last%%# '
(%%' (
)%%( )
;%%) *
}&& 	
public(( 
static(( 
UserBookViewModel(( '
ToUserBookViewModel((( ;
(((; <
this((< @
Book((A E
book((F J
)((J K
{)) 	
var** 
result** 
=** 
new** 
UserBookViewModel** .
(**. /
)**/ 0
{++ 
Isbn,, 
=,, 
book,, 
.,, 
Isbn,,  
,,,  !
BiaId-- 
=-- 
book-- 
.-- 
BiaId-- "
,--" #
Title.. 
=.. 
book.. 
... 
Title.. "
,.." #
Subtitle// 
=// 
book// 
.//  
Subtitle//  (
,//( )
Language00 
=00 
book00 
.00  
Language00  (
,00( )
Year11 
=11 
book11 
.11 
Year11  
,11  !
Edition22 
=22 
book22 
.22 
Edition22 &
,22& '
Pages33 
=33 
book33 
.33 
Pages33 "
,33" #

CoverImage44 
=44 
book44 !
.44! "

CoverImage44" ,
,44, -

Annotation55 
=55 
book55 !
.55! "

Annotation55" ,
,55, -
}66 
;66 
result77 
.77 
Authors77 
=77 
new77  
List77! %
<77% &
AuthorViewModel77& 5
>775 6
(776 7
)777 8
;778 9
foreach88 
(88 
var88 
author88 
in88  "
book88# '
.88' (
Authors88( /
)88/ 0
{99 
result:: 
.:: 
Authors:: 
.:: 
Add:: "
(::" #
new::# &
AuthorViewModel::' 6
(::6 7
)::7 8
{;; 
}== 
)== 
;== 
}>> 
result?? 
.?? 
Cathegories?? 
=??  
new??! $
List??% )
<??) *
CategoryViewModel??* ;
>??; <
(??< =
)??= >
;??> ?
result@@ 
.@@ 
Reviews@@ 
=@@ 
new@@  
List@@! %
<@@% &
ReviewViewModel@@& 5
>@@5 6
(@@6 7
)@@7 8
;@@8 9
returnBB 
resultBB 
;BB 
}CC 	
publicEE 
staticEE 
intEE 
SumCurrentRatingEE *
(EE* +
thisEE+ /
BookEE0 4
bookEE5 9
)EE9 :
{FF 	
varGG 
ratingGG 
=GG 
bookGG 
.GG 
ReviewsGG %
.GG% &
SelectGG& ,
(GG, -
qGG- .
=>GG/ 1
qGG2 3
.GG3 4
RatingGG4 :
)GG: ;
;GG; <
varHH 
currHH 
=HH 
ratingHH 
.HH 
SumHH !
(HH! "
)HH" #
;HH# $
varII 
countII 
=II 
ratingII 
.II 
CountII $
(II$ %
)II% &
;II& '
currJJ 
=JJ 
(JJ 
currJJ 
>JJ 
$numJJ 
)JJ 
?JJ 
currJJ  $
/JJ$ %
countJJ% *
:JJ+ ,
$numJJ- .
;JJ/ 0
returnKK 
currKK 
;KK 
}LL 	
publicNN 
staticNN 
stringNN 
FullNameNN %
(NN% &
thisNN& *
AuthorNN+ 1
authorNN2 8
)NN8 9
{OO 	
ifPP 
(PP 
stringPP 
.PP 
IsNullOrEmptyPP $
(PP$ %
authorPP% +
.PP+ ,

MiddleNamePP, 6
)PP6 7
)PP7 8
{QQ 
returnRR 
$"RR 
{RR 
authorRR  
.RR  !
	FirstNameRR! *
}RR* +
$strRR+ ,
{RR, -
authorRR- 3
.RR3 4
LastNameRR4 <
}RR< =
"RR= >
;RR> ?
}SS 
returnTT 
$"TT 
{TT 
authorTT 
.TT 
	FirstNameTT &
}TT& '
$strTT' (
{TT( )
authorTT) /
.TT/ 0

MiddleNameTT0 :
}TT: ;
$strTT; <
{TT< =
authorTT= C
.TTC D
LastNameTTD L
}TTL M
"TTM N
;TTN O
}UU 	
publicWW 
staticWW 
stringWW 
InitialsWW %
(WW% &
thisWW& *
AuthorWW+ 1
authorWW2 8
)WW8 9
{XX 	
ifYY 
(YY 
stringYY 
.YY 
IsNullOrEmptyYY $
(YY$ %
authorYY% +
.YY+ ,

MiddleNameYY, 6
)YY6 7
)YY7 8
{ZZ 
return[[ 
$"[[ 
{[[ 
author[[  
.[[  !
	FirstName[[! *
[[[* +
$num[[+ ,
][[, -
}[[- .
$str[[. 0
{[[0 1
author[[1 7
.[[7 8
LastName[[8 @
}[[@ A
"[[A B
;[[B C
}\\ 
return]] 
$"]] 
{]] 
author]] 
.]] 
	FirstName]] &
[]]& '
$num]]' (
]]]( )
}]]) *
$str]]* +
{]]+ ,
author]], 2
.]]2 3

MiddleName]]3 =
[]]= >
$num]]> ?
]]]? @
}]]@ A
$str]]A C
{]]C D
author]]D J
.]]J K
LastName]]K S
}]]S T
"]]T U
;]]U V
}^^ 	
}`` 
}aa ¯
sC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Extentions\ActiveDirectoryUserNotFoundException.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
{ 
[ 
Serializable 
] 
public 

class 0
$ActiveDirectoryUserNotFoundException 5
:6 7
	Exception8 A
{ 
public		 0
$ActiveDirectoryUserNotFoundException		 3
(		3 4
)		4 5
:		6 7
base		8 <
(		< =
)		= >
{

 	
} 	
public 0
$ActiveDirectoryUserNotFoundException 3
(3 4
string4 :
message; B
)B C
:D E
baseF J
(J K
messageK R
)R S
{ 	
} 	
public 0
$ActiveDirectoryUserNotFoundException 3
(3 4
string4 :
message; B
,B C
	ExceptionD M
innerExceptionN \
)\ ]
:^ _
base` d
(d e
messagee l
,l m
innerExceptionn |
)| }
{ 	
} 	
	protected 0
$ActiveDirectoryUserNotFoundException 6
(6 7
SerializationInfo7 H
infoI M
,M N
StreamingContextO _
context` g
)g h
:i j
basek o
(o p
infop t
,t u
contextv }
)} ~
{ 	
} 	
public 
override 
string 
Message &
=>' )
base* .
.. /
Message/ 6
.6 7
Equals7 =
(= >
string> D
.D E
EmptyE J
)J K
?L M
$strN w
:x y
basez ~
.~ 
Message	 Ü
;
Ü á
} 
} ∆
WC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Extentions\AdHelper.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
{

 
public 

static 
class 
AdHelper  
{ 
public 
static 
AppUser &
NewUserFromActiveDirectory 8
(8 9
this9 =
AppUser> E
userF J
,J K
stringK Q
usernameR Z
)Z [
{ 	
using 
( 
var 
context 
=  
new! $
PrincipalContext% 5
(5 6
ContextType6 A
.A B
DomainB H
,H I
EnvironmentJ U
.U V"
GetEnvironmentVariableV l
(l m
$strm y
)y z
??{ }
Environment	~ â
.
â ä$
GetEnvironmentVariable
ä †
(
† °
$str
° ´
)
´ ¨
)
¨ ≠
)
≠ Æ
{ 
using 
( 
var 
searcher #
=$ %
new& )
PrincipalSearcher* ;
(; <
new< ?
UserPrincipal@ M
(M N
contextN U
)U V
)V W
)W X
{ 
searcher 
. 
QueryFilter (
.( )
SamAccountName) 7
=8 9
username: B
;B C
var 
adInfo 
=  
(! "
UserPrincipal" /
)/ 0
searcher0 8
.8 9
FindOne9 @
(@ A
)A B
;B C
if 
( 
adInfo 
== !
null" &
)& '
{ 
throw 
new !0
$ActiveDirectoryUserNotFoundException" F
(F G
)G H
;H I
}   
user"" 
."" 
Uid"" 
="" 
adInfo"" %
.""% &
Guid""& *
??""+ -
Guid"". 2
.""2 3
NewGuid""3 :
("": ;
)""; <
;""< =
user## 
.## 
Email## 
=##  
adInfo##! '
.##' (
EmailAddress##( 4
;##4 5
user$$ 
.$$ 
IsActive$$ !
=$$" #
adInfo$$$ *
.$$* +
Enabled$$+ 2
??$$3 5
true$$6 :
;$$: ;
user%% 
.%% 
	FirstName%% "
=%%# $
adInfo%%% +
.%%+ ,
	GivenName%%, 5
;%%5 6
user&& 
.&& 
LastName&& !
=&&" #
adInfo&&$ *
.&&* +
Surname&&+ 2
;&&2 3
user'' 
.'' 
FullName'' !
=''" #
adInfo''$ *
.''* +
DisplayName''+ 6
;''6 7
user(( 
.(( 

DateJoined(( #
=(($ %
DateTime((& .
.((. /
Now((/ 2
;((2 3
user)) 
.)) 
	LoginName)) "
=))# $
username))% -
;))- .
return++ 
user++ 
;++  
},, 
}-- 
}.. 	
}// 
}00 æ`
gC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Middleware\LocalAuthorityMiddleware.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #

Middleware# -
{ 
public 

class $
LocalAuthorityMiddleware )
{ 
private 
readonly 
RequestDelegate (
_next) .
;. /
private 
readonly 
ILogger  
_log! %
;% &
private 
readonly 
IConfiguration '
_config( /
;/ 0
public $
LocalAuthorityMiddleware '
(' (
RequestDelegate( 7
next8 <
,< =
ILogger> E
<E F$
LocalAuthorityMiddlewareF ^
>^ _
log` c
,c d
IConfigurationf t
configuration	u Ç
)
Ç É
{ 	
_next 
= 
next 
; 
_log 
= 
log 
; 
_config 
= 
configuration '
;' (
} 	
public 
async 
Task 
Invoke  
(  !
HttpContext! ,
context- 4
,4 5
BookDbContext6 C
ctxD G
)G H
{ 	
try 
{ 
_log   
.   
LogDebug   
(   
$str   @
)  @ A
;  A B
if"" 
("" 
context"" 
."" 
User""  
.""  !
Identity""! )
."") *
IsAuthenticated""* 9
)""9 :
{## 
_log$$ 
.$$ 
LogDebug$$ !
($$! "
$"$$" $
$str$$$ K
{$$K L
context$$L S
.$$S T
User$$T X
.$$X Y
Identity$$Y a
.$$a b
Name$$b f
}$$f g
$str$$g h
"$$h i
)$$i j
;$$j k
string&& 
sam&& 
;&& 
try'' 
{(( 
sam)) 
=)) 
context)) %
.))% &
User))& *
.))* +
Identity))+ 3
.))3 4
Name))4 8
.))8 9
Split))9 >
())> ?
$char))? C
)))C D
[))D E
$num))E F
]))F G
;))G H
}** 
catch++ 
(++ $
IndexOutOfRangeException++ 3
)++3 4
{,, 
sam-- 
=-- 
context-- %
.--% &
User--& *
.--* +
Identity--+ 3
.--3 4
Name--4 8
;--8 9
}.. 
var// 
us// 
=// 
ctx//  
.//  !
AppUsers//! )
.//) *
Where//* /
(/// 0
res//0 3
=>//4 6
res//7 :
.//: ;
	LoginName//; D
==//E G
sam//H K
)//K L
;//L M
var00 
dbUser00 
=00  
us00! #
.00# $
SingleOrDefault00$ 3
(003 4
)004 5
;005 6
if11 
(11 
dbUser11 
==11 !
null11" &
)11& '
{22 
_log33 
.33 

LogWarning33 '
(33' (
$str33( Q
)33Q R
;33R S
AppUser44 
user44  $
;44$ %
AccessGroupId55 %
AccessGroup55& 1
;551 2
var66 
claims66 "
=66# $
new66% (
List66) -
<66- .
Claim66. 3
>663 4
(664 5
)665 6
;666 7
if77 
(77 
_config77 #
[77# $
$str77$ 1
]771 2
.772 3
Split773 8
(778 9
$char779 <
)77< =
.77= >
Any77> A
(77A B
dev77B E
=>77F H
dev77I L
.77L M
Contains77M U
(77U V
sam77V Y
)77Y Z
)77Z [
)77[ \
{88 
user99  
=99! "
new99# &
Admin99' ,
(99, -
)99- .
;99. /
AccessGroup:: '
=::( )
AccessGroupId::* 7
.::7 8
	Developer::8 A
;::A B
claims;; "
.;;" #
Add;;# &
(;;& '
new;;' *
Claim;;+ 0
(;;0 1
Data;;1 5
.;;5 6
S;;6 7
.;;7 8
AccessLevelClaim;;8 H
,;;H I
AccessGroupId;;J W
.;;W X
	Developer;;X a
.;;a b
ToString;;b j
(;;j k
);;k l
);;l m
);;m n
;;;n o
}<< 
else== 
if== 
(==  !
_config==! (
[==( )
$str==) 8
]==8 9
.==9 :
Split==: ?
(==? @
$char==@ C
)==C D
.==D E
Any==E H
(==H I
adm==I L
=>==M O
adm==P S
.==S T
Contains==T \
(==\ ]
sam==] `
)==` a
)==a b
)==b c
{>> 
user??  
=??! "
new??# &
Admin??' ,
(??, -
)??- .
;??. /
AccessGroup@@ '
=@@( )
AccessGroupId@@* 7
.@@7 8
Admin@@8 =
;@@= >
claimsAA "
.AA" #
AddAA# &
(AA& '
newAA' *
ClaimAA+ 0
(AA0 1
DataAA1 5
.AA5 6
SAA6 7
.AA7 8
AccessLevelClaimAA8 H
,AAH I
AccessGroupIdAAJ W
.AAW X
AdminAAX ]
.AA] ^
ToStringAA^ f
(AAf g
)AAg h
)AAh i
)AAi j
;AAj k
}BB 
elseCC 
{DD 
AccessGroupEE '
=EE( )
AccessGroupIdEE* 7
.EE7 8
CommonEE8 >
;EE> ?
userFF  
=FF! "
newFF# &
AppUserFF' .
(FF. /
)FF/ 0
;FF0 1
claimsGG "
.GG" #
AddGG# &
(GG& '
newGG' *
ClaimGG+ 0
(GG0 1
DataGG1 5
.GG5 6
SGG6 7
.GG7 8
AccessLevelClaimGG8 H
,GGH I
AccessGroupIdGGJ W
.GGW X
CommonGGX ^
.GG^ _
ToStringGG_ g
(GGg h
)GGh i
)GGi j
)GGj k
;GGk l
}HH 
tryJJ 
{KK 
dbUserLL "
=LL# $
userLL% )
.LL) *&
NewUserFromActiveDirectoryLL* D
(LLD E
samLLE H
)LLH I
;LLI J
contextNN #
.NN# $
ItemsNN$ )
[NN) *
$strNN* 3
]NN3 4
=NN5 6
dbUserNN7 =
;NN= >
}OO 
catchPP 
(PP 0
$ActiveDirectoryUserNotFoundExceptionPP C
exPPD F
)PPF G
{QQ 
_logRR  
.RR  !

LogWarningRR! +
(RR+ ,
exRR, .
,RR. /
$"RR0 2
$strRR2 7
{RR7 8
contextRR8 ?
.RR? @
UserRR@ D
.RRD E
IdentityRRE M
.RRM N
NameRRN R
}RRR S
$strRRS c
"RRc d
)RRd e
;RRe f
contextSS #
.SS# $
ItemsSS$ )
[SS) *
$strSS* 8
]SS8 9
=SS: ;
contextSS< C
.SSC D
RequestSSD K
.SSK L
PathSSL P
.SSP Q
ValueSSQ V
;SSV W
contextTT #
.TT# $
RequestTT$ +
.TT+ ,
PathTT, 0
=TT1 2
$strTT3 J
;TTJ K
awaitUU !
_nextUU" '
(UU' (
contextUU( /
)UU/ 0
;UU0 1
returnVV "
;VV" #
}WW 
dbUserZZ 
.ZZ 
AccessGroupZZ *
=ZZ+ ,
AccessGroupZZ- 8
;ZZ8 9
foreach[[ 
([[  !
var[[! $
claim[[% *
in[[+ -
claims[[. 4
)[[4 5
{\\ 
(]] 
(]] 
ClaimsIdentity]] ,
)]], -
context]]. 5
.]]5 6
User]]6 :
.]]: ;
Identity]]; C
)]]C D
.]]D E
AddClaim]]E M
(]]M N
claim]]N S
)]]S T
;]]T U
}^^ 
ctx`` 
.`` 
AppUsers`` $
.``$ %
Add``% (
(``( )
dbUser``) /
)``/ 0
;``0 1
ctxaa 
.aa 
SaveChangesaa '
(aa' (
)aa( )
;aa) *
_logbb 
.bb 
LogTracebb %
(bb% &
$strbb& Q
)bbQ R
;bbR S
awaitcc 
ctxcc !
.cc! "
SaveChangesAsynccc" 2
(cc2 3
)cc3 4
;cc4 5
awaitee 
_nextee #
(ee# $
contextee$ +
)ee+ ,
;ee, -
}ff 
elsegg 
{hh 
ifii 
(ii 
!ii 
dbUserii #
.ii# $
IsActiveii$ ,
)ii, -
{jj 
contextkk #
.kk# $
Itemskk$ )
[kk) *
$strkk* 8
]kk8 9
=kk: ;
contextkk< C
.kkC D
RequestkkD K
.kkK L
PathkkL P
.kkP Q
ValuekkQ V
;kkV W
contextll #
.ll# $
Requestll$ +
.ll+ ,
Pathll, 0
=ll1 2
$strll3 J
;llJ K
awaitmm !
_nextmm" '
(mm' (
contextmm( /
)mm/ 0
;mm0 1
}nn 
elseoo 
ifoo 
(oo  !
dbUseroo! '
.oo' (
AccessGroupoo( 3
!=oo4 6
$numoo7 8
)oo8 9
{pp 
varqq 
claimsqq  &
=qq' (
(qq) *
dbUserqq* 0
.qq0 1
AccessGroupqq1 <
)qq< =
.qq= >
GetClaimsValuesqq> M
(qqM N
)qqN O
;qqO P
(rr 
(rr 
ClaimsIdentityrr ,
)rr, -
contextrr- 4
.rr4 5
Userrr5 9
.rr9 :
Identityrr: B
)rrB C
.rrC D
	AddClaimsrrD M
(rrM N
claimsrrN T
)rrT U
;rrU V
contexttt #
.tt# $
Itemstt$ )
[tt) *
$strtt* 3
]tt3 4
=tt5 6
dbUsertt7 =
;tt= >
_logvv  
.vv  !

LogWarningvv! +
(vv+ ,
$"vv, .
$strvv. U
{vvU V
contextvvV ]
.vv] ^
Uservv^ b
.vvb c
Identityvvc k
.vvk l
Namevvl p
}vvp q
$strvvq w
"vvw x
)vvx y
;vvy z
}ww 
awaitxx 
_nextxx #
(xx# $
contextxx$ +
)xx+ ,
;xx, -
}yy 
}zz 
else{{ 
{|| 
_log}} 
.}} 
LogTrace}} !
(}}! "
$"}}" $
$str}}$ T
{}}T U
context}}U \
.}}\ ]
User}}] a
.}}a b
Identity}}b j
.}}j k
Name}}k o
}}}o p
"}}p q
)}}q r
;}}r s
await~~ 
_next~~ 
(~~  
context~~  '
)~~' (
;~~( )
} 
}
ÄÄ 
catch
ÅÅ 
(
ÅÅ 
	Exception
ÅÅ 
ex
ÅÅ 
)
ÅÅ  
when
ÅÅ! %
(
ÅÅ& '
!
ÅÅ' (
System
ÅÅ( .
.
ÅÅ. /
Diagnostics
ÅÅ/ :
.
ÅÅ: ;
Debugger
ÅÅ; C
.
ÅÅC D

IsAttached
ÅÅD N
)
ÅÅN O
{
ÇÇ 
_log
ÉÉ 
.
ÉÉ 
LogError
ÉÉ 
(
ÉÉ 
ex
ÉÉ  
,
ÉÉ  !
$str
ÉÉ" C
)
ÉÉC D
;
ÉÉD E
await
ÑÑ 
_next
ÑÑ 
(
ÑÑ 
context
ÑÑ #
)
ÑÑ# $
;
ÑÑ$ %
}
ÖÖ 
}
ÜÜ 	
}
áá 
}àà π$
VC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\AddBookForm.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
.		" #
Models		# )
{

 
[ 
DataContract 
] 
[ 
Serializable 
] 
public 

class 
AddBookForm 
{ 
[ 	

DataMember	 
( 
Name 
= 
$str "
)" #
]# $
public 
int 
Id 
{ 
get 
; 
set  
;  !
}" #
[ 	

DataMember	 
( 
Name 
= 
$str "
)" #
]# $
public 
string 
Title 
{ 
get !
;! "
set# &
;& '
}( )
[ 	

DataMember	 
( 
Name 
= 
$str %
)% &
]& '
public 
string 
Subtitle 
{  
get! $
;$ %
set& )
;) *
}+ ,
[ 	

DataMember	 
( 
Name 
= 
$str '
)' (
]( )
public 
string 

Annotation  
{! "
get# &
;& '
set( +
;+ ,
}- .
[ 	

DataMember	 
( 
Name 
= 
$str !
)! "
]" #
public 
string 
Isbn 
{ 
get  
;  !
set" %
;% &
}' (
[ 	

DataMember	 
( 
Name 
= 
$str !
)! "
]" #
public 
string 
Link 
{ 
get  
;  !
set" %
;% &
}' (
[ 	

DataMember	 
( 
Name 
= 
$str '
)' (
]( )
public 
string 

CoverImage  
{! "
get# &
;& '
set( +
;+ ,
}- .
[ 	

DataMember	 
( 
Name 
= 
$str !
)! "
]" #
public 
int 
? 
Year 
{ 
get 
; 
set  #
;# $
}% &
[   	

DataMember  	 
(   
Name   
=   
$str   "
)  " #
]  # $
public!! 
int!! 
?!! 
Pages!! 
{!! 
get!! 
;!!  
set!!! $
;!!$ %
}!!& '
["" 	

DataMember""	 
("" 
Name"" 
="" 
$str"" $
)""$ %
]""% &
public## 
int## 
?## 
Edition## 
{## 
get## !
;##! "
set### &
;##& '
}##( )
[$$ 	

DataMember$$	 
($$ 
Name$$ 
=$$ 
$str$$ &
)$$& '
]$$' (
public%% 
bool%% 
	PaperBook%% 
{%% 
get%%  #
;%%# $
set%%% (
;%%( )
}%%* +
[&& 	

DataMember&&	 
(&& 
Name&& 
=&& 
$str&& %
)&&% &
]&&& '
public'' 

LanguageId'' 
Language'' "
{''# $
get''% (
;''( )
set''* -
;''- .
}''/ 0
[(( 	

DataMember((	 
((( 
Name(( 
=(( 
$str(( $
)(($ %
]((% &
public)) 
IEnumerable)) 
<)) 
Guid)) 
>))  
Authors))! (
{))) *
get))+ .
;)). /
set))0 3
;))3 4
}))5 6
[** 	

DataMember**	 
(** 
Name** 
=** 
$str** (
)**( )
]**) *
public++ 
IEnumerable++ 
<++ 
int++ 
>++ 

Categories++  *
{+++ ,
get++- 0
;++0 1
set++2 5
;++5 6
}++7 8
},, 
}-- ≤
YC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\AddReviewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 
AddReviewModel 
{		 
public

 
int

 
BookId

 
{

 
get

 
;

  
set

! $
;

$ %
}

& '
public 
int 
Rating 
{ 
get 
;  
set! $
;$ %
}& '
public 
string 
Text 
{ 
get  
;  !
set" %
;% &
}' (
} 
} Ô

ZC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\AuthorViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 
AuthorViewModel  
{		 
public

 
Guid

 
AuthoUid

 
{

 
get

 "
;

" #
set

$ '
;

' (
}

) *
public 
string 
	FirstName 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
LastName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 

MiddleName  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
string 
FullName 
{ 	
get 
{ 
return 
$" 
{ 
	FirstName #
}# $
$str$ %
{% &

MiddleName& 0
}0 1
$str1 2
{2 3
LastName3 ;
}; <
"< =
;= >
} 
} 	
} 
} ≠
\C:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\CategoryViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 
CategoryViewModel "
{		 
public

 
int

 

CategoryId

 
{

 
get

  #
;

# $
set

% (
;

( )
}

* +
public 
string 
CategoryName "
{# $
get% (
;( )
set* -
;- .
}/ 0
} 
} ‰
YC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\EBookViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 
EBookViewModel 
:  
UserBookViewModel  1
{		 
public

 
string

 
Format

 
{

 
get

 "
;

" #
set

$ '
;

' (
}

) *
public 
string 
Size 
{ 
get  
;  !
set" %
;% &
}' (
public 
string 
Link 
{ 
get  
;  !
set" %
;% &
}' (
} 
} Î
YC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\ErrorViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 
ErrorViewModel 
{ 
public 
string 
	RequestId 
{  !
get" %
;% &
set' *
;* +
}, -
public		 
bool		 
ShowRequestId		 !
=>		" $
!		% &
string		& ,
.		, -
IsNullOrEmpty		- :
(		: ;
	RequestId		; D
)		D E
;		E F
}

 
} í
]C:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\PaperBookViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 
PaperBookViewModel #
:# $
UserBookViewModel$ 5
{		 
public

 
bool

 
Rented

 
{

 
get

  
;

  !
set

" %
;

% &
}

' (
public 
User 
User 
{ 
get 
; 
set  #
;# $
}% &
public 
DateTime 
StartRenting $
{% &
get' *
;* +
set, /
;/ 0
}1 2
public 
DateTime 

EndRenting "
{# $
get% (
;( )
set* -
;- .
}/ 0
} 
} º
UC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\RentedBook.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public 

class 

RentedBook 
{		 
public

 
int

 
BiaId

 
{

 
get

 
;

 
set

  #
;

# $
}

% &
public 
string 
Title 
{ 
get !
;! "
set" %
;% &
}& '
public 
string 
User 
{ 
get  
;  !
set" %
;% &
}' (
public 
DateTime 
StartRenting $
{% &
get' *
;* +
set, /
;/ 0
}1 2
public 
DateTime 

EndRenting "
{# $
get% (
;( )
set* -
;- .
}/ 0
public 

RentStatus 
Status  
{ 	
get 
{ 
return 
( 

EndRenting "
<=" $
DateTime$ ,
., -
Today- 2
)2 3
?3 4

RentStatus5 ?
.? @
Early@ E
:E F

RentStatusG Q
.Q R
LateR V
;V W
} 
} 	
} 
public 

enum 

RentStatus 
{ 
Early 
, 
Late 
} 
} Ë
ZC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\ReviewViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public		 

class		 
ReviewViewModel		  
{

 
public 
Guid 
	ReviewUid 
{ 
get  #
;# $
set% (
;( )
}* +
public 
string 
Book 
{ 
get  
;  !
set" %
;% &
}' (
public 
string 
Review 
{ 
get "
;" #
set$ '
;' (
}) *
public 
User 
User 
{ 
get 
; 
set  #
;# $
}% &
public 
int 
Rating 
{ 
get 
;  
set! $
;$ %
}& '
} 
} Ï
\C:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\SettingsViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public		 

class		 
SettingsViewModel		 "
{

 
public 
IEnumerable 
< 
AppUser "
>" #
Users$ )
{* +
get, /
;/ 0
set1 4
;4 5
}6 7
public 
IEnumerable 
< 
Author !
>! "
Authors# *
{+ ,
get- 0
;0 1
set2 5
;5 6
}7 8
public 
IEnumerable 
< 
Category #
># $

Categories% /
{0 1
get2 5
;5 6
set7 :
;: ;
}< =
} 
} ê
OC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\User.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{ 
public		 

class		 
User		 
{

 
public 
string 
FullName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
ImageUrl 
{  
get! $
;$ %
set& )
;) *
}+ ,
} 
} é$
\C:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Models\UserBookViewModel.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Models# )
{		 
public

 

class

 
UserBookViewModel

 "
{ 
[ 	
Display	 
( 
Name 
= 
$str 
) 
]  
public 
string 
Isbn 
{ 
get  
;  !
set" %
;% &
}' (
[ 	
Display	 
( 
Name 
= 
$str 
) 
] 
public 
int 
BiaId 
{ 
get 
; 
set  #
;# $
}% &
[ 	
Display	 
( 
Name 
= 
$str "
)" #
]# $
public 
string 
Title 
{ 
get !
;! "
set# &
;& '
}( )
[ 	
Display	 
( 
Name 
= 
$str &
)& '
]' (
public 
string 
Subtitle 
{  
get! $
;$ %
set& )
;) *
}+ ,
[ 	
Display	 
( 
Name 
= 
$str 
) 
]  
public 

LanguageId 
Language "
{# $
get% (
;( )
set* -
;- .
}/ 0
[ 	
Display	 
( 
Name 
= 
$str  
)  !
]! "
public 
ICollection 
< 
AuthorViewModel *
>* +
Authors, 3
{4 5
get6 9
;9 :
set; >
;> ?
}@ A
[ 	
Display	 
( 
Name 
= 
$str #
)# $
]$ %
public 
ICollection 
< 
CategoryViewModel ,
>, -
Cathegories. 9
{: ;
get< ?
;? @
setA D
;D E
}F G
[!! 	
Display!!	 
(!! 
Name!! 
=!! 
$str!!  
)!!  !
]!!! "
public"" 
ICollection"" 
<"" 
ReviewViewModel"" *
>""* +
Reviews"", 3
{""4 5
get""6 9
;""9 :
set""; >
;""> ?
}""@ A
[$$ 	
Display$$	 
($$ 
Name$$ 
=$$ 
$str$$ 
)$$ 
]$$ 
public%% 
int%% 
?%% 
Year%% 
{%% 
get%% 
;%% 
set%%  #
;%%# $
}%%% &
['' 	
Display''	 
('' 
Name'' 
='' 
$str'' !
)''! "
]''" #
public(( 
int(( 
?(( 
Edition(( 
{(( 
get(( !
;((! "
set((# &
;((& '
}((( )
[** 	
Display**	 
(** 
Name** 
=** 
$str** 
)** 
]**  
public++ 
int++ 
?++ 
Pages++ 
{++ 
get++ 
;++  
set++! $
;++$ %
}++& '
[-- 	
Display--	 
(-- 
Name-- 
=-- 
$str-- !
)--! "
]--" #
public.. 
string.. 

CoverImage..  
{..! "
get..# &
;..& '
set..( +
;..+ ,
}..- .
[00 	
Display00	 
(00 
Name00 
=00 
$str00 "
)00" #
]00# $
public11 
string11 

Annotation11  
{11! "
get11# &
;11& '
set11( +
;11+ ,
}11- .
[33 	
Display33	 
(33 
Name33 
=33 
$str33 !
)33! "
]33" #
public44 
int44 
AverageRating44  
{44! "
get44# &
;44& '
set44( +
;44+ ,
}44- .
}66 
}77 ƒ
SC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\OperationResult.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
{

 
public 

class 
OperationResult  
{ 
public 
string 
Status 
{ 
get "
;" #
set$ '
;' (
}) *
public 
string 
Details 
{ 
get  #
;# $
set% (
;( )
}* +
public 
string 
ExceptionData #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 
	Exception 
	Exception "
=># %
GetException& 2
(2 3
)3 4
;4 5
private 
	Exception 

_exception $
;$ %
public 
	Exception 
GetException %
(% &
)& '
{ 	
if 
( 
ExceptionData 
==  
null! %
)% &
return 
null 
; 
return   

_exception   
??    
SetException  ! -
(  - .
)  . /
;  / 0
}!! 	
public## 
OperationResult## 

SetSuccess## )
(##) *
string##* 0
details##1 8
=##8 9
null##9 =
)##= >
{$$ 	
Status%% 
=%% 
$str%% 
;%% 
if&& 
(&& 
!&& 
string&& 
.&& 
IsNullOrEmpty&& %
(&&% &
details&&& -
)&&- .
)&&. /
{'' 
Details(( 
=(( 
details(( !
;((! "
})) 
return** 
this** 
;** 
}++ 	
public-- 
OperationResult-- 
SetFail-- &
(--& '
string--' -
details--. 5
)--5 6
{.. 	
Status// 
=// 
$str// 
;// 
Details00 
=00 
details00 
;00 
return11 
this11 
;11 
}22 	
public44 
OperationResult44 
SetFail44 &
(44& '
	Exception44' 0
ex441 3
=444 5
null446 :
)44: ;
{55 	
Status66 
=66 
$str66 
;66 
if77 
(77 
ex77 
!=77 
null77 
)77 
{88 
Details99 
=99 
ex99 
.99 
Message99 $
;99$ %
}:: 
return;; 
this;; 
;;; 
}<< 	
private>> 
	Exception>> 
SetException>> &
(>>& '
)>>' (
{?? 	
try@@ 
{AA 
usingBB 
(BB 
varBB 
streamBB !
=BB" #
newBB$ '
MemoryStreamBB( 4
(BB4 5
ConvertBB5 <
.BB< =
FromBase64StringBB= M
(BBM N
ExceptionDataBBN [
)BB[ \
)BB\ ]
)BB] ^
{CC 

_exceptionDD 
=DD  
(DD! "
	ExceptionDD" +
)DD+ ,
newDD, /
BinaryFormatterDD0 ?
(DD? @
)DD@ A
.DDA B
DeserializeDDB M
(DDM N
streamDDN T
)DDT U
;DDU V
returnEE 

_exceptionEE %
;EE% &
}FF 
}GG 
catchHH 
{II 
returnJJ 
nullJJ 
;JJ 
}KK 
}LL 	
}MM 
}NN ø
KC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Program.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
{ 
public 

class 
Program 
{ 
public 
static 
void 
Main 
(  
string  &
[& '
]' (
args) -
)- .
{ 	
var 
_log 
= 
NLog 
. 

LogManager &
.& '
LoadConfiguration' 8
(8 9
S9 :
.: ;

NLogConfig; E
)E F
.F G!
GetCurrentClassLoggerG \
(\ ]
)] ^
;^ _
_log 
. 
Debug 
( 
$str 
) 
; 
try 
{ 
_log 
. 
Info 
( 
$str -
)- .
;. / 
CreateWebHostBuilder $
($ %
args% )
)) *
.* +
Build+ 0
(0 1
)1 2
.2 3
Run3 6
(6 7
)7 8
;8 9
} 
catch 
( 
	Exception 
ex 
)  
{ 
_log 
. 
Error 
( 
ex 
, 
$str B
)B C
;C D
throw 
; 
} 
finally   
{!! 
NLog## 
.## 

LogManager## 
.##  
Shutdown##  (
(##( )
)##) *
;##* +
}$$ 
}%% 	
public'' 
static'' 
IWebHostBuilder'' % 
CreateWebHostBuilder''& :
('': ;
string''; A
[''A B
]''B C
args''D H
)''H I
=>''J L
WebHost(( 
.((  
CreateDefaultBuilder(( (
(((( )
args(() -
)((- .
.)) 

UseStartup)) 
<)) 
Startup)) #
>))# $
())$ %
)))% &
.** 
UseNLog** 
(** 
)** 
;** 
}++ 
},, ’
EC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\S.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
{ 
public		 

class		 
S		 
{

 
public 
const 
string 

NLogConfig &
=' (
$str) 6
;6 7
public 
static 
void 
Initializate '
(' (
IConfiguration( 6
configuration7 D
)D E
{ 	
MailUser 
= 
configuration $
.$ %

GetSection% /
(/ 0
$str0 :
): ;
.; <
Get< ?
<? @
string@ F
>F G
(G H
)H I
;I J
MailPassword 
= 
configuration (
.( )

GetSection) 3
(3 4
$str4 B
)B C
.C D
GetD G
<G H
stringH N
>N O
(O P
)P Q
;Q R
MailBot 
= 
configuration #
.# $

GetSection$ .
(. /
$str/ :
): ;
.; <
Get< ?
<? @
string@ F
>F G
(G H
)H I
;I J
MailHost 
= 
configuration $
.$ %

GetSection% /
(/ 0
$str0 <
)< =
.= >
Get> A
<A B
stringB H
>H I
(I J
)J K
;K L
} 	
public 
static 
string 
MailHost %
=& '
$str( 8
;8 9
public 
static 
string 
MailBot $
=% &
$str' >
;> ?
public 
static 
string 
MailUser %
=& '
$str( 7
;7 8
public 
static 
string 
MailPassword )
=* +
$str, <
;< =
public   
const   
int   
MaxBook    
=  ! "
$num  # %
;  % &
}!! 
}"" Å@
KC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\Startup.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
{ 
public 

class 
Startup 
{ 
public 
Startup 
( 
IConfiguration %
configuration& 3
)3 4
{ 	
Configuration 
= 
configuration )
;) *
S 
. 
Initializate 
( 
configuration (
)( )
;) *
} 	
public!! 
IConfiguration!! 
Configuration!! +
{!!, -
get!!. 1
;!!1 2
}!!3 4
public$$ 
async$$ 
void$$ 
ConfigureServices$$ +
($$+ ,
IServiceCollection$$, >
services$$? G
)$$G H
{%% 	
services&& 
.&& 
	Configure&& 
<&& 
CookiePolicyOptions&& 2
>&&2 3
(&&3 4
options&&4 ;
=>&&< >
{'' 
options)) 
.)) 
CheckConsentNeeded)) *
=))+ ,
context))- 4
=>))5 7
true))8 <
;))< =
options** 
.** !
MinimumSameSitePolicy** -
=**. /
SameSiteMode**0 <
.**< =
None**= A
;**A B
}++ 
)++ 
;++ 
services99 
.99 
AddDbContext99 !
<99! "
BookDbContext99" /
>99/ 0
(990 1
options991 8
=>999 ;
options99< C
.99C D
UseMySql99D L
(99L M
Configuration:: "
.::" #
GetConnectionString::# 6
(::6 7
Data::7 ;
.::; <
S::< =
.::= > 
ConnectionStringName::> R
)::R S
,::S T
optionsBuilder;; #
=>;;$ &
optionsBuilder;;' 5
.;;5 6
MigrationsAssembly;;6 H
(;;H I
typeof;;I O
(;;O P
BookDbContext;;P ]
);;] ^
.;;^ _
	Namespace;;_ h
);;h i
);;i j
)<< 
;<< 
servicesAA 
.AA 
AddTransientAA !
(AA! "
qAA" #
=>AA$ &
newAA' *
EmailServiceAA+ 7
(AA7 8
SAA8 9
.AA9 :
MailHostAA: B
,AAB C
SAAD E
.AAE F
MailUserAAF N
,AAN O
SAAP Q
.AAQ R
MailPasswordAAR ^
)AA^ _
)AA_ `
;AA` a
servicesCC 
.CC 
AddDetectionCoreCC %
(CC% &
)CC& '
.CC' (

AddBrowserCC( 2
(CC2 3
)CC3 4
;CC4 5
servicesEE 
.EE 
AddMvcEE 
(EE 
)EE 
.EE #
SetCompatibilityVersionEE 5
(EE5 6 
CompatibilityVersionEE6 J
.EEJ K
Version_2_2EEK V
)EEV W
;EEW X
servicesFF 
.FF 
AddAuthenticationFF &
(FF& '
	MicrosoftFF' 0
.FF0 1

AspNetCoreFF1 ;
.FF; <
ServerFF< B
.FFB C
IISIntegrationFFC Q
.FFQ R
IISDefaultsFFR ]
.FF] ^ 
AuthenticationSchemeFF^ r
)FFr s
;FFs t
servicesGG 
.GG 
AddAuthorizationGG %
(GG% &
optionsGG& -
=>GG. 0
{HH 
optionsII 
.II 
	AddPolicyII !
(II! "
DataII" &
.II& '
SII' (
.II( )
GroupDeveloperII) 7
,II7 8
policyII9 ?
=>II@ B
policyIIC I
.III J
RequireClaimIIJ V
(IIV W
DataIIW [
.II[ \
SII\ ]
.II] ^
AccessLevelClaimII^ n
,IIn o
newIIp s
[IIs t
]IIt u
{IIv w
DataIIx |
.II| }
SII} ~
.II~ 
	Developer	II à
}
IIâ ä
)
IIä ã
)
IIã å
;
IIå ç
optionsJJ 
.JJ 
	AddPolicyJJ !
(JJ! "
DataJJ" &
.JJ& '
SJJ' (
.JJ( )

GroupAdminJJ) 3
,JJ3 4
policyJJ5 ;
=>JJ< >
policyJJ? E
.JJE F
RequireClaimJJF R
(JJR S
DataJJS W
.JJW X
SJJX Y
.JJY Z
AccessLevelClaimJJZ j
,JJj k
newJJl o
[JJo p
]JJp q
{JJr s
DataJJt x
.JJx y
SJJy z
.JJz {
Admin	JJ{ Ä
}
JJÅ Ç
)
JJÇ É
)
JJÉ Ñ
;
JJÑ Ö
optionsKK 
.KK 
	AddPolicyKK !
(KK! "
DataKK" &
.KK& '
SKK' (
.KK( )
GroupCommonKK) 4
,KK4 5
policyKK6 <
=>KK= ?
policyKK@ F
.KKF G
RequireClaimKKG S
(KKS T
DataKKT X
.KKX Y
SKKY Z
.KKZ [
AccessLevelClaimKK[ k
,KKk l
newKKm p
[KKp q
]KKq r
{KKs t
DataKKu y
.KKy z
SKKz {
.KK{ |
Common	KK| Ç
}
KKÉ Ñ
)
KKÑ Ö
)
KKÖ Ü
;
KKÜ á
}MM 
)MM 
;MM 
}NN 	
publicQQ 
asyncQQ 
voidQQ 
	ConfigureQQ #
(QQ# $
IApplicationBuilderQQ$ 7
appQQ8 ;
,QQ; <
IHostingEnvironmentQQ= P
envQQQ T
)QQT U
{RR 	
ifTT 
(TT 
envTT 
.TT 
IsDevelopmentTT !
(TT! "
)TT" #
)TT# $
{UU 
appVV 
.VV %
UseDeveloperExceptionPageVV -
(VV- .
)VV. /
;VV/ 0
}XX 
elseYY 
{ZZ 
app[[ 
.[[ 
UseExceptionHandler[[ '
([[' (
$str[[( 3
)[[3 4
;[[4 5
app]] 
.]] 
UseHsts]] 
(]] 
)]] 
;]] 
}^^ 
appcc 
.cc 
UseHttpsRedirectioncc #
(cc# $
)cc$ %
;cc% &
appdd 
.dd 
UseStaticFilesdd 
(dd 
)dd  
;dd  !
appgg 
.gg 
UseMiddlewaregg 
<gg $
LocalAuthorityMiddlewaregg 6
>gg6 7
(gg7 8
)gg8 9
;gg9 :
appii 
.ii 
UseMvcii 
(ii 
routesii 
=>ii  
{jj 
routeskk 
.kk 
MapRoutekk 
(kk  
namell 
:ll 
$strll #
,ll# $
templatemm 
:mm 
$strmm F
)mmF G
;mmG H
}nn 
)nn 
;nn 
}oo 	
privateqq 
staticqq 
voidqq 
UpdateDatabaseqq *
(qq* +
IApplicationBuilderqq+ >
appqq? B
)qqB C
{rr 	
usingtt 
(tt 
vartt 
serviceScopett #
=tt$ %
apptt& )
.tt) *
ApplicationServicestt* =
.uu 
GetRequiredServiceuu #
<uu# $ 
IServiceScopeFactoryuu$ 8
>uu8 9
(uu9 :
)uu: ;
.vv 
CreateScopevv 
(vv 
)vv 
)vv 
{ww 
usingxx 
(xx 
varxx 
contextxx "
=xx# $
serviceScopexx% 1
.xx1 2
ServiceProviderxx2 A
.xxA B

GetServicexxB L
<xxL M
BookDbContextxxM Z
>xxZ [
(xx[ \
)xx\ ]
)xx] ^
{yy 
contextzz 
.zz 
Databasezz $
.zz$ %
Migratezz% ,
(zz, -
)zz- .
;zz. /
}{{ 
}|| 
}}} 	
}~~ 
} ù
lC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ViewComponents\BooksActionsViewComponent.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
.		" #
ViewComponents		# 1
{

 
public 

class %
BooksActionsViewComponent *
:+ ,
ViewComponent- :
{ 
private 
BookDbContext 
_ctx "
;" #
public %
BooksActionsViewComponent (
(( )
BookDbContext) 6
ctx7 :
): ;
{ 	
_ctx 
= 
ctx 
; 
} 	
public  
IViewComponentResult #
Invoke$ *
(* +
int+ .
id/ 1
)1 2
{ 	
var 
book 
= 
_ctx 
. 
Books !
.! "
FirstOrDefault" 0
(0 1
b1 2
=>3 5
b6 7
.7 8
BiaId8 =
==> @
idA C
)C D
;D E
if 
( 
book 
is 
Ebook 
) 
{ 
var 
ebook 
= 
book  
as! #
Ebook$ )
;) *
return 
View 
( 
$str <
,< =
new> A
EBookViewModelB P
(P Q
)Q R
{S T
BiaIdU Z
=[ \
id] _
,_ `
Linka e
=f g
ebookh m
.m n
Linkn r
}r s
)s t
;t u
} 
if 
( 
book 
is 
	PaperBook !
)! "
{ 
var 
paper 
= 
book  
as! #
	PaperBook$ -
;- .
return   
View   
(   
$str   A
,  A B
paper  C H
)  H I
;  I J
}!! 
return## 
View## 
(## 
$str## 7
)##7 8
;##8 9
}$$ 	
}%% 
}&& ‰	
pC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ViewComponents\BrowserDetectionViewComponent.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
.		" #
ViewComponents		# 1
{

 
public 

class )
BrowserDetectionViewComponent .
:. /
ViewComponent0 =
{ 
public  
IViewComponentResult #
Invoke$ *
(* +
)+ ,
{ 	
var 
type 
= 
Request 
. 
Browser &
(& '
)' (
.( )
Type) -
;- .
if 
( 
type 
!= 
BrowserType #
.# $
Chrome$ *
&&+ -
type. 2
!=3 5
BrowserType6 A
.A B
OperaB G
)G H
{ 
return 
View 
( 
$str 0
)0 1
;1 2
} 
return 
View 
( 
$str )
)) *
;* +
} 	
} 
} ≠	
iC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ViewComponents\CathegoryViewComponent.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
.		" #
ViewComponents		# 1
{

 
public 

class "
CathegoryViewComponent '
:( )
ViewComponent* 7
{ 
private 
BookDbContext 
_ctx "
;" #
public "
CathegoryViewComponent %
(% &
BookDbContext& 3
ctx4 7
)7 8
{ 	
_ctx 
= 
ctx 
; 
} 	
public  
IViewComponentResult #
Invoke$ *
(* +
)+ ,
{ 	
var 
all 
= 
_ctx 
. 

Categories %
.% &
ToList& ,
(, -
)- .
;. /
return 
View 
( 
$str 8
,8 9
all: =
)= >
;> ?
} 	
} 
} €;
uC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ViewComponents\CustomSelectListItemsViewComponent.cs
	namespace

 	
Bia


 
.

 
Internal

 
.

 
BookLibrary

 "
.

" #
ViewComponents

# 1
{ 
public 

class .
"CustomSelectListItemsViewComponent 3
:3 4
ViewComponent5 B
{ 
private 
BookDbContext 
_ctx "
;" #
public .
"CustomSelectListItemsViewComponent 1
(1 2
BookDbContext2 ?
ctx@ C
)C D
{ 	
_ctx 
= 
ctx 
; 
} 	
public  
IViewComponentResult #
Invoke$ *
(* + 
ViewComponentContext+ ?
context@ G
)G H
{ 	
switch 
( 
context 
. 
Method "
." #
ToLower# *
(* +
)+ ,
), -
{ 
case 
$str 
: 
return  &
Authors' .
(. /
context/ 6
.6 7
Id7 9
)9 :
;: ;
case 
$str  
:  !
return" (
	Cathegory) 2
(2 3
context3 :
.: ;
Id; =
)= >
;> ?
default 
: 
return 
null  $
;$ %
} 
} 	
private  
IViewComponentResult $
Authors% ,
(, -
int- 0
id1 3
)3 4
{   	
var!! 
all!! 
=!! 
_ctx!! 
.!! 
Authors!! "
;!!" #
var"" 
checkedAuthors"" 
=""  
_ctx""! %
.""% &
BookAuthors""& 1
.""1 2
Where""2 7
(""7 8
q""8 9
=>"": <
q""= >
.""> ?
BookId""? E
==""F H
id""I K
)""K L
.## 
Join## 
(## 
all## 
,## 
ba## 
=>##  
ba##! #
.### $
	AuthorUid##$ -
,##- .
a##/ 0
=>##1 3
a##4 5
.##5 6
	AuthorUid##6 ?
,##? @
(##A B
ba##B D
,##D E
a##E F
)##F G
=>##H J
a##K L
)##L M
.$$ 
ToList$$ 
($$ 
)$$ 
;$$ 
if&& 
(&& 
all&& 
.&& 
Any&& 
(&& 
)&& 
)&& 
{'' 
var(( 
top(( 
=(( 
new(( 
List(( "
<((" #
SelectListItem((# 1
>((1 2
(((2 3
)((3 4
;((4 5
foreach)) 
()) 
var)) 
cur))  
in))! #
all))$ '
)))' (
{** 
var++ 
current++ 
=++  !
new++" %
SelectListItem++& 4
(++4 5
)++5 6
{,, 
Text-- 
=-- 
cur-- "
.--" #
FullName--# +
(--+ ,
)--, -
,--- .
Value.. 
=.. 
cur..  #
...# $
	AuthorUid..$ -
...- .
ToString... 6
(..6 7
)..7 8
,..8 9
Selected//  
=//! "
checkedAuthors//# 1
.//1 2
Contains//2 :
(//: ;
cur//; >
)//> ?
}00 
;00 
top11 
.11 
Add11 
(11 
current11 #
)11# $
;11$ %
}22 
return44 
View44 
(44 
$str44 <
,44< =
top44> A
)44A B
;44B C
}55 
else66 
{77 
return88 
View88 
(88 
$str88 <
,88< =
new88> A
List88B F
<88F G
SelectListItem88G U
>88U V
(88V W
)88W X
)88X Y
;88Y Z
}99 
};; 	
private==  
IViewComponentResult== $
	Cathegory==% .
(==. /
int==/ 2
id==3 5
)==5 6
{>> 	
var?? 
all?? 
=?? 
_ctx?? 
.?? 

Categories?? %
;??% &
var@@ 
checekCategories@@  
=@@! "
_ctx@@# '
.@@' (
BookCategories@@( 6
.@@6 7
Where@@7 <
(@@< =
q@@= >
=>@@? A
q@@B C
.@@C D
BookId@@D J
==@@K M
id@@N P
)@@P Q
.AA 
JoinAA 
(AA 
allAA 
,AA 
baAA 
=>AA  
baAA! #
.AA# $

CategoryIdAA$ .
,AA. /
aAA0 1
=>AA2 4
aAA5 6
.AA6 7

CategoryIdAA7 A
,AAA B
(AAC D
baAAD F
,AAF G
aAAH I
)AAI J
=>AAK M
aAAN O
)AAO P
.BB 
ToListBB 
(BB 
)BB 
;BB 
ifDD 
(DD 
allDD 
.DD 
AnyDD 
(DD 
)DD 
)DD 
{EE 
varFF 
topFF 
=FF 
newFF 
ListFF "
<FF" #
SelectListItemFF# 1
>FF1 2
(FF2 3
)FF3 4
;FF4 5
foreachGG 
(GG 
varGG 
curGG  
inGG! #
allGG$ '
)GG' (
{HH 
varII 
currentII 
=II  !
newII" %
SelectListItemII& 4
(II4 5
)II5 6
{JJ 
TextKK 
=KK 
curKK "
.KK" #
CategoryNameKK# /
,KK/ 0
ValueLL 
=LL 
curLL  #
.LL# $

CategoryIdLL$ .
.LL. /
ToStringLL/ 7
(LL7 8
)LL8 9
,LL9 :
SelectedMM  
=MM! "
checekCategoriesMM# 3
.MM3 4
ContainsMM4 <
(MM< =
curMM= @
)MM@ A
}NN 
;NN 
topOO 
.OO 
AddOO 
(OO 
currentOO #
)OO# $
;OO$ %
}PP 
returnQQ 
ViewQQ 
(QQ 
$strQQ <
,QQ< =
topQQ> A
)QQA B
;QQB C
}RR 
elseSS 
{TT 
returnUU 
ViewUU 
(UU 
$strUU <
,UU< =
newUU> A
ListUUB F
<UUF G
SelectListItemUUG U
>UUU V
(UUV W
)UUW X
)UUX Y
;UUY Z
}VV 
}WW 	
}YY 
public]] 

class]]  
ViewComponentContext]] %
{^^ 
public__ 
string__ 
Method__ 
{__ 
get__ "
;__" #
set__$ '
;__' (
}__) *
public`` 
int`` 
Id`` 
{`` 
get`` 
;`` 
set``  
;``  !
}``" #
publicaa 
stringaa 
[aa 
]aa 
Argsaa 
{aa 
getaa "
;aa" #
setaa$ '
;aa' (
}aa) *
}bb 
}cc ô
eC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ViewComponents\ModalViewComponent.cs
	namespace		 	
Bia		
 
.		 
Internal		 
.		 
BookLibrary		 "
.		" #
ViewComponents		# 1
{

 
public 

class 
ModalViewComponent #
:$ %
ViewComponent& 3
{ 
private 
BookDbContext 
_ctx "
;" #
public 
ModalViewComponent !
(! "
BookDbContext" /
ctx0 3
)3 4
{ 	
_ctx 
= 
ctx 
; 
} 	
public  
IViewComponentResult #
Invoke$ *
(* +
string+ 1
str2 5
)5 6
{ 	
switch 
( 
str 
) 
{ 
case 
$str 
: 
return  &
View' +
(+ ,
$str, A
)A B
;B C
case 
$str  
:  !
return" (
View) -
(- .
$str. E
)E F
;F G
case 
$str !
:! "
return# )
View* .
(. /
$str/ G
)G H
;H I
case 
$str #
:# $
return% +
View, 0
(0 1
$str1 K
)K L
;L M
case 
$str #
:# $
return% +
View, 0
(0 1
$str1 K
)K L
;L M
case 
$str  
:  !
return" (
View) -
(- .
$str. E
)E F
;F G
case 
$str #
:# $
return% +
View, 0
(0 1
$str1 K
)K L
;L M
case 
$str 
:  
return! '
View( ,
(, -
$str- C
)C D
;D E
case   
$str   )
:  ) *
return  + 1
View  2 6
(  6 7
$str  7 W
)  W X
;  X Y
default!! 
:!! 
return!! 
null!!  $
;!!$ %
}"" 
}## 	
}$$ 
}%% ®.
oC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary\ViewComponents\SelectListItemsViewComponent.cs
	namespace

 	
Bia


 
.

 
Internal

 
.

 
BookLibrary

 "
.

" #
ViewComponents

# 1
{ 
public 

class (
SelectListItemsViewComponent -
:. /
ViewComponent0 =
{ 
private 
BookDbContext 
_ctx "
;" #
public (
SelectListItemsViewComponent +
(+ ,
BookDbContext, 9
ctx: =
)= >
{ 	
_ctx 
= 
ctx 
; 
} 	
public  
IViewComponentResult #
Invoke$ *
(* +
string+ 1
str2 5
)5 6
{ 	
switch 
( 
str 
. 
ToLower 
(  
)  !
)! "
{ 
case 
$str 
: 
return  &
Authors' .
(. /
)/ 0
;0 1
case 
$str  
:  !
return" (
	Cathegory) 2
(2 3
)3 4
;4 5
case 
$str 
: 
return $
Users% *
(* +
)+ ,
;, -
default 
: 
return 
null  $
;$ %
} 
} 	
private    
IViewComponentResult   $
Authors  % ,
(  , -
)  - .
{!! 	
var"" 
all"" 
="" 
_ctx"" 
."" 
Authors"" "
;""" #
if## 
(## 
all## 
.## 
Any## 
(## 
)## 
)## 
{$$ 
var%% 
top%% 
=%% 
all%% 
.&& 
Select&& 
(&& 
st&& 
=>&& !
new&&" %
SelectListItem&&& 4
(&&4 5
)&&5 6
{&&7 8
Text&&9 =
=&&> ?
st&&@ B
.&&B C
FullName&&C K
(&&K L
)&&L M
,&&M N
Value&&O T
=&&U V
st&&W Y
.&&Y Z
	AuthorUid&&Z c
.&&c d
ToString&&d l
(&&l m
)&&m n
}&&o p
)&&p q
.'' 
ToList'' 
('' 
)'' 
;'' 
return)) 
View)) 
()) 
$str)) <
,))< =
top))> A
)))A B
;))B C
}** 
else++ 
{,, 
return-- 
View-- 
(-- 
$str-- <
,--< =
new--> A
List--B F
<--F G
SelectListItem--G U
>--U V
(--V W
)--W X
)--X Y
;--Y Z
}.. 
}00 	
private22  
IViewComponentResult22 $
	Cathegory22% .
(22. /
)22/ 0
{33 	
var44 
all44 
=44 
_ctx44 
.44 

Categories44 %
;44% &
if55 
(55 
all55 
.55 
Any55 
(55 
)55 
)55 
{66 
var77 
top77 
=77 
all77 
.88 
Select88 
(88 
st88 
=>88 !
new88" %
SelectListItem88& 4
(884 5
)885 6
{887 8
Text889 =
=88> ?
st88@ B
.88B C
CategoryName88C O
,88O P
Value88Q V
=88W X
st88Y [
.88[ \

CategoryId88\ f
.88f g
ToString88g o
(88o p
)88p q
}88r s
)88s t
.99 
ToList99 
(99 
)99 
;99 
return;; 
View;; 
(;; 
$str;; <
,;;< =
top;;> A
);;A B
;;;B C
}<< 
else== 
{>> 
return?? 
View?? 
(?? 
$str?? <
,??< =
new??> A
List??B F
<??F G
SelectListItem??G U
>??U V
(??V W
)??W X
)??X Y
;??Y Z
}@@ 
}AA 	
privateCC  
IViewComponentResultCC $
UsersCC% *
(CC* +
)CC+ ,
{DD 	
varEE 
allEE 
=EE 
_ctxEE 
.EE 
AppUsersEE #
;EE# $
ifFF 
(FF 
allFF 
.FF 
AnyFF 
(FF 
)FF 
)FF 
{GG 
varHH 
topHH 
=HH 
allHH 
.II 
SelectII 
(II 
stII 
=>II !
newII" %
SelectListItemII& 4
(II4 5
)II5 6
{II7 8
TextII9 =
=II> ?
stII@ B
.IIB C
FullNameIIC K
,IIK L
ValueIIM R
=IIS T
stIIU W
.IIW X
UidIIX [
.II[ \
ToStringII\ d
(IId e
)IIe f
}IIg h
)IIh i
.JJ 
ToListJJ 
(JJ 
)JJ 
;JJ 
returnLL 
ViewLL 
(LL 
$strLL <
,LL< =
topLL> A
)LLA B
;LLB C
}MM 
elseNN 
{OO 
returnPP 
ViewPP 
(PP 
$strPP <
,PP< =
newPP> A
ListPPB F
<PPF G
SelectListItemPPG U
>PPU V
(PPV W
)PPW X
)PPX Y
;PPY Z
}QQ 
}RR 	
}SS 
}TT 