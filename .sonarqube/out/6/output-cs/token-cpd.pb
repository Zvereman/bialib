ñÉ
XC:\vsproj\beck\bia.internal.booklibrary\Bia.Internal.BookLibrary.Notification\Program.cs
	namespace 	
Bia
 
. 
Internal 
. 
BookLibrary "
." #
Notification# /
{ 
class 	
Program
 
{ 
private 
static 
void 
Execute #
(# $
string$ *
host+ /
,/ 0
string0 6
mail7 ;
,; <
string= C
mailUserD L
,L M
stringN T
passU Y
,Y Z
string[ a

connectionb l
)l m
{ 	
var 
	localPath 
= 
Path  
.  !
GetDirectoryName! 1
(1 2
Assembly2 :
.: ; 
GetExecutingAssembly; O
(O P
)P Q
.Q R
LocationR Z
)Z [
+\ ]
$str^ j
;j k
var 
	template1 
= 
File  
.  !
ReadAllText! ,
(, -
	localPath- 6
+7 8
$str9 I
)I J
;J K
var 
	template2 
= 
File  
.  !
ReadAllText! ,
(, -
	localPath- 6
+7 8
$str9 I
)I J
;J K
using 
( 
var 
ctx 
= 
new   
BookDbContextFactory! 5
(5 6

connection6 @
)@ A
.A B
CreateDbContextB Q
(Q R
newR U
stringV \
[\ ]
]] ^
{_ `

connectiona k
}l m
)m n
)n o
{ 
var 
ignoredUsers  
=! "
ctx# &
.& '
IgnoredUsers' 3
.3 4
Select4 :
(: ;
q; <
=>< >
q> ?
.? @
AppUser@ G
.G H
	LoginNameH Q
)Q R
.R S
ToListS Y
(Y Z
)Z [
;[ \
var   
notifaedAdmins   "
=  # $
ctx  % (
.  ( )
AdminNotifies  ) 6
.  6 7
Where  7 <
(  < =
q  = >
=>  ? A
q  B C
.  C D
NotifyId  D L
==  M O
AdminNotifyTypes  P `
.  ` a
General  a h
)  h i
.  i j
Select  j p
(  p q
q  q r
=>  r t
q  t u
.  u v
Admin  v {
)  { |
;  | }
var!! 
mentionAdminList!! $
=!!% &
notifaedAdmins!!' 5
.!!5 6
Select!!6 <
(!!< =
q!!= >
=>!!> @
q!!@ A
.!!A B
Email!!B G
)!!G H
.!!H I
ToList!!I O
(!!O P
)!!P Q
;!!Q R
mentionAdminList""  
.""  !
Add""! $
(""$ %
$str""% 5
)""5 6
;""6 7
var## 
mentionAdmin##  
=##! "
string### )
.##) *
Join##* .
(##. /
$str##/ 2
,##2 3
mentionAdminList##4 D
)##D E
;##E F
var'' 
rents'' 
='' 
ctx'' 
.''  
RentHistories''  -
.''- .
Where''. 3
(''3 4
q''4 5
=>''5 7
q''8 9
.''9 :
ReturnedDate'': F
==''G I
null''J N
)''O P
.''P Q
Where''Q V
(''V W
q''W X
=>''Y [
q''\ ]
.''] ^
ExtendedDueDate''^ m
.''m n
Date''n r
<''s t
DateTime''u }
.''} ~
Now	''~ Å
.
''Å Ç
Date
''Ç Ü
&&
''á â
!
''ä ã
ignoredUsers
''ã ó
.
''ó ò
Contains
''ò †
(
''† °
q
''° ¢
.
''¢ £
User
''£ ß
.
''ß ®
	LoginName
''® ±
)
''± ≤
)
''≤ ≥
;
''≥ ¥
var)) 
client)) 
=)) 
new))  
EmailService))! -
())- .
host)). 2
,))2 3
mailUser))4 <
,))< =
pass))> B
)))B C
;))C D
var++ 
loglist++ 
=++ 
new++ !
StringBuilder++" /
(++/ 0
)++0 1
;++1 2
foreach.. 
(.. 
var.. 
rent.. !
in.." $
rents..% *
)..* +
{// 
try00 
{11 
var22 
book22  
=22! "
rent22# '
.22' (
	TakenBook22( 1
;221 2
var33 
user33  
=33! "
rent33# '
.33' (
User33( ,
;33, -
if44 
(44 
!44 
string44 #
.44# $
IsNullOrWhiteSpace44$ 6
(446 7
user447 ;
.44; <
Email44< A
)44A B
)44B C
{55 
MimeMessage66 '
msg66( +
=66, -
new66. 1
MimeMessage662 =
(66= >
)66> ?
;66? @
msg77 
.77  
From77  $
.77$ %
Add77% (
(77( )
new77) ,
MailboxAddress77- ;
(77; <
mail77< @
)77@ A
)77A B
;77B C
msg88 
.88  
To88  "
.88" #
Add88# &
(88& '
new88' *
MailboxAddress88+ 9
(889 :
user88: >
.88> ?
Email88? D
)88D E
)88E F
;88F G
msg99 
.99  
Subject99  '
=99( )
$str99* D
;99D E
if:: 
(::  
rent::  $
.::$ %
ExtendedDueDate::% 4
<::5 6
DateTime::7 ?
.::? @
Now::@ C
)::C D
{;; 
var>>  #
text>>$ (
=>>) *
	template2>>+ 4
.??$ %
Replace??% ,
(??, -
$str??- :
,??: ;
user??< @
.??@ A
	FirstName??A J
)??J K
.@@$ %
Replace@@% ,
(@@, -
$str@@- ;
,@@; <
mentionAdmin@@= I
)@@I J
.AA$ %
ReplaceAA% ,
(AA, -
$strAA- 8
,AA8 9
bookAA: >
.AA> ?
BiaIdAA? D
.AAD E
ToStringAAE M
(AAM N
)AAN O
)AAO P
.BB$ %
ReplaceBB% ,
(BB, -
$strBB- :
,BB: ;
bookBB< @
.BB@ A
TitleBBA F
)BBF G
;BBG H
msgDD  #
.DD# $
BodyDD$ (
=DD) *
newDD+ .
TextPartDD/ 7
(DD7 8
MimeKitDD8 ?
.DD? @
TextDD@ D
.DDD E

TextFormatDDE O
.DDO P
HtmlDDP T
)DDT U
{EE  !
TextFF$ (
=FF) *
textFF+ /
}GG  !
;GG! "
clientHH  &
.HH& '
SendHH' +
(HH+ ,
msgHH, /
)HH/ 0
;HH0 1
loglistII  '
.II' (

AppendLineII( 2
(II2 3
$"II3 5
$strII5 B
{IIB C
userIIC G
.IIG H
FullNameIIH P
}IIP Q
$strIIQ l
{IIl m
bookIIm q
.IIq r
TitleIIr w
}IIw x
$strIIx z
{IIz {
rentII{ 
.	II Ä
ExtendedDueDate
IIÄ è
}
IIè ê
$str
IIê ë
{
IIë í
Environment
IIí ù
.
IIù û
NewLine
IIû •
}
II• ¶
"
II¶ ß
)
IIß ®
;
II® ©
}JJ 
elseKK  
{LL 
}\\ 
}]] 
else^^ 
{__ 
loglistaa #
.aa# $

AppendLineaa$ .
(aa. /
$"aa/ 1
$straa1 >
{aa> ?
useraa? C
.aaC D
	LoginNameaaD M
}aaM N
$straaN ]
{aa] ^
Environmentaa^ i
.aai j
NewLineaaj q
}aaq r
"aar s
)aas t
;aat u
}bb 
}cc 
catchdd 
(dd 
	Exceptiondd $
edd% &
)dd& '
{ee 
loglistff 
.ff  

AppendLineff  *
(ff* +
$"ff+ -
$strff- h
{ffh i
effi j
.ffj k
Messageffk r
}ffr s
{ffs t
Environmentfft 
.	ff Ä
NewLine
ffÄ á
}
ffá à
"
ffà â
)
ffâ ä
;
ffä ã
}gg 
}hh 
varkk 
logkk 
=kk 
loglistkk !
.kk! "
ToStringkk" *
(kk* +
)kk+ ,
;kk, -
varll 
currentTimell 
=ll  !
DateTimell" *
.ll* +
Nowll+ .
;ll. /
ifnn 
(nn 
loglistnn 
.nn 
Lengthnn "
>nn# $
$numnn% &
)nn& '
{oo 
MimeMessagepp 
msgpp  #
=pp$ %
newpp& )
MimeMessagepp* 5
(pp5 6
)pp6 7
;pp7 8
msgqq 
.qq 
Fromqq 
.qq 
Addqq  
(qq  !
newqq! $
MailboxAddressqq% 3
(qq3 4
mailqq4 8
)qq8 9
)qq9 :
;qq: ;
foreachrr 
(rr 
varrr  
notifaedAdminrr! .
inrr/ 1
notifaedAdminsrr2 @
)rr@ A
{ss 
msgtt 
.tt 
Tott 
.tt 
Addtt "
(tt" #
newtt# &
MailboxAddresstt' 5
(tt5 6
notifaedAdmintt6 C
.ttC D
EmailttD I
)ttI J
)ttJ K
;ttK L
}uu 
msgvv 
.vv 
Subjectvv 
=vv  !
$"vv" $
$strvv$ _
{vv_ `
currentTimevv` k
}vvk l
"vvl m
;vvm n
msgww 
.ww 
Bodyww 
=ww 
newww "
TextPartww# +
(ww+ ,
)ww, -
{xx 
Textyy 
=yy 
logyy "
}zz 
;zz 
client{{ 
.{{ 
Send{{ 
({{  
msg{{  #
){{# $
;{{$ %
}|| 
}}} 
}~~ 	
static 
void 
Main 
( 
string 
[  
]  !
args" &
)& '
{
ÄÄ 	
if
ÅÅ 
(
ÅÅ 
DateTime
ÅÅ 
.
ÅÅ 
Now
ÅÅ 
.
ÅÅ 
	DayOfWeek
ÅÅ &
==
ÅÅ' )
	DayOfWeek
ÅÅ* 3
.
ÅÅ3 4
Sunday
ÅÅ4 :
||
ÅÅ; =
DateTime
ÅÅ> F
.
ÅÅF G
Now
ÅÅG J
.
ÅÅJ K
	DayOfWeek
ÅÅK T
==
ÅÅU W
	DayOfWeek
ÅÅX a
.
ÅÅa b
Saturday
ÅÅb j
)
ÅÅj k
return
ÇÇ 
;
ÇÇ 
try
ÉÉ 
{
ÑÑ 
var
ÖÖ 
builder
ÖÖ 
=
ÖÖ 
new
ÖÖ !"
ConfigurationBuilder
ÖÖ" 6
(
ÖÖ6 7
)
ÖÖ7 8
.
ÜÜ 
SetBasePath
ÜÜ  
(
ÜÜ  !
Path
ÜÜ! %
.
ÜÜ% &
GetDirectoryName
ÜÜ& 6
(
ÜÜ6 7
Assembly
ÜÜ7 ?
.
ÜÜ? @"
GetExecutingAssembly
ÜÜ@ T
(
ÜÜT U
)
ÜÜU V
.
ÜÜV W
Location
ÜÜW _
)
ÜÜ_ `
)
ÜÜ` a
.
áá 
AddJsonFile
áá  
(
áá  !
$str
áá! 3
,
áá3 4
optional
áá5 =
:
áá= >
true
áá? C
,
ááC D
reloadOnChange
ááE S
:
ááS T
true
ááU Y
)
ááY Z
;
ááZ [
var
àà 
config
àà 
=
àà 
builder
àà $
.
àà$ %
Build
àà% *
(
àà* +
)
àà+ ,
;
àà, -
NLog
ää 
.
ää 

LogManager
ää 
.
ää  #
GetCurrentClassLogger
ää  5
(
ää5 6
)
ää6 7
.
ää7 8
Info
ää8 <
(
ää< =
$str
ää= I
)
ääI J
;
ääJ K
NLog
ãã 
.
ãã 

LogManager
ãã 
.
ãã  #
GetCurrentClassLogger
ãã  5
(
ãã5 6
)
ãã6 7
.
ãã7 8
Trace
ãã8 =
(
ãã= >
$"
ãã> @
$str
ãã@ J
{
ããJ K
Path
ããK O
.
ããO P
GetDirectoryName
ããP `
(
ãã` a
Assembly
ããa i
.
ããi j"
GetExecutingAssembly
ããj ~
(
ãã~ 
)ãã Ä
.ããÄ Å
LocationããÅ â
)ããâ ä
}ããä ã
"ããã å
)ããå ç
;ããç é
var
çç 

connection
çç 
=
çç  
config
çç! '
.
çç' (
GetValue
çç( 0
<
çç0 1
string
çç1 7
>
çç7 8
(
çç8 9
$str
çç9 Y
)
ççY Z
;
ççZ [
var
èè 
host
èè 
=
èè 
config
èè !
.
èè! "

GetSection
èè" ,
(
èè, -
$str
èè- 9
)
èè9 :
.
èè: ;
Get
èè; >
<
èè> ?
string
èè? E
>
èèE F
(
èèF G
)
èèG H
;
èèH I
var
êê 
mail
êê 
=
êê 
config
êê !
.
êê! "

GetSection
êê" ,
(
êê, -
$str
êê- 8
)
êê8 9
.
êê9 :
Get
êê: =
<
êê= >
string
êê> D
>
êêD E
(
êêE F
)
êêF G
;
êêG H
var
ëë 
mailUser
ëë 
=
ëë 
config
ëë %
.
ëë% &

GetSection
ëë& 0
(
ëë0 1
$str
ëë1 ;
)
ëë; <
.
ëë< =
Get
ëë= @
<
ëë@ A
string
ëëA G
>
ëëG H
(
ëëH I
)
ëëI J
;
ëëJ K
var
íí 
mailPass
íí 
=
íí 
config
íí %
.
íí% &

GetSection
íí& 0
(
íí0 1
$str
íí1 ?
)
íí? @
.
íí@ A
Get
ííA D
<
ííD E
string
ííE K
>
ííK L
(
ííL M
)
ííM N
;
ííN O
NLog
ññ 
.
ññ 

LogManager
ññ 
.
ññ  #
GetCurrentClassLogger
ññ  5
(
ññ5 6
)
ññ6 7
.
ññ7 8
Trace
ññ8 =
(
ññ= >
$"
ññ> @
{
ññ@ A
host
ññA E
}
ññE F
$str
ññF G
{
ññG H
mail
ññH L
}
ññL M
$str
ññM N
{
ññN O

connection
ññO Y
}
ññY Z
"
ññZ [
)
ññ[ \
;
ññ\ ]
NLog
óó 
.
óó 

LogManager
óó 
.
óó  #
GetCurrentClassLogger
óó  5
(
óó5 6
)
óó6 7
.
óó7 8
Trace
óó8 =
(
óó= >
$"
óó> @
$str
óó@ A
{
óóA B

connection
óóB L
}
óóL M
"
óóM N
)
óóN O
;
óóO P
NLog
òò 
.
òò 

LogManager
òò 
.
òò  #
GetCurrentClassLogger
òò  5
(
òò5 6
)
òò6 7
.
òò7 8
Trace
òò8 =
(
òò= >
$str
òò> N
)
òòN O
;
òòO P
Execute
öö 
(
öö 
host
öö 
,
öö 
mail
öö "
,
öö" #
mailUser
öö$ ,
,
öö, -
mailPass
öö. 6
,
öö6 7

connection
öö8 B
)
ööB C
;
ööC D
NLog
úú 
.
úú 

LogManager
úú 
.
úú  #
GetCurrentClassLogger
úú  5
(
úú5 6
)
úú6 7
.
úú7 8
Info
úú8 <
(
úú< =
$str
úú= R
)
úúR S
;
úúS T
}
ùù 
catch
ûû 
(
ûû 
	Exception
ûû 
e
ûû 
)
ûû 
{
üü 
NLog
†† 
.
†† 

LogManager
†† 
.
††  #
GetCurrentClassLogger
††  5
(
††5 6
)
††6 7
.
††7 8
Error
††8 =
(
††= >
e
††> ?
)
††? @
;
††@ A
}
°° 
}
¢¢ 	
}
££ 
}§§ 